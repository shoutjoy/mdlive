<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="theme-color" content="#1a1a24">
<meta name="description" content="ì—°êµ¬Â·ë…¼ë¬¸ ì „ìš© ë§ˆí¬ë‹¤ìš´ ì—ë””í„° â€” ë°•ì¤‘í¬">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="MD PRO V20">
<link rel="manifest" id="pwa-manifest">
<title>Markdown PDF Editor Pro</title>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&family=Figtree:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/marked/9.1.6/marked.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.min.js"></script>
<style>
:root{
  --bg:#0f0f13;--bg2:#16161d;--bg3:#1c1c26;--bg4:#22222f;--bg5:#2a2a3a;
  --bd:#2e2e42;--bda:#4a4a6a;
  --ac:#7c6af7;--acd:#4a3fc4;--acg:rgba(124,106,247,.15);--ac2:#f7a06a;
  --tx:#e8e8f0;--tx2:#9090b0;--tx3:#55556a;--txh:#fff;
  --er:#f76a6a;--ok:#6af7a0;--wn:#f7d06a;
  --fm:'JetBrains Mono',monospace;--fb:'Figtree',sans-serif;--fs:'Libre Baskerville',serif;
  --r:6px;--sh:0 4px 24px rgba(0,0,0,.4);--tr:.15s ease;--sw:240px;
}
[data-theme=light]{
  --bg:#f0f0f5;--bg2:#fff;--bg3:#f7f7fc;--bg4:#ededf5;--bg5:#e8e8f2;
  --bd:#d0d0e0;--bda:#a0a0c0;--ac:#5b4ce4;--acd:#3d31a8;--acg:rgba(91,76,228,.1);
  --tx:#1a1a2e;--tx2:#505070;--tx3:#9090a8;--txh:#0a0a18;
  --er:#d64242;--ok:#2a8a50;--wn:#c07010;
}
[data-theme=light] .tb.tb-heading{color:#a07008}
[data-theme=light] .tb.tb-heading:hover{color:#b08010;background:rgba(160,112,8,.1)}
[data-theme=light] .tb.tb-fmt{color:#b85e1a}
[data-theme=light] .tb.tb-fmt:hover{color:#d07020;background:rgba(184,94,26,.1)}
[data-theme=light] .tb.tb-layout{color:#1a8040}
[data-theme=light] .tb.tb-layout:hover{color:#20a050;background:rgba(26,128,64,.1)}
[data-theme=light] .tb.tb-table{color:#1870a8}
[data-theme=light] .tb.tb-table:hover{color:#2088c8;background:rgba(24,112,168,.1)}
[data-theme=light] .tb.tb-table-tidy{color:#007a60}
[data-theme=light] .tb.tb-table-tidy:hover{color:#009a78;background:rgba(0,122,96,.1)}
[data-theme=light] .tb.tb-code{color:#5a30c0}
[data-theme=light] .tb.tb-code:hover{color:#7040e0;background:rgba(90,48,192,.1)}
[data-theme=light] .tb.tb-insert{color:#a02060}
[data-theme=light] .tb.tb-insert:hover{color:#c02878;background:rgba(160,32,96,.1)}
/* â”€â”€ pv-hdr ë³µì‚¬ ë²„íŠ¼ â”€â”€ */
.tb.tb-copy-rich{font-size:10px;padding:0 8px;height:22px;color:#6af7a0;border:1px solid rgba(106,247,160,.35);border-radius:4px;font-weight:600}
.tb.tb-copy-rich:hover{color:#fff;background:rgba(106,247,160,.2);border-color:rgba(106,247,160,.6)}
.tb.tb-copy-text{font-size:10px;padding:0 8px;height:22px;color:#a090d0;border:1px solid rgba(160,144,208,.3);border-radius:4px}
.tb.tb-copy-text:hover{color:#c4b8f0;background:rgba(160,144,208,.15);border-color:rgba(160,144,208,.55)}

/* â”€â”€ ë³´ê¸° ëª¨ë“œ Split/Edit/View â”€â”€ */
.tb.tb-view{font-size:10px;min-width:36px;padding:0 5px;color:#60c8f0;border:1px solid rgba(96,200,240,.25);border-radius:4px}
.tb.tb-view:hover{color:#90dcff;background:rgba(96,200,240,.15);border-color:rgba(96,200,240,.5)}
.tb.tb-view.active{background:rgba(96,200,240,.2);color:#b8eeff;border-color:#60c8f0}

/* â”€â”€ PV / â†» â”€â”€ */
.tb.tb-pv{color:#f0c060;font-size:11px}
.tb.tb-pv:hover{color:#ffe090;background:rgba(240,192,96,.15)}
.tb.tb-pv.open::after{display:block}

/* â”€â”€ â—‘ ln ? ì‹œìŠ¤í…œ ë²„íŠ¼ â”€â”€ */
.tb.tb-sys{color:#8888c0}
.tb.tb-sys:hover{color:#b0b0e8;background:rgba(136,136,192,.15)}
.tb.tb-sys.active{color:var(--ac);background:var(--acg)}

/* â”€â”€ titlebar ë°°ê²½ìƒ‰ ë²„íŠ¼ë“¤ â”€â”€ */
.btn.btn-tmpl{background:linear-gradient(135deg,#2a2060 0%,#3a2880 100%);color:#c8b8ff;border:1px solid rgba(160,130,255,.4)}
.btn.btn-tmpl:hover{background:linear-gradient(135deg,#3a2880 0%,#4a38a0 100%);color:#e0d4ff;border-color:rgba(180,160,255,.7)}

.btn.btn-research{background:linear-gradient(135deg,#0d3a2a 0%,#124a36 100%);color:#6af7a0;border:1px solid rgba(106,247,160,.35)}
.btn.btn-research:hover{background:linear-gradient(135deg,#154a34 0%,#1a6045 100%);color:#8fffbe;border-color:rgba(106,247,160,.6)}

.btn.btn-ref{background:linear-gradient(135deg,#2a1a40 0%,#381f5a 100%);color:#d4a0ff;border:1px solid rgba(180,120,255,.35)}
.btn.btn-ref:hover{background:linear-gradient(135deg,#3a2050 0%,#4a2a70 100%);color:#eebbff;border-color:rgba(200,150,255,.6)}

.btn.btn-scholar{background:linear-gradient(135deg,#1a2a40 0%,#1e3558 100%);color:#6ac8f7;border:1px solid rgba(106,200,247,.35)}
.btn.btn-scholar:hover{background:linear-gradient(135deg,#203050 0%,#264068 100%);color:#90dcff;border-color:rgba(140,220,255,.6)}

.btn.btn-save{background:linear-gradient(135deg,#2a2000 0%,#3a2e00 100%);color:#f7d06a;border:1px solid rgba(247,208,106,.35)}
.btn.btn-save:hover{background:linear-gradient(135deg,#3a2e00 0%,#4e3e00 100%);color:#ffe090;border-color:rgba(247,208,106,.6)}

.btn.btn-print{background:linear-gradient(135deg,#2e0a0a 0%,#420e0e 100%);color:#f77a7a;border:1px solid rgba(247,122,122,.35)}
.btn.btn-print:hover{background:linear-gradient(135deg,#400e0e 0%,#581414 100%);color:#ffaaaa;border-color:rgba(247,160,160,.6)}

[data-theme=light] .btn.btn-tmpl{background:linear-gradient(135deg,#ede8ff 0%,#ddd4ff 100%);color:#5a30c0;border:1px solid rgba(90,48,192,.3)}
[data-theme=light] .btn.btn-research{background:linear-gradient(135deg,#e0fff0 0%,#c8f5e0 100%);color:#1a7040;border:1px solid rgba(26,112,64,.3)}
[data-theme=light] .btn.btn-ref{background:linear-gradient(135deg,#f5e8ff 0%,#ead4ff 100%);color:#8020c0;border:1px solid rgba(128,32,192,.3)}
[data-theme=light] .btn.btn-scholar{background:linear-gradient(135deg,#e0f2ff 0%,#c8e8ff 100%);color:#1060a0;border:1px solid rgba(16,96,160,.3)}
[data-theme=light] .btn.btn-save{background:linear-gradient(135deg,#fff8e0 0%,#ffeebc 100%);color:#906000;border:1px solid rgba(144,96,0,.3)}
[data-theme=light] .btn.btn-print{background:linear-gradient(135deg,#ffe8e8 0%,#ffd0d0 100%);color:#c02020;border:1px solid rgba(192,32,32,.3)}
[data-theme=light] .tb.tb-view{color:#1878b0;border-color:rgba(24,120,176,.3)}
[data-theme=light] .tb.tb-view.active{background:rgba(24,120,176,.12);color:#1060a0;border-color:#1878b0}
[data-theme=light] .tb.tb-pv{color:#a07010}
[data-theme=light] .tb.tb-sys{color:#5050a0}
[data-theme=light] .tb.tb-copy-rich{color:#1a7040;border-color:rgba(26,112,64,.35)}
[data-theme=light] .tb.tb-copy-text{color:#5050a0;border-color:rgba(80,80,160,.3)}

/* â”€â”€ pv-hdr ë¼ì´íŠ¸ í…Œë§ˆ â”€â”€ */
[data-theme=light] #pv-hdr{background:linear-gradient(90deg,#eeebff 0%,#f0eeff 100%);border-bottom:1px solid #d0c8f0}
[data-theme=light] #pv-hdr .pane-lbl{color:#5040b0}
[data-theme=light] #pv-hdr #pg-cnt{color:#1878b0}
[data-theme=light] #pv-hdr #render-ts{color:#1a7040}
[data-theme=light] #pv-dark-btn{color:#3060c0!important;border-color:rgba(48,96,192,.35)!important}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%;overflow:hidden;font-family:var(--fb);background:var(--bg);color:var(--tx);font-size:14px;line-height:1.5;-webkit-font-smoothing:antialiased}
/* layout */
#app{display:grid;grid-template-rows:36px 44px 1fr 26px;grid-template-columns:var(--sw) 1fr;height:100vh;grid-template-areas:"tb tb""bar bar""side main""stat stat"}
#app.ns{grid-template-columns:0 1fr}
#app.ns #sidebar{display:none}
/* titlebar */
#titlebar{grid-area:tb;display:flex;align-items:center;background:#1a1a24;border-bottom:1px solid #2e2e40;height:36px;padding:0 10px;z-index:100;gap:5px}
#app-logo{display:flex;align-items:center;gap:7px;font-family:var(--fm);font-size:11px;font-weight:600;color:var(--ac);letter-spacing:.05em;flex-shrink:0}
.logo-icon{width:20px;height:20px;background:var(--ac);border-radius:4px;display:flex;align-items:center;justify-content:center;font-size:11px;color:#fff;font-weight:700}
#doc-title{flex:1;text-align:center;background:none;border:none;color:#9090b0;font-family:var(--fb);font-size:13px;outline:none;cursor:pointer;transition:color var(--tr)}
#doc-title:hover,#doc-title:focus{color:#e8e8f0;cursor:text}
#tba{display:flex;align-items:center;gap:4px;flex-shrink:0}
/* toolbar */
#toolbar{grid-area:bar;display:flex;align-items:center;background:#222230;border-bottom:1px solid #2e2e42;padding:0 6px;overflow-x:auto;scrollbar-width:none;user-select:none}
#toolbar::-webkit-scrollbar{display:none}
.tg{display:flex;align-items:center;gap:1px;flex-shrink:0}
.ts{width:1px;height:18px;background:#3a3a50;margin:0 4px;flex-shrink:0}
.tb{display:flex;align-items:center;justify-content:center;min-width:26px;height:26px;padding:0 5px;border:none;background:transparent;color:#9090b0;border-radius:var(--r);cursor:pointer;font-size:11px;font-family:var(--fb);font-weight:500;transition:all var(--tr);white-space:nowrap;position:relative}
.tb:hover{background:#2e2e42;color:#e8e8f0}.tb.active{background:var(--acg);color:var(--ac)}
.tbsel{background:#2a2a3a;border:1px solid #3a3a50;border-radius:var(--r);color:#9090b0;font-size:11px;padding:2px 4px;outline:none;cursor:pointer;font-family:var(--fb);height:26px}
/* sidebar */
#sidebar{grid-area:side;background:var(--bg2);border-right:1px solid var(--bd);display:flex;flex-direction:column;overflow:hidden}
#sb-hdr{padding:8px 12px;font-size:10px;font-weight:600;letter-spacing:.1em;color:var(--tx3);text-transform:uppercase;border-bottom:1px solid var(--bd);display:flex;align-items:center;justify-content:space-between}
#toc-list{flex:1;overflow-y:auto;padding:4px 0;scrollbar-width:thin;scrollbar-color:var(--bd) transparent}
.toc-item{display:flex;align-items:center;gap:6px;padding:3px 12px;cursor:pointer;color:var(--tx2);font-size:12px;line-height:1.4;transition:all var(--tr);border-left:2px solid transparent}
.toc-item:hover{color:var(--tx);background:var(--bg3)}.toc-item.active{color:var(--ac);border-left-color:var(--ac);background:var(--acg)}
.toc-item[data-level="2"]{padding-left:22px}.toc-item[data-level="3"]{padding-left:34px;font-size:11px}
.toc-num{font-family:var(--fm);font-size:10px;color:var(--tx3);flex-shrink:0}
#sb-stats{padding:6px 12px;border-top:1px solid var(--bd);font-size:11px;color:var(--tx3);display:flex;flex-direction:column;gap:2px}
/* main */
#main{grid-area:main;display:flex;flex-direction:column;overflow:hidden}
#find-bar{display:none;align-items:center;gap:6px;padding:4px 10px;background:var(--bg2);border-bottom:1px solid var(--bd);flex-shrink:0}
#find-bar.vis{display:flex}
#find-bar input{background:var(--bg3);border:1px solid var(--bd);border-radius:4px;color:var(--tx);padding:3px 7px;font-size:12px;font-family:var(--fb);outline:none;width:140px}
#find-bar input:focus{border-color:var(--ac)}
#editor-wrap{flex:1;display:flex;overflow:hidden;position:relative}
/* editor pane */
#editor-pane{flex:1;display:flex;flex-direction:column;overflow:hidden;border-right:1px solid var(--bd)}
#editor-pane.hidden{display:none}
#ed-hdr{display:flex;align-items:center;padding:3px 8px;background:var(--bg2);border-bottom:1px solid var(--bd);gap:6px;height:30px;flex-shrink:0}
.pane-lbl{font-size:10px;font-weight:600;letter-spacing:.08em;text-transform:uppercase;color:var(--tx3)}
.pane-lbl span{width:6px;height:6px;border-radius:50%;background:var(--ac);display:inline-block;margin-right:5px}
#ed-container{flex:1;position:relative;overflow:hidden}
#line-numbers{position:absolute;left:0;top:0;bottom:0;width:42px;background:var(--bg2);border-right:1px solid var(--bd);overflow:hidden;pointer-events:none;display:none;z-index:1}
#line-numbers.vis{display:block}
.lnc{padding-top:12px;display:flex;flex-direction:column;align-items:flex-end;padding-right:8px}
.ln{font-family:var(--fm);font-size:11px;color:var(--tx3);line-height:21px;height:21px}
#editor{width:100%;height:100%;background:var(--bg3);color:var(--tx);border:none;outline:none;resize:none;font-family:var(--fm);font-size:13.5px;line-height:21px;padding:12px 14px;tab-size:2;word-wrap:break-word;overflow-y:auto;overflow-x:hidden;scrollbar-width:thin;scrollbar-color:var(--bd) transparent}
#editor.wln{padding-left:58px}
#editor::placeholder{color:var(--tx3)}
/* preview pane */
#preview-pane{flex:1;display:flex;flex-direction:column;overflow:hidden}
#preview-pane.hidden{display:none}
#pv-hdr{display:flex;align-items:center;padding:3px 8px;background:linear-gradient(90deg,#1a1a28 0%,#1e1e2e 100%);border-bottom:1px solid #3a3a58;gap:6px;height:30px;flex-shrink:0}
#pv-hdr .pane-lbl{color:#a090f0;letter-spacing:.1em;font-size:10px}
#pv-hdr .pane-lbl span{background:#f7a06a!important}
#pv-hdr #pg-cnt{color:#6acff7;font-weight:600;font-family:var(--fm);font-size:10px}
#pv-hdr #render-ts{color:#6af7a0;font-family:var(--fm);font-size:10px;opacity:.8}
#preview-container{flex:1;overflow-y:auto;overflow-x:hidden;background:#6a6e7e;display:flex;flex-direction:column;align-items:center;padding:16px 0 36px;scrollbar-width:thin;scrollbar-color:#444 transparent;position:relative}
/* A4 page cards */
.preview-page{width:210mm;min-height:297mm;background:white;color:#1a1a2e;padding:22mm 18mm;box-shadow:0 6px 40px rgba(0,0,0,.5);font-family:var(--fs);font-size:11pt;line-height:1.8;word-break:break-word;position:relative;flex-shrink:0;margin-bottom:16px}
.preview-page::after{content:"â€” " attr(data-page) " â€”";position:absolute;bottom:10mm;left:50%;transform:translateX(-50%);font-family:sans-serif;font-size:9pt;color:#bbb;white-space:nowrap}
.preview-page h1{font-size:21pt;font-weight:700;margin:0 0 14px;border-bottom:2.5px solid #1a1a2e;padding-bottom:8px}
.preview-page h2{font-size:15pt;font-weight:700;margin:20px 0 10px}
.preview-page h3{font-size:12pt;font-weight:700;margin:16px 0 7px;color:#2a2a3e}
.preview-page h4{font-size:11pt;font-weight:700;margin:14px 0 5px}
.preview-page p{margin:0 0 11px}
.preview-page ul,.preview-page ol{margin:0 0 11px;padding-left:22px}
.preview-page li{margin-bottom:3px}
.preview-page blockquote{border-left:3px solid #5b4ce4;margin:14px 0;padding:7px 14px;background:#f5f5ff;color:#3a3a5e;font-style:italic}
.preview-page code{font-family:'JetBrains Mono',monospace;font-size:9pt;background:#f0f0f8;padding:1px 4px;border-radius:3px;color:#5b4ce4}
.preview-page pre{background:#1a1a2e;color:#e8e8f0;padding:14px;border-radius:6px;overflow-x:auto;margin:11px 0;font-size:9pt}
.preview-page pre code{background:none;color:inherit;padding:0}
.preview-page table{width:100%;border-collapse:collapse;margin:11px 0;font-size:inherit}
.preview-page th{background:#1a1a2e;color:#fff;padding:7px 11px;text-align:left;font-weight:600}
.preview-page td{padding:6px 11px;border:1px solid #d0d0e0}
.preview-page tr:nth-child(even) td{background:#f7f7fc}
.preview-page img{max-width:100%}
.preview-page a{color:#5b4ce4;text-decoration:underline;text-underline-offset:2px}
.preview-page a[href^="http"]::after{content:" â†—";font-size:8pt;opacity:.5}
.preview-page .ref-block{border-top:1px solid #d0d0e0;margin-top:28px;padding-top:10px;font-size:9pt;color:#4a4a6a}
.preview-page .tbl-caption{font-size:10pt;font-weight:600;color:#1a1a2e;margin-bottom:5px;display:block}
.preview-page .fig-caption{font-size:10pt;color:#4a4a6a;margin-top:5px;font-style:italic;display:block;text-align:center}
/* RESEARCH MODE: ë³¸ë¬¸ ë‹¨ë½(p)ì—ë§Œ í–‰ ë²ˆí˜¸ â€” JSë¡œ ì‚½ì… */
.preview-page.rm p{
  padding-left:42px;
  position:relative;
}
.rm-ln{
  position:absolute;
  left:0;
  top:0;
  width:34px;
  text-align:right;
  font-family:'JetBrains Mono',monospace;
  font-size:8pt;
  line-height:inherit;
  color:#a0a0c8;
  user-select:none;
  pointer-events:none;
  border-right:1px solid #ddd;
  padding-right:5px;
  /* ë²ˆí˜¸ê°€ ê¸´ ë‹¨ë½ì—ì„œ ì²« ì¤„ì—ë§Œ í‘œì‹œ */
  height:1.8em;
  overflow:hidden;
}
/* â”€â”€ ë¯¸ë¦¬ë³´ê¸° í™•ëŒ€/ì¶•ì†Œ â”€â”€ */
#preview-container.zoomed .preview-page{
  transform-origin:top center;
  /* zoomì€ JSë¡œ --pv-scale ë³€ìˆ˜ ì ìš© */
  transform:scale(var(--pv-scale,1));
  margin-bottom:calc(16px + (var(--pv-scale,1) - 1) * 297mm);
}
/* â”€â”€ ë¯¸ë¦¬ë³´ê¸° ë‹¤í¬ í…Œë§ˆ â”€â”€ */
#preview-container.pv-dark{background:#0d0d1a}
#preview-container.pv-dark .preview-page{background:#1a1a2e;color:#e0e0f0}
#preview-container.pv-dark .preview-page h1,
#preview-container.pv-dark .preview-page h2,
#preview-container.pv-dark .preview-page h3,
#preview-container.pv-dark .preview-page h4{color:#a8b8ff}
#preview-container.pv-dark .preview-page a{color:#6acff7}
#preview-container.pv-dark .preview-page code{background:#252538;color:#f7a06a}
#preview-container.pv-dark .preview-page pre{background:#1e1e30;border:1px solid #3a3a5a}
#preview-container.pv-dark .preview-page blockquote{border-left-color:#5b4ce4;color:#b0b0c8;background:#20203a}
#preview-container.pv-dark .preview-page table{color:#e0e0f0}
#preview-container.pv-dark .preview-page table th{background:#252540;color:#c8c8f0}
#preview-container.pv-dark .preview-page table td{border-color:#3a3a58;color:#e0e0f0}
#preview-container.pv-dark .preview-page table tr:nth-child(even) td{background:#20203a}
#preview-container.pv-dark .preview-page table *{color:#e0e0f0}
#preview-container.pv-dark .preview-page table th *{color:#c8c8f0}
#preview-container.pv-dark .preview-page .tbl-caption{color:#c8c8f0}
#preview-container.pv-dark .preview-page .fig-caption{color:#9090b8}
#preview-container.pv-dark .preview-page span[style*="color"]{color:#e0e0f0!important}
#preview-container.pv-dark .preview-page p,
#preview-container.pv-dark .preview-page li,
#preview-container.pv-dark .preview-page td,
#preview-container.pv-dark .preview-page span{color:inherit}
#preview-container.pv-dark .preview-page::after{color:#555}
/* â”€â”€ PPT ëª¨ë“œ (ë‚´ë¶€) â”€â”€ */
#preview-pane.ppt-mode{
  background:#111;
  position:relative;
}
/* PPT ëª¨ë“œì—ì„œ pv-hdr(íˆ´ë°”)ëŠ” í•­ìƒ ìœ„ì— í‘œì‹œ */
#preview-pane.ppt-mode #pv-hdr{
  position:relative;
  z-index:300;
  background:#1a1a2e;
  border-bottom:1px solid #f0c06044;
  flex-shrink:0;
}
#preview-pane.ppt-mode #preview-container{
  background:#111;
  padding:0;
  scroll-snap-type:y mandatory;
  align-items:center;
  flex:1;
  overflow-y:auto;
}
#preview-pane.ppt-mode .preview-page{
  scroll-snap-align:start;
  transform-origin:top center;
  box-shadow:none;
  margin-bottom:0;
  border:none;
}
/* PPT ë„¤ë¹„ ì˜¤ë²„ë ˆì´ */
#ppt-nav{
  display:none;
  position:absolute;
  bottom:18px;
  left:50%;
  transform:translateX(-50%);
  z-index:400;
  background:rgba(0,0,0,.80);
  border:1px solid rgba(255,255,255,.3);
  border-radius:24px;
  padding:4px 10px;
  gap:6px;
  align-items:center;
  backdrop-filter:blur(6px);
  pointer-events:all;
}
#ppt-nav.vis{display:flex}
#ppt-nav button{background:none;border:none;color:#fff;cursor:pointer;font-size:18px;padding:2px 8px;border-radius:12px;transition:background .15s;line-height:1}
#ppt-nav button:hover{background:rgba(255,255,255,.15)}
#ppt-nav #ppt-pg{font-family:var(--fm);font-size:11px;color:rgba(255,255,255,.7);min-width:40px;text-align:center}
#preview-pane{position:relative}          /* ì˜¤ë²„ë ˆì´ ê¸°ì¤€ì  */
#a4-overlay{
  position:absolute;
  left:0;top:30px;           /* pv-hdr ë†’ì´(30px) ì•„ë˜ë¶€í„° */
  right:0;bottom:0;
  pointer-events:none;
  z-index:50;
  overflow:hidden;
  display:none;
}
#a4-overlay.vis{display:block}
/* ê°œë³„ ê¸°ì¤€ì„  */
.a4-rl{
  position:absolute;
  left:0;right:0;
  height:2px;
  background: repeating-linear-gradient(
    to right,
    rgba(220,35,35,.85) 0,
    rgba(220,35,35,.85) 6px,
    transparent 6px,
    transparent 12px
  );
  pointer-events:none;
}
.a4-rl-label{
  position:absolute;
  right:6px;
  top:-15px;
  font-size:9px;
  font-family:monospace;
  color:rgba(220,35,35,.9);
  background:rgba(255,255,255,.92);
  border:1px solid rgba(220,35,35,.3);
  padding:0 5px;
  border-radius:3px;
  pointer-events:none;
  user-select:none;
  white-space:nowrap;
}
/* A4 ë²„íŠ¼ */
.tb.tb-a4{font-size:10px;padding:0 7px;height:22px;color:#f06060;border:1px solid rgba(240,96,96,.35);border-radius:4px;font-weight:600;letter-spacing:.03em}
.tb.tb-a4:hover{color:#ff8888;background:rgba(240,96,96,.15);border-color:rgba(240,96,96,.6)}
.tb.tb-a4.active{color:#fff;background:rgba(210,35,35,.8);border-color:#cc2222;box-shadow:0 0 8px rgba(220,40,40,.5)}
[data-theme=light] .tb.tb-a4{color:#c02020;border-color:rgba(192,32,32,.35)}
[data-theme=light] .tb.tb-a4.active{color:#fff;background:#c02020;border-color:#a01010}
/* â”€â”€ Light theme: structural elements â”€â”€ */
[data-theme=light] #toolbar{background:#f0eef8;border-bottom:1px solid #d0c8f0}
[data-theme=light] #hdr,
[data-theme=light] #hdr2{background:linear-gradient(90deg,#eeebff 0%,#f4f0ff 100%);border-bottom:1px solid #d0c8f0}
[data-theme=light] #hdr{color:#2a1a80}
[data-theme=light] #hdr input,
[data-theme=light] #hdr .btn-title{color:#2a1a80;background:transparent}
[data-theme=light] #sidebar{background:#f7f5ff;border-right:1px solid #d0c8f0}
[data-theme=light] #sb-hdr{background:#f0eef8;border-bottom:1px solid #d0c8f0}
[data-theme=light] #sb-hdr *{color:#5040b0}
[data-theme=light] #sb-list a{color:#3a2a90}
[data-theme=light] #sb-list a:hover{background:rgba(124,106,247,.12)}
[data-theme=light] #editor-pane{background:#fdfcff}
[data-theme=light] #editor{background:#fdfcff;color:#1a1a30;caret-color:#5040b0}
[data-theme=light] #editor::selection{background:rgba(124,106,247,.25)}
[data-theme=light] #ln-col{background:#f0eef8;border-right:1px solid #d8d4f0;color:#9090b8}
[data-theme=light] .status-bar,
[data-theme=light] #cursor-info,
[data-theme=light] .cursor-stat{color:#5050a0;background:#f0eef8;border-top:1px solid #d0c8f0}
[data-theme=light] .modal-box,
[data-theme=light] .modal{background:#fdfcff;border-color:#c0b8e8}
[data-theme=light] .modal-hdr{background:#f0eef8;border-bottom:1px solid #d0c8f0;color:#2a1a80}display:flex;align-items:center;padding:0 12px;background:var(--acd);color:rgba(255,255,255,.85);font-size:11px;gap:12px;font-family:var(--fm);overflow:hidden}
.si{white-space:nowrap;flex-shrink:0}.ss{color:rgba(255,255,255,.3);flex-shrink:0}.ssp{flex:1}
#autosave-indicator{display:flex;align-items:center;gap:4px}
.save-dot{width:6px;height:6px;border-radius:50%;background:var(--ok)}
.save-dot.saving{animation:pulse .8s ease infinite;background:var(--wn)}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}
#error-count{color:var(--er);cursor:pointer}
/* buttons */
.btn{display:inline-flex;align-items:center;gap:4px;padding:5px 11px;border:none;border-radius:var(--r);cursor:pointer;font-family:var(--fb);font-size:12px;font-weight:500;transition:all var(--tr)}
.btn-p{background:var(--ac);color:#fff}.btn-p:hover{background:var(--acd)}
.btn-g{background:transparent;border:1px solid var(--bd);color:var(--tx2)}.btn-g:hover{border-color:var(--bda);color:var(--tx);background:var(--bg5)}
.btn-sm{padding:3px 8px;font-size:11px}
.btn-ic{background:transparent;border:none;color:var(--tx2);cursor:pointer;padding:4px;border-radius:var(--r);transition:all var(--tr);display:flex;align-items:center;justify-content:center;font-size:13px}.btn-ic:hover{color:var(--tx);background:var(--bg5)}
.btn-tog{background:var(--bg3);border:1px solid var(--bd);color:var(--tx2)}.btn-tog.active{background:var(--acg);border-color:var(--ac);color:var(--ac)}
/* tooltip */
#tooltip{position:fixed;z-index:9999;background:#1a1a2e;color:#e8e8f0;padding:5px 9px;border-radius:5px;font-family:var(--fb);font-size:11px;pointer-events:none;opacity:0;transition:opacity .15s;max-width:260px;box-shadow:0 4px 16px rgba(0,0,0,.4);border:1px solid #2e2e42;line-height:1.4}
#tooltip.vis{opacity:1}
.tt-key{display:inline-block;background:#2e2e42;border-radius:3px;padding:0 4px;font-family:var(--fm);font-size:10px;color:#a0a0c0;margin-left:4px}
/* overlays & modals */
.ov{position:fixed;inset:0;z-index:8000;background:rgba(0,0,0,.55);backdrop-filter:blur(3px);display:none;align-items:center;justify-content:center}
.ov.vis{display:flex}
.modal{background:var(--bg2);border:1px solid var(--bd);border-radius:10px;padding:22px;min-width:340px;max-width:560px;width:90vw;box-shadow:var(--sh);max-height:90vh;overflow-y:auto}
.modal.lg{max-width:780px}.modal.xl{max-width:940px}
.modal h3{font-size:15px;font-weight:600;margin-bottom:14px;color:var(--txh)}
.mb{margin-bottom:16px}.mf{display:flex;gap:8px;justify-content:flex-end;margin-top:14px}
.fg{margin-bottom:10px}
.fl{display:block;font-size:11px;color:var(--tx2);margin-bottom:3px;font-weight:500}
.fi{width:100%;background:var(--bg3);border:1px solid var(--bd);border-radius:var(--r);color:var(--tx);padding:7px 10px;font-family:var(--fb);font-size:13px;outline:none;transition:border-color var(--tr)}
.fi:focus{border-color:var(--ac)}
select.fi option{background:var(--bg2)}
textarea.fi{resize:vertical;min-height:70px;font-family:var(--fm);font-size:12px;line-height:1.6}
/* tabs */
.tab-row{display:flex;border-bottom:1px solid var(--bd);margin-bottom:14px}
.tab{padding:6px 13px;font-size:12px;font-weight:500;color:var(--tx3);cursor:pointer;border-bottom:2px solid transparent;transition:all var(--tr);white-space:nowrap}
.tab.active{color:var(--ac);border-bottom-color:var(--ac)}
.tp{display:none}.tp.active{display:block}
/* cite */
#cite-list-area{min-height:60px;max-height:210px;overflow-y:auto;border:1px solid var(--bd);border-radius:var(--r);background:var(--bg3);margin-bottom:10px}
.cite-entry{display:flex;align-items:flex-start;gap:8px;padding:7px 11px;border-bottom:1px solid var(--bd);cursor:pointer;transition:background var(--tr)}
.cite-entry:last-child{border-bottom:none}
.cite-entry:hover{background:var(--bg5)}
.cite-entry input[type=checkbox]{margin-top:3px;accent-color:var(--ac);flex-shrink:0}
.cite-body{flex:1;min-width:0}
.cite-key{font-family:var(--fm);font-size:11px;color:var(--ac);font-weight:600;margin-bottom:2px}
.cite-full{font-size:11px;color:var(--tx2);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.cite-empty{padding:18px;text-align:center;color:var(--tx3);font-size:12px}
#lib-list{min-height:50px;max-height:280px;overflow-y:auto;border:1px solid var(--bd);border-radius:var(--r);background:var(--bg3)}
.lib-item{display:flex;align-items:center;padding:5px 10px;border-bottom:1px solid var(--bd);font-size:11px;gap:6px}
.lib-item:last-child{border-bottom:none}
.lib-key{font-family:var(--fm);font-size:10px;color:var(--ac);font-weight:600;flex-shrink:0;min-width:90px}
/* error panel */
#error-panel{position:absolute;bottom:0;left:0;right:0;background:var(--bg2);border-top:1px solid var(--bd);max-height:100px;overflow-y:auto;z-index:50;display:none}
#error-panel.vis{display:block}
#ep-hdr{display:flex;align-items:center;justify-content:space-between;padding:4px 12px;font-size:11px;font-weight:600;color:var(--er);border-bottom:1px solid var(--bd)}
.error-item{padding:3px 12px;font-size:11px;font-family:var(--fm);color:var(--tx2);border-bottom:1px solid var(--bd)}
/* hotkey overlay */
#hk-overlay{position:fixed;inset:0;z-index:10000;background:rgba(0,0,0,.7);backdrop-filter:blur(4px);display:none;align-items:center;justify-content:center}
#hk-overlay.vis{display:flex}
#hk-panel{background:var(--bg2);border:1px solid var(--bd);border-radius:12px;padding:22px;max-width:700px;width:92vw;max-height:82vh;overflow-y:auto;box-shadow:0 24px 80px rgba(0,0,0,.5)}
#hk-panel h2{font-size:15px;font-weight:600;color:var(--txh);margin-bottom:16px;display:flex;align-items:center;justify-content:space-between}
.hk-s{font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:.1em;color:var(--ac);margin:12px 0 6px}
.hk-grid{display:grid;grid-template-columns:1fr 1fr;gap:3px}
.hk-item{display:flex;align-items:center;justify-content:space-between;padding:4px 8px;border-radius:4px;background:var(--bg3)}
.hk-desc{font-size:11px;color:var(--tx2)}.hk-keys{display:flex;gap:2px;flex-shrink:0}
kbd{background:var(--bg5);border:1px solid var(--bd);border-radius:3px;padding:1px 5px;font-family:var(--fm);font-size:9px;color:var(--tx)}
/* color swatches */
.csw-row{display:flex;gap:4px;flex-wrap:wrap;margin-top:4px}
.csw{width:22px;height:22px;border-radius:3px;cursor:pointer;border:2px solid transparent;transition:border-color .1s}
.csw:hover,.csw.sel{border-color:white}
/* template grid */
.tmpl-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.tmpl-card{border:1px solid var(--bd);border-radius:8px;padding:12px;cursor:pointer;transition:all var(--tr);background:var(--bg3)}
.tmpl-card:hover{border-color:var(--ac);background:var(--acg)}
.tmpl-card h4{font-size:13px;font-weight:600;color:var(--txh);margin-bottom:4px}
.tmpl-card p{font-size:11px;color:var(--tx2);line-height:1.4}
/* rm badge */
#rm-badge{background:var(--acd);color:rgba(255,255,255,.9);font-size:10px;font-weight:600;padding:2px 7px;border-radius:3px;display:none}
#rm-badge.vis{display:inline-block}
#vm-sel{background:var(--bg3);border:1px solid var(--bd);border-radius:var(--r);color:var(--tx2);font-size:11px;padding:2px 6px;outline:none;cursor:pointer;font-family:var(--fb)}
#pw-btn{position:relative}
#pw-btn::after{content:'';position:absolute;top:3px;right:3px;width:5px;height:5px;border-radius:50%;background:var(--ok);display:none}
#pw-btn.open::after{display:block}
.spacer{flex:1}
/* caption opts */
.cap-opt{padding:4px 10px;border:1px solid var(--bd);border-radius:var(--r);font-size:12px;cursor:pointer;background:var(--bg3);color:var(--tx2);transition:all var(--tr)}
.cap-opt.sel{border-color:var(--ac);background:var(--acg);color:var(--ac)}
/* font size stepper â€” inline input mode */
#fsize-input{display:none;width:50px;text-align:center;font-family:var(--fm);font-size:12px;font-weight:600;color:#e8e8f0;background:#2a2a3a;border:1px solid var(--ac);border-radius:3px;outline:none;padding:0 4px;height:22px}
#fsize-input.vis{display:block}
#fsize-display.edit-mode{display:none}
/* format quick panel */
#fmt-panel{position:fixed;z-index:9000;background:var(--bg2);border:1px solid var(--bd);border-radius:10px;padding:16px;box-shadow:0 8px 40px rgba(0,0,0,.5);min-width:300px;display:none}
#fmt-panel.vis{display:block}
#fmt-panel h4{font-size:12px;font-weight:600;color:var(--tx3);text-transform:uppercase;letter-spacing:.08em;margin-bottom:10px}
.fmt-row{display:flex;align-items:center;gap:8px;margin-bottom:10px}
.fmt-lbl{font-size:11px;color:var(--tx2);width:56px;flex-shrink:0}
/* stats type buttons */
#stats-type-row .btn-tog{font-size:11px;padding:3px 8px}
/* view mode buttons â€” tb-view í´ë˜ìŠ¤ë¡œ ì´ë™ë¨ */

/* â”€â”€ íˆ´ë°” ê·¸ë£¹ë³„ ìƒ‰ìƒ í…Œë§ˆ â”€â”€ */
/* ğŸŸ¡ í—¤ë”© â€” ì§„í•œ ë…¸ë€ìƒ‰ */
.tb.tb-heading{color:#d4a017}
.tb.tb-heading:hover{color:#f5c842;background:rgba(212,160,23,.15)}
.tb.tb-heading.active{background:rgba(212,160,23,.2);color:#f5c842}

/* ğŸŸ  í…ìŠ¤íŠ¸ ì„œì‹ â€” ì˜¤ë Œì§€ */
.tb.tb-fmt{color:#e07a30}
.tb.tb-fmt:hover{color:#f7a06a;background:rgba(224,122,48,.15)}
.tb.tb-fmt.active{background:rgba(224,122,48,.2);color:#f7a06a}

/* ğŸŸ¢ ë ˆì´ì•„ì›ƒ(ì •ë ¬Â·ëª©ë¡) â€” ì–´ë‘ìš´ í˜•ê´‘ ì´ˆë¡ */
.tb.tb-layout{color:#3dba6e}
.tb.tb-layout:hover{color:#6af7a0;background:rgba(61,186,110,.15)}
.tb.tb-layout.active{background:rgba(61,186,110,.2);color:#6af7a0}

/* ğŸ”µ í‘œ â€” ë°ì€ í•˜ëŠ˜ìƒ‰ */
.tb.tb-table{color:#3a9fd4}
.tb.tb-table:hover{color:#6acff7;background:rgba(58,159,212,.15)}
.tb.tb-table.active{background:rgba(58,159,212,.2);color:#6acff7}

/* âœ¦ Tidy â€” ì²­ë¡ í˜•ê´‘ */
.tb.tb-table-tidy{color:#00d4aa;font-weight:600}
.tb.tb-table-tidy:hover{color:#00ffcc;background:rgba(0,212,170,.15)}

/* ğŸ’» ì½”ë“œ â€” ì—°ë³´ë¼ */
.tb.tb-code{color:#a07af7}
.tb.tb-code:hover{color:#c4aeff;background:rgba(160,122,247,.15)}
.tb.tb-code.active{background:rgba(160,122,247,.2);color:#c4aeff}

/* ğŸ”´ ì‚½ì…Â·íŠ¹ìˆ˜ â€” ë¶„í™/ì—°ìí™ */
.tb.tb-insert{color:#d45a8a}
.tb.tb-insert:hover{color:#f77ab0;background:rgba(212,90,138,.15)}
.tb.tb-insert.active{background:rgba(212,90,138,.2);color:#f77ab0}

/* ğŸ” ìœ í‹¸ â€” ì—°í•œ ì‹œì•ˆ */
.tb.tb-util{color:#5ac8d4}
.tb.tb-util:hover{color:#8aecf7;background:rgba(90,200,212,.15)}
/* footnote highlight in editor via preview */
.preview-page .footnote-highlight{background:#f0f0f0;color:#1a1a2e;border-radius:2px;padding:0 2px}

/* â”€â”€ HK í¸ì§‘ ëª¨ë“œ â”€â”€ */
.hk-item-edit{display:flex;align-items:center;gap:6px;padding:3px 6px;border-radius:4px;background:var(--bg3);border:1px solid transparent;transition:border-color .15s}
.hk-item-edit:hover{border-color:var(--bd)}
.hk-editable{background:none;border:none;outline:none;font-family:var(--fb);color:var(--tx);cursor:text;padding:2px 4px;border-radius:3px;transition:background .15s}
.hk-editable:focus{background:var(--bg5);outline:1px solid var(--ac)}
.hk-editable.desc{flex:1;font-size:11px}
.hk-editable.keys{font-size:11px;font-family:var(--fm);color:var(--ac);min-width:80px;text-align:right}
.hk-del-btn{background:none;border:none;color:var(--tx3);cursor:pointer;padding:2px 4px;border-radius:3px;font-size:12px;line-height:1;transition:color .15s;flex-shrink:0}
.hk-del-btn:hover{color:var(--er);background:rgba(247,106,106,.12)}
#hk-edit-actions{margin-top:12px;display:flex;gap:6px;justify-content:flex-end}
#hk-panel h2{font-size:15px;font-weight:600;margin-bottom:12px;color:var(--txh);display:flex;align-items:center;justify-content:space-between}
.preview-page .footnote-def{background:#f5f5f5;color:#1a1a2e;border-left:3px solid #bbb;padding:4px 10px;margin:4px 0;font-size:9.5pt}
.preview-page .footnotes-section{border-top:1px solid #d0d0e0;margin-top:24px;padding-top:10px;font-size:9.5pt;color:#444}
/* editor footnote syntax highlight */
#editor{caret-color:var(--ac)}
/* search result cards */
.ref-card{padding:9px 12px;border-bottom:1px solid var(--bd);transition:background var(--tr)}
.ref-card:last-child{border-bottom:none}
.ref-card:hover{background:var(--bg5)}
.ref-card-title{font-size:12px;font-weight:600;color:var(--txh);margin-bottom:3px;line-height:1.4}
.ref-card-meta{font-size:10px;color:var(--tx3);margin-bottom:5px;line-height:1.5}
.ref-card-apa{font-size:10px;color:var(--tx2);font-family:var(--fm);background:var(--bg4);border-radius:3px;padding:4px 8px;margin-bottom:5px;line-height:1.6;word-break:break-word;cursor:text;user-select:all}
.ref-card-btns{display:flex;gap:5px;flex-wrap:wrap;align-items:center}
.ref-tag{font-size:9px;padding:1px 5px;border-radius:3px;background:var(--bg5);color:var(--tx3);border:1px solid var(--bd)}
::-webkit-scrollbar{width:5px;height:5px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--bd);border-radius:3px}
::-webkit-scrollbar-thumb:hover{background:var(--bda)}
@media print{
  #app{display:block;height:auto}
  #titlebar,#toolbar,#sidebar,#statusbar,#editor-pane{display:none!important}
  #main{display:block}#preview-pane{display:block!important}
  #preview-container{background:white;padding:0;display:block}
  .preview-page{box-shadow:none;margin:0;page-break-after:always;width:100%;min-height:0}
  .preview-page:last-child{page-break-after:auto}
  .preview-page::after{display:none}
}
</style>
</head>
<body>
<div id="app">

<!-- TITLEBAR -->
<header id="titlebar">
  <div id="app-logo"><div class="logo-icon">M</div>MD PRO V20</div>
  <input id="doc-title" type="text" value="Untitled Document" spellcheck="false">
  <div id="tba">
    <span id="rm-badge">RESEARCH</span>
    <button class="btn btn-sm btn-tmpl" onclick="App.showTmpl()" data-tooltip="ë…¼ë¬¸ ì–‘ì‹ ì„ íƒ">ğŸ“‹ ì–‘ì‹</button>
    <button class="btn btn-sm btn-research" onclick="App.toggleRM()" data-tooltip="Research Mode (ë‹¨ë½ ì¤„ë²ˆí˜¸)" data-key="Ctrl+Shift+R">ğŸ”¬ Research</button>
    <button class="btn btn-sm btn-ref" onclick="App.showCite()" data-tooltip="ì°¸ê³ ë¬¸í—Œ ê´€ë¦¬ & ì¸ìš©" data-key="Ctrl+Shift+C">ğŸ“š References</button>
    <button class="btn btn-sm btn-scholar" onclick="Scholar.show()" data-tooltip="Google Scholar ê²€ìƒ‰ (ìƒˆ ì°½)" data-key="Ctrl+Shift+G">ğŸ” Scholar</button>
    <button class="btn btn-sm btn-save" onclick="App.showSaveDlg()" data-tooltip="ì €ì¥ í˜•ì‹ ì„ íƒ" data-key="Ctrl+S">ğŸ’¾ ì €ì¥</button>
    <button class="btn btn-sm btn-print" onclick="App.printDoc()" data-tooltip="ì¸ì‡„ / PDF ì €ì¥">ğŸ–¨ï¸ ì¸ì‡„</button>
  </div>
</header>

<!-- TOOLBAR -->
<div id="toolbar">
  <!-- â˜° ì‚¬ì´ë“œë°” í† ê¸€ -->
  <div class="tg"><button class="tb" onclick="App.toggleSidebar()" data-tooltip="ì‚¬ì´ë“œë°”">â˜°</button></div>
  <div class="ts"></div>

  <!-- ğŸŸ¡ í—¤ë”© â€” ë…¸ë€ìƒ‰ ê³„ì—´ -->
  <div class="tg">
    <button class="tb tb-heading" onclick="ED.h(1)" data-tooltip="ì œëª© H1" data-key="Ctrl+Alt+1"><b>H1</b></button>
    <button class="tb tb-heading" onclick="ED.h(2)" data-tooltip="ì œëª© H2" data-key="Ctrl+Alt+2"><b>H2</b></button>
    <button class="tb tb-heading" onclick="ED.h(3)" data-tooltip="ì œëª© H3" data-key="Ctrl+Alt+3"><b>H3</b></button>
  </div>
  <div class="ts"></div>

  <!-- ğŸŸ  í…ìŠ¤íŠ¸ ì„œì‹ â€” ì˜¤ë Œì§€ ê³„ì—´ -->
  <div class="tg">
    <button class="tb tb-fmt" id="bold-btn" onclick="ED.bold()" data-tooltip="Smart Bold" data-key="Ctrl+B"><b>B</b></button>
    <button class="tb tb-fmt" id="italic-btn" onclick="ED.italic()" data-tooltip="ê¸°ìš¸ì„ê¼´" data-key="Ctrl+I"><i>I</i></button>
    <button class="tb tb-fmt" onclick="ED.strike()" data-tooltip="ì·¨ì†Œì„ ">SÌ¶</button>
    <button class="tb tb-fmt" onclick="ED.inlineCode()" data-tooltip="ì¸ë¼ì¸ ì½”ë“œ"><code style="font-size:10px">`c`</code></button>
  </div>
  <div class="ts"></div>

  <!-- ğŸŸ  ê¸€ì í¬ê¸° â€” ì˜¤ë Œì§€ ê³„ì—´ -->
  <div class="tg" style="gap:0">
    <button class="tb tb-fmt" onclick="FS.dec()" data-tooltip="ì„ íƒ ê¸€ì í¬ê¸° ì¤„ì´ê¸° (Shift+Alt+,)" style="min-width:22px;font-size:14px;font-weight:700;padding:0 4px">âˆ’</button>
    <div id="fsize-display" style="min-width:38px;text-align:center;font-family:var(--fm);font-size:12px;font-weight:600;color:#f7a06a;line-height:26px;cursor:pointer;user-select:none;background:#2a2a3a;border-top:1px solid #3a3a50;border-bottom:1px solid #3a3a50" data-tooltip="í•œë²ˆ í´ë¦­: ëª©ë¡ / ë‘ë²ˆ í´ë¦­: ì§ì ‘ ì…ë ¥" onclick="FS.clickPick(event)" ondblclick="FS.startEdit(event)">12pt</div>
    <input id="fsize-input" type="text" value="12" onblur="FS.endEdit()" onkeydown="FS.editKey(event)" style="display:none;width:46px;text-align:center;font-family:var(--fm);font-size:12px;font-weight:600;color:#f7a06a;background:#2a2a3a;border:1px solid var(--ac);border-radius:3px;outline:none;padding:0 4px;height:22px;line-height:22px">
    <button class="tb tb-fmt" onclick="FS.inc()" data-tooltip="ì„ íƒ ê¸€ì í¬ê¸° í‚¤ìš°ê¸° (Shift+Alt+.)" style="min-width:22px;font-size:14px;font-weight:700;padding:0 4px">+</button>
  </div>

  <!-- ğŸŸ  ìƒ‰ìƒ â€” ì˜¤ë Œì§€ ê³„ì—´ -->
  <div class="tg">
    <button class="tb tb-fmt" id="fc-btn" onclick="App.openColorPicker('text')" data-tooltip="ê¸€ì ìƒ‰ìƒ" style="flex-direction:column;gap:1px">
      <span style="font-size:11px;font-weight:700">A</span>
      <span id="fc-bar" style="width:14px;height:2px;border-radius:1px;background:#e8e8f0"></span>
    </button>
    <button class="tb tb-fmt" id="hl-btn" onclick="App.openColorPicker('bg')" data-tooltip="í˜•ê´‘íœ í•˜ì´ë¼ì´íŠ¸" style="flex-direction:column;gap:1px">
      <span style="font-size:11px">ğŸ–Š</span>
      <span id="hl-bar" style="width:14px;height:2px;border-radius:1px;background:transparent;border:1px solid var(--bd)"></span>
    </button>
  </div>
  <div class="ts"></div>

  <!-- ğŸŸ¢ ì •ë ¬ â€” í˜•ê´‘ ì´ˆë¡ ê³„ì—´ -->
  <div class="tg">
    <button class="tb tb-layout" onclick="ED.align('left')" data-tooltip="ì™¼ìª½ ì •ë ¬" data-key="Shift+Alt+L">â‡¤</button>
    <button class="tb tb-layout" onclick="ED.align('center')" data-tooltip="ê°€ìš´ë° ì •ë ¬" data-key="Shift+Alt+C">â‡”</button>
    <button class="tb tb-layout" onclick="ED.align('right')" data-tooltip="ì˜¤ë¥¸ìª½ ì •ë ¬" data-key="Shift+Alt+R">â‡¥</button>
  </div>
  <div class="ts"></div>

  <!-- ğŸŸ¢ ëª©ë¡Â·ì¸ìš© â€” í˜•ê´‘ ì´ˆë¡ ê³„ì—´ -->
  <div class="tg">
    <button class="tb tb-layout" onclick="ED.list('ul')" data-tooltip="ëª©ë¡">â€¢ List</button>
    <button class="tb tb-layout" onclick="ED.list('ol')" data-tooltip="ë²ˆí˜¸ ëª©ë¡">1. List</button>
    <button class="tb tb-layout" onclick="ED.bquote()" data-tooltip="ì¸ìš©êµ¬" data-key="Ctrl+.">â</button>
  </div>
  <div class="ts"></div>

  <!-- ğŸ”µ í‘œ â€” íŒŒë€/ë³´ë¼ ê³„ì—´ -->
  <div class="tg">
    <button class="tb tb-table" onclick="ED.table()" data-tooltip="í‘œ ì‚½ì…" data-key="Alt+8">âŠ í‘œ</button>
    <button class="tb tb-table" onclick="ED.tableRow()" data-tooltip="í–‰ ì¶”ê°€" data-key="Alt+9">+í–‰</button>
    <button class="tb tb-table" onclick="ED.tableCol()" data-tooltip="ì—´ ì¶”ê°€" data-key="Alt+0">+ì—´</button>
    <button class="tb tb-table" onclick="ED.mergeH()" data-tooltip="ê°€ë¡œ ë³‘í•© (colspan)" data-key="Alt+Shift+H">âŠH</button>
    <button class="tb tb-table" onclick="ED.mergeV()" data-tooltip="ì„¸ë¡œ ë³‘í•© (rowspan)" data-key="Alt+Shift+V">âŠV</button>
    <button class="tb tb-table-tidy" onclick="ED.tidyTable()" data-tooltip="HTML í‘œ ë“¤ì—¬ì“°ê¸° ì •ëˆ (ì»¤ì„œë¥¼ í‘œ ì•ˆì— ë†“ê³  ì‹¤í–‰)">âœ¦ Tidy</button>
    <button class="tb tb-table" onclick="App.showCaption('table')" data-tooltip="í‘œ ìº¡ì…˜">ã€ˆí‘œã€‰</button>
    <button class="tb tb-table" onclick="App.showCaption('fig')" data-tooltip="ê·¸ë¦¼ ìº¡ì…˜">[ê·¸ë¦¼]</button>
  </div>
  <div class="ts"></div>

  <!-- ğŸ”µ ì½”ë“œ â€” íŒŒë€/ë³´ë¼ ê³„ì—´ -->
  <div class="tg">
    <button class="tb tb-code" onclick="App.showCode()" data-tooltip="ì½”ë“œ ë¸”ë¡ ì–¸ì–´ ì„ íƒ (ë©”ë‰´) / Alt+C = ë§ˆì§€ë§‰ ì–¸ì–´ ì§ì ‘ ì‚½ì…">âŒ¨ Code</button>
  </div>
  <div class="ts"></div>

  <!-- ğŸ”´ ì‚½ì…/íŠ¹ìˆ˜ â€” ë¶„í™/ì—°ë³´ë¼ ê³„ì—´ -->
  <div class="tg">
    <button class="tb tb-insert" onclick="ED.pageBreak()" data-tooltip="í˜ì´ì§€ ë‚˜ëˆ„ê¸°" data-key="Ctrl+Enter">â‹¯ PB</button>
    <button class="tb tb-insert" onclick="ED.lineBreak()" data-tooltip="ì¤„ë°”ê¿ˆ &lt;br&gt;" data-key="Ctrl+Shift+Enter">â†©</button>
    <button class="tb tb-insert" onclick="ED.insertNbsp()" data-tooltip="ë¶ˆì—°ì† ê³µë°± &amp;nbsp; ì‚½ì…" data-key="Ctrl+Shift+Space">âµ</button>
    <button class="tb tb-insert" onclick="App.showImg()" data-tooltip="ì´ë¯¸ì§€">ğŸ–¼</button>
    <button class="tb tb-insert" onclick="App.showLink()" data-tooltip="ë§í¬ (ìƒˆ íƒ­)">ğŸ”—</button>
    <button class="tb tb-insert" onclick="ED.footnote()" data-tooltip="ê°ì£¼">â€ </button>
    <button class="tb tb-insert" onclick="ED.math()" data-tooltip="ìˆ˜ì‹(LaTeX)">âˆ‘</button>
    <button class="tb tb-insert" onclick="App.showCite()" data-tooltip="ì¸ìš© ì‚½ì…" data-key="Ctrl+Shift+C">ğŸ“–</button>
    <button class="tb tb-insert" onclick="STATS.show()" data-tooltip="APA í†µê³„ ì‚½ì…" data-key="Shift+Alt+9">ğ‘“(x)</button>
  </div>
  <div class="ts"></div>

  <!-- ğŸ” ì°¾ê¸° -->
  <div class="tg"><button class="tb tb-util" onclick="App.toggleFind()" data-tooltip="ì°¾ê¸°/ë°”ê¾¸ê¸°" data-key="Ctrl+F">ğŸ”</button></div>
  <div class="spacer"></div>

  <!-- âš™ ë³´ê¸° ëª¨ë“œ -->
  <div class="tg">
    <button class="tb tb-view" onclick="App.setViewCycle('split')" id="vm-split" data-tooltip="ë¶„í•  ë³´ê¸° (Alt+1)" data-key="Alt+1">Split</button>
    <button class="tb tb-view" onclick="App.setViewCycle('editor')" id="vm-editor" data-tooltip="ì—ë””í„°ë§Œ (Alt+2)" data-key="Alt+2">Edit</button>
    <button class="tb tb-view" onclick="App.setViewCycle('preview')" id="vm-preview" data-tooltip="ë¯¸ë¦¬ë³´ê¸°ë§Œ (Alt+3)" data-key="Alt+3">View</button>
  </div>
  <div class="ts"></div>
  <div class="tg">
    <button class="tb tb-pv" id="pw-btn" onclick="PW.open()" data-tooltip="ìƒˆì°½ ë¯¸ë¦¬ë³´ê¸°" data-key="Ctrl+Shift+P">ğŸ—— PV</button>
    <button class="tb tb-pv" onclick="PW.openPPT()" data-tooltip="PPT ëª¨ë“œë¡œ ë°”ë¡œ ì—´ê¸°" data-key="Ctrl+Shift+T">ğŸ¬ PPT</button>
    <button class="tb tb-pv" onclick="PW.forceRefresh()" data-tooltip="ìƒˆì°½ ê°•ì œ ìƒˆë¡œê³ ì¹¨">â†»</button>
  </div>
  <div class="ts"></div>
  <div class="tg">
    <button class="tb tb-sys" onclick="App.toggleTheme()" data-tooltip="í…Œë§ˆ ì „í™˜">â—‘</button>
    <button class="tb tb-sys" id="ln-btn" onclick="LN.toggle()" data-tooltip="ì¤„ ë²ˆí˜¸">ln</button>
    <button class="tb tb-sys" onclick="App.showHK()" data-tooltip="ë‹¨ì¶•í‚¤ ëª©ë¡" data-key="Alt+?">?</button>
  </div>
</div>

<!-- SIDEBAR -->
<nav id="sidebar">
  <div id="sb-hdr">
    <span>ëª©ì°¨ (TOC)</span>
    <div style="display:flex;gap:4px;align-items:center">
      <button class="btn btn-g btn-sm" style="font-size:10px;padding:1px 7px" onclick="TOC.insertTOC()" data-tooltip="ë¬¸ì„œ ë§¨ ì•ì— ëª©ì°¨ ìë™ ì‚½ì…">ğŸ“‘ ì‚½ì…</button>
      <button class="btn-ic" onclick="TOC.build(document.getElementById('editor').value)" data-tooltip="ëª©ì°¨ ìƒˆë¡œê³ ì¹¨">â†»</button>
    </div>
  </div>
  <div id="toc-list"><div style="padding:12px;color:var(--tx3);font-size:12px">í—¤ë”©(#) ì¶”ê°€ ì‹œ ìë™ ìƒì„±</div></div>
  <div id="sb-stats"><span id="sw">0 ë‹¨ì–´</span><span id="sc">0 ì</span><span id="sp">ì•½ 0 í˜ì´ì§€</span></div>
</nav>

<!-- MAIN -->
<main id="main">
  <div id="find-bar">
    <span style="font-size:11px;color:var(--tx3)">ì°¾ê¸°</span>
    <input id="fi" type="text" placeholder="ê²€ìƒ‰ì–´..." onkeydown="App.findKey(event)">
    <span style="font-size:11px;color:var(--tx3)">ë°”ê¾¸ê¸°</span>
    <input id="ri" type="text" placeholder="ë°”ê¿€ ë‚´ìš©...">
    <button class="btn btn-g btn-sm" onclick="App.findNext()">ë‹¤ìŒ</button>
    <button class="btn btn-g btn-sm" onclick="App.replaceOne()">ë°”ê¾¸ê¸°</button>
    <button class="btn btn-g btn-sm" onclick="App.replaceAll()">ëª¨ë‘</button>
    <button class="btn-ic" onclick="App.toggleFind()">âœ•</button>
    <span id="fc-cnt" style="font-size:11px;color:var(--tx3)"></span>
  </div>
  <div id="editor-wrap">
    <div id="editor-pane">
      <div id="ed-hdr"><span class="pane-lbl"><span></span>MARKDOWN</span></div>
      <div id="ed-container">
        <div id="line-numbers"><div class="lnc" id="lnc"></div></div>
        <textarea id="editor" placeholder="# ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”&#10;&#10;ì—¬ê¸°ì— Markdownì„ ì‘ì„±í•˜ì„¸ìš”.&#10;Alt+? â†’ ë‹¨ì¶•í‚¤ ëª©ë¡" spellcheck="false"></textarea>
      </div>
    </div>
    <div id="preview-pane">
      <div id="pv-hdr">
        <span class="pane-lbl"><span style="background:var(--ac2)"></span>PV</span>
        <span id="pg-cnt" style="font-size:9px;color:var(--ac);font-family:var(--fm);margin-left:4px"></span>
        <span id="render-ts" style="font-size:9px;color:var(--tx3);font-family:var(--fm);margin-left:4px"></span>
        <span class="spacer"></span>
        <div style="display:flex;align-items:center;gap:3px">
          <!-- í™•ëŒ€/ì¶•ì†Œ -->
          <button class="tb tb-sys" onclick="PV.zoomOut()" data-tooltip="ë¯¸ë¦¬ë³´ê¸° ì¶•ì†Œ" style="font-size:14px;font-weight:700">ï¼</button>
          <span id="pv-zoom-lbl" style="font-size:10px;font-family:var(--fm);color:#6acff7;min-width:32px;text-align:center">100%</span>
          <button class="tb tb-sys" onclick="PV.zoomIn()" data-tooltip="ë¯¸ë¦¬ë³´ê¸° í™•ëŒ€" style="font-size:14px;font-weight:700">ï¼‹</button>
          <div class="ts"></div>
          <!-- PPT ëª¨ë“œ -->
          <button class="tb" id="ppt-btn" onclick="PV.togglePPT()" data-tooltip="PPT ëª¨ë“œ â€” íŒ¨ë„ ë„ˆë¹„ì— ë§ì¶° í™•ëŒ€ í›„ í˜ì´ì§€ ë‹¨ìœ„ ì´ë™ (â†‘â†“ í‚¤)" style="font-size:10px;padding:0 7px;height:22px;color:#f0c060;border:1px solid rgba(240,192,96,.35);border-radius:4px;font-weight:600">ğŸ¬ PPT</button>
          <div class="ts"></div>
          <!-- í°íŠ¸ í¬ê¸° -->
          <div class="ts"></div>
          <span style="font-size:9px;color:rgba(255,255,255,.4);font-family:var(--fm)">í°íŠ¸</span>
          <button class="tb tb-sys" onclick="PV.fontDown()" data-tooltip="í°íŠ¸ ì¶•ì†Œ" style="font-size:11px">á´¬ï¼</button>
          <span id="pv-font-lbl" style="font-size:10px;font-family:var(--fm);color:#6acff7;min-width:28px;text-align:center">11pt</span>
          <button class="tb tb-sys" onclick="PV.fontUp()" data-tooltip="í°íŠ¸ í™•ëŒ€" style="font-size:11px">á´¬ï¼‹</button>
          <div class="ts"></div>
          <!-- Dark í…Œë§ˆ -->
          <button class="tb" id="pv-dark-btn" onclick="PV.toggleDark()" data-tooltip="ë¯¸ë¦¬ë³´ê¸° ë‹¤í¬ í…Œë§ˆ í† ê¸€" style="font-size:10px;padding:0 7px;height:22px;color:#7ab8ff;border:1px solid rgba(100,160,255,.3);border-radius:4px;font-weight:600">â—‘ Dark</button>
          <div class="ts"></div>
          <button class="tb tb-a4" id="a4-ruler-btn" onclick="A4Ruler.toggle()" data-tooltip="A4 í˜ì´ì§€ êµ¬ë¶„ì„  í‘œì‹œ/ìˆ¨ê¸°ê¸° â€” 297mm ìœ„ì¹˜ì— ë¹¨ê°„ ì ì„ ">ğŸ“„ A4</button>
          <button class="tb tb-copy-rich" id="copy-rich-btn" onclick="CP.copyRich()" data-tooltip="ì„œì‹ ìˆëŠ” ë³µì‚¬ â€” WordÂ·êµ¬ê¸€ë…ìŠ¤ì— ë¶™ì—¬ë„£ê¸° ì‹œ ì„œì‹ ìœ ì§€">ğŸ“‹ ë³µì‚¬</button>
          <button class="tb tb-copy-text" id="copy-text-btn" onclick="CP.copyText()" data-tooltip="í…ìŠ¤íŠ¸ ë³µì‚¬ â€” ì„œì‹ ì—†ì´ ìˆœìˆ˜ í…ìŠ¤íŠ¸ë§Œ">ï¼¡ í…ìŠ¤íŠ¸</button>
        </div>
      </div>
      <div id="preview-container">
      </div>
      <div id="a4-overlay"></div>
      <!-- PPT ë„¤ë¹„ê²Œì´ì…˜ -->
      <div id="ppt-nav">
        <button onclick="PV.pptPrev()" title="ì´ì „ í˜ì´ì§€ [â†]">â—€</button>
        <span id="ppt-pg">1 / 1</span>
        <button onclick="PV.pptNext()" title="ë‹¤ìŒ í˜ì´ì§€ [â†’]">â–¶</button>
        <div style="width:1px;height:16px;background:rgba(255,255,255,.2);margin:0 4px"></div>
        <button onclick="PV.togglePPT()" title="PPT ëª¨ë“œ ì¢…ë£Œ [Esc]" style="font-size:13px;opacity:.6;background:none;border:none;cursor:pointer;color:#ddd;padding:0 4px">âœ•</button>
      </div>
    </div>
  </div>
  <div id="error-panel">
    <div id="ep-hdr"><span>âš  ì˜¤ë¥˜</span><button class="btn-ic" onclick="App.closeErr()">âœ•</button></div>
    <div id="ep-list"></div>
  </div>
</main>

<!-- STATUSBAR -->
<div id="statusbar">
  <div class="si" id="autosave-indicator"><div class="save-dot" id="save-dot"></div><span id="save-st">ì €ì¥ë¨</span></div>
  <div class="ss">|</div><div class="si" id="cursor-pos">ì¤„ 1, ì—´ 1</div>
  <div class="ss">|</div><div class="si" id="sel-info"></div>
  <div class="ssp"></div>
  <div class="si" id="error-count" onclick="App.toggleErr()"></div>
  <div class="ss" id="ec-sep" style="display:none">|</div>
  <div class="si">UTF-8</div><div class="ss">|</div>
  <div class="si" id="mode-ind">NORMAL</div>
</div>
</div><!-- #app -->

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• MODALS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->

<!-- HOTKEY OVERLAY -->
<div id="hk-overlay" onclick="App.hideHK()">
  <div id="hk-panel" onclick="event.stopPropagation()">
    <h2>
      <span>âŒ¨ ë‹¨ì¶•í‚¤ ëª©ë¡</span>
      <div style="display:flex;align-items:center;gap:6px">
        <button class="btn btn-g btn-sm" id="hk-edit-btn" onclick="HK.toggleEdit()" style="font-size:11px">âœ í¸ì§‘</button>
        <button class="btn-ic" onclick="App.hideHK()">âœ•</button>
      </div>
    </h2>

    <!-- í¸ì§‘ ëª¨ë“œ ì•ˆë‚´ -->
    <div id="hk-edit-hint" style="display:none;background:rgba(124,106,247,.1);border:1px solid var(--ac);border-radius:6px;padding:8px 12px;margin-bottom:12px;font-size:11px;color:var(--tx2);line-height:1.6">
      <b style="color:var(--ac)">í¸ì§‘ ëª¨ë“œ</b> â€” ì„¤ëª… í´ë¦­ í›„ ìˆ˜ì • | ë‹¨ì¶•í‚¤ í´ë¦­ í›„ ìˆ˜ì • | <kbd style="background:var(--bg5);border:1px solid var(--bd);border-radius:3px;padding:1px 5px;font-size:10px">Del</kbd> í–‰ ì‚­ì œ | <button onclick="HK.addRow()" class="btn btn-g btn-sm" style="font-size:10px;padding:2px 7px;vertical-align:middle">+ í–‰ ì¶”ê°€</button>
    </div>

    <!-- ë‹¨ì¶•í‚¤ ëª©ë¡ ë Œë” ì˜ì—­ -->
    <div id="hk-list-wrap"></div>

    <div style="margin-top:10px;font-size:11px;color:var(--tx3)" id="hk-footer-note">
      í‘œ ë‚´ë¶€: Tabâ†’ë‹¤ìŒ ì…€ | Enterâ†’ìƒˆ í–‰ | âŒ¨ Code ë²„íŠ¼â†’ì–¸ì–´ ì„ íƒ | Alt+Câ†’ë§ˆì§€ë§‰ ì–¸ì–´ ì§ì ‘ ì‚½ì…
    </div>
    <div style="margin-top:8px;display:flex;gap:6px;justify-content:flex-end" id="hk-edit-actions" style="display:none">
      <button class="btn btn-g btn-sm" onclick="HK.resetDefault()">â†© ê¸°ë³¸ê°’ ë³µì›</button>
      <button class="btn btn-p btn-sm" onclick="HK.saveEdit()">ì €ì¥</button>
    </div>
  </div>
</div>

<!-- SAVE DIALOG -->
<div class="ov" id="save-modal">
  <div class="modal" style="max-width:400px">
    <h3>ğŸ’¾ ì €ì¥ í˜•ì‹ ì„ íƒ</h3>
    <div style="display:flex;flex-direction:column;gap:9px;margin-bottom:16px">
      <button class="btn btn-g" style="justify-content:flex-start;padding:11px 14px;gap:10px" onclick="App.saveMD()">
        <span style="font-size:18px">ğŸ“</span>
        <div style="text-align:left"><div style="font-weight:600;font-size:13px">Markdown (.md)</div><div style="font-size:11px;color:var(--tx2)">ì›ë³¸ ë§ˆí¬ë‹¤ìš´ íŒŒì¼</div></div>
      </button>
      <button class="btn btn-g" style="justify-content:flex-start;padding:11px 14px;gap:10px" onclick="App.saveTXT()">
        <span style="font-size:18px">ğŸ“„</span>
        <div style="text-align:left"><div style="font-weight:600;font-size:13px">Plain Text (.txt)</div><div style="font-size:11px;color:var(--tx2)">ë§ˆí¬ë‹¤ìš´ ê¸°í˜¸ ì œê±°í•œ í…ìŠ¤íŠ¸</div></div>
      </button>
      <button class="btn btn-g" style="justify-content:flex-start;padding:11px 14px;gap:10px" onclick="App.saveHTML()">
        <span style="font-size:18px">ğŸŒ</span>
        <div style="text-align:left"><div style="font-weight:600;font-size:13px">HTML (.html)</div><div style="font-size:11px;color:var(--tx2)">A4 ë‹¤ì¤‘ í˜ì´ì§€ ìŠ¤íƒ€ì¼ í¬í•¨</div></div>
      </button>
      <button class="btn btn-g" style="justify-content:flex-start;padding:11px 14px;gap:10px" onclick="App.printDoc()">
        <span style="font-size:18px">ğŸ–¨ï¸</span>
        <div style="text-align:left"><div style="font-weight:600;font-size:13px">ì¸ì‡„ / PDFë¡œ ì €ì¥</div><div style="font-size:11px;color:var(--tx2)">ë¸Œë¼ìš°ì € ì¸ì‡„ì°½ â†’ PDF ì €ì¥ ê°€ëŠ¥ (ì „ì²´ í˜ì´ì§€)</div></div>
      </button>
      <div style="display:flex;align-items:center;gap:10px;padding:10px 14px;background:var(--bg3);border-radius:var(--r);border:1px solid var(--bd)">
        <span style="font-size:16px">ğŸ”–</span>
        <div style="flex:1;text-align:left">
          <div style="font-weight:600;font-size:12px;color:var(--tx)">ì£¼ì„([^n]) í‘œì‹œ ì„¤ì •</div>
          <div style="font-size:11px;color:var(--tx2);margin-top:2px">ì €ì¥Â·ì¸ì‡„ ì‹œ ê°ì£¼ í‘œì‹œ ì—¬ë¶€</div>
        </div>
        <label style="display:flex;align-items:center;gap:5px;cursor:pointer;font-size:12px;color:var(--tx2)">
          <input type="checkbox" id="show-footnotes-chk" checked style="accent-color:var(--ac)"> í‘œì‹œ
        </label>
      </div>
    </div>
    <div class="mf"><button class="btn btn-g btn-sm" onclick="App.hideModal('save-modal')">ë‹«ê¸°</button></div>
  </div>
</div>

<!-- APA STATS MODAL -->
<div class="ov" id="stats-modal">
  <div class="modal" style="max-width:560px">
    <h3>ğ‘“(x) APA í†µê³„ ê²°ê³¼ ì‚½ì… <span style="font-size:11px;color:var(--tx3);font-weight:400">Shift+Alt+9</span></h3>
    <!-- Analysis type selector -->
    <div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:14px" id="stats-type-row">
      <button class="btn btn-tog btn-sm active" onclick="STATS.setType('ttest')" id="st-ttest">t-test</button>
      <button class="btn btn-tog btn-sm" onclick="STATS.setType('anova')" id="st-anova">ANOVA</button>
      <button class="btn btn-tog btn-sm" onclick="STATS.setType('regression')" id="st-regression">Regression</button>
      <button class="btn btn-tog btn-sm" onclick="STATS.setType('correlation')" id="st-correlation">Correlation</button>
      <button class="btn btn-tog btn-sm" onclick="STATS.setType('chisq')" id="st-chisq">Chi-square</button>
      <button class="btn btn-tog btn-sm" onclick="STATS.setType('sem')" id="st-sem">SEM</button>
      <button class="btn btn-tog btn-sm" onclick="STATS.setType('logistic')" id="st-logistic">Logistic</button>
      <button class="btn btn-tog btn-sm" onclick="STATS.setType('multilevel')" id="st-multilevel">Multilevel</button>
      <button class="btn btn-tog btn-sm" onclick="STATS.setType('custom')" id="st-custom" style="border-color:var(--ac2);color:var(--ac2)">âœ Custom</button>
    </div>
    <!-- Fields area -->
    <div id="stats-fields" style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:10px"></div>
    <!-- Custom area (hidden by default) -->
    <div id="stats-custom-area" style="display:none;margin-bottom:10px">
      <div class="fg"><label class="fl">ì»¤ìŠ¤í…€ ì´ë¦„</label><input class="fi" id="custom-name" type="text" placeholder="ì˜ˆ: Mixed ANOVA"></div>
      <div class="fg"><label class="fl">ì¶œë ¥ í¬ë§· <span style="color:var(--tx3);font-size:10px">{ë³€ìˆ˜ëª…} ì‚¬ìš©</span></label>
        <input class="fi" id="custom-fmt" type="text" placeholder="ì˜ˆ: (F({df1}, {df2}) = {F}, p = {p})">
      </div>
      <div class="fg" id="custom-vars-area"><label class="fl">ë³€ìˆ˜ ëª©ë¡ <span style="color:var(--tx3);font-size:10px">ì½¤ë§ˆë¡œ êµ¬ë¶„</span></label>
        <input class="fi" id="custom-vars" type="text" placeholder="df1, df2, F, p" oninput="STATS.updateCustomVars()">
      </div>
      <div id="custom-fields" style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px"></div>
      <div style="margin-top:8px;display:flex;gap:6px;align-items:center">
        <button class="btn btn-g btn-sm" onclick="STATS.saveCustom()">ğŸ’¾ ì €ì¥</button>
        <select id="custom-saved-sel" class="fi" style="width:auto;flex:1;padding:4px 8px;font-size:11px" onchange="STATS.loadCustom(this.value)"><option value="">â€” ì €ì¥ëœ ì»¤ìŠ¤í…€ â€”</option></select>
        <button class="btn btn-g btn-sm" style="color:var(--er)" onclick="STATS.deleteCustom()">ì‚­ì œ</button>
      </div>
    </div>
    <!-- Preview -->
    <div style="background:var(--bg3);border:1px solid var(--bd);border-radius:var(--r);padding:8px 12px;margin-bottom:12px;font-family:var(--fm);font-size:12px;color:var(--tx);min-height:28px">
      <span style="font-size:10px;color:var(--tx3);margin-right:6px">ë¯¸ë¦¬ë³´ê¸°:</span><span id="stats-preview" style="color:var(--ac)"></span>
    </div>
    <div class="mf">
      <button class="btn btn-g btn-sm" onclick="App.hideModal('stats-modal')">ì·¨ì†Œ</button>
      <button class="btn btn-p btn-sm" onclick="STATS.insert()">ì‚½ì…</button>
    </div>
  </div>
</div>

<!-- CITATION MANAGER -->
<div class="ov" id="cite-modal">
  <div class="modal xl">
    <h3>ğŸ“š ì°¸ê³ ë¬¸í—Œ ê´€ë¦¬ &amp; ì¸ìš© ì‚½ì…</h3>
    <div class="tab-row">
      <div class="tab active" onclick="CM.tab('add')">â‘  ì°¸ê³ ë¬¸í—Œ ì¶”ê°€</div>
      <div class="tab" onclick="CM.tab('cite')">â‘¡ ì¸ìš© ì‚½ì…</div>
      <div class="tab" onclick="CM.tab('convert')">â‘¢ ìŠ¤íƒ€ì¼ ë³€í™˜</div>
      <div class="tab" onclick="CM.tab('lib')">â‘£ ì €ì¥ëœ ëª©ë¡</div>
      <div class="tab" onclick="CM.tab('search')" style="color:var(--ac2)">â‘¤ ğŸ” ë…¼ë¬¸ ê²€ìƒ‰</div>
    </div>

    <!-- ADD -->
    <div class="tp active" id="cp-add">
      <div class="fg">
        <label class="fl">ì…ë ¥ êµ¬ë¶„ ë°©ì‹</label>
        <div style="display:flex;gap:8px;margin-bottom:10px">
          <button id="sep-blank-btn" class="btn btn-tog active btn-sm" style="flex:1" onclick="CM.setSep('blank')">
            ğŸ“‹ ë¹ˆ ì¤„ë¡œ êµ¬ë¶„<br><span style="font-size:10px;color:inherit;opacity:.8">í•­ëª© ì‚¬ì´ì— ë¹ˆ ì¤„ 1ê°œ</span>
          </button>
          <button id="sep-line-btn" class="btn btn-tog btn-sm" style="flex:1" onclick="CM.setSep('line')">
            â†µ ì—”í„°(ì¤„ë°”ê¿ˆ)ë¡œ êµ¬ë¶„<br><span style="font-size:10px;color:inherit;opacity:.8">ê° ì¤„ = 1ê°œ ì°¸ê³ ë¬¸í—Œ</span>
          </button>
        </div>
      </div>
      <div class="fg">
        <label class="fl">APA í˜•ì‹ ì°¸ê³ ë¬¸í—Œ ë¶™ì—¬ë„£ê¸°</label>
        <textarea id="cite-raw" class="fi" style="min-height:130px" placeholder="ì—¬ê¸°ì— ì°¸ê³ ë¬¸í—Œì„ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”..."></textarea>
        <div style="display:flex;gap:8px;margin-top:7px;align-items:center;flex-wrap:wrap">
          <button class="btn btn-p btn-sm" onclick="CM.parse()">ì•±ì—ì„œ ì‚¬ìš©í•˜ê¸° â†’</button>
          <button class="btn btn-g btn-sm" onclick="document.getElementById('cite-raw').value=''">ì§€ìš°ê¸°</button>
          <label class="btn btn-g btn-sm" style="cursor:pointer">ğŸ“ TXT ë¶ˆëŸ¬ì˜¤ê¸°<input type="file" accept=".txt,.bib,.ris" style="display:none" onchange="CM.loadFile(event)"></label>
          <span id="cite-msg" style="font-size:11px;color:var(--ok)"></span>
        </div>
        <div style="margin-top:7px;font-size:11px;color:var(--tx3)" id="sep-desc">í˜„ì¬: ë¹ˆ ì¤„ë¡œ êµ¬ë¶„ â€” í•­ëª© ì‚¬ì´ì— ë¹ˆ ì¤„ í•˜ë‚˜ë¥¼ ë„£ì–´ êµ¬ë¶„í•˜ì„¸ìš”.</div>
      </div>
    </div>

    <!-- CITE -->
    <div class="tp" id="cp-cite">
      <div style="display:flex;gap:7px;margin-bottom:9px;align-items:center">
        <input type="text" id="cite-search" class="fi" style="flex:1" placeholder="ì €ì, ì—°ë„, í‚¤ì›Œë“œë¡œ ê²€ìƒ‰..." oninput="CM.filter()">
        <button class="btn btn-g btn-sm" onclick="CM.selAll()">ì „ì²´ ì„ íƒ</button>
        <button class="btn btn-g btn-sm" onclick="CM.clrSel()">ì„ íƒ í•´ì œ</button>
      </div>
      <div id="cite-list-area"><div class="cite-empty">ì¶”ê°€ íƒ­ì—ì„œ ë¨¼ì € ì°¸ê³ ë¬¸í—Œì„ ì…ë ¥í•˜ì„¸ìš”.</div></div>
      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:8px">
        <label style="font-size:12px;color:var(--tx2)">ì‚½ì… í˜•ì‹:</label>
        <select id="cite-style" class="fi" style="width:auto;padding:4px 8px">
          <option value="inline">ì¸ë¼ì¸: (ì €ì, ì—°ë„)</option>
          <option value="narrative">ì„œìˆ í˜•: ì €ì(ì—°ë„)</option>
          <option value="multi">ë³µìˆ˜: (A, ì—°ë„; B, ì—°ë„)</option>
          <option value="footnote">ê°ì£¼: [^n]</option>
        </select>
        <span id="cite-sc" style="font-size:11px;color:var(--tx3);margin-left:auto">0ê°œ ì„ íƒë¨</span>
      </div>
    </div>

    <!-- CONVERT -->
    <div class="tp" id="cp-convert">
      <div style="display:flex;gap:8px;margin-bottom:12px;align-items:center;flex-wrap:wrap">
        <label style="font-size:12px;color:var(--tx2)">ì…ë ¥ ìŠ¤íƒ€ì¼:</label>
        <select id="from-style" class="fi" style="width:auto;padding:4px 8px">
          <option value="apa" selected>APA 7 (ê¸°ë³¸)</option>
          <option value="mla">MLA 9</option>
          <option value="chicago">Chicago (Author-Date)</option>
          <option value="vancouver">Vancouver</option>
        </select>
        <span style="font-size:12px;color:var(--tx2)">â†’ ë³€í™˜ ëŒ€ìƒ:</span>
        <select id="to-style" class="fi" style="width:auto;padding:4px 8px">
          <option value="mla" selected>MLA 9</option>
          <option value="apa">APA 7</option>
          <option value="chicago">Chicago (Author-Date)</option>
          <option value="vancouver">Vancouver</option>
        </select>
        <button class="btn btn-p btn-sm" onclick="CM.convertStyle()">ë³€í™˜</button>
      </div>
      <div class="fg">
        <label class="fl">ë³€í™˜í•  ì°¸ê³ ë¬¸í—Œ (ì €ì¥ ëª©ë¡ ë¯¸ì„ íƒ ì‹œ ì§ì ‘ ì…ë ¥)</label>
        <textarea id="conv-input" class="fi" style="min-height:80px" placeholder="Kim, J. H., &amp; Lee, S. (2023). SEM in education. Journal of Educational Research, 45(2), 123â€“145."></textarea>
      </div>
      <div class="fg">
        <label class="fl">ë³€í™˜ ê²°ê³¼ <span id="conv-label" style="color:var(--ac);font-weight:600"></span></label>
        <textarea id="conv-output" class="fi" style="min-height:80px" readonly placeholder="ë³€í™˜ ê²°ê³¼ê°€ ì—¬ê¸° í‘œì‹œë©ë‹ˆë‹¤..."></textarea>
      </div>
      <div style="display:flex;gap:8px">
        <button class="btn btn-g btn-sm" onclick="CM.copyConverted()">ğŸ“‹ ë³µì‚¬</button>
        <button class="btn btn-p btn-sm" onclick="CM.insertConverted()">ì—ë””í„°ì— ì‚½ì…</button>
      </div>
    </div>

    <!-- LIB -->
    <div class="tp" id="cp-lib">
      <div style="display:flex;gap:7px;margin-bottom:9px;align-items:center;flex-wrap:wrap">
        <span style="font-size:12px;color:var(--tx2)">ì €ì¥ <span id="lib-cnt" style="color:var(--ac);font-weight:600">0</span>ê±´</span>
        <span class="spacer"></span>
        <button class="btn btn-g btn-sm" onclick="CM.insertRefSection()">ğŸ“„ ì°¸ê³ ë¬¸í—Œ ì„¹ì…˜ ì‚½ì…</button>
        <button class="btn btn-g btn-sm" onclick="CM.downloadLib()">â¬‡ ëª©ë¡ ë‹¤ìš´ë¡œë“œ</button>
        <button class="btn btn-g btn-sm" style="color:var(--er)" onclick="CM.clearAll()">ì „ì²´ ì‚­ì œ</button>
      </div>
      <div id="lib-list"><div class="cite-empty">ì €ì¥ëœ ì°¸ê³ ë¬¸í—Œì´ ì—†ìŠµë‹ˆë‹¤.</div></div>
    </div>

    <!-- SEARCH TAB -->
    <div class="tp" id="cp-search">
      <!-- ê²€ìƒ‰ì°½ -->
      <div style="display:flex;gap:6px;margin-bottom:8px;align-items:flex-end;flex-wrap:wrap">
        <div style="flex:1;min-width:200px">
          <label class="fl">ì œëª© / ì €ì / í‚¤ì›Œë“œ</label>
          <input class="fi" id="ref-q" type="text" placeholder="ì˜ˆ) self-efficacy academic achievement Korea" onkeydown="if(event.key==='Enter')RefSearch.search()">
        </div>
        <div style="flex:0 0 auto">
          <label class="fl">ì¶œíŒì—°ë„ ì´í›„</label>
          <select class="fi" id="ref-year" style="padding:7px 8px;width:auto">
            <option value="">ì „ì²´</option>
            <option value="2020">2020~</option>
            <option value="2018">2018~</option>
            <option value="2015">2015~</option>
            <option value="2010">2010~</option>
          </select>
        </div>
        <div style="flex:0 0 auto">
          <label class="fl">ê²€ìƒ‰ DB</label>
          <select class="fi" id="ref-db" style="padding:7px 8px;width:auto">
            <option value="crossref">CrossRef (ì „ì²´)</option>
            <option value="openalex">OpenAlex (ì˜¤í”ˆì•¡ì„¸ìŠ¤)</option>
          </select>
        </div>
        <button class="btn btn-p" onclick="RefSearch.search()" style="height:36px;padding:0 16px;flex-shrink:0">ğŸ” ê²€ìƒ‰</button>
        <button class="btn btn-g btn-sm" onclick="RefSearch.openScholar()" style="height:36px;flex-shrink:0" title="Google Scholar ìƒˆ ì°½">Scholar â†—</button>
      </div>

      <!-- ìƒíƒœ/ê²°ê³¼ìˆ˜ -->
      <div id="ref-status" style="font-size:11px;color:var(--tx3);min-height:18px;margin-bottom:6px"></div>

      <!-- ê²°ê³¼ ëª©ë¡ -->
      <div id="ref-results" style="border:1px solid var(--bd);border-radius:var(--r);background:var(--bg3);min-height:80px;max-height:340px;overflow-y:auto">
        <div class="cite-empty" id="ref-placeholder">ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ê³  ğŸ” ê²€ìƒ‰ì„ ëˆ„ë¥´ì„¸ìš”.<br><span style="font-size:10px;color:var(--tx3)">CrossRef: 1ì–µ ê±´+ | OpenAlex: ì˜¤í”ˆì•¡ì„¸ìŠ¤ ë…¼ë¬¸ íŠ¹í™”</span></div>
      </div>

      <!-- í•˜ë‹¨ ì•ˆë‚´ -->
      <div style="margin-top:8px;font-size:10px;color:var(--tx3);line-height:1.7">
        âœ… <b>+ ì¶”ê°€</b> í´ë¦­ â†’ APA í˜•ì‹ìœ¼ë¡œ â‘£ ì €ì¥ëœ ëª©ë¡ì— ìë™ ì €ì¥ &nbsp;|&nbsp;
        ğŸ“‹ <b>ë³µì‚¬</b> í´ë¦­ â†’ í´ë¦½ë³´ë“œë¡œ ë³µì‚¬ &nbsp;|&nbsp;
        ê²°ê³¼ê°€ ì—†ìœ¼ë©´ <b>Scholar â†—</b>ë¡œ ì§ì ‘ ê²€ìƒ‰
      </div>
    </div>
      <button class="btn btn-g btn-sm" onclick="App.hideModal('cite-modal')">ë‹«ê¸°</button>
      <button class="btn btn-p btn-sm" id="cite-ins-btn" onclick="CM.insert()" style="display:none">âœ” ì„ íƒ í•­ëª© ì¸ìš© ì‚½ì…</button>
    </div>
  </div>
</div>

<!-- CODE MODAL (toolbar button) -->
<div class="ov" id="code-modal">
  <div class="modal" style="max-width:380px">
    <h3>ì½”ë“œ ë¸”ë¡ ì–¸ì–´ ì„ íƒ</h3>
    <div class="mb">
      <select class="fi" id="code-lang">
        <option value="">ì—†ìŒ</option><option value="python">Python</option><option value="javascript">JavaScript</option>
        <option value="typescript">TypeScript</option><option value="java">Java</option><option value="c">C</option>
        <option value="cpp">C++</option><option value="r">R</option><option value="matlab">MATLAB</option>
        <option value="sql">SQL</option><option value="bash">Bash/Shell</option><option value="latex">LaTeX</option>
        <option value="html">HTML</option><option value="css">CSS</option><option value="json">JSON</option>
        <option value="yaml">YAML</option><option value="markdown">Markdown</option>
      </select>
    </div>
    <div class="mf">
      <button class="btn btn-g btn-sm" onclick="App.hideModal('code-modal')">ì·¨ì†Œ</button>
      <button class="btn btn-p btn-sm" onclick="ED.codeBlockModal()">ì‚½ì…</button>
    </div>
  </div>
</div>

<!-- LINK MODAL -->
<div class="ov" id="link-modal">
  <div class="modal" style="max-width:420px">
    <h3>ğŸ”— ë§í¬ ì‚½ì… <span style="font-size:11px;color:var(--ac2)">(ìƒˆ íƒ­)</span></h3>
    <div class="mb">
      <div class="fg"><label class="fl">í‘œì‹œ í…ìŠ¤íŠ¸</label><input class="fi" id="link-text" type="text" placeholder="ë§í¬ í…ìŠ¤íŠ¸"></div>
      <div class="fg"><label class="fl">URL</label><input class="fi" id="link-url" type="text" placeholder="https://..."></div>
    </div>
    <div class="mf">
      <button class="btn btn-g btn-sm" onclick="App.hideModal('link-modal')">ì·¨ì†Œ</button>
      <button class="btn btn-p btn-sm" onclick="ED.link()">ì‚½ì…</button>
    </div>
  </div>
</div>

<!-- IMAGE MODAL -->
<div class="ov" id="image-modal">
  <div class="modal" style="max-width:480px">
    <h3>ğŸ–¼ ì´ë¯¸ì§€ ì‚½ì…</h3>
    <!-- Drag & Drop Zone -->
    <div id="img-dropzone" style="border:2px dashed var(--bd);border-radius:8px;padding:20px;text-align:center;margin-bottom:14px;cursor:pointer;transition:all .2s;background:var(--bg3)" onclick="document.getElementById('img-file-input').click()" ondragover="IMG.dragOver(event)" ondragleave="IMG.dragLeave(event)" ondrop="IMG.drop(event)">
      <div id="img-drop-text" style="font-size:13px;color:var(--tx2)">ğŸ–¼ ì´ë¯¸ì§€ë¥¼ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•´ì„œ ì„ íƒ</div>
      <div style="font-size:11px;color:var(--tx3);margin-top:4px">PNG, JPG, GIF, WebP ì§€ì› Â· Base64ë¡œ ìë™ ì‚½ì…</div>
      <input type="file" id="img-file-input" accept="image/*" style="display:none" onchange="IMG.fileSelected(event)">
    </div>
    <div id="img-preview-wrap" style="display:none;margin-bottom:12px;text-align:center">
      <img id="img-preview" style="max-width:100%;max-height:160px;border-radius:4px;border:1px solid var(--bd)">
    </div>
    <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px">
      <div style="flex:1;height:1px;background:var(--bd)"></div>
      <span style="font-size:11px;color:var(--tx3)">ë˜ëŠ” URL ì…ë ¥</span>
      <div style="flex:1;height:1px;background:var(--bd)"></div>
    </div>
    <div class="mb">
      <div class="fg"><label class="fl">Alt í…ìŠ¤íŠ¸</label><input class="fi" id="img-alt" type="text" placeholder="ì´ë¯¸ì§€ ì„¤ëª…"></div>
      <div class="fg"><label class="fl">URL ë˜ëŠ” ê²½ë¡œ</label><input class="fi" id="img-url" type="text" placeholder="https://..."></div>
    </div>
    <div class="mf">
      <button class="btn btn-g btn-sm" onclick="App.hideModal('image-modal')">ì·¨ì†Œ</button>
      <button class="btn btn-p btn-sm" onclick="ED.image()">ì‚½ì…</button>
    </div>
  </div>
</div>

<!-- COLOR PICKER MODAL -->
<!-- SCHOLAR SEARCH MODAL -->
<div class="ov" id="scholar-modal">
  <div class="modal" style="max-width:520px">
    <h3>ğŸ” Google Scholar ê²€ìƒ‰</h3>
    <div class="fg">
      <label class="fl">ê²€ìƒ‰ì–´ (ë…¼ë¬¸ ì œëª©, ì €ì, í‚¤ì›Œë“œ ë“±)</label>
      <div style="display:flex;gap:7px">
        <input class="fi" id="scholar-q" type="text" placeholder="ì˜ˆ) structural equation modeling education Korea" style="flex:1" onkeydown="if(event.key==='Enter')Scholar.search()">
        <button class="btn btn-p" onclick="Scholar.search()" style="white-space:nowrap">ê²€ìƒ‰ â†’</button>
      </div>
    </div>
    <div class="fg">
      <label class="fl">ê²€ìƒ‰ ì˜µì…˜</label>
      <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
        <label style="font-size:12px;color:var(--tx2)">ì–¸ì–´:</label>
        <select id="scholar-lang" class="fi" style="width:auto;padding:4px 8px">
          <option value="ko">í•œêµ­ì–´ ìš°ì„ </option>
          <option value="">ì „ì²´</option>
          <option value="en">ì˜ì–´ ìš°ì„ </option>
        </select>
        <label style="font-size:12px;color:var(--tx2)">ê¸°ê°„:</label>
        <select id="scholar-year" class="fi" style="width:auto;padding:4px 8px">
          <option value="">ì „ì²´ ê¸°ê°„</option>
          <option value="2024">2024ë…„~</option>
          <option value="2022">2022ë…„~</option>
          <option value="2020">2020ë…„~</option>
          <option value="2015">2015ë…„~</option>
          <option value="2010">2010ë…„~</option>
        </select>
        <label style="display:flex;align-items:center;gap:4px;font-size:12px;color:var(--tx2);cursor:pointer">
          <input type="checkbox" id="scholar-review" style="accent-color:var(--ac)"> ë¦¬ë·° ë…¼ë¬¸ë§Œ
        </label>
      </div>
    </div>
    <div style="font-size:11px;color:var(--tx3);margin-bottom:10px;line-height:1.6">
      ğŸ’¡ ê²€ìƒ‰ ê²°ê³¼ëŠ” <b>Google Scholar ìƒˆ ì°½</b>ì—ì„œ ì—´ë¦½ë‹ˆë‹¤.<br>
      ë…¼ë¬¸ ì œëª© í´ë¦­ â†’ ì¸ìš© ë²„íŠ¼ â†’ APA ë³µì‚¬ â†’ ğŸ“š References íƒ­ì— ë¶™ì—¬ë„£ê¸°
    </div>
    <div class="fg" id="scholar-recent-wrap" style="display:none">
      <label class="fl">ìµœê·¼ ê²€ìƒ‰ì–´</label>
      <div id="scholar-recent" style="display:flex;gap:5px;flex-wrap:wrap"></div>
    </div>
    <div class="mf">
      <button class="btn btn-g btn-sm" onclick="Scholar.clear()">ê²€ìƒ‰ì–´ ì´ˆê¸°í™”</button>
      <button class="btn btn-g btn-sm" onclick="App.hideModal('scholar-modal')">ë‹«ê¸°</button>
      <button class="btn btn-p btn-sm" onclick="Scholar.search()">ğŸ” Scholar ê²€ìƒ‰</button>
    </div>
  </div>
</div>

<div class="ov" id="color-modal">
  <div class="modal" style="max-width:400px">
    <h3 id="color-modal-title">ê¸€ì ìƒ‰ìƒ ì„¤ì •</h3>
    <div class="fg">
      <label class="fl">ë¹ ë¥¸ ì„ íƒ</label>
      <div class="csw-row" id="color-swatches"></div>
    </div>
    <div class="fg">
      <div style="display:flex;gap:6px;align-items:center">
        <div style="flex:1">
          <label class="fl">ì§ì ‘ ì…ë ¥ (Hex ë˜ëŠ” ìƒ‰ìƒëª…)</label>
          <input class="fi" id="color-hex" type="text" placeholder="#ff0000" style="font-family:var(--fm)" oninput="ColorPicker.updatePreview(this.value)">
        </div>
        <!-- ë„¤ì´í‹°ë¸Œ color input (hidden) -->
        <div style="display:flex;flex-direction:column;align-items:center;gap:3px;flex-shrink:0;margin-top:14px">
          <label id="eyedrop-btn" class="btn btn-g btn-sm" style="cursor:pointer;padding:5px 8px;display:flex;flex-direction:column;align-items:center;gap:2px" title="ìŠ¤í¬ì´ë“œ / ìƒ‰ìƒ íŒ”ë ˆíŠ¸">
            <span style="font-size:16px">ğŸ¨</span>
            <span style="font-size:9px">íŒ”ë ˆíŠ¸</span>
            <input type="color" id="color-native" style="position:absolute;opacity:0;width:0;height:0;pointer-events:none" oninput="ColorPicker.fromNative(this.value)" onchange="ColorPicker.fromNative(this.value)">
          </label>
          <button id="eyedropper-btn" class="btn btn-g btn-sm" style="padding:5px 8px;display:flex;flex-direction:column;align-items:center;gap:2px" onclick="ColorPicker.eyedrop()" title="í™”ë©´ì—ì„œ ìƒ‰ìƒ ì¶”ì¶œ (ìŠ¤í¬ì´ë“œ)">
            <span style="font-size:16px">ğŸ’‰</span>
            <span style="font-size:9px">ìŠ¤í¬ì´ë“œ</span>
          </button>
        </div>
      </div>
    </div>
    <div style="display:flex;align-items:center;gap:10px;margin-bottom:12px">
      <label class="fl" style="margin:0;flex-shrink:0">ë¯¸ë¦¬ë³´ê¸°:</label>
      <div id="color-preview" style="flex:1;padding:5px 12px;border-radius:4px;font-size:13px;border:1px solid var(--bd);transition:all .15s">ìƒ˜í”Œ í…ìŠ¤íŠ¸ / Sample Text</div>
    </div>
    <div id="eyedrop-support-msg" style="font-size:10px;color:var(--tx3);margin-bottom:8px;display:none">âš  ìŠ¤í¬ì´ë“œëŠ” Chrome/Edgeì—ì„œë§Œ ì§€ì›ë©ë‹ˆë‹¤.</div>
    <div class="mf">
      <button class="btn btn-g btn-sm" onclick="App.hideModal('color-modal')">ì·¨ì†Œ</button>
      <button class="btn btn-p btn-sm" onclick="App.applyColor()">ì ìš©</button>
    </div>
  </div>
</div>

<!-- CAPTION MODAL -->
<div class="ov" id="caption-modal">
  <div class="modal" style="max-width:520px">
    <h3 id="cap-title">í‘œ ìº¡ì…˜ ì‚½ì…</h3>
    <div class="fg">
      <label class="fl">í˜•ì‹ ì„ íƒ (í´ë¦­ìœ¼ë¡œ ì„ íƒ)</label>
      <div id="cap-opts" style="display:flex;gap:6px;flex-wrap:wrap;margin-top:4px"></div>
    </div>
    <div style="display:flex;gap:10px;margin-bottom:10px">
      <div class="fg" style="flex:0 0 80px">
        <label class="fl">ë²ˆí˜¸</label>
        <input class="fi" id="cap-num" type="text" placeholder="1" oninput="App.updateCapPreview()">
      </div>
      <div class="fg" style="flex:1">
        <label class="fl">ì„¤ëª… / ì œëª©</label>
        <input class="fi" id="cap-desc" type="text" placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”" oninput="App.updateCapPreview()">
      </div>
    </div>
    <div class="fg">
      <label class="fl">ë¯¸ë¦¬ë³´ê¸°</label>
      <div id="cap-preview" style="background:var(--bg3);border:1px solid var(--bd);border-radius:var(--r);padding:8px 12px;font-family:var(--fm);font-size:12px;color:var(--tx);min-height:28px"></div>
    </div>
    <div class="mf">
      <button class="btn btn-g btn-sm" onclick="App.hideModal('caption-modal')">ì·¨ì†Œ</button>
      <button class="btn btn-p btn-sm" onclick="App.insertCaption()">ì‚½ì…</button>
    </div>
  </div>
</div>

<!-- TEMPLATE MODAL -->
<div class="ov" id="tmpl-modal">
  <div class="modal lg">
    <h3>ğŸ“‹ ë…¼ë¬¸ ì–‘ì‹ ì„ íƒ</h3>
    <p style="font-size:12px;color:var(--tx2);margin-bottom:14px">ì„ íƒí•˜ë©´ ì—ë””í„°ì— êµ¬ì¡°ê°€ ìë™ ì‚½ì…ë©ë‹ˆë‹¤. ê¸°ì¡´ ë‚´ìš©ì€ ìœ ì§€ë©ë‹ˆë‹¤.</p>
    <div class="tmpl-grid" id="tmpl-grid"></div>
    <div class="mf"><button class="btn btn-g btn-sm" onclick="App.hideModal('tmpl-modal')">ë‹«ê¸°</button></div>
  </div>
</div>

<!-- FORMAT QUICK PANEL (Alt+L) -->
<div id="fmt-panel">
  <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px">
    <h4 style="font-size:13px;font-weight:600;color:var(--txh);margin:0">âœï¸ ì„œì‹ ì„¤ì • <span style="font-size:10px;color:var(--tx3);font-weight:400">Alt+L</span></h4>
    <button class="btn-ic" onclick="FP.hide()" style="font-size:14px">âœ•</button>
  </div>
  <!-- font size -->
  <div class="fmt-row">
    <span class="fmt-lbl">ê¸€ì í¬ê¸°</span>
    <button class="btn btn-g btn-sm" style="padding:2px 8px;font-size:13px;font-weight:700" onclick="FP.fsz(-1)">âˆ’</button>
    <select id="fp-fsize" class="fi" style="flex:1;padding:3px 6px;font-size:12px" onchange="FP.applyFsize()">
      <option>8pt</option><option>9pt</option><option>10pt</option><option>11pt</option>
      <option selected>12pt</option><option>13pt</option><option>14pt</option><option>15pt</option>
      <option>16pt</option><option>18pt</option><option>20pt</option><option>22pt</option>
      <option>24pt</option><option>28pt</option><option>32pt</option><option>36pt</option><option>40pt</option><option>48pt</option><option>50pt</option>
    </select>
    <button class="btn btn-g btn-sm" style="padding:2px 8px;font-size:13px;font-weight:700" onclick="FP.fsz(1)">+</button>
  </div>
  <!-- font color -->
  <div class="fmt-row">
    <span class="fmt-lbl">ê¸€ì ìƒ‰</span>
    <div style="display:flex;gap:4px;flex-wrap:wrap;flex:1">
      <input type="color" id="fp-fc" value="#e8e8f0" style="width:30px;height:26px;border:none;border-radius:4px;cursor:pointer;background:none;padding:0" onchange="FP.applyColor()">
      <div style="display:flex;gap:3px;flex-wrap:wrap">
        <div class="csw" style="background:#e8e8f0" onclick="FP.setFc('#e8e8f0')" title="í°ìƒ‰ê³„"></div>
        <div class="csw" style="background:#ff4444" onclick="FP.setFc('#ff4444')" title="ë¹¨ê°•"></div>
        <div class="csw" style="background:#ff8800" onclick="FP.setFc('#ff8800')" title="ì£¼í™©"></div>
        <div class="csw" style="background:#ffcc00" onclick="FP.setFc('#ffcc00')" title="ë…¸ë‘"></div>
        <div class="csw" style="background:#44cc44" onclick="FP.setFc('#44cc44')" title="ì´ˆë¡"></div>
        <div class="csw" style="background:#00aaff" onclick="FP.setFc('#00aaff')" title="íŒŒë‘"></div>
        <div class="csw" style="background:#aa44ff" onclick="FP.setFc('#aa44ff')" title="ë³´ë¼"></div>
        <div class="csw" style="background:#ff44aa" onclick="FP.setFc('#ff44aa')" title="í•‘í¬"></div>
        <div class="csw" style="background:#333333" onclick="FP.setFc('#333333')" title="ê²€ì •"></div>
        <div class="csw" style="background:#5b4ce4" onclick="FP.setFc('#5b4ce4')" title="ì¸ë””ê³ "></div>
      </div>
    </div>
  </div>
  <!-- highlight -->
  <div class="fmt-row">
    <span class="fmt-lbl">í˜•ê´‘íœ</span>
    <div style="display:flex;gap:4px;flex-wrap:wrap;flex:1">
      <input type="color" id="fp-hl" value="#fff176" style="width:30px;height:26px;border:none;border-radius:4px;cursor:pointer;background:none;padding:0" onchange="FP.applyHL()">
      <div style="display:flex;gap:3px;flex-wrap:wrap">
        <div class="csw" style="background:#fff176" onclick="FP.setHL('#fff176')" title="ë…¸ë‘"></div>
        <div class="csw" style="background:#ffcc80" onclick="FP.setHL('#ffcc80')" title="ì˜¤ë Œì§€"></div>
        <div class="csw" style="background:#ef9a9a" onclick="FP.setHL('#ef9a9a')" title="ë¹¨ê°•"></div>
        <div class="csw" style="background:#80cbc4" onclick="FP.setHL('#80cbc4')" title="ë¯¼íŠ¸"></div>
        <div class="csw" style="background:#a5d6a7" onclick="FP.setHL('#a5d6a7')" title="ì´ˆë¡"></div>
        <div class="csw" style="background:#90caf9" onclick="FP.setHL('#90caf9')" title="íŒŒë‘"></div>
        <div class="csw" style="background:#ce93d8" onclick="FP.setHL('#ce93d8')" title="ë³´ë¼"></div>
        <div class="csw" style="background:#f48fb1" onclick="FP.setHL('#f48fb1')" title="í•‘í¬"></div>
        <div class="csw" style="background:#ffecb3" onclick="FP.setHL('#ffecb3')" title="ì—°ë…¸ë‘"></div>
        <div class="csw" style="background:repeating-linear-gradient(45deg,#888,#888 2px,transparent 2px,transparent 6px);border:1px solid #888" onclick="FP.setHL('none')" title="ì—†ìŒ"></div>
      </div>
    </div>
  </div>
  <div style="text-align:right;margin-top:4px">
    <button class="btn btn-g btn-sm" onclick="FP.hide()">ë‹«ê¸°</button>
  </div>
</div>

<div id="tooltip"></div>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   UNDO STACK
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const US=(()=>{
  const MAX=500;let st=[],ptr=-1;
  const snap=()=>{const e=el('editor');push(e.value,[e.selectionStart,e.selectionEnd])};
  function push(v,s){st=st.slice(0,ptr+1);st.push({v,s});if(st.length>MAX)st.shift();else ptr++}
  function undo(){if(ptr<=0)return;ptr--;const s=st[ptr];el('editor').value=s.v;el('editor').setSelectionRange(s.s[0],s.s[1]);App.render()}
  function redo(){if(ptr>=st.length-1)return;ptr++;const s=st[ptr];el('editor').value=s.v;el('editor').setSelectionRange(s.s[0],s.s[1]);App.render()}
  return{snap,undo,redo};
})();

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HELPERS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function el(id){return document.getElementById(id)}
function ins(ed,s,e,text){ed.value=ed.value.substring(0,s)+text+ed.value.substring(e);const p=s+text.length;ed.setSelectionRange(p,p);ed.focus();App.render();US.snap()}
function getCL(ed){const pos=ed.selectionStart,bef=ed.value.substring(0,pos);const ls=bef.lastIndexOf('\n')+1,aft=ed.value.substring(pos);const le=pos+(aft.indexOf('\n')===-1?aft.length:aft.indexOf('\n'));return{ls,le,text:ed.value.substring(ls,le)}}
function repCL(ed,t){const{ls,le}=getCL(ed);ed.value=ed.value.substring(0,ls)+t+ed.value.substring(le);const p=ls+t.length;ed.setSelectionRange(p,p);ed.focus();App.render();US.snap()}
function dlBlob(content,filename,type){const a=document.createElement('a');a.href=URL.createObjectURL(new Blob([content],{type}));a.download=filename;a.click()}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MARKED SETUP â€” links new tab
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
marked.setOptions({breaks:true,gfm:true});
const _r=new marked.Renderer();
_r.heading=(text,level)=>{const id='h-'+text.toLowerCase().replace(/[^a-z0-9ê°€-í£\s]/g,'').replace(/\s+/g,'-').substring(0,50);return`<h${level} id="${id}">${text}</h${level}>`;};
_r.link=(href,title,text)=>`<a href="${href}"${title?` title="${title}"`:''} target="_blank" rel="noopener noreferrer">${text}</a>`;
marked.use({renderer:_r});
function mdRender(md,showFootnotes){
  try{
    // Process footnotes: highlight [^n] references and collect definitions
    let fnDefs={};let fnCounter=0;
    // Collect footnote definitions [^n]: text
    md=md.replace(/^\[\^([^\]]+)\]:\s*(.+)$/gm,(m,key,text)=>{fnDefs[key]=text;return'__FN_DEF_'+key+'__'});
    // Replace inline [^n] with highlighted spans
    md=md.replace(/\[\^([^\]]+)\]/g,(m,key)=>{
      fnCounter++;
      return`<sup class="footnote-highlight" title="${fnDefs[key]||''}">[${fnCounter}]</sup>`;
    });
    // Remove def placeholders (they'll be added to footnotes section)
    md=md.replace(/__FN_DEF_[^_]+__\n?/g,'');
    // ** ì‚¬ì´ì— (), [], ë“± íŠ¹ìˆ˜ë¬¸ìê°€ ìˆìœ¼ë©´ markedê°€ íŒŒì‹± ëª»í•˜ë¯€ë¡œ <b>ë¡œ ì„ ë³€í™˜
    md=md.replace(/\*\*([^*\n]*[()[\]{}][^*\n]*)\*\*/g,(m,inner)=>`<b>${inner}</b>`);
    let html=marked.parse(md||'');
    // Append footnotes section if there are definitions and showFootnotes is not false
    if(Object.keys(fnDefs).length>0 && showFootnotes!==false){
      let fnHtml='<div class="footnotes-section">';
      let i=1;
      Object.entries(fnDefs).forEach(([k,v])=>{fnHtml+=`<div class="footnote-def"><sup>[${i}]</sup> ${v}</div>`;i++});
      fnHtml+='</div>';
      html+=fnHtml;
    }
    return html;
  }catch(e){return`<p style="color:red">${e.message}</p>`;}
}
/* PAGE SPLIT */
function splitPages(md){const p=md.replace(/\r\n/g,'\n').split(/\n?<div class="page-break"><\/div>\n?/);return p.length?p:[md]}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PREVIEW RENDERER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const PR={
  rm:false,
  /* ë‹¨ë½(p)ì—ë§Œ ì—°ì† ë²ˆí˜¸ ì‚½ì… â€” ì œëª©Â·í‘œÂ·ì½”ë“œÂ·ì¸ìš© ì œì™¸ */
  _applyRM(container){
    /* ê¸°ì¡´ ë²ˆí˜¸ ì œê±° */
    container.querySelectorAll('.rm-ln').forEach(n=>n.remove());
    if(!this.rm)return;
    let n=1;
    container.querySelectorAll('.preview-page').forEach(page=>{
      /* ì§ê³„ pë§Œ ëŒ€ìƒ (blockquote>p, li>p ë“± ì¤‘ì²© ì œì™¸) */
      page.querySelectorAll(':scope>p, :scope>section>p').forEach(p=>{
        const span=document.createElement('span');
        span.className='rm-ln';
        span.textContent=n++;
        span.setAttribute('aria-hidden','true');
        p.insertBefore(span,p.firstChild);
      });
    });
  },
  render(md,showFootnotes){
    if(showFootnotes===undefined)showFootnotes=true;
    const c=el('preview-container');const pages=splitPages(md);c.innerHTML='';
    pages.forEach((p,i)=>{
      const div=document.createElement('div');
      div.className='preview-page'+(this.rm?' rm':'');div.dataset.page=i+1;
      div.innerHTML=mdRender(p,showFootnotes);
      div.querySelectorAll('a').forEach(a=>{a.target='_blank';a.rel='noopener noreferrer'});
      c.appendChild(div);
    });
    this._applyRM(c);
    if(window.MathJax)MathJax.typesetPromise([c]).catch(()=>{});
    el('pg-cnt').textContent=`1 / ${pages.length}`;
    /* ìŠ¤í¬ë¡¤ ì‹œ í˜„ì¬ í˜ì´ì§€ ë²ˆí˜¸ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ */
    const _pcEl=el('preview-container');
    if(_pcEl && !_pcEl._pgScrollBound){
      _pcEl._pgScrollBound=true;
      _pcEl.addEventListener('scroll',()=>{
        const scrollPages=[...document.querySelectorAll('#preview-container .preview-page')];
        if(!scrollPages.length)return;
        const mid=_pcEl.scrollTop+_pcEl.clientHeight*0.3;
        let cur=0;
        for(let i=0;i<scrollPages.length;i++){
          if(scrollPages[i].offsetTop<=mid)cur=i;
        }
        el('pg-cnt').textContent=`${cur+1} / ${scrollPages.length}`;
      },{passive:true});
    }
    if(typeof A4Ruler!=='undefined') A4Ruler.refresh();
    if(typeof PV!=='undefined') PV.refresh();
  }
};

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PV â€” ë¯¸ë¦¬ë³´ê¸° í™•ëŒ€/ì¶•ì†Œ + PPT ëª¨ë“œ
   PPT ëª¨ë“œ: 245% í™•ëŒ€ + scroll-snapìœ¼ë¡œ í˜ì´ì§€ ë‹¨ìœ„ ì´ë™
   â†‘â†“ í‚¤, â—€â–¶ ë²„íŠ¼ìœ¼ë¡œ í˜ì´ì§€ ì´ë™
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const PV = (() => {
  let scale = 1.0;
  const STEP = 0.15, MIN = 0.4, MAX = 3.0;
  let pptOn = false;
  let pptIdx = 0;
  let _keyBound = false;

  let _pvFontPt = 11; /* ë‚´ë¶€ PV í°íŠ¸ í¬ê¸°(pt) */

  function setScale(s) {
    scale = Math.min(MAX, Math.max(MIN, Math.round(s * 100) / 100));
    const pc = el('preview-container');
    pc.style.setProperty('--pv-scale', scale);
    el('pv-zoom-lbl').textContent = Math.round(scale * 100) + '%';
    const fontPx = Math.round(_pvFontPt * (96/72));
    pc.querySelectorAll('.preview-page').forEach(p => {
      if (scale === 1) {
        p.style.transform = ''; p.style.transformOrigin = ''; p.style.marginBottom = '';
      } else {
        p.style.transformOrigin = 'top center';
        p.style.transform = `scale(${scale})`;
        const baseH = p.offsetHeight;
        p.style.marginBottom = (16 + baseH * (scale - 1)) + 'px';
      }
      p.style.fontSize = fontPx + 'px';
      p.style.lineHeight = '1.8'; /* í°íŠ¸ ë³€ê²½ ì‹œ ì¤„ê°„ê²© ìœ ì§€ */
    });
    _updateFontLbl();
  }

  function _updateFontLbl(){
    const lbl=el('pv-font-lbl');
    if(lbl) lbl.textContent=_pvFontPt+'pt';
  }

  function fontUp(){
    _pvFontPt=Math.min(24,_pvFontPt+1);
    if(pptOn){
      const pane=el('preview-pane');
      const vw=pane.clientWidth;
      const ratio=vw/Math.round(210*(96/25.4));
      const fontPx=Math.round(_pvFontPt*(96/72)*ratio);
      el('preview-container').querySelectorAll('.preview-page').forEach(p=>{
        p.style.fontSize=fontPx+'px'; p.style.lineHeight='1.8';
      });
    } else { setScale(scale); }
    _updateFontLbl();
  }
  function fontDown(){
    _pvFontPt=Math.max(6,_pvFontPt-1);
    if(pptOn){
      const pane=el('preview-pane');
      const vw=pane.clientWidth;
      const ratio=vw/Math.round(210*(96/25.4));
      const fontPx=Math.round(_pvFontPt*(96/72)*ratio);
      el('preview-container').querySelectorAll('.preview-page').forEach(p=>{
        p.style.fontSize=fontPx+'px'; p.style.lineHeight='1.8';
      });
    } else { setScale(scale); }
    _updateFontLbl();
  }

  /* ë¯¸ë¦¬ë³´ê¸° íŒ¨ë„ ë„ˆë¹„ì— ë§ê²Œ ìë™ fit */
  function fitToPane() {
    const pc = el('preview-container');
    const pages = [...pc.querySelectorAll('.preview-page')];
    if (!pages.length) return;
    const origW = pages[0].offsetWidth / scale; /* í˜„ì¬ scale ì œê±°í•œ ì›ë³¸ ë„ˆë¹„ */
    const avail = pc.clientWidth - 32;          /* ì¢Œìš° íŒ¨ë”© ê°ì•ˆ */
    if (avail <= 0) return;
    const fit = Math.floor((avail / origW) * 100) / 100;
    setScale(Math.max(MIN, Math.min(MAX, fit)));
  }

  /* PPT ëª¨ë“œ ì „ìš© zoom: í˜ì´ì§€ width/padding/minHeight ë¹„ë¡€ ì¡°ì • */
  function _pptZoom(delta) {
    const pane = el('preview-pane');
    const pc   = el('preview-container');
    const pages = getPages();
    if (!pages.length) return;
    const MM = 96/25.4;
    const origPx = Math.round(210*MM);
    /* í˜„ì¬ pane ë„ˆë¹„ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ratio ì‚°ì¶œ í›„ delta ì ìš© */
    const curW = parseFloat(pages[0].style.width) || pane.clientWidth;
    const newW = Math.round(Math.max(pane.clientWidth * 0.5,
                            Math.min(pane.clientWidth * 2.0, curW + delta * origPx)));
    const ratio = newW / origPx;
    const fontPx=Math.round(_pvFontPt*(96/72)*ratio);
    pages.forEach(p => {
      p.style.width      = newW + 'px';
      p.style.padding    = Math.round(22*MM*ratio)+'px '+Math.round(18*MM*ratio)+'px';
      p.style.minHeight  = Math.round(297*MM*ratio) + 'px';
      p.style.fontSize   = fontPx + 'px';
      p.style.lineHeight = '1.8';
    });
    el('pv-zoom-lbl').textContent = Math.round(ratio*100) + '%';
  }

  function zoomIn()  { if (pptOn) { _pptZoom(+STEP); } else { setScale(scale + STEP); } }
  function zoomOut() { if (pptOn) { _pptZoom(-STEP); } else { setScale(scale - STEP); } }

  /* PPT ëª¨ë“œ */
  function getPages() {
    return [...el('preview-container').querySelectorAll('.preview-page')];
  }

  function pptGo(idx) {
    const pages = getPages();
    if (!pages.length) return;
    pptIdx = Math.max(0, Math.min(pages.length - 1, idx));
    /* PPT ëª¨ë“œ: preview-container ìŠ¤í¬ë¡¤ (scrollIntoViewëŠ” ë¶€ëª¨ê°€ overflow:autoì¼ ë•Œ ì •í™•íˆ ì‘ë™) */
    const pc = el('preview-container');
    const target = pages[pptIdx];
    pc.scrollTo({ top: target.offsetTop, behavior: 'smooth' });
    el('ppt-pg').textContent = `${pptIdx + 1} / ${pages.length}`;
  }

  /* PPT ë·°í¬íŠ¸ ë‹¨ìœ„ ì´ë™ (ë‚´ë¶€ íŒ¨ë„ìš©) */
  function pptStep(dir) {
    const pc = el('preview-container');
    const vh = pc.clientHeight;
    let next = pc.scrollTop + dir * vh;
    next = Math.max(0, next);
    /* í˜ì´ì§€ ìƒë‹¨ snap */
    getPages().forEach(p => {
      if (Math.abs(next - p.offsetTop) < vh * 0.18) next = p.offsetTop;
    });
    next = Math.min(next, pc.scrollHeight - pc.clientHeight);
    pc.scrollTo({ top: next, behavior: 'smooth' });
    /* í˜ì´ì§€ ë²ˆí˜¸ ê°±ì‹  */
    setTimeout(() => {
      const mid = pc.scrollTop + vh / 2;
      let best = 0, bestD = Infinity;
      getPages().forEach((p, i) => {
        const d = Math.abs(p.offsetTop + p.offsetHeight / 2 - mid);
        if (d < bestD) { bestD = d; best = i; }
      });
      pptIdx = best;
      el('ppt-pg').textContent = `${best + 1} / ${getPages().length}`;
    }, 350);
  }

  function pptPrev() { pptOn ? pptStep(-1) : pptGo(pptIdx - 1); }
  function pptNext() { pptOn ? pptStep(1)  : pptGo(pptIdx + 1); }

  function togglePPT() {
    pptOn = !pptOn;
    const pane = el('preview-pane');
    const btn  = el('ppt-btn');
    const nav  = el('ppt-nav');

    if (pptOn) {
      /* PPT ì§„ì…:
         1. View ëª¨ë“œë¡œ ìë™ ì „í™˜ (ë¯¸ë¦¬ë³´ê¸° íŒ¨ë„ ìµœëŒ€í™”)
         2. transform ëŒ€ì‹  widthë¥¼ íŒ¨ë„ ë„ˆë¹„ì— ë§ê²Œ ì§ì ‘ í™•ëŒ€
         3. pv-hdr í•­ìƒ ìœ„ì— ìœ ì§€ */
      App.setView('preview');

      pane.classList.add('ppt-mode');
      btn.textContent  = 'ğŸ¬ ì¢…ë£Œ';
      btn.style.background = 'rgba(240,192,96,.28)';
      btn.style.color = '#ffe090';
      btn.style.borderColor = '#f0c060';
      nav.classList.add('vis');

      /* íŒ¨ë„ì´ ë Œë” ì™„ë£Œëœ ë’¤ fit ì ìš© */
      setTimeout(() => {
        const pages = getPages();
        if (!pages.length) return;
        /* íŒ¨ë„ ë‚´ìš© ì˜ì—­ ë„ˆë¹„ (pv-hdr ë„ˆë¹„ = pane ë„ˆë¹„) */
        const vw = pane.clientWidth;
        const MM = 96/25.4;
        const origPx = Math.round(210*MM); /* A4 210mm px */
        const ratio = vw / origPx;
        const pc = el('preview-container');

        pages.forEach(p => {
          p.style.transform = 'none';
          p.style.transformOrigin = '';
          p.style.width = vw + 'px';
          p.style.padding = Math.round(22*MM*ratio)+'px '+Math.round(18*MM*ratio)+'px';
          p.style.minHeight = Math.round(297*MM*ratio) + 'px';
          p.style.marginBottom = '0';
          p.style.boxSizing = 'border-box';
        });
        /* preview-container í°íŠ¸ ë¹„ë¡€ í™•ëŒ€ (_pvFontPt ë°˜ì˜) */
        const fontPx=Math.round(_pvFontPt*(96/72)*ratio);
        pages.forEach(p=>{ p.style.fontSize=fontPx+'px'; p.style.lineHeight='1.8'; });
        el('pv-zoom-lbl').textContent = Math.round(ratio*100) + '%';

        pptIdx = 0;
        pc.scrollTop = 0;
        setTimeout(() => pptGo(0), 60);
      }, 80);

      if (!_keyBound) {
        _keyBound = true;
        document.addEventListener('keydown', _pptKey, true);
      }
    } else {
      /* PPT ì¢…ë£Œ: ìŠ¤íƒ€ì¼ ë³µêµ¬ */
      const drawExt=document.getElementById('pv-draw-ext');
      if(drawExt)drawExt.style.display='none';
      pane.classList.remove('ppt-mode');
      btn.textContent = 'ğŸ¬ PPT';
      btn.style.background = '';
      btn.style.color = '';
      btn.style.borderColor = '';
      nav.classList.remove('vis');

      const pc = el('preview-container');
      getPages().forEach(p => {
        p.style.transform='';p.style.transformOrigin='';
        p.style.width='';p.style.padding='';
        p.style.minHeight='';p.style.marginBottom='';
        p.style.boxSizing='';p.style.fontSize='';p.style.lineHeight='';
      });
      pc.style.fontSize='';
      setScale(1.0);
    }
  }

  /* capture ë‹¨ê³„ì—ì„œ ì¡ì•„ì•¼ ì—ë””í„°/ë‹¤ë¥¸ ìš”ì†Œ í¬ì»¤ìŠ¤ì— ë¬´ê´€í•˜ê²Œ ì‘ë™ */
  function _pptKey(e) {
    if (!pptOn) return;
    if (e.key === 'ArrowDown' || e.key === 'PageDown') { e.preventDefault(); e.stopPropagation(); pptNext(); }
    else if (e.key === 'ArrowUp' || e.key === 'PageUp') { e.preventDefault(); e.stopPropagation(); pptPrev(); }
    else if (e.key === 'Escape') { e.preventDefault(); e.stopPropagation(); togglePPT(); }
    else if(e.key>='1'&&e.key<='6'){e.preventDefault();IPPT.handleKey(e.key);}
  }

  /* â”€â”€ Dark í…Œë§ˆ â”€â”€ */
  let _darkOn = false;
  function toggleDark() {
    _darkOn = !_darkOn;
    const pc  = el('preview-container');
    const btn = el('pv-dark-btn');
    pc.classList.toggle('pv-dark', _darkOn);
    if (_darkOn) {
      btn.textContent = 'â˜€ Light';
      btn.style.background = 'rgba(100,160,255,.2)';
      btn.style.color = '#7ab8ff';
      btn.style.borderColor = '#5090ff';
    } else {
      btn.textContent = 'â—‘ Dark';
      btn.style.background = '';
      btn.style.color = '#7ab8ff';
      btn.style.borderColor = 'rgba(100,160,255,.3)';
    }
  }

  /* ë Œë” í›„ scale ìœ ì§€. ì²« ë Œë” ì‹œì—ëŠ” ì°½ì— ë§ê²Œ ìë™ fit */
  let _firstRender = true;
  function refresh() {
    if (_firstRender) {
      _firstRender = false;
      /* ë‹¤ìŒ í”„ë ˆì„ì— ì¸¡ì • (DOM ë°˜ì˜ í›„) */
      requestAnimationFrame(() => fitToPane());
      return;
    }
    if (pptOn) {
      /* PPT ëª¨ë“œ ì¤‘ ì¬ë Œë”: ìŠ¤íƒ€ì¼ ì¬ì ìš© */
      setTimeout(() => {
        const pane = el('preview-pane');
        const vw = pane.clientWidth;
        const MM = 96/25.4;
        const origPx = Math.round(210*MM);
        const ratio = vw / origPx;
        const fontPx=Math.round(_pvFontPt*(96/72)*ratio);
        getPages().forEach(p => {
          p.style.width = vw + 'px';
          p.style.padding = Math.round(22*MM*ratio)+'px '+Math.round(18*MM*ratio)+'px';
          p.style.minHeight = Math.round(297*MM*ratio) + 'px';
          p.style.marginBottom = '0';
          p.style.boxSizing = 'border-box';
          p.style.fontSize = fontPx+'px';
          p.style.lineHeight = '1.8';
        });
        el('ppt-pg').textContent = `${pptIdx + 1} / ${getPages().length}`;
      }, 50);
      return;
    }
    if (scale !== 1.0) setScale(scale);
  }

  return { zoomIn, zoomOut, fitToPane, fontUp, fontDown, togglePPT, pptPrev, pptNext, refresh, toggleDark };
})();

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   IPPT â€” ë‚´ë¶€ PV PPT ë“œë¡œì‰ íŒ”ë ˆíŠ¸
   (ppt-nav ë‚´ ë²„íŠ¼ìœ¼ë¡œ ì œì–´)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const IPPT = (() => {
  let tool='laser', penColor='#e63030', penSize=4;
  let hlColor='#ffe040', hlSize=18, hlAlpha=0.40;
  let drawing=false;
  let canvas, ctx, laserDot, container;
  let _init=false;

  function init(){
    if(!_init){
      _init=true;
      canvas=document.getElementById('ippt-canvas');
      laserDot=document.getElementById('ippt-laser');
      container=document.getElementById('preview-container');
      if(!canvas||!container)return;

      /* ì´ë²¤íŠ¸: ì»¨í…Œì´ë„ˆ ê¸°ì¤€ ì¢Œí‘œ ì‚¬ìš© */
      document.addEventListener('mousemove',onMove);
      canvas.addEventListener('mousedown',onDown);
      document.addEventListener('mouseup',onUp);
    }
    /* ìº”ë²„ìŠ¤ í¬ê¸°ëŠ” ë§¤ë²ˆ show() ì‹œ ê°±ì‹  (PPT ëª¨ë“œì—ì„œ í¬ê¸°ê°€ ë°”ë€Œë¯€ë¡œ) */
    _resizeCanvas();
  }

  function _resizeCanvas(){
    if(!canvas||!container)return;
    const w=container.scrollWidth||container.clientWidth;
    const h=container.scrollHeight||container.clientHeight;
    if(canvas.width===w&&canvas.height===h)return; /* ë³€í™” ì—†ìœ¼ë©´ ìŠ¤í‚µ */
    const tmp=document.createElement('canvas');
    tmp.width=canvas.width; tmp.height=canvas.height;
    if(ctx) tmp.getContext('2d').drawImage(canvas,0,0);
    canvas.width=w; canvas.height=h;
    canvas.style.width=w+'px'; canvas.style.height=h+'px';
    ctx=canvas.getContext('2d');
    if(tmp.width>0) ctx.drawImage(tmp,0,0);
    /* ResizeObserverëŠ” ìµœì´ˆ 1íšŒë§Œ ë“±ë¡ */
    if(!_resizeObserver){
      _resizeObserver=new ResizeObserver(()=>_resizeCanvas());
      _resizeObserver.observe(container);
    }
  }
  let _resizeObserver=null;

  function _updHlUI(){
    const sl=document.getElementById('ippt-hl-size-lbl');
    const al=document.getElementById('ippt-hl-alpha-lbl');
    if(sl)sl.textContent=hlSize;
    if(al)al.textContent=Math.round(hlAlpha*100)+'%';
  }
  function setTool(t){
    tool=t;
    /* pv-hdr + ppt-nav ëª¨ë“  ippt-tool ë²„íŠ¼ ì—…ë°ì´íŠ¸ */
    document.querySelectorAll('.ippt-tool').forEach(b=>{
      b.classList.toggle('active-tool',b.dataset.tool===t);
    });
    /* ppt-nav ìƒ‰ìƒ í”¼ì»¤Â·hl ì»¨íŠ¸ë¡¤ í‘œì‹œ */
    const colorNav=document.getElementById('ippt-pen-color-nav');
    if(colorNav)colorNav.style.display=(t==='pen'||t==='hl')?'block':'none';
    const hlCtrl=document.getElementById('ippt-hl-ctrl');
    if(hlCtrl){hlCtrl.style.display=(t==='hl')?'flex':'none'; if(t==='hl')_updHlUI();}
    if(!canvas)return;
    if(t==='laser'){
      canvas.style.pointerEvents='none';
      if(laserDot)laserDot.style.display='block';
    } else {
      canvas.style.pointerEvents='all';
      if(laserDot)laserDot.style.display='none';
    }
    canvas.style.cursor=(t==='eraser')?'cell':(t==='pen'||t==='hl')?'crosshair':'default';
  }

  function _canvasXY(e){
    /* container ê¸°ì¤€ ì¢Œí‘œ (ìŠ¤í¬ë¡¤ í¬í•¨) */
    const r=container.getBoundingClientRect();
    return {x: e.clientX-r.left+container.scrollLeft,
            y: e.clientY-r.top+container.scrollTop};
  }

  /* í˜•ê´‘íœ ì „ìš©: ì˜¤í”„ìŠ¤í¬ë¦° ìº”ë²„ìŠ¤ì— íš ì „ì²´ë¥¼ ê·¸ë¦° ë’¤ í•œ ë²ˆì— í•©ì„±
     â†’ í•œ íš ì•ˆì—ì„œ alphaê°€ ëˆ„ì ë˜ì§€ ì•Šì•„ ë†ë„ê°€ ì¼ì •í•˜ê²Œ ìœ ì§€ë¨ */
  let _hlOffscreen=null, _hlOffCtx=null, _hlPoints=[];

  function _ensureHlOffscreen(){
    if(_hlOffscreen&&_hlOffscreen.width===canvas.width&&_hlOffscreen.height===canvas.height)return;
    _hlOffscreen=document.createElement('canvas');
    _hlOffscreen.width=canvas.width; _hlOffscreen.height=canvas.height;
    _hlOffCtx=_hlOffscreen.getContext('2d');
  }

  function _drawHlStroke(){
    if(!_hlOffCtx||_hlPoints.length<2)return;
    _hlOffCtx.clearRect(0,0,_hlOffscreen.width,_hlOffscreen.height);
    _hlOffCtx.beginPath();
    _hlOffCtx.moveTo(_hlPoints[0].x,_hlPoints[0].y);
    for(let i=1;i<_hlPoints.length;i++) _hlOffCtx.lineTo(_hlPoints[i].x,_hlPoints[i].y);
    _hlOffCtx.strokeStyle=hlColor; _hlOffCtx.lineWidth=hlSize;
    _hlOffCtx.lineCap='round'; _hlOffCtx.lineJoin='round';
    _hlOffCtx.globalAlpha=1; _hlOffCtx.globalCompositeOperation='source-over';
    _hlOffCtx.stroke();
    /* ì˜¤í”„ìŠ¤í¬ë¦°ì„ ë©”ì¸ ìº”ë²„ìŠ¤ì— globalAlphaë¡œ í•œ ë²ˆë§Œ í•©ì„± */
    ctx.save();
    ctx.globalAlpha=hlAlpha;
    ctx.globalCompositeOperation='source-over';
    ctx.drawImage(_hlOffscreen,0,0);
    ctx.restore();
  }

  function onDown(e){
    drawing=true;
    if(tool==='pen'||tool==='eraser'){
      const {x,y}=_canvasXY(e);
      ctx.beginPath();
      ctx.moveTo(x,y);
      _setCtxStyle();
    } else if(tool==='hl'){
      _ensureHlOffscreen();
      _hlPoints=[_canvasXY(e)];
    }
  }

  function _setCtxStyle(){
    if(tool==='eraser'){
      ctx.globalCompositeOperation='destination-out';
      ctx.globalAlpha=1; ctx.lineWidth=24; ctx.strokeStyle='rgba(0,0,0,1)';
    } else if(tool==='pen'){
      ctx.globalCompositeOperation='source-over';
      ctx.globalAlpha=1; ctx.strokeStyle=penColor; ctx.lineWidth=penSize;
    }
    ctx.lineCap='round'; ctx.lineJoin='round';
  }

  function onMove(e){
    if(tool==='laser'&&laserDot){
      const r=container.getBoundingClientRect();
      const x=e.clientX-r.left, y=e.clientY-r.top;
      const inBounds=x>=0&&y>=0&&x<=r.width&&y<=r.height;
      laserDot.style.display=inBounds?'block':'none';
      /* ë ˆì´ì € ë‹·: viewport ê¸°ì¤€ (fixedì²˜ëŸ¼ ë³´ì—¬ì•¼ í•¨) */
      laserDot.style.left=x+'px';
      laserDot.style.top=(y+container.scrollTop)+'px';
      return;
    }
    if(!drawing||!ctx)return;
    if(tool==='pen'||tool==='eraser'){
      const {x,y}=_canvasXY(e);
      ctx.lineTo(x,y); ctx.stroke(); ctx.beginPath(); ctx.moveTo(x,y);
    } else if(tool==='hl'){
      _hlPoints.push(_canvasXY(e));
    }
  }

  function onUp(){
    if(drawing&&tool==='hl'){
      /* íš ì™„ë£Œ: ì˜¤í”„ìŠ¤í¬ë¦°ì„ globalAlphaë¡œ ë©”ì¸ ìº”ë²„ìŠ¤ì— í•œ ë²ˆ í•©ì„± */
      _drawHlStroke();
      _hlPoints=[];
      if(_hlOffCtx) _hlOffCtx.clearRect(0,0,_hlOffscreen.width,_hlOffscreen.height);
    }
    drawing=false;
    if(ctx){ctx.globalAlpha=1; ctx.globalCompositeOperation='source-over';}
  }

  function clearAll(){
    if(ctx)ctx.clearRect(0,0,canvas.width,canvas.height);
  }

  function show(){
    init(); /* ì´ë²¤íŠ¸ ë“±ë¡ + ìµœì´ˆ í¬ê¸° */
    if(canvas)canvas.style.display='block';
    setTool('laser');
    /* PPT ë ˆì´ì•„ì›ƒ ì ìš© í›„ ìº”ë²„ìŠ¤ í¬ê¸° ì¬ì¡°ì • */
    setTimeout(()=>_resizeCanvas(), 120);
  }
  function hide(){
    if(canvas)canvas.style.display='none';
    if(laserDot)laserDot.style.display='none';
    clearAll(); tool='laser';
  }

  /* ë‹¨ì¶•í‚¤ (ë‚´ë¶€ PPT ëª¨ë“œ ì „ìš©) */
  function handleKey(k){
    if(k==='1')setTool('laser');
    else if(k==='2')setTool('select');
    else if(k==='4')setTool('pen');
    else if(k==='5')setTool('hl');
    else if(k==='6')setTool('eraser');
  }

  return{
    show,hide,setTool,clearAll,handleKey,
    setPenColor(col){
      penColor=col;
      const n=document.getElementById('ippt-pen-color');
      const n2=document.getElementById('ippt-pen-color-nav');
      if(n)n.value=col; if(n2)n2.value=col;
    },
    setPenSize(s){penSize=+s},
    setHlColor(col){hlColor=col},
    setHlSize(s){hlSize=+s; _updHlUI();},
    setHlAlpha(v){hlAlpha=+v/100; _updHlUI();},
    hlSizeUp(){hlSize=Math.min(60,hlSize+2); _updHlUI();},
    hlSizeDown(){hlSize=Math.max(4,hlSize-2); _updHlUI();},
    hlAlphaUp(){hlAlpha=Math.min(0.90,+(hlAlpha+0.05).toFixed(2)); _updHlUI();},
    hlAlphaDown(){hlAlpha=Math.max(0.02,+(hlAlpha-0.05).toFixed(2)); _updHlUI();}
  };
})();



/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   A4Ruler â€” ë¯¸ë¦¬ë³´ê¸° A4 í˜ì´ì§€ êµ¬ë¶„ ì ì„ 
   297mm(A4 ë†’ì´) ê°„ê²©ìœ¼ë¡œ ë¹¨ê°„ ì ì„ ì„ ê° .preview-page ìœ„ì— ê·¸ë¦¼
   ë‚´ìš©ì´ ê¸¸ì–´ì„œ 297mmë¥¼ ë„˜ëŠ” í˜ì´ì§€ì—ë„ ë°˜ë³µ í‘œì‹œ
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const A4Ruler = (() => {
  let on = false;

  /* 210mm ê¸°ì¤€ìœ¼ë¡œ ì‹¤ì œ px scale ê³„ì‚° */
  function getScale() {
    const page = el('preview-container').querySelector('.preview-page');
    if (!page) return 1;
    return page.offsetWidth / (210 * (96 / 25.4));
  }

  /* 297mm â†’ px */
  function a4px() {
    return Math.round(297 * (96 / 25.4) * getScale());
  }

  function drawOverlay() {
    const overlay = el('a4-overlay');
    overlay.innerHTML = '';
    if (!on) { overlay.classList.remove('vis'); return; }

    const container = el('preview-container');
    const pages = [...container.querySelectorAll('.preview-page')];
    if (!pages.length) return;

    overlay.classList.add('vis');

    const gap = a4px();                          /* 297mm in px */
    const containerScrollTop = container.scrollTop;
    const pvHdrH = 30;                           /* pv-hdr ë†’ì´ */

    /* container ê¸°ì¤€ ì¢Œí‘œë¡œ ê° í˜ì´ì§€ ìœ„ì¹˜ íŒŒì•… */
    const containerRect = container.getBoundingClientRect();

    pages.forEach(page => {
      const pageRect = page.getBoundingClientRect();
      /* container ë‚´ ì ˆëŒ€ y ì¢Œí‘œ (ìŠ¤í¬ë¡¤ í¬í•¨) */
      const pageTop = pageRect.top - containerRect.top + containerScrollTop;
      const pageH   = page.offsetHeight;

      /* ì´ í˜ì´ì§€ ì•ˆì—ì„œ 297mm ë°°ìˆ˜ë§ˆë‹¤ ì„  */
      let n = 1;
      while (n * gap < pageH - 2) {
        const lineY = pageTop + n * gap;          /* overlay ê¸°ì¤€ y */

        const line = document.createElement('div');
        line.className = 'a4-rl';
        /* overlay top = pv-hdr(30px), container top = pvHdrH ì—ì„œ ì‹œì‘
           container ì•ˆ ì¢Œí‘œ â†’ overlay ì¢Œí‘œë¡œ ë³€í™˜ */
        line.style.top = (lineY - containerScrollTop) + 'px';

        const label = document.createElement('span');
        label.className = 'a4-rl-label';
        label.textContent = `${297 * n} mm`;
        line.appendChild(label);

        overlay.appendChild(line);
        n++;
      }
    });
  }

  /* ìŠ¤í¬ë¡¤í•  ë•Œë§ˆë‹¤ ì„  ìœ„ì¹˜ ì¬ê³„ì‚° */
  let _scrollBound = false;
  function _bindScroll() {
    if (_scrollBound) return;
    _scrollBound = true;
    el('preview-container').addEventListener('scroll', () => {
      if (on) drawOverlay();
    }, { passive: true });
  }

  return {
    toggle() {
      on = !on;
      const btn = el('a4-ruler-btn');
      btn.classList.toggle('active', on);
      btn.textContent = on ? 'ğŸ“„ A4 âœ“' : 'ğŸ“„ A4';
      _bindScroll();
      drawOverlay();
    },
    refresh() {
      if (on) {
        /* ë Œë” ì§í›„ ë ˆì´ì•„ì›ƒì´ í™•ì •ë˜ë„ë¡ í•œ í”„ë ˆì„ ë’¤ì— */
        requestAnimationFrame(() => drawOverlay());
      }
    },
  };
})();

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CP â€” ë¯¸ë¦¬ë³´ê¸° ë³µì‚¬ ë§¤ë‹ˆì €
   ğŸ“‹ ë³µì‚¬  : ClipboardItemìœ¼ë¡œ HTML + plaintext ë™ì‹œ ë“±ë¡
              â†’ Word / êµ¬ê¸€ë…ìŠ¤ / í•œê¸€ ë¶™ì—¬ë„£ê¸° ì‹œ ì„œì‹ ìœ ì§€
   ï¼¡ í…ìŠ¤íŠ¸: ìˆœìˆ˜ í…ìŠ¤íŠ¸ë§Œ (innerText ì¶”ì¶œ)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const CP = (() => {

  /* preview-container ë‚´ ëª¨ë“  .preview-pageë¥¼ í•©ì¹œ HTML ìŠ¤ëƒ…ìƒ· */
  function getPageNodes() {
    return [...el('preview-container').querySelectorAll('.preview-page')];
  }

  /* ë³µì‚¬ìš© HTML ìƒì„±
     - í˜ì´ì§€ ë²ˆí˜¸ ê°€ìƒìš”ì†Œ(::after)ëŠ” ë³µì‚¬ ëŒ€ìƒì´ ì•„ë‹ˆë¯€ë¡œ ì œê±°
     - ì™¸ë¶€ ë¬¸ì„œì—ì„œë„ ê¸°ë³¸ ì„œì‹ì´ ì‚´ì•„ìˆë„ë¡ ì¸ë¼ì¸ ìŠ¤íƒ€ì¼ ê¸°ë°˜ wrapper ì¶”ê°€ */
  function buildHtml(nodes) {
    // ê° í˜ì´ì§€ innerHTML í•©ì¹˜ê¸° (í˜ì´ì§€ êµ¬ë¶„ì€ <hr>)
    const parts = nodes.map((n, i) => {
      // data-page ì†ì„± ë° ::after ë“±ì€ ë³µì‚¬ë³¸ì— ë¶ˆí•„ìš” â†’ cloneNode
      const clone = n.cloneNode(true);
      // í˜ì´ì§€ ë²ˆí˜¸ í‘œì‹œìš© after ì½˜í…ì¸ ëŠ” DOMì— ì—†ìœ¼ë¯€ë¡œ ë¬´ì‹œ
      return clone.innerHTML;
    });
    const body = parts.join('\n<hr style="border:none;border-top:1px dashed #ccc;margin:18px 0">\n');

    // WordÂ·êµ¬ê¸€ë…ìŠ¤ í˜¸í™˜ wrapper â€” ê¸°ë³¸ í°íŠ¸Â·ì¤„ê°„ê²© ì„¤ì •
    return `<div style="font-family:serif;font-size:11pt;line-height:1.8;color:#1a1a2e;max-width:170mm;word-break:break-word">${body}</div>`;
  }

  /* ë²„íŠ¼ í”¼ë“œë°± ì• ë‹ˆë©”ì´ì…˜ */
  function flash(btnId, successLabel, color) {
    const btn = el(btnId);
    const orig = btn.textContent;
    const origColor = btn.style.color;
    btn.textContent = successLabel;
    btn.style.color = color || '#6af7a0';
    btn.style.opacity = '0.7';
    setTimeout(() => {
      btn.textContent = orig;
      btn.style.color = origColor;
      btn.style.opacity = '';
    }, 1600);
  }

  return {
    /* â”€â”€ ì„œì‹ ìˆëŠ” ë³µì‚¬ â”€â”€ */
    async copyRich() {
      const nodes = getPageNodes();
      if (!nodes.length) { alert('ë¯¸ë¦¬ë³´ê¸° ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.'); return; }

      const htmlStr = buildHtml(nodes);
      // ìˆœìˆ˜ í…ìŠ¤íŠ¸ fallback
      const textStr = nodes.map(n => n.innerText).join('\n\n');

      try {
        // ClipboardItem API â€” HTML + text/plain ë™ì‹œ ë“±ë¡
        if (window.ClipboardItem) {
          const htmlBlob = new Blob([htmlStr], { type: 'text/html' });
          const textBlob = new Blob([textStr], { type: 'text/plain' });
          await navigator.clipboard.write([
            new ClipboardItem({ 'text/html': htmlBlob, 'text/plain': textBlob })
          ]);
        } else {
          // fallback: execCommand (êµ¬í˜• ë¸Œë¼ìš°ì €)
          const tmp = document.createElement('div');
          tmp.innerHTML = htmlStr;
          tmp.style.cssText = 'position:fixed;left:-9999px;top:0;opacity:0';
          document.body.appendChild(tmp);
          const range = document.createRange();
          range.selectNodeContents(tmp);
          const sel = window.getSelection();
          sel.removeAllRanges();
          sel.addRange(range);
          document.execCommand('copy');
          sel.removeAllRanges();
          document.body.removeChild(tmp);
        }
        flash('copy-rich-btn', 'âœ“ ë³µì‚¬ë¨', '#6af7a0');
      } catch (err) {
        // ê¶Œí•œ ê±°ë¶€ ì‹œ í…ìŠ¤íŠ¸ë¡œ fallback
        try {
          await navigator.clipboard.writeText(textStr);
          flash('copy-rich-btn', 'âœ“ í…ìŠ¤íŠ¸ë¡œ ë³µì‚¬', '#f7d06a');
        } catch(e2) {
          alert('í´ë¦½ë³´ë“œ ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.\në¸Œë¼ìš°ì € ì£¼ì†Œì°½ì„ í•œ ë²ˆ í´ë¦­í•œ ë’¤ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.');
        }
      }
    },

    /* â”€â”€ í…ìŠ¤íŠ¸ë§Œ ë³µì‚¬ â”€â”€ */
    async copyText() {
      const nodes = getPageNodes();
      if (!nodes.length) { alert('ë¯¸ë¦¬ë³´ê¸° ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.'); return; }

      // innerText: ê°€ì‹œì  í…ìŠ¤íŠ¸ + ì¤„ë°”ê¿ˆ êµ¬ì¡° ìœ ì§€
      const text = nodes.map(n => n.innerText.trim()).join('\n\n');
      try {
        await navigator.clipboard.writeText(text);
        flash('copy-text-btn', 'âœ“ ë³µì‚¬ë¨', '#6af7a0');
      } catch(err) {
        alert('í´ë¦½ë³´ë“œ ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      }
    },
  };
})();

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PREVIEW WINDOW (popup) + scroll sync
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const PW=(()=>{
  let win=null,st=null,rm=false;
  const CSS=`@import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500&family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&display=swap');
*{box-sizing:border-box;margin:0;padding:0}body{font-family:sans-serif;background:#6a6e7e;display:flex;flex-direction:column;align-items:center;padding:16px 0 36px;min-height:100vh}
.preview-page{width:210mm;min-height:297mm;background:white;color:#1a1a2e;padding:22mm 18mm;box-shadow:0 6px 40px rgba(0,0,0,.5);font-family:'Libre Baskerville',serif;font-size:11pt;line-height:1.8;word-break:break-word;position:relative;margin-bottom:16px}
.preview-page::after{content:"â€” " attr(data-page) " â€”";position:absolute;bottom:10mm;left:50%;transform:translateX(-50%);font-family:sans-serif;font-size:9pt;color:#bbb}
.preview-page h1{font-size:21pt;font-weight:700;margin:0 0 14px;border-bottom:2px solid #1a1a2e;padding-bottom:8px}
.preview-page h2{font-size:15pt;font-weight:700;margin:20px 0 10px}.preview-page h3{font-size:12pt;font-weight:700;margin:16px 0 7px}
.preview-page p{margin:0 0 11px}.preview-page ul,.preview-page ol{margin:0 0 11px;padding-left:22px}.preview-page li{margin-bottom:3px}
.preview-page blockquote{border-left:3px solid #5b4ce4;margin:14px 0;padding:7px 14px;background:#f5f5ff;font-style:italic}
.preview-page code{font-family:'JetBrains Mono',monospace;font-size:9pt;background:#f0f0f8;padding:1px 4px;border-radius:3px;color:#5b4ce4}
.preview-page pre{background:#1a1a2e;color:#e8e8f0;padding:14px;border-radius:6px;overflow-x:auto;margin:11px 0;font-size:9pt}
.preview-page pre code{background:none;color:inherit;padding:0}
.preview-page table{width:100%;border-collapse:collapse;margin:11px 0;font-size:inherit}
.preview-page th{background:#1a1a2e;color:#fff;padding:7px 11px;text-align:left}
.preview-page td{padding:6px 11px;border:1px solid #d0d0e0}
.preview-page tr:nth-child(even) td{background:#f7f7fc}
.preview-page img{max-width:100%}
.preview-page a{color:#5b4ce4;text-decoration:underline}
.preview-page a[href^="http"]::after{content:" â†—";font-size:8pt;opacity:.5}
.preview-page .ref-block{border-top:1px solid #d0d0e0;margin-top:28px;padding-top:10px;font-size:9pt;color:#4a4a6a}
.preview-page.rm p{padding-left:42px;position:relative}
.rm-ln{position:absolute;left:0;top:0;width:34px;text-align:right;font-family:'JetBrains Mono',monospace;font-size:8pt;line-height:inherit;color:#a0a0c8;user-select:none;pointer-events:none;border-right:1px solid #ddd;padding-right:5px;height:1.8em;overflow:hidden}
@media print{body{background:none;padding:0}.preview-page{box-shadow:none;margin:0;page-break-after:always;width:100%;min-height:0}.preview-page:last-child{page-break-after:auto}.preview-page::after{display:none}}`;

  function buildHTML(md,title){
    const pages=splitPages(md);
    const html=pages.map((p,i)=>`<div class="preview-page${rm?' rm':''}" data-page="${i+1}">${mdRender(p)}</div>`).join('');
    const A4_CSS=`
/* â”€â”€ PV íˆ´ë°” â”€â”€ */
#pw-toolbar{position:fixed;top:0;left:0;right:0;height:36px;background:rgba(20,20,32,.93);
  backdrop-filter:blur(8px);border-bottom:1px solid rgba(255,255,255,.1);
  display:flex;align-items:center;padding:0 10px;gap:5px;z-index:10000;font-family:monospace}
#pw-toolbar button{background:none;border:1px solid rgba(255,255,255,.18);border-radius:4px;
  color:#ccc;cursor:pointer;font-size:11px;padding:2px 9px;height:24px;transition:all .15s;white-space:nowrap}
#pw-toolbar button:hover{background:rgba(255,255,255,.12);color:#fff;border-color:rgba(255,255,255,.45)}
#pw-toolbar button.active{background:rgba(240,192,96,.22);color:#f7d06a;border-color:#f0c060}
#pw-toolbar button.active-dark{background:rgba(80,140,255,.22);color:#7ab8ff;border-color:#5090ff}
#pw-toolbar .sep{width:1px;height:18px;background:rgba(255,255,255,.13);flex-shrink:0}
#pw-toolbar .lbl{font-size:10px;color:rgba(255,255,255,.38);flex-shrink:0}
#pw-toolbar #pw-zoom-lbl{font-size:10px;color:#6acff7;min-width:36px;text-align:center}
#pw-toolbar .spacer{flex:1}
/* PPT ë„¤ë¹„ */
#pw-ppt-nav{display:none;position:fixed;bottom:22px;left:50%;transform:translateX(-50%);
  z-index:10001;background:rgba(0,0,0,.75);border:1px solid rgba(255,255,255,.2);
  border-radius:28px;padding:6px 16px;gap:10px;align-items:center;backdrop-filter:blur(10px)}
#pw-ppt-nav.vis{display:flex}
#pw-ppt-nav button{background:none;border:none;color:#fff;cursor:pointer;font-size:22px;
  padding:0 6px;border-radius:12px;line-height:1;transition:background .15s}
#pw-ppt-nav button:hover{background:rgba(255,255,255,.18)}
#pw-ppt-nav #pw-ppt-pg{font-size:12px;color:rgba(255,255,255,.78);min-width:56px;text-align:center;font-family:monospace}
body{padding-top:36px;margin:0;background:#555}
html,body{overflow-x:hidden}
/* body-inner: ê¸°ë³¸ â€” ê³ ì • ë„ˆë¹„ í˜ì´ì§€ë¥¼ ì¤‘ì•™ì— í‘œì‹œ */
#body-inner{
  display:flex;
  flex-direction:column;
  align-items:center;
  padding:16px 0 48px;
}
/* PPT ëª¨ë“œ */
body.ppt-mode{background:#000;padding-top:36px}
body.ppt-mode #body-inner{
  display:block;
  padding:0;
  height:calc(100vh - 36px);
  overflow:hidden;
}
/* í”„ë ˆì  í…Œì´ì…˜ ë„êµ¬ ì˜¤ë²„ë ˆì´ */
#pres-overlay{
  position:fixed;inset:0;top:36px;
  z-index:20000;
  pointer-events:none;
  cursor:default;
}
#pres-overlay.mode-pointer{pointer-events:none;cursor:none}
#pres-overlay.mode-pan{pointer-events:all;cursor:grab}
#pres-overlay.mode-pan:active{cursor:grabbing}
#pres-overlay.mode-pen{pointer-events:all;cursor:crosshair}
#pres-overlay.mode-hl{pointer-events:all;cursor:crosshair}
#pres-canvas{position:absolute;inset:0;width:100%;height:100%}
/* í¬ì¸í„° ë ˆì´ì € ë‹· */
#laser-dot{
  display:none;
  position:fixed;
  width:18px;height:18px;
  border-radius:50%;
  background:rgba(255,30,30,.92);
  box-shadow:0 0 8px 4px rgba(255,60,60,.6),0 0 20px 8px rgba(255,0,0,.3);
  pointer-events:none;
  z-index:20001;
  transform:translate(-50%,-50%);
  transition:opacity .1s;
}
/* í”„ë ˆì  í…Œì´ì…˜ íˆ´ë°” */
/* â•â•â• pres-toolbar: PPT ëª¨ë“œ ë„êµ¬ íˆ´ë°” â•â•â•
   ê¸°ë³¸(pos-top): ìƒë‹¨ toolbar ì•„ë˜ ìˆ˜í‰ë°”
   pos-bottom: í™”ë©´ í•˜ë‹¨ ì¤‘ì•™
   pos-right: í™”ë©´ ìš°ì¸¡ ì¤‘ì•™ ìˆ˜ì§
   pos-left: í™”ë©´ ì¢Œì¸¡ ì¤‘ì•™ ìˆ˜ì§ */
#pres-toolbar{
  display:none;
  position:fixed;
  /* ê¸°ë³¸: ìƒë‹¨ toolbar ë°”ë¡œ ì•„ë˜ */
  top:40px; left:50%; transform:translateX(-50%);
  z-index:20002;
  background:rgba(10,10,22,.92);
  border:1px solid rgba(255,255,255,.22);
  border-radius:28px;
  padding:5px 14px; gap:6px;
  align-items:center;
  backdrop-filter:blur(12px);
  white-space:nowrap;
}
#pres-toolbar.vis{ display:flex }
/* í•˜ë‹¨ */
#pres-toolbar.pos-bottom{
  top:auto; bottom:68px; left:50%; transform:translateX(-50%);
  flex-direction:row;
}
/* ìš°ì¸¡ */
#pres-toolbar.pos-right{
  top:50%; left:auto; right:10px; transform:translateY(-50%);
  flex-direction:column; border-radius:16px; padding:10px 6px;
}
/* ì¢Œì¸¡ */
#pres-toolbar.pos-left{
  top:50%; left:10px; right:auto; transform:translateY(-50%);
  flex-direction:column; border-radius:16px; padding:10px 6px;
}
#pres-toolbar button{
  background:none;border:1px solid rgba(255,255,255,.15);
  border-radius:8px;color:#ccc;cursor:pointer;font-size:13px;
  padding:3px 9px;height:28px;transition:all .15s;white-space:nowrap;
  display:flex;align-items:center;gap:4px;
}
#pres-toolbar button:hover{background:rgba(255,255,255,.12);color:#fff}
#pres-toolbar button.active-tool{background:rgba(240,192,96,.25);color:#f7d06a;border-color:#f0c060}
#pres-toolbar .pt-sep{width:1px;height:18px;background:rgba(255,255,255,.15)}
#pres-toolbar input[type=color]{width:26px;height:26px;border:none;background:none;cursor:pointer;padding:0;border-radius:4px}
#pres-toolbar input[type=range]{width:60px;accent-color:#f7d06a}
/* Trans ê°€ë¡œ ëª¨ë“œ */
body.trans-mode .preview-page{width:297mm;min-height:210mm;padding:15mm 22mm}
/* Dark ë°˜ì „ í…Œë§ˆ */
body.dark-theme{background:#111}
body.dark-theme .preview-page{background:#1a1a2e;color:#e8e8f0}
body.dark-theme .preview-page h1,body.dark-theme .preview-page h2,
body.dark-theme .preview-page h3{color:#a8b8ff}
body.dark-theme .preview-page a{color:#6acff7}
body.dark-theme .preview-page code{background:#2a2a3e;color:#f7a06a}
body.dark-theme .preview-page blockquote{
  border-left-color:#7c6af7;
  color:#d4d0f0;
  background:rgba(40,35,80,.6);
  border-radius:0 6px 6px 0;
}
body.dark-theme .preview-page blockquote p{color:#d4d0f0}
body.dark-theme .preview-page blockquote blockquote{
  border-left-color:#a090ff;
  color:#c0bce8;
  background:rgba(50,45,90,.5);
}
body.dark-theme .preview-page table{color:#e8e8f0 !important;font-size:inherit !important}
body.dark-theme .preview-page table th{background:#252540 !important;color:#c8d8ff !important;border-color:#4a4a68 !important}
body.dark-theme .preview-page table td{border-color:#3a3a58 !important;background:transparent !important;color:#e8e8f0 !important}
body.dark-theme .preview-page table tr:nth-child(even) td{background:#20203a !important;color:#e8e8f0 !important}
body.dark-theme .preview-page table *{color:#e8e8f0 !important}
body.dark-theme .preview-page table th *{color:#c8d8ff !important}
@media print{body{background:none;padding:0}.preview-page{box-shadow:none;margin:0;page-break-after:always;width:100%;min-height:0}.preview-page:last-child{page-break-after:auto}.preview-page::after{display:none}}`;

    return`<!DOCTYPE html><html lang="ko"><head><meta charset="UTF-8"><title>${title||'Preview'}</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.min.js"><\/script>
<style>${CSS}${A4_CSS}<\/style></head>
<body>
<div id="pw-toolbar">
  <button onclick="window.print()" title="ì¸ì‡„ / PDF">ğŸ–¨ ì¸ì‡„</button>
  <button onclick="pwDownload()" title="í˜„ì¬ HTML ì €ì¥">ğŸ’¾ ì €ì¥</button>
  <div class="sep"></div>
  <button onclick="pwZoomOut()" title="í˜ì´ì§€ ì¶•ì†Œ">ï¼</button>
  <span id="pw-zoom-lbl" title="í˜„ì¬ ë°°ìœ¨">100%</span>
  <button onclick="pwZoomIn()" title="í˜ì´ì§€ í™•ëŒ€">ï¼‹</button>
  <button onclick="pwZoomReset()" title="100%ë¡œ ì´ˆê¸°í™”">â†º</button>
  <div class="sep"></div>
  <button id="pw-ppt-btn" onclick="pwTogglePPT()" title="PPT í”„ë ˆì  í…Œì´ì…˜ ëª¨ë“œ">ğŸ¬ PPT</button>
  <button id="pw-trans-btn" onclick="pwToggleTrans()" title="í˜ì´ì§€ ë°©í–¥ ì „í™˜">â†” Trans</button>
  <button id="pw-dark-btn" onclick="pwToggleDark()" title="ë‹¤í¬ í…Œë§ˆ">â—‘ Dark</button>
  <button onclick="pwFullscreen()" title="ì „ì²´í™”ë©´ (F11)">â›¶ ì „ì²´í™”ë©´</button>
  <div class="spacer"></div>
  <span class="lbl" style="color:rgba(255,255,255,.4);font-size:9px">í°íŠ¸</span>
  <button onclick="pwFontDown()" title="í°íŠ¸ ì¶•ì†Œ (í…ìŠ¤íŠ¸ë§Œ)">á´¬ï¼</button>
  <span id="pw-font-lbl" style="color:#6acff7;font-size:10px;min-width:30px;text-align:center">11pt</span>
  <button onclick="pwFontUp()" title="í°íŠ¸ í™•ëŒ€ (í…ìŠ¤íŠ¸ë§Œ)">á´¬ï¼‹</button>
  <button onclick="pwFontReset()" title="í°íŠ¸ ì´ˆê¸°í™”">â†º</button>
  <div class="sep"></div>
  <span class="lbl" id="pw-pg-lbl" style="color:rgba(255,255,255,.5)"></span>
</div>
<div id="body-inner">${html}</div>
<div id="a4-overlay"></div>
<!-- í”„ë ˆì  í…Œì´ì…˜ ë„êµ¬ ì˜¤ë²„ë ˆì´ -->
<div id="pres-overlay" style="display:none">
  <canvas id="pres-canvas"></canvas>
</div>
<div id="laser-dot"></div>
</div>
<!-- í”„ë ˆì  í…Œì´ì…˜ ë„êµ¬ íˆ´ë°” (PPT ëª¨ë“œì—ì„œ í‘œì‹œ, ìœ„ì¹˜ ë³€ê²½ ê°€ëŠ¥) -->
<div id="pres-toolbar">
  <button onclick="PRES.cyclePos()" id="pt-pos-btn" title="íˆ´ë°” ìœ„ì¹˜: ìƒë‹¨â†’í•˜ë‹¨â†’ìš°ì¸¡â†’ì¢Œì¸¡ [P]" style="font-size:11px">ğŸ“Œ</button>
  <div class="pt-sep"></div>
  <button class="pt-tool active-tool" data-tool="laser" onclick="PRES.setTool('laser')" title="ë ˆì´ì € í¬ì¸í„° [1]">â¶ğŸ”´</button>
  <button class="pt-tool" data-tool="select" onclick="PRES.setTool('select')" title="ì„ íƒ [2]">â·â†–</button>
  <button class="pt-tool" data-tool="pan" onclick="PRES.setTool('pan')" title="ì´ë™ [3]">â¸âœ‹</button>
  <div class="pt-sep"></div>
  <button class="pt-tool" data-tool="pen" onclick="PRES.setTool('pen')" title="íœ [4]">â¹âœ</button>
  <span id="pt-pen-opts" style="display:none;align-items:center;gap:3px">
    <input type="color" id="pt-pen-color" value="#e63030" onchange="PRES.setPenColor(this.value)">
    <input type="range" min="1" max="20" value="4" oninput="PRES.setPenSize(this.value)" style="width:60px">
  </span>
  <button class="pt-tool" data-tool="hl" onclick="PRES.setTool('hl')" title="í˜•ê´‘íœ [5]">âºğŸ–Š</button>
  <span id="pt-hl-opts" style="display:none;align-items:center;gap:3px">
    <input type="color" id="pt-hl-color" value="#ffe040" onchange="PRES.setHlColor(this.value)" title="í˜•ê´‘íœ ìƒ‰ìƒ">
    <span title="êµµê¸°" style="font-size:9px;color:#aaa">êµµ</span>
    <button onclick="PRES.hlSizeDown()" title="êµµê¸° ê°ì†Œ" style="font-size:10px;padding:0 4px;height:20px;background:none;border:1px solid rgba(255,255,255,.2);border-radius:4px;color:#ddd;cursor:pointer">ï¼</button>
    <span id="pt-hl-size-lbl" style="font-size:10px;color:#ffe040;min-width:20px;text-align:center">18</span>
    <button onclick="PRES.hlSizeUp()" title="êµµê¸° ì¦ê°€" style="font-size:10px;padding:0 4px;height:20px;background:none;border:1px solid rgba(255,255,255,.2);border-radius:4px;color:#ddd;cursor:pointer">ï¼‹</button>
    <span title="íˆ¬ëª…ë„" style="font-size:9px;color:#aaa;margin-left:4px">Î±</span>
    <button onclick="PRES.hlAlphaDown()" title="íˆ¬ëª…ë„ ê°ì†Œ (ë” ì—°í•˜ê²Œ)" style="font-size:10px;padding:0 4px;height:20px;background:none;border:1px solid rgba(255,255,255,.2);border-radius:4px;color:#ddd;cursor:pointer">ï¼</button>
    <span id="pt-hl-alpha-lbl" style="font-size:10px;color:#ffe040;min-width:24px;text-align:center">10%</span>
    <button onclick="PRES.hlAlphaUp()" title="íˆ¬ëª…ë„ ì¦ê°€ (ë” ì§„í•˜ê²Œ)" style="font-size:10px;padding:0 4px;height:20px;background:none;border:1px solid rgba(255,255,255,.2);border-radius:4px;color:#ddd;cursor:pointer">ï¼‹</button>
  </span>
  <button class="pt-tool" data-tool="eraser" onclick="PRES.setTool('eraser')" title="ì§€ìš°ê°œ [6]">â»â¬œ</button>
  <div class="pt-sep"></div>
  <button onclick="PRES.clearCanvas()" title="ì „ì²´ ì§€ìš°ê¸°" style="color:#f08080">ğŸ—‘</button>
</div>
<div id="pw-ppt-nav">
  <button onclick="pwPptPrev()" title="ì´ì „ (â† â†‘ PageUp)">â—€</button>
  <span id="pw-ppt-pg">1 / 1</span>
  <button onclick="pwPptNext()" title="ë‹¤ìŒ (â†’ â†“ PageDown Space)">â–¶</button>
  <button onclick="pwTogglePPT()" style="font-size:13px;opacity:.55;margin-left:4px" title="PPT ì¢…ë£Œ (Esc)">âœ•</button>
</div>
<script>
document.querySelectorAll('a').forEach(a=>{a.target='_blank';a.rel='noopener noreferrer'});
/* Research Mode ë‹¨ë½ ë²ˆí˜¸ */
(function(){let n=1;document.querySelectorAll('.preview-page').forEach(pg=>{pg.querySelectorAll(':scope>p').forEach(p=>{const s=document.createElement('span');s.className='rm-ln';s.textContent=n++;s.setAttribute('aria-hidden','true');p.insertBefore(s,p.firstChild)})})})();
/* scroll sync â€” ë©”ì¸ ì—ë””í„°ì™€ */
window.addEventListener('message',e=>{
  if(e.data&&e.data.type==='ss'){
    const bi=document.getElementById('body-inner');
    if(bi)bi.scrollTop=e.data.ratio*(bi.scrollHeight-bi.clientHeight);
    else window.scrollTo(0,e.data.ratio*(document.body.scrollHeight-window.innerHeight));
  }
});
let _st;
document.getElementById('body-inner').addEventListener('scroll',()=>{
  clearTimeout(_st);_st=setTimeout(()=>{
    const bi=document.getElementById('body-inner');
    const r=bi.scrollTop/Math.max(1,bi.scrollHeight-bi.clientHeight);
    try{window.opener.postMessage({type:'pvS',ratio:r},'*')}catch(e){}
  },10);
},{passive:true});

/* â•â• í™•ëŒ€/ì¶•ì†Œ â•â•
   ë‚´ë¶€ PVì™€ ë™ì¼í•œ ë°©ì‹: í˜ì´ì§€ widthë¥¼ pxë¡œ ì§ì ‘ ì„¤ì •.
   í™•ëŒ€ ì‹œ body-inner(flex center)ê°€ ì¤‘ì•™ ì •ë ¬ì„ ë³´ì¥.
*/
let _scale=1.0;
const MIN_S=0.2, MAX_S=5.0, STEP_S=0.15;
const _MM=96/25.4;
const _A4W_PX=Math.round(210*_MM); /* â‰ˆ794 */

let _fontPt=11; /* ê¸°ë³¸ í°íŠ¸ í¬ê¸°(pt) */
const FONT_MIN=6,FONT_MAX=24,FONT_STEP=1;

function _applyScale(){
  if(_pptOn) return; /* PPT ëª¨ë“œëŠ” _pptApplyê°€ ì²˜ë¦¬ */
  const pages=document.querySelectorAll('.preview-page');
  const fontPx=Math.round(_fontPt*(96/72)); /* ptâ†’px */
  pages.forEach(p=>{
    p.style.padding=''; p.style.minHeight=''; p.style.boxSizing='';
    p.style.maxWidth=''; p.style.transform=''; p.style.transformOrigin='';
    if(_scale===1){
      p.style.width=''; p.style.marginBottom='';
    } else {
      p.style.width=Math.round(_A4W_PX*_scale)+'px';
      p.style.marginBottom='16px';
    }
    /* í°íŠ¸ í¬ê¸°: í˜ì´ì§€ ì „ì²´ì— ì ìš© (table í¬í•¨ ìƒì†) */
    p.style.fontSize=fontPx+'px';
    p.style.lineHeight='1.8'; /* í°íŠ¸ ë³€ê²½ ì‹œ ì¤„ê°„ê²© ìœ ì§€ */
  });
  document.getElementById('pw-zoom-lbl').textContent=Math.round(_scale*100)+'%';
  const lbl=document.getElementById('pw-font-lbl');
  if(lbl)lbl.textContent=_fontPt+'pt';
}

function _applyFont(){
  const lbl=document.getElementById('pw-font-lbl');
  if(lbl)lbl.textContent=_fontPt+'pt';
  const fontPx=Math.round(_fontPt*(96/72)*10)/10;
  if(_pptOn){
    /* PPT ëª¨ë“œ: í˜„ì¬ í˜ì´ì§€ ë¹„ìœ¨ ê³„ì‚° í›„ pagesì— ì§ì ‘ ì ìš© */
    const pages=_getPages();
    if(pages.length){
      const curW=parseFloat(pages[0].style.width)||window.innerWidth;
      const ratio=curW/_A4W_PX;
      const szPx=Math.round(_fontPt*(96/72)*ratio*10)/10;
      pages.forEach(p=>{ p.style.fontSize=szPx+'px'; p.style.lineHeight='1.8'; });
    }
    /* body-innerë„ í•¨ê»˜ ì ìš© (ìƒì† ë³´ì¡°) */
    const bi=document.getElementById('body-inner');
    const ratio=window.innerWidth/_A4W_PX;
    if(bi)bi.style.fontSize=Math.round(_fontPt*(96/72)*ratio*10)/10+'px';
  } else {
    /* ì¼ë°˜ ëª¨ë“œ: preview-pageì— ì§ì ‘ fontSize ì ìš© */
    document.querySelectorAll('.preview-page').forEach(p=>{
      p.style.fontSize=fontPx+'px';
      p.style.lineHeight='1.8';
    });
    /* zoom ë ˆì´ë¸”ë„ ê°±ì‹  */
    const zl=document.getElementById('pw-zoom-lbl');
    if(zl)zl.textContent=Math.round(_scale*100)+'%';
  }
}
function pwFontUp(){_fontPt=Math.min(FONT_MAX,_fontPt+FONT_STEP);_applyFont();}
function pwFontDown(){_fontPt=Math.max(FONT_MIN,_fontPt-FONT_STEP);_applyFont();}
function pwFontReset(){_fontPt=11;_applyFont();}

/* ì°½ ë„ˆë¹„ì— fit */
function _fitToWindow(){
  const avail=window.innerWidth-40;
  _scale=Math.max(MIN_S, Math.min(MAX_S, Math.floor((avail/_A4W_PX)*100)/100));
  _applyScale();
}

/* PPT ëª¨ë“œ ì „ìš© zoom: í˜ì´ì§€ ë¹„ë¡€ ì¡°ì • (vw ê¸°ì¤€ Â±15%) */
function _pptZoomExternal(delta){
  const pages=_getPages();
  if(!pages.length)return;
  const curW=parseFloat(pages[0].style.width)||window.innerWidth;
  const newW=Math.round(Math.max(window.innerWidth*0.5,
                        Math.min(window.innerWidth*2.0, curW+delta*_A4W_PX)));
  const ratio=newW/_A4W_PX;
  const fontPx=Math.round(_fontPt*(96/72)*ratio*10)/10;
  pages.forEach(p=>{
    p.style.width=newW+'px';
    p.style.padding=Math.round(22*_MM*ratio)+'px '+Math.round(18*_MM*ratio)+'px';
    p.style.minHeight=Math.round(297*_MM*ratio)+'px';
    p.style.fontSize=fontPx+'px';
    p.style.lineHeight='1.8';
  });
  const bi=document.getElementById('body-inner');
  bi.style.fontSize=fontPx+'px';
  document.getElementById('pw-zoom-lbl').textContent=Math.round(ratio*100)+'%';
}

function pwZoomIn(){
  if(_pptOn){ _pptZoomExternal(+0.15); return; }
  _scale=Math.min(MAX_S, Math.round((_scale+STEP_S)*100)/100);
  _applyScale();
}
function pwZoomOut(){
  if(_pptOn){ _pptZoomExternal(-0.15); return; }
  _scale=Math.max(MIN_S, Math.round((_scale-STEP_S)*100)/100);
  _applyScale();
}
function pwZoomReset(){ _scale=1.0; _applyScale(); }

/* â•â• ì „ì²´í™”ë©´ â•â• */
function pwFullscreen(){
  if(!document.fullscreenElement) document.documentElement.requestFullscreen().catch(()=>{});
  else document.exitFullscreen();
}

/* â•â• PPT ëª¨ë“œ â•â•
   ì „ì²´í™”ë©´ í›„ vwì— ë§ê²Œ ê° í˜ì´ì§€ width/padding/fontSize ì§ì ‘ ì„¤ì •.
   transform ì—†ìŒ â†’ ì˜ë¦¼ ì—†ìŒ.
   zoom ë²„íŠ¼ì€ PPT ëª¨ë“œ ì¤‘ ë¹„í™œì„±.
*/
let _pptOn=false;
function _getPages(){ return [...document.querySelectorAll('.preview-page')]; }

function _pptApply(){
  const vw=window.innerWidth;
  const ratio=vw/_A4W_PX;
  const fontPx=Math.round(_fontPt*(96/72)*ratio*10)/10;
  _getPages().forEach(p=>{
    p.style.transform=''; p.style.transformOrigin='';
    p.style.width=vw+'px';
    p.style.maxWidth='none';
    p.style.padding=Math.round(22*_MM*ratio)+'px '+Math.round(18*_MM*ratio)+'px';
    p.style.minHeight=Math.round(297*_MM*ratio)+'px';
    p.style.marginBottom='0';
    p.style.boxSizing='border-box';
    p.style.fontSize=fontPx+'px';
    p.style.lineHeight='1.8';
  });
  const bi=document.getElementById('body-inner');
  bi.style.fontSize=fontPx+'px';
  bi.style.alignItems='flex-start';
  document.getElementById('pw-zoom-lbl').textContent=Math.round(ratio*100)+'%';
  _updatePptPg();
}

function _pptRestore(){
  _getPages().forEach(p=>{
    p.style.width=''; p.style.padding=''; p.style.minHeight='';
    p.style.marginBottom=''; p.style.boxSizing=''; p.style.maxWidth='';
  });
  const bi=document.getElementById('body-inner');
  bi.style.fontSize=''; bi.style.alignItems='';
  document.getElementById('pw-zoom-lbl').style.opacity='';
  _applyScale();
  /* font lbl ë³µì› */
  const fl=document.getElementById('pw-font-lbl');
  if(fl)fl.textContent=_fontPt+'pt';
}

function _vpH(){ return window.innerHeight-36; }

function _pptStep(dir){
  const bi=document.getElementById('body-inner');
  const vh=_vpH();
  let next=bi.scrollTop+dir*vh;
  next=Math.max(0,next);
  _getPages().forEach(p=>{
    if(Math.abs(next-p.offsetTop)<vh*0.18) next=p.offsetTop;
  });
  next=Math.min(next, bi.scrollHeight-bi.clientHeight);
  bi.scrollTo({top:next, behavior:'smooth'});
  setTimeout(_updatePptPg,350);
}

function _updatePptPg(){
  const bi=document.getElementById('body-inner');
  const pages=_getPages(); if(!pages.length) return;
  const mid=bi.scrollTop+_vpH()/2;
  let best=0,bestD=Infinity;
  pages.forEach((p,i)=>{
    const d=Math.abs(p.offsetTop+p.offsetHeight/2-mid);
    if(d<bestD){bestD=d;best=i;}
  });
  const pgText=(best+1)+' / '+pages.length;
  document.getElementById('pw-ppt-pg').textContent=pgText;
  document.getElementById('pw-pg-lbl').textContent=pgText;
}

function pwPptPrev(){ _pptStep(-1); }
function pwPptNext(){ _pptStep(1); }

function pwTogglePPT(autoStart){
  const btn=document.getElementById('pw-ppt-btn');
  const nav=document.getElementById('pw-ppt-nav');
  if(!_pptOn){
    _pptOn=true;
    document.body.classList.add('ppt-mode');
    btn.classList.add('active'); btn.textContent='ğŸ¬ ì¢…ë£Œ';
    nav.classList.add('vis');
    PRES.show(); /* í”„ë ˆì  í…Œì´ì…˜ ë„êµ¬ íˆ´ë°” í‘œì‹œ */
    const doApply=()=>requestAnimationFrame(()=>{
      _pptApply();
      document.getElementById('body-inner').scrollTop=0;
    });
    if(!document.fullscreenElement){
      document.documentElement.requestFullscreen()
        .then(()=>setTimeout(doApply,120))
        .catch(()=>doApply());
    } else { doApply(); }
    window._pptResizeH=()=>{
      if(!_pptOn) return;
      const bi=document.getElementById('body-inner');
      const r=bi.scrollTop/Math.max(1,bi.scrollHeight);
      _pptApply();
      setTimeout(()=>{bi.scrollTop=r*bi.scrollHeight;_updatePptPg();},50);
    };
    window.addEventListener('resize',window._pptResizeH);
  } else {
    _pptOn=false;
    document.body.classList.remove('ppt-mode');
    btn.classList.remove('active'); btn.textContent='ğŸ¬ PPT';
    nav.classList.remove('vis');
    PRES.hide(); /* ë„êµ¬ íˆ´ë°” ìˆ¨ê¹€ */
    _pptRestore();
    if(document.fullscreenElement) document.exitFullscreen();
    if(window._pptResizeH){ window.removeEventListener('resize',window._pptResizeH); window._pptResizeH=null; }
    document.getElementById('pw-pg-lbl').textContent=_getPages().length+' í˜ì´ì§€';
  }
}

/* â•â• í”„ë ˆì  í…Œì´ì…˜ ë„êµ¬ (PRES) â•â•
   ë„êµ¬: select(ê¸°ë³¸), pan(ì´ë™), pen(íœ), hl(í˜•ê´‘íœ), laser(í¬ì¸í„°)
   ìº”ë²„ìŠ¤ì— drawing, panì€ body-inner ìŠ¤í¬ë¡¤ ì¡°ì‘
*/
const PRES=(()=>{
  let tool='laser', penColor='#e63030', penSize=4;
  let hlColor='#ffe040', hlSize=18, hlAlpha=0.40;
  let drawing=false;
  let panStartY=0, panStartScroll=0;
  let canvas,ctx,overlay,laserDot;
  let _init=false;

  function init(){
    if(_init)return; _init=true;
    overlay=document.getElementById('pres-overlay');
    canvas=document.getElementById('pres-canvas');
    laserDot=document.getElementById('laser-dot');

    function resize(){
      const imgData=ctx?ctx.getImageData(0,0,canvas.width,canvas.height):null;
      canvas.width=window.innerWidth;
      canvas.height=window.innerHeight;
      ctx=canvas.getContext('2d');
      if(imgData)ctx.putImageData(imgData,0,0);
    }
    resize();
    window.addEventListener('resize',resize);

    /* mousemoveëŠ” documentì— ë“±ë¡ â†’ ì˜¤ë²„ë ˆì´ ë°–ì—ì„œë„ ë ˆì´ì €/pan ì¶”ì  */
    document.addEventListener('mousemove',onMove);
    overlay.addEventListener('mousedown',onDown);
    document.addEventListener('mouseup',onUp);

    /* ë§ˆìš°ìŠ¤ íœ ë¡œ ìŠ¤í¬ë¡¤ (pan/laser ë„êµ¬ì¼ ë•Œ) */
    window.addEventListener('wheel',e=>{
      if(!['pan','laser','select'].includes(tool))return;
      const bi=document.getElementById('body-inner');
      if(bi){bi.scrollTop+=e.deltaY;setTimeout(_updatePptPg,100);}
    },{passive:true});
  }

  function setTool(t){
    tool=t;
    if(!overlay)return;
    document.querySelectorAll('#pres-toolbar .pt-tool').forEach(b=>{
      b.classList.toggle('active-tool',b.dataset.tool===t);
    });
    /* ì˜¤ë²„ë ˆì´ pointer-events */
    overlay.className='';
    if(t==='laser'){
      overlay.className='mode-pointer';
      laserDot.style.display='block';
    } else {
      laserDot.style.display='none';
      if(t==='pan') overlay.className='mode-pan';
      else if(t==='pen'||t==='hl'||t==='eraser') overlay.className='mode-pen';
    }
    /* ì˜µì…˜ íŒ¨ë„ */
    document.getElementById('pt-pen-opts').style.display=(t==='pen')?'flex':'none';
    document.getElementById('pt-hl-opts').style.display=(t==='hl')?'flex':'none';
  }

  function onDown(e){
    if(tool==='pan'){
      drawing=true;
      panStartY=e.clientY;
      const bi=document.getElementById('body-inner');
      panStartScroll=bi?bi.scrollTop:0;
      return;
    }
    if(tool==='pen'||tool==='hl'||tool==='eraser'){
      drawing=true;
      /* ê²½ë¡œ ì‹œì‘: canvas ê¸°ì¤€ ì¢Œí‘œë¡œ ë³€í™˜ */
      const cr=canvas.getBoundingClientRect();
      const sx=e.clientX-cr.left, sy=e.clientY-cr.top;
      ctx.beginPath();
      _setCtxStyle();
      ctx.moveTo(sx,sy);
      /* ì²« ì  ê¸°ë¡ â€” onMoveê°€ ë‹¤ë¥¸ ì¢Œí‘œê³„ ì“°ëŠ” ë²„ê·¸ ë°©ì§€ */
      canvas._lastX=sx; canvas._lastY=sy;
    }
  }

  function _setCtxStyle(){
    if(tool==='eraser'){
      ctx.globalCompositeOperation='destination-out';
      ctx.globalAlpha=1;
      ctx.lineWidth=24;
      ctx.strokeStyle='rgba(0,0,0,1)';
    } else if(tool==='pen'){
      ctx.globalCompositeOperation='source-over';
      ctx.globalAlpha=1;
      ctx.strokeStyle=penColor;
      ctx.lineWidth=penSize;
    } else {
      ctx.globalCompositeOperation='source-over';
      ctx.globalAlpha=hlAlpha;
      ctx.strokeStyle=hlColor;
      ctx.lineWidth=hlSize;
    }
    ctx.lineCap='round';
    ctx.lineJoin='round';
  }

  function onMove(e){
    /* ë ˆì´ì €: overlay ë°–ì—ì„œë„ ì¶”ì  */
    if(tool==='laser'){
      laserDot.style.left=e.clientX+'px';
      laserDot.style.top=e.clientY+'px';
      return;
    }
    if(!drawing)return;
    if(tool==='pan'){
      const bi=document.getElementById('body-inner');
      if(bi)bi.scrollTop=panStartScroll+(panStartY-e.clientY);
      return;
    }
    if(tool==='pen'||tool==='hl'||tool==='eraser'){
      const cr=canvas.getBoundingClientRect();
      const cx=e.clientX-cr.left, cy=e.clientY-cr.top;
      ctx.moveTo(canvas._lastX!==undefined?canvas._lastX:cx,
                 canvas._lastY!==undefined?canvas._lastY:cy);
      ctx.lineTo(cx,cy);
      ctx.stroke();
      ctx.beginPath();
      canvas._lastX=cx; canvas._lastY=cy;
    }
  }

  function onUp(){
    drawing=false;
    if(canvas){canvas._lastX=undefined;canvas._lastY=undefined;}
    if(ctx){ctx.globalAlpha=1;ctx.globalCompositeOperation='source-over';}
  }

  function clearCanvas(){
    if(ctx)ctx.clearRect(0,0,canvas.width,canvas.height);
  }

  function show(){
    init();
    const tb=document.getElementById('pres-toolbar');
    if(tb){
      /* ì´ì „ í¬ì§€ì…˜ í´ë˜ìŠ¤ ë³µì› */
      tb.classList.remove('vis','pos-bottom','pos-right','pos-left');
      tb.classList.add('vis');
      if(_posClasses[_posIdx]) tb.classList.add(_posClasses[_posIdx]);
    }
    const ov=document.getElementById('pres-overlay');
    if(ov) ov.style.display='block';
    setTool('laser');
  }
  function hide(){
    const tb=document.getElementById('pres-toolbar');
    if(tb) tb.classList.remove('vis','pos-bottom','pos-right','pos-left');
    const ov=document.getElementById('pres-overlay');
    if(ov) ov.style.display='none';
    if(laserDot)laserDot.style.display='none';
    clearCanvas();
    tool='laser'; _posIdx=0;
  }

  /* íˆ´ë°” ìœ„ì¹˜ ìˆœí™˜: ìƒë‹¨(ê¸°ë³¸) â†’ í•˜ë‹¨ â†’ ìš°ì¸¡ â†’ ì¢Œì¸¡ â†’ ìƒë‹¨ */
  const _posClasses=['','pos-bottom','pos-right','pos-left'];
  const _posLabels=['ğŸ“Œâ¬†','ğŸ“Œâ¬‡','ğŸ“Œâ–¶','ğŸ“Œâ—€'];
  let _posIdx=0;
  function cyclePos(){
    const tb=document.getElementById('pres-toolbar');
    if(!tb||!tb.classList.contains('vis'))return;
    _posIdx=(_posIdx+1)%_posClasses.length;
    /* ê¸°ì¡´ ìœ„ì¹˜ í´ë˜ìŠ¤ ì œê±° í›„ ìƒˆ í´ë˜ìŠ¤ ì¶”ê°€ */
    tb.classList.remove('pos-bottom','pos-right','pos-left');
    if(_posClasses[_posIdx]) tb.classList.add(_posClasses[_posIdx]);
    const btn=document.getElementById('pt-pos-btn');
    if(btn)btn.title='í˜„ì¬: '+['ìƒë‹¨','í•˜ë‹¨','ìš°ì¸¡','ì¢Œì¸¡'][_posIdx]+' â†’ í´ë¦­ìœ¼ë¡œ ë³€ê²½';
  }

  function _updHlUI(){
    const sl=document.getElementById('pt-hl-size-lbl');
    const al=document.getElementById('pt-hl-alpha-lbl');
    if(sl)sl.textContent=hlSize;
    if(al)al.textContent=Math.round(hlAlpha*100)+'%';
  }
  return{
    show,hide,setTool,clearCanvas,cyclePos,
    setPenColor(col){penColor=col},
    setPenSize(s){penSize=+s},
    setHlColor(col){hlColor=col},
    setHlSize(s){hlSize=+s; _updHlUI();},
    setHlAlpha(v){hlAlpha=+v/100; _updHlUI();},
    hlSizeUp(){hlSize=Math.min(60,hlSize+2); _updHlUI();},
    hlSizeDown(){hlSize=Math.max(4,hlSize-2); _updHlUI();},
    hlAlphaUp(){hlAlpha=Math.min(0.90,+(hlAlpha+0.05).toFixed(2)); _updHlUI();},
    hlAlphaDown(){hlAlpha=Math.max(0.02,+(hlAlpha-0.05).toFixed(2)); _updHlUI();}
  };
})();

/* â•â• Trans â•â• */
let _transOn=false;
function pwToggleTrans(){
  _transOn=!_transOn;
  const btn=document.getElementById('pw-trans-btn');
  document.body.classList.toggle('trans-mode',_transOn);
  btn.classList.toggle('active',_transOn);
  btn.textContent=_transOn?'â†• Portrait':'â†” Trans';
  if(_pptOn){setTimeout(()=>{_pptApply();},80);}
  else {_applyScale();}
}

/* â•â• Dark ë°˜ì „ í…Œë§ˆ â•â• */
let _darkOn=false;
function pwToggleDark(){
  _darkOn=!_darkOn;
  const btn=document.getElementById('pw-dark-btn');
  document.body.classList.toggle('dark-theme',_darkOn);
  btn.classList.toggle('active-dark',_darkOn);
  btn.textContent=_darkOn?'â˜€ Light':'â—‘ Dark';
}

/* â•â• í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤ â•â• */
document.addEventListener('keydown',e=>{
  if(e.key==='F11'){e.preventDefault();pwFullscreen();return;}
  if(!_pptOn)return;
  if(e.key==='ArrowRight'||e.key==='ArrowDown'||e.key==='PageDown'||e.key===' '){e.preventDefault();pwPptNext();}
  else if(e.key==='ArrowLeft'||e.key==='ArrowUp'||e.key==='PageUp'){e.preventDefault();pwPptPrev();}
  else if(e.key==='Escape'){e.preventDefault();pwTogglePPT();}
  else if(e.key==='Home'){e.preventDefault();document.getElementById('body-inner').scrollTo({top:0,behavior:'smooth'});}
  else if(e.key==='End'){const bi=document.getElementById('body-inner');bi.scrollTo({top:bi.scrollHeight,behavior:'smooth'});}
  /* í”„ë ˆì  í…Œì´ì…˜ ë„êµ¬ ë‹¨ì¶•í‚¤ 1~6 */
  else if(e.key==='1')PRES.setTool('laser');
  else if(e.key==='2')PRES.setTool('select');
  else if(e.key==='3')PRES.setTool('pan');
  else if(e.key==='4')PRES.setTool('pen');
  else if(e.key==='5')PRES.setTool('hl');
  else if(e.key==='6')PRES.setTool('eraser');
  else if(e.key==='p'||e.key==='P')PRES.cyclePos();
});

/* â•â• ë§ˆìš°ìŠ¤ íœ  ìŠ¤í¬ë¡¤ (PPT ëª¨ë“œ) â•â• */
window.addEventListener('wheel',e=>{
  if(!_pptOn)return;
  const bi=document.getElementById('body-inner');
  bi.scrollTop+=e.deltaY;
  setTimeout(_updatePptPg,100);
},{passive:true});

/* í˜ì´ì§€ ìˆ˜ í‘œì‹œ + ì°½ í¬ê¸°ì— í•­ìƒ fit */
window.addEventListener('load',()=>{
  const n=document.querySelectorAll('.preview-page').length;
  document.getElementById('pw-pg-lbl').textContent='1 / '+n;
  _fitToWindow();
  /* ì¼ë°˜ ëª¨ë“œ ìŠ¤í¬ë¡¤ ì‹œ í˜ì´ì§€ í‘œì‹œ ê°±ì‹  */
  const bi=document.getElementById('body-inner');
  bi.addEventListener('scroll',()=>{
    if(_pptOn)return; /* PPT ëª¨ë“œëŠ” _updatePptPgê°€ ì²˜ë¦¬ */
    const pages=[...document.querySelectorAll('.preview-page')];
    if(!pages.length)return;
    const mid=bi.scrollTop+window.innerHeight*0.3;
    let cur=0;
    for(let i=0;i<pages.length;i++){if(pages[i].offsetTop<=mid)cur=i;}
    document.getElementById('pw-pg-lbl').textContent=(cur+1)+' / '+pages.length;
  },{passive:true});
});<\/script></body></html>`;
  }

  // ì´ìŠˆ1 ìˆ˜ì •: ë©”ì‹œì§€ ë¦¬ìŠ¤ë„ˆë¥¼ open() ë°–ì—ì„œ 1íšŒë§Œ ë“±ë¡
  let _msgListenerRegistered=false;
  function _initMsgListener(){
    if(_msgListenerRegistered)return;
    _msgListenerRegistered=true;
    window.addEventListener('message',e=>{
      if(e.data&&e.data.type==='pvS'){
        const r=e.data.ratio;
        const ed2=el('editor');
        ed2.scrollTop=r*(ed2.scrollHeight-ed2.clientHeight);
        const pc=el('preview-container');
        pc.scrollTop=r*(pc.scrollHeight-pc.clientHeight);
      }
    });
  }

  function open(){
    _initMsgListener();
    const title=el('doc-title').value;
    if(win&&!win.closed){win.focus();sync();return}
    const w=920,h=Math.floor(window.screen.height*.88);
    const left=window.screenX+window.outerWidth+10,top=window.screenY;
    try{
      win=window.open('','_blank',`width=${w},height=${h},left=${left},top=${top},resizable=yes,scrollbars=yes`);
      if(!win)throw 0;
      win.document.open();win.document.write(buildHTML(el('editor').value,title));win.document.close();
      el('pw-btn').classList.add('open');
      win.addEventListener('beforeunload',()=>el('pw-btn').classList.remove('open'));
    }catch(e){alert('íŒì—…ì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤.');}
  }

  function pushScroll(r){if(!win||win.closed)return;try{win.postMessage({type:'ss',ratio:r},'*')}catch(e){}}

  function sync(){
    clearTimeout(st);st=setTimeout(()=>{
      if(!win||win.closed){el('pw-btn').classList.remove('open');return}
      const title=el('doc-title').value;
      try{const sy=win.scrollY,sh=win.document.body.scrollHeight,ih=win.innerHeight,r=sy/Math.max(1,sh-ih);
        win.document.open();win.document.write(buildHTML(el('editor').value,title));win.document.close();
        setTimeout(()=>{if(!win||win.closed)return;win.scrollTo(0,r*(win.document.body.scrollHeight-win.innerHeight))},150);
      }catch(e){}
    },200);
  }

  function forceRefresh(){if(win&&!win.closed){const t=el('doc-title').value;try{win.document.open();win.document.write(buildHTML(el('editor').value,t));win.document.close()}catch(e){}}else open()}
  function checkClosed(){if(win&&win.closed){el('pw-btn').classList.remove('open');win=null;}}
  function setRM(v){rm=v}

  /* PPT ëª¨ë“œë¡œ ë°”ë¡œ ì—´ê¸° */
  function openPPT(){
    _initMsgListener();
    const title=el('doc-title').value;
    /* ì´ë¯¸ ì°½ì´ ì—´ë ¤ìˆìœ¼ë©´ ì¬ì‚¬ìš© */
    if(win&&!win.closed){
      win.focus();
      // ì•½ê°„ ë”œë ˆì´ í›„ PPT ì‹œì‘ ë©”ì‹œì§€
      setTimeout(()=>{try{win.postMessage({type:'startPPT'},'*')}catch(e){}},300);
      return;
    }
    const w=Math.floor(window.screen.width*.9);
    const h=Math.floor(window.screen.height*.9);
    const left=Math.floor((window.screen.width-w)/2);
    const top=Math.floor((window.screen.height-h)/2);
    try{
      win=window.open('','_blank',`width=${w},height=${h},left=${left},top=${top},resizable=yes,scrollbars=no`);
      if(!win)throw 0;
      win.document.open();win.document.write(buildHTML(el('editor').value,title));win.document.close();
      el('pw-btn').classList.add('open');
      win.addEventListener('beforeunload',()=>el('pw-btn').classList.remove('open'));
      // ë¡œë“œ ì™„ë£Œ í›„ PPT ìë™ ì‹œì‘
      setTimeout(()=>{try{win.postMessage({type:'startPPT'},'*')}catch(e){}},800);
    }catch(e){alert('íŒì—…ì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤.');}
  }

  return{open,sync,forceRefresh,checkClosed,pushScroll,setRM,openPPT};
})();

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SCROLL SYNC â€” í—¤ë”© ì•µì»¤ ê¸°ë°˜ ë™ê¸°í™”
   ì—ë””í„°ì˜ í˜„ì¬ ìŠ¤í¬ë¡¤ ìœ„ì¹˜ì—ì„œ ì§ì „ í—¤ë”©ì„ ì°¾ì•„
   ë¯¸ë¦¬ë³´ê¸°ì˜ ê°™ì€ í—¤ë”©ìœ¼ë¡œ ì í”„ + í—¤ë”© ì‚¬ì´ ë¹„ìœ¨ë¡œ ë³´ì •
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const SS=(()=>{
  let lock=false,t=null;

  /* ì—ë””í„° ë¼ì¸ ê¸°ë°˜ í—¤ë”© ë§µ ë¹Œë“œ
     ë°˜í™˜: [{line, id, edY}] â€” ì—ë””í„° ìŠ¤í¬ë¡¤ px ì¢Œí‘œ í¬í•¨ */
  function buildEdMap(ed){
    const lines=ed.value.split('\n');
    const lineH=ed.scrollHeight/Math.max(1,lines.length); /* ì¤„ë‹¹ í‰ê·  ë†’ì´ */
    const map=[];
    lines.forEach((ln,i)=>{
      const m=ln.match(/^(#{1,3})\s+(.+)/);
      if(!m)return;
      const text=m[2].replace(/[*_`]/g,'');
      const id='h-'+text.toLowerCase().replace(/[^a-z0-9ê°€-í£\s]/g,'').replace(/\s+/g,'-').substring(0,50);
      map.push({line:i,id,edY:i*lineH});
    });
    return map;
  }

  /* ì—ë””í„° scrollTop â†’ ì§ì „ í—¤ë”© + êµ¬ê°„ ë‚´ ë¹„ìœ¨ */
  function edScrollToAnchor(ed){
    const map=buildEdMap(ed);
    if(!map.length)return null;
    const st=ed.scrollTop;
    let prev=map[0],next=null;
    for(let i=0;i<map.length;i++){
      if(map[i].edY<=st+2){prev=map[i];next=map[i+1]||null;}
      else break;
    }
    const segLen=next?next.edY-prev.edY:ed.scrollHeight-prev.edY;
    const ratio=segLen>0?Math.min(1,(st-prev.edY)/segLen):0;
    return{id:prev.id,ratio,nextId:next?next.id:null};
  }

  /* ë¯¸ë¦¬ë³´ê¸°ì—ì„œ í—¤ë”© id â†’ scrollTop ê³„ì‚° */
  function pvYofId(pc,id){
    const el2=pc.querySelector(`#${id}`);
    if(!el2)return null;
    return el2.offsetTop - (el2.closest('.preview-page')?.offsetTop||0)
         + (el2.closest('.preview-page')?.offsetTop||0)
         - pc.offsetTop + pc.scrollTop
         - el2.offsetParent?.offsetTop||0;
  }
  function pvAbsY(pc,id){
    const h=pc.querySelector(`#${id}`);
    if(!h)return null;
    /* getBoundingClientRect ê¸°ë°˜ â€” ìŠ¤í¬ë¡¤ í¬í•¨ ì ˆëŒ€ê°’ */
    const pcRect=pc.getBoundingClientRect();
    const hRect=h.getBoundingClientRect();
    return pc.scrollTop+(hRect.top-pcRect.top);
  }

  /* ì—ë””í„° â†’ ë¯¸ë¦¬ë³´ê¸° ë™ê¸°í™” */
  function syncEdToPv(){
    const ed=el('editor'),pc=el('preview-container');
    const anchor=edScrollToAnchor(ed);
    if(!anchor){
      /* í—¤ë”© ì—†ìœ¼ë©´ ë¹„ìœ¨ fallback */
      const r=ed.scrollTop/Math.max(1,ed.scrollHeight-ed.clientHeight);
      pc.scrollTop=r*(pc.scrollHeight-pc.clientHeight);
      PW.pushScroll(r);
      return;
    }
    const y0=pvAbsY(pc,anchor.id);
    if(y0===null){
      const r=ed.scrollTop/Math.max(1,ed.scrollHeight-ed.clientHeight);
      pc.scrollTop=r*(pc.scrollHeight-pc.clientHeight);
      return;
    }
    const y1=anchor.nextId?pvAbsY(pc,anchor.nextId):null;
    const segPv=y1!==null?y1-y0:pc.scrollHeight-y0;
    pc.scrollTop=y0+segPv*anchor.ratio;
    const rGlobal=pc.scrollTop/Math.max(1,pc.scrollHeight-pc.clientHeight);
    PW.pushScroll(rGlobal);
  }

  /* ë¯¸ë¦¬ë³´ê¸° â†’ ì—ë””í„° ë™ê¸°í™” (ë¹„ìœ¨ ê¸°ë°˜ fallback ìœ ì§€) */
  function syncPvToEd(){
    const ed=el('editor'),pc=el('preview-container');
    const r=pc.scrollTop/Math.max(1,pc.scrollHeight-pc.clientHeight);
    /* ë¯¸ë¦¬ë³´ê¸°ì—ì„œ í˜„ì¬ ë³´ì´ëŠ” í—¤ë”©ì„ ì—­ìœ¼ë¡œ ì°¾ì•„ ì—ë””í„° ì í”„ */
    const map=buildEdMap(ed);
    if(!map.length){
      ed.scrollTop=r*(ed.scrollHeight-ed.clientHeight);
      return;
    }
    /* ë¯¸ë¦¬ë³´ê¸°ì—ì„œ scrollTop ì§ì „ í—¤ë”© */
    let bestId=null,bestY=-Infinity;
    map.forEach(m=>{
      const y=pvAbsY(pc,m.id);
      if(y!==null&&y<=pc.scrollTop+8&&y>bestY){bestY=y;bestId=m.id;}
    });
    if(!bestId){
      ed.scrollTop=r*(ed.scrollHeight-ed.clientHeight);
      return;
    }
    const idx=map.findIndex(m=>m.id===bestId);
    const cur=map[idx],nxt=map[idx+1]||null;
    const pvSeg=nxt?pvAbsY(pc,nxt.id)-bestY:pc.scrollHeight-bestY;
    const pvOff=Math.max(0,pc.scrollTop-bestY);
    const segRatio=pvSeg>0?Math.min(1,pvOff/pvSeg):0;
    const edSeg=nxt?nxt.edY-cur.edY:ed.scrollHeight-cur.edY;
    ed.scrollTop=cur.edY+edSeg*segRatio;
  }

  function init(){
    const ed=el('editor'),pc=el('preview-container');
    ed.addEventListener('scroll',()=>{
      if(lock)return;
      clearTimeout(t);
      t=setTimeout(()=>{lock=true;syncEdToPv();setTimeout(()=>lock=false,80);},8);
    },{passive:true});
    pc.addEventListener('scroll',()=>{
      if(lock)return;
      clearTimeout(t);
      t=setTimeout(()=>{lock=true;syncPvToEd();setTimeout(()=>lock=false,80);},8);
    },{passive:true});
  }
  return{init};
})();

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TOC
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const TOC=(()=>{
  let obs=null;
  function build(md){
    const list=el('toc-list');const hs=[];const cnt=[0,0,0];
    md.split('\n').forEach(line=>{const m=line.match(/^(#{1,3})\s+(.+)/);if(!m)return;const lv=m[1].length,text=m[2].replace(/[*_`]/g,'');const id='h-'+text.toLowerCase().replace(/[^a-z0-9ê°€-í£\s]/g,'').replace(/\s+/g,'-').substring(0,50);cnt[lv-1]++;for(let i=lv;i<3;i++)cnt[i]=0;const num=lv===1?cnt[0]:lv===2?`${cnt[0]}.${cnt[1]}`:`${cnt[0]}.${cnt[1]}.${cnt[2]}`;hs.push({lv,text,id,num})});
    if(!hs.length){list.innerHTML='<div style="padding:12px;color:var(--tx3);font-size:12px">í—¤ë”©(#)ì„ ì¶”ê°€í•˜ë©´ ìë™ ìƒì„±ë©ë‹ˆë‹¤.</div>';return}
    list.innerHTML=hs.map(h=>`<div class="toc-item" data-level="${h.lv}" data-id="${h.id}" onclick="TOC.go('${h.id}')"><span class="toc-num">${h.num}</span><span style="flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${h.text}</span></div>`).join('');
    attachObs();
  }
  function go(id){const e=document.querySelector(`#preview-container #${id}`);if(e){e.scrollIntoView({behavior:'smooth',block:'start'});document.querySelectorAll('.toc-item').forEach(i=>i.classList.remove('active'));document.querySelectorAll(`.toc-item[data-id="${id}"]`).forEach(i=>i.classList.add('active'))}}
  function attachObs(){if(obs)obs.disconnect();const pc=el('preview-container');obs=new IntersectionObserver(es=>{es.forEach(e=>{if(e.isIntersecting){const id=e.target.id;document.querySelectorAll('.toc-item').forEach(i=>i.classList.remove('active'));document.querySelectorAll(`.toc-item[data-id="${id}"]`).forEach(i=>i.classList.add('active'))}})},{root:pc,threshold:.15});pc.querySelectorAll('h1,h2,h3').forEach(h=>obs.observe(h))}

  /* ëª©ì°¨ ìë™ ì‚½ì… â€” ë¬¸ì„œ ë§¨ ì•(ë˜ëŠ” ì²« h1 ì•)ì— ë§ˆí¬ë‹¤ìš´ ëª©ì°¨ ë¸”ë¡ ì‚½ì… */
  function insertTOC(){
    const ed=el('editor');
    const md=ed.value;
    const lines=md.split('\n');
    const hs=[];const cnt=[0,0,0];
    lines.forEach(ln=>{
      const m=ln.match(/^(#{1,3})\s+(.+)/);
      if(!m)return;
      const lv=m[1].length,text=m[2].replace(/[*_`[\]()]/g,'').trim();
      const id='h-'+text.toLowerCase().replace(/[^a-z0-9ê°€-í£\s]/g,'').replace(/\s+/g,'-').substring(0,50);
      cnt[lv-1]++;for(let i=lv;i<3;i++)cnt[i]=0;
      const num=lv===1?`${cnt[0]}`:lv===2?`${cnt[0]}.${cnt[1]}`:`${cnt[0]}.${cnt[1]}.${cnt[2]}`;
      const indent='  '.repeat(lv-1);
      hs.push(`${indent}- [${num}. ${text}](#${id})`);
    });
    if(!hs.length){alert('í—¤ë”©(#)ì´ ì—†ì–´ ëª©ì°¨ë¥¼ ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');return;}
    const tocBlock=`## ëª©ì°¨\n\n${hs.join('\n')}\n\n---\n\n`;
    /* ì´ë¯¸ ëª©ì°¨ ë¸”ë¡ì´ ìˆìœ¼ë©´ êµì²´, ì—†ìœ¼ë©´ ì•ì— ì‚½ì… */
    const existing=/^## ëª©ì°¨\n[\s\S]*?---\n\n/m;
    if(existing.test(md)){
      ed.value=md.replace(existing,tocBlock);
    } else {
      ed.value=tocBlock+md;
    }
    US.snap();App.render();
  }

  return{build,go,insertTOC};
})();

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LINE NUMBERS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const LN=(()=>{
  let v=false;
  function update(){if(!v)return;const ed=el('editor'),c=el('lnc');c.innerHTML=ed.value.split('\n').map((_,i)=>`<div class="ln">${i+1}</div>`).join('');el('line-numbers').scrollTop=ed.scrollTop}
  function toggle(){v=!v;el('line-numbers').classList.toggle('vis',v);el('editor').classList.toggle('wln',v);el('ln-btn').classList.toggle('active',v);update()}
  return{update,toggle};
})();

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   AUTO SAVE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const AS=(()=>{
  let t;const K='mdpro_v7';
  function load(){try{const d=JSON.parse(localStorage.getItem(K)||'{}');if(d.c)el('editor').value=d.c;if(d.t)el('doc-title').value=d.t}catch(e){}}
  function save(c,t2){
    clearTimeout(t);
    el('save-dot').classList.add('saving');
    el('save-st').textContent='ì €ì¥ ì¤‘...';
    t=setTimeout(()=>{
      try{
        localStorage.setItem(K,JSON.stringify({c,t:t2,ts:Date.now()}));
        el('save-dot').classList.remove('saving');
        el('save-dot').style.background='';
        el('save-st').textContent='ì €ì¥ë¨';
      }catch(e){
        // ì´ìŠˆ2 ìˆ˜ì •: QuotaExceededError ë“± ì €ì¥ ì‹¤íŒ¨ ì‹œ ì‚¬ìš©ìì—ê²Œ ëª…ì‹œì ìœ¼ë¡œ ì•Œë¦¼
        el('save-dot').classList.remove('saving');
        el('save-dot').style.background='#f76a6a';
        el('save-st').textContent='âš  ìë™ì €ì¥ ì‹¤íŒ¨ (ìš©ëŸ‰ ì´ˆê³¼) â€” ğŸ’¾ ì €ì¥ ë²„íŠ¼ìœ¼ë¡œ íŒŒì¼ ì €ì¥ ê¶Œì¥';
        console.warn('localStorage ì €ì¥ ì‹¤íŒ¨:',e);
      }
    },1000);
  }
  return{load,save};
})();

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CITATION MANAGER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const CM=(()=>{
  const KEY='mdpro_refs';let refs=[];let sep='blank';// blank|line

  function load(){try{refs=JSON.parse(localStorage.getItem(KEY)||'[]')}catch(e){refs=[]}}
  function save(){try{localStorage.setItem(KEY,JSON.stringify(refs))}catch(e){}}

  function setSep(s){
    sep=s;
    el('sep-blank-btn').classList.toggle('active',s==='blank');
    el('sep-line-btn').classList.toggle('active',s==='line');
    const descs={blank:'í˜„ì¬: ë¹ˆ ì¤„ë¡œ êµ¬ë¶„ â€” í•­ëª© ì‚¬ì´ì— ë¹ˆ ì¤„ í•˜ë‚˜ë¥¼ ë„£ì–´ êµ¬ë¶„í•˜ì„¸ìš”.',line:'í˜„ì¬: ì—”í„°(ì¤„ë°”ê¿ˆ)ë¡œ êµ¬ë¶„ â€” ê° ì¤„ì´ í•˜ë‚˜ì˜ ì°¸ê³ ë¬¸í—Œìœ¼ë¡œ ì²˜ë¦¬ë©ë‹ˆë‹¤.'};
    el('sep-desc').textContent=descs[s];
  }

  /* APA parser */
  function parseAPA(line){
    line=line.trim();if(!line||line.length<10)return null;
    const ym=line.match(/\((\d{4}[a-z]?)\)/);const year=ym?ym[1]:'?';
    let ap=ym?line.substring(0,line.indexOf(ym[0])).trim().replace(/,\s*$/,''):line.split('.')[0];
    const names=ap.split(/,\s*&\s*|;\s*|,\s*(?=[A-Zê°€-í£])/).map(s=>s.trim().split(',')[0].trim()).filter(Boolean);
    let key=names.length===1?`${names[0]}, ${year}`:names.length===2?`${names[0]} & ${names[1]}, ${year}`:`${names[0]} et al., ${year}`;
    return{key,year,author:names[0]||'Unknown',full:line,id:Date.now()+Math.random(),mla:'',chicago:''};
  }

  function parse(){
    const raw=el('cite-raw').value;if(!raw.trim())return;
    let lines;
    if(sep==='blank'){
      // Split by one or more blank lines
      lines=raw.split(/\n[ \t]*\n+/).map(block=>
        block.split('\n').map(l=>l.trim()).filter(Boolean).join(' ')
      ).map(l=>l.replace(/^\d+[\.\)]\s*/,'')).filter(l=>l.length>10);
    }else{
      // Each non-empty line is one reference
      lines=raw.split('\n').map(l=>l.replace(/^\d+[\.\)]\s*/,'').trim()).filter(l=>l.length>10);
    }
    let added=0;
    lines.forEach(l=>{const p=parseAPA(l);if(p&&!refs.find(r=>r.full===p.full)){p.mla=toMLA(p);p.chicago=toChicago(p);refs.push(p);added++}});
    save();
    el('cite-msg').textContent=added?`âœ“ ${added}ê±´ ì¶”ê°€ë¨ (ì´ ${refs.length}ê±´)`:lines.length?'ì´ë¯¸ ì¡´ì¬í•˜ê±°ë‚˜ íŒŒì‹± ì‹¤íŒ¨':'ë¹ˆ ì¤„ì´ ì—†ìŠµë‹ˆë‹¤ â€” êµ¬ë¶„ ë°©ì‹ì„ í™•ì¸í•˜ì„¸ìš”';
    setTimeout(()=>el('cite-msg').textContent='',4000);
    renderLib();renderList('');
  }

  function loadFile(ev){
    const file=ev.target.files[0];if(!file)return;
    const reader=new FileReader();
    reader.onload=e=>{el('cite-raw').value=e.target.result;};
    reader.readAsText(file,'utf-8');
    ev.target.value='';
  }

  /* Style converters (heuristic) */
  function toMLA(ref){
    // APA: Author, A. A., & Author, B. B. (Year). Title. Journal, Vol(No), pp. DOI
    const m=ref.full.match(/^(.+?)\.\s*\((\d{4}[a-z]?)\)\.\s*(.+?)\.\s*([^,]+),\s*(\d+)\((\d+)\),\s*([\dâ€“\-]+)/);
    if(m){const[,authors,year,title,journal,vol,no,pp]=m;return`${expandAuthors(authors)} "${capTitle(title.trim())}" ${journal}, vol. ${vol}, no. ${no}, ${year}, pp. ${pp}.`}
    // fallback â€” use ref.year (not local year which is out of scope here)
    const fy=ref.year||'?';
    const titlePart=ref.full.replace(/\(.*?\)\./,'').replace(/^[^.]+\.\s*/,'').trim();
    return`${ref.author}. "${titlePart}" ${fy}.`;
  }

  function toChicago(ref){
    const m=ref.full.match(/^(.+?)\.\s*\((\d{4}[a-z]?)\)\.\s*(.+?)\.\s*([^,]+),\s*(\d+)\((\d+)\),\s*([\dâ€“\-]+)/);
    if(m){const[,authors,year,title,journal,vol,no,pp]=m;return`${expandAuthors(authors)} ${year}. "${capTitle(title.trim())}" ${journal} ${vol} (${no}): ${pp}.`}
    return`${ref.author}. ${ref.year}. "${ref.full}."`;
  }

  function toVancouver(ref){
    const m=ref.full.match(/^(.+?)\.\s*\((\d{4}[a-z]?)\)\.\s*(.+?)\.\s*([^,]+),\s*(\d+)\((\d+)\),\s*([\dâ€“\-]+)/);
    if(m){const[,authors,year,title,journal,vol,no,pp]=m;const au=authors.split(/,\s*&\s*|;\s*/).map(s=>s.trim()).join(', ');return`${au}. ${title.trim()}. ${journal}. ${year};${vol}(${no}):${pp}.`}
    return ref.full;
  }

  function expandAuthors(s){return s.replace(/\s*&\s*/g,', and ').replace(/,\s*et\s+al\./,'et al.')}
  function capTitle(t){return t.replace(/\b(\w)/g,(m,c,i)=>i===0||'.:!?'.includes(t[i-1])?c.toUpperCase():m)}

  function convertByStyle(ref,style){
    if(style==='mla')return ref.mla||toMLA(ref);
    if(style==='chicago')return ref.chicago||toChicago(ref);
    if(style==='vancouver')return toVancouver(ref);
    return ref.full;// APA
  }

  function convertStyle(){
    const from=el('from-style').value,to=el('to-style').value;
    const raw=el('conv-input').value.trim();
    if(!raw){el('conv-output').value='ì…ë ¥ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.';return}
    const p=parseAPA(raw);if(!p){el('conv-output').value='íŒŒì‹± ì‹¤íŒ¨ â€” APA í˜•ì‹ì„ í™•ì¸í•˜ì„¸ìš”.';return}
    p.mla=toMLA(p);p.chicago=toChicago(p);
    el('conv-output').value=convertByStyle(p,to);
    const labels={apa:'APA 7',mla:'MLA 9',chicago:'Chicago (Author-Date)',vancouver:'Vancouver'};
    el('conv-label').textContent=`â†’ ${labels[to]}`;
  }
  function copyConverted(){const v=el('conv-output').value;if(v)navigator.clipboard.writeText(v).then(()=>{}).catch(()=>{})}
  function insertConverted(){const v=el('conv-output').value;if(!v)return;const ed=el('editor'),pos=ed.selectionEnd;ins(ed,pos,pos,'\n'+v+'\n');App.hideModal('cite-modal')}

  /* List rendering */
  function renderList(q){
    const area=el('cite-list-area');
    const flt=refs.filter(r=>!q||r.full.toLowerCase().includes(q.toLowerCase())||r.key.toLowerCase().includes(q.toLowerCase()));
    if(!flt.length){area.innerHTML='<div class="cite-empty">í•´ë‹¹ ë¬¸í—Œ ì—†ìŒ. ì¶”ê°€ íƒ­ì—ì„œ ë¨¼ì € ì…ë ¥í•˜ì„¸ìš”.</div>';return}
    area.innerHTML=flt.map(r=>`<div class="cite-entry" onclick="CM.toggle('cb_${r.id}')"><input type="checkbox" id="cb_${r.id}" data-id="${r.id}" onchange="CM.upd()" onclick="event.stopPropagation()"><div class="cite-body"><div class="cite-key">${r.key}</div><div class="cite-full" title="${r.full}">${r.full}</div></div></div>`).join('');
    upd();
  }

  function filter(){renderList(el('cite-search').value)}
  function toggle(id){const cb=el(id);if(cb){cb.checked=!cb.checked;upd()}}
  function getSel(){return Array.from(document.querySelectorAll('#cite-list-area input:checked')).map(cb=>refs.find(r=>String(r.id)===cb.dataset.id)).filter(Boolean)}
  function upd(){const n=getSel().length;el('cite-sc').textContent=`${n}ê°œ ì„ íƒë¨`;el('cite-ins-btn').style.display=n>0?'':'none'}
  function selAll(){document.querySelectorAll('#cite-list-area input[type=checkbox]').forEach(cb=>cb.checked=true);upd()}
  function clrSel(){document.querySelectorAll('#cite-list-area input[type=checkbox]').forEach(cb=>cb.checked=false);upd()}

  function insert(){
    const sel=getSel();if(!sel.length)return;
    const style=el('cite-style').value;const ed=el('editor');const pos=ed.selectionStart;let text='';
    if(style==='inline')text='('+sel.map(r=>r.key).join('; ')+')';
    else if(style==='narrative')text=sel.map(r=>`${r.author}(${r.year})`).join('; ');
    else if(style==='multi')text='('+sel.map(r=>r.key).join('; ')+')';
    else if(style==='footnote'){let it='',dt='\n';sel.forEach((r,i)=>{const n=Math.floor((ed.value.match(/\[\^\d+\]/g)||[]).length/2)+i+1;it+=`[^${n}]`;dt+=`[^${n}]: ${r.full}\n`});ed.value=ed.value.substring(0,pos)+it+ed.value.substring(pos)+dt;App.render();US.snap();App.hideModal('cite-modal');return}
    ed.value=ed.value.substring(0,pos)+text+ed.value.substring(pos);ed.setSelectionRange(pos+text.length,pos+text.length);App.render();US.snap();App.hideModal('cite-modal');
  }

  function renderLib(){
    el('lib-cnt').textContent=refs.length;
    if(!refs.length){el('lib-list').innerHTML='<div class="cite-empty">ì €ì¥ëœ ì°¸ê³ ë¬¸í—Œì´ ì—†ìŠµë‹ˆë‹¤.</div>';return}
    el('lib-list').innerHTML=refs.map((r,i)=>`<div class="lib-item"><span class="lib-key">${r.key}</span><span style="flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;font-size:11px" title="${r.full}">${r.full}</span><span style="font-size:10px;color:var(--tx3);flex-shrink:0;margin:0 4px">${r.mla?'MLAâœ“':''}</span><button class="btn-ic" style="color:var(--er);font-size:12px;flex-shrink:0" onclick="CM.del(${i})">âœ•</button></div>`).join('');
  }

  function del(i){refs.splice(i,1);save();renderLib();renderList(el('cite-search')?.value||'')}
  function clearAll(){if(!confirm('ëª¨ë“  ì°¸ê³ ë¬¸í—Œì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?'))return;refs=[];save();renderLib();renderList('')}

  function insertRefSection(){
    const ed=el('editor');const pos=ed.selectionEnd;
    const list=refs.map((r,i)=>`${i+1}. ${r.full}`).join('\n');
    const block=`\n\n<div class="ref-block">\n\n**ì°¸ê³ ë¬¸í—Œ**\n\n${list}\n\n</div>\n`;
    ed.value=ed.value.substring(0,pos)+block+ed.value.substring(pos);App.render();US.snap();App.hideModal('cite-modal');
  }

  function downloadLib(){
    let content=`# ì°¸ê³ ë¬¸í—Œ ëª©ë¡ (${new Date().toLocaleDateString()})\n\n`;
    content+=`## APA 7\n\n`;refs.forEach((r,i)=>{content+=`${i+1}. ${r.full}\n`});
    content+=`\n## MLA 9\n\n`;refs.forEach((r,i)=>{content+=`${i+1}. ${r.mla||toMLA(r)}\n`});
    content+=`\n## Chicago (Author-Date)\n\n`;refs.forEach((r,i)=>{content+=`${i+1}. ${r.chicago||toChicago(r)}\n`});
    dlBlob(content,'references.txt','text/plain;charset=utf-8');
  }

  function tab(name){
    const names=['add','cite','convert','lib','search'];
    document.querySelectorAll('#cite-modal .tab').forEach((t,i)=>t.classList.toggle('active',names[i]===name));
    names.forEach(n=>el(`cp-${n}`)?.classList.toggle('active',n===name));
    if(name==='cite'){renderList(el('cite-search')?.value||'');el('cite-ins-btn').style.display='none'}
    if(name==='lib')renderLib();
    if(name==='search')setTimeout(()=>el('ref-q')?.focus(),80);
  }

  // RefSearch ì—ì„œ ë‹¨ì¼ APA ë¬¸ìì—´ì„ ì§ì ‘ ì¶”ê°€í•˜ëŠ” ê³µê°œ ë©”ì„œë“œ
  function addRaw(apaStr){
    apaStr=apaStr.trim();if(!apaStr)return;
    const p=parseAPA(apaStr);
    if(p&&!refs.find(r=>r.full===p.full)){p.mla=toMLA(p);p.chicago=toChicago(p);refs.push(p);save();renderLib();}
  }

  function open(){load();renderList('');renderLib();el('cite-ins-btn').style.display='none'}

  return{load,setSep,parse,loadFile,filter,toggle,getSel,upd,selAll,clrSel,insert,del,clearAll,insertRefSection,downloadLib,convertStyle,copyConverted,insertConverted,tab,open,addRaw};
})();

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CAPTION MANAGER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const CAP=(()=>{
  let type='table';let selOpt=0;

  const tableOpts=[
    {label:'&lt;í‘œ N&gt;',template:(n,d)=>`<í‘œ${n}> ${d}`},
    {label:'í‘œ N.',template:(n,d)=>`í‘œ ${n}. ${d}`},
    {label:'&lt;Table N&gt;',template:(n,d)=>`<Table ${n}> ${d}`},
    {label:'Table N.',template:(n,d)=>`Table ${n}. ${d}`},
  ];
  const figOpts=[
    {label:'[ê·¸ë¦¼ N]',template:(n,d)=>`[ê·¸ë¦¼ ${n}] ${d}`},
    {label:'ê·¸ë¦¼ N.',template:(n,d)=>`ê·¸ë¦¼ ${n}. ${d}`},
    {label:'[Fig N]',template:(n,d)=>`[Fig ${n}] ${d}`},
    {label:'Fig N.',template:(n,d)=>`Fig ${n}. ${d}`},
    {label:'[Figure N]',template:(n,d)=>`[Figure ${n}] ${d}`},
    {label:'Figure N.',template:(n,d)=>`Figure ${n}. ${d}`},
  ];

  function show(t){
    type=t;selOpt=0;
    el('cap-title').textContent=t==='table'?'í‘œ ìº¡ì…˜ ì‚½ì…':'ê·¸ë¦¼ ìº¡ì…˜ ì‚½ì…';
    const opts=t==='table'?tableOpts:figOpts;
    el('cap-opts').innerHTML=opts.map((o,i)=>`<span class="cap-opt${i===0?' sel':''}" onclick="CAP.selOpt(${i})">${o.label}</span>`).join('');
    el('cap-num').value='1';el('cap-desc').value='';
    updatePreview();
    el('caption-modal').classList.add('vis');
  }

  function selOptFn(i){
    selOpt=i;
    document.querySelectorAll('#cap-opts .cap-opt').forEach((o,j)=>o.classList.toggle('sel',j===i));
    updatePreview();
  }

  function updatePreview(){
    const opts=type==='table'?tableOpts:figOpts;
    const n=el('cap-num').value||'1';
    const d=el('cap-desc').value||'(ìº¡ì…˜ ë‚´ìš©)';
    el('cap-preview').textContent=opts[selOpt].template(n,d);
  }

  function insert(){
    const opts=type==='table'?tableOpts:figOpts;
    const n=el('cap-num').value||'1';
    const d=el('cap-desc').value||'ë‚´ìš©';
    const caption=opts[selOpt].template(n,d);
    const ed=el('editor');const pos=ed.selectionEnd;
    const cssClass=type==='table'?'tbl-caption':'fig-caption';
    const md=`\n<span class="${cssClass}">${caption}</span>\n`;
    ins(ed,pos,pos,md);
    App.hideModal('caption-modal');
  }

  return{show,selOpt:selOptFn,updatePreview,insert};
})();

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PAPER TEMPLATES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const TMPLS=[
  {name:'í•™ìœ„ë…¼ë¬¸ (ì‚¬íšŒê³¼í•™Â·êµìœ¡í•™Â·ì‹¬ë¦¬í•™)',icon:'ğŸ“',desc:'êµ­ë¬¸ì´ˆë¡, Abstract, 6ì¥ êµ¬ì¡°',content:`# ë…¼ë¬¸ ì œëª©

---

## êµ­ë¬¸ì´ˆë¡

í•µì‹¬ì–´: 

---

## Abstract

Keywords: 

---

## ëª©ì°¨

---

## í‘œ ëª©ì°¨

---

## ê·¸ë¦¼ ëª©ì°¨

---

# ì œ1ì¥ ì„œë¡ 

## 1. ì—°êµ¬ì˜ í•„ìš”ì„±

## 2. ì—°êµ¬ ëª©ì 

## 3. ì—°êµ¬ ë¬¸ì œ

1. 
2. 

## 4. ì—°êµ¬ ê°€ì„¤

## 5. ìš©ì–´ì˜ ì •ì˜

## 6. ì—°êµ¬ì˜ ì œí•œì 

<div class="page-break"></div>

# ì œ2ì¥ ì´ë¡ ì  ë°°ê²½

## 1. í•µì‹¬ ì´ë¡ 

## 2. ì„ í–‰ì—°êµ¬ ê³ ì°°

## 3. ì—°êµ¬ëª¨í˜• ì„¤ì •

<div class="page-break"></div>

# ì œ3ì¥ ì—°êµ¬ë°©ë²•

## 1. ì—°êµ¬ëŒ€ìƒ

## 2. ì—°êµ¬ë„êµ¬

## 3. ìë£Œìˆ˜ì§‘ ì ˆì°¨

## 4. ë¶„ì„ë°©ë²•

## 5. ì—°êµ¬ëª¨í˜• ë¶„ì„ì „ëµ

<div class="page-break"></div>

# ì œ4ì¥ ì—°êµ¬ê²°ê³¼

## 1. ê¸°ìˆ í†µê³„

## 2. ì¸¡ì •ëª¨í˜• ê²€ì¦

## 3. êµ¬ì¡°ëª¨í˜• ë¶„ì„

## 4. ì¶”ê°€ ë¶„ì„

<div class="page-break"></div>

# ì œ5ì¥ ë…¼ì˜

## 1. ê²°ê³¼ í•´ì„

## 2. ì´ë¡ ì  ì‹œì‚¬ì 

## 3. ì‹¤ì²œì  ì‹œì‚¬ì 

<div class="page-break"></div>

# ì œ6ì¥ ê²°ë¡ 

## 1. ì—°êµ¬ ìš”ì•½

## 2. ì •ì±…ì  ì œì–¸

## 3. í›„ì†ì—°êµ¬ ì œì•ˆ

<div class="page-break"></div>

# ì°¸ê³ ë¬¸í—Œ

<div class="ref-block">

</div>

---

# ë¶€ë¡
`},
  {name:'SSCI / KCI í•™ìˆ ì§€',icon:'ğŸ“°',desc:'êµ­ì œí•™ìˆ ì§€ í‘œì¤€ IMRaD êµ¬ì¡°',content:`# ë…¼ë¬¸ ì œëª©

**Authors:** 

**Journal:** 

**Received:** | **Accepted:** | **Published:** 

---

## Abstract

**Keywords:** 

---

# 1. Introduction

## 1.1 Background

## 1.2 Research Gap

## 1.3 Research Purpose

<div class="page-break"></div>

# 2. Literature Review

<div class="page-break"></div>

# 3. Theoretical Framework and Hypotheses

**H1:** 

**H2:** 

<div class="page-break"></div>

# 4. Method

## 4.1 Participants

## 4.2 Measures

## 4.3 Procedure

## 4.4 Data Analysis

<div class="page-break"></div>

# 5. Results

<div class="page-break"></div>

# 6. Discussion

## 6.1 Theoretical Implications

## 6.2 Practical Implications

## 6.3 Limitations and Future Research

<div class="page-break"></div>

# 7. Conclusion

<div class="page-break"></div>

# References

<div class="ref-block">

</div>
`},
  {name:'ë‹¨ì¼ ì—°êµ¬ ë…¼ë¬¸ (ì‹¤ì¦)',icon:'ğŸ”¬',desc:'ì„œë¡ -ë°©ë²•-ê²°ê³¼-ë…¼ì˜ 4ë‹¨ êµ¬ì¡°',content:`# ë…¼ë¬¸ ì œëª©

**ì €ì:** 

---

## ìš”ì•½

**ì£¼ìš”ì–´:** 

---

# 1. ì„œë¡ 

<div class="page-break"></div>

# 2. ì´ë¡ ì  ë°°ê²½ ë° ê°€ì„¤ ì„¤ì •

## 2.1 ì´ë¡ ì  ë°°ê²½

## 2.2 ì—°êµ¬ ê°€ì„¤

**ê°€ì„¤ 1:** 

**ê°€ì„¤ 2:** 

<div class="page-break"></div>

# 3. ì—°êµ¬ë°©ë²•

## 3.1 ì—°êµ¬ëŒ€ìƒ

## 3.2 ì¸¡ì •ë„êµ¬

## 3.3 ë¶„ì„ë°©ë²•

<div class="page-break"></div>

# 4. ì—°êµ¬ê²°ê³¼

## 4.1 ê¸°ìˆ í†µê³„

## 4.2 ê°€ì„¤ ê²€ì¦

<div class="page-break"></div>

# 5. ë…¼ì˜ ë° ê²°ë¡ 

## 5.1 ë…¼ì˜

## 5.2 ê²°ë¡ 

## 5.3 ì—°êµ¬ì˜ í•œê³„

# ì°¸ê³ ë¬¸í—Œ

<div class="ref-block">

</div>
`},
  {name:'ë‹¤ì¤‘ ì—°êµ¬ (Study 1 / Study 2)',icon:'ğŸ“Š',desc:'ë³µìˆ˜ ì—°êµ¬ í¬í•¨ ì‹¤ì¦ ë…¼ë¬¸ êµ¬ì¡°',content:`# ë…¼ë¬¸ ì œëª©

**Authors:** 

---

## Abstract

**Keywords:** 

---

# 1. Introduction

<div class="page-break"></div>

# 2. Study 1

## 2.1 Method

### 2.1.1 Participants

### 2.1.2 Measures

### 2.1.3 Procedure

## 2.2 Results

## 2.3 Discussion

<div class="page-break"></div>

# 3. Study 2

## 3.1 Method

### 3.1.1 Participants

### 3.1.2 Measures

### 3.1.3 Procedure

## 3.2 Results

## 3.3 Discussion

<div class="page-break"></div>

# 4. General Discussion

## 4.1 Theoretical Contributions

## 4.2 Practical Implications

## 4.3 Limitations and Future Research

# References

<div class="ref-block">

</div>
`},
  {name:'ë©”íƒ€ë¶„ì„ ë…¼ë¬¸',icon:'ğŸ“ˆ',desc:'ì²´ê³„ì  ë¬¸í—Œ ê²€í†  ë° ë©”íƒ€ë¶„ì„',content:`# ë…¼ë¬¸ ì œëª©: A Meta-Analysis

**Authors:** 

---

## Abstract

**Keywords:** 

---

# 1. Introduction

## 1.1 Theoretical Background

## 1.2 Purpose of Meta-Analysis

<div class="page-break"></div>

# 2. Literature Search Strategy

## 2.1 Search Databases

## 2.2 Search Keywords

## 2.3 Search Period

<div class="page-break"></div>

# 3. Inclusion Criteria

## 3.1 Inclusion Criteria

## 3.2 Exclusion Criteria

## 3.3 PRISMA Flow Diagram

<div class="page-break"></div>

# 4. Coding Procedure

## 4.1 Variables Coded

## 4.2 Coder Agreement

<div class="page-break"></div>

# 5. Statistical Analysis

## 5.1 Effect Size Calculation

## 5.2 Heterogeneity Test

## 5.3 Moderator Analysis

<div class="page-break"></div>

# 6. Results

## 6.1 Overall Effect Size

## 6.2 Moderator Effects

<div class="page-break"></div>

# 7. Publication Bias Test

## 7.1 Funnel Plot

## 7.2 Egger's Test

<div class="page-break"></div>

# 8. Discussion

## 8.1 Interpretation of Effect Sizes

## 8.2 Practical Implications

## 8.3 Limitations

# References

<div class="ref-block">

</div>

---

# Appendix

## Appendix A: List of Included Studies
`},
];

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   GOOGLE SCHOLAR SEARCH
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const Scholar=(()=>{
  const RK='mdpro_scholar_recent';
  let recent=[];

  function load(){try{recent=JSON.parse(localStorage.getItem(RK)||'[]')}catch(e){recent=[]}}

  function show(){
    load();renderRecent();el('scholar-modal').classList.add('vis');
    setTimeout(()=>el('scholar-q').focus(),80);
  }

  function search(){
    const q=el('scholar-q').value.trim();
    if(!q){el('scholar-q').focus();return;}
    const lang=el('scholar-lang').value;
    const year=el('scholar-year').value;
    const review=el('scholar-review').checked;

    // URL íŒŒë¼ë¯¸í„° êµ¬ì„±
    const params=new URLSearchParams();
    params.set('q',q);
    params.set('hl',lang==='ko'?'ko':'en');
    if(year)params.set('as_ylo',year);
    if(review)params.set('as_rr','1');// ë¦¬ë·° ë…¼ë¬¸ í•„í„°

    const url=`https://scholar.google.com/scholar?${params.toString()}`;
    window.open(url,'scholar_search','width=1100,height=800,left=100,top=80,resizable=yes,scrollbars=yes');

    // ìµœê·¼ ê²€ìƒ‰ì–´ ì €ì¥ (ì¤‘ë³µ ì œê±°, ìµœëŒ€ 8ê°œ)
    recent=recent.filter(r=>r!==q);recent.unshift(q);recent=recent.slice(0,8);
    try{localStorage.setItem(RK,JSON.stringify(recent))}catch(e){}
    renderRecent();
  }

  function renderRecent(){
    const wrap=el('scholar-recent-wrap');
    const div=el('scholar-recent');
    if(!recent.length){wrap.style.display='none';return}
    wrap.style.display='block';
    div.innerHTML=recent.map(r=>`<span style="display:inline-flex;align-items:center;gap:3px;background:var(--bg5);border:1px solid var(--bd);border-radius:var(--r);padding:2px 8px;font-size:11px;cursor:pointer;color:var(--tx2)" onclick="Scholar.useRecent('${r.replace(/'/g,"\\'")}')">ğŸ• ${r}</span>`).join('');
  }

  function useRecent(q){el('scholar-q').value=q;search()}

  function clear(){
    el('scholar-q').value='';recent=[];
    try{localStorage.removeItem(RK)}catch(e){}
    renderRecent();
    el('scholar-q').focus();
  }

  return{show,search,useRecent,clear};
})();

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   REF SEARCH â€” CrossRef / OpenAlex ë‚´ì¥ ë…¼ë¬¸ ê²€ìƒ‰
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const RefSearch=(()=>{
  let _loading=false;

  /* â”€â”€ APA í¬ë§·í„° â”€â”€ */
  function toAPA(w){
    // ì €ì
    let authors='';
    if(w._src==='openalex'){
      const au=(w.authorships||[]).map(a=>a.author?.display_name||'').filter(Boolean);
      if(au.length===0)authors='Unknown';
      else if(au.length<=5)authors=au.map(fmtName).join(', ');
      else authors=fmtName(au[0])+', et al.';
    } else {
      // CrossRef ì‹¤ì œ êµ¬ì¡°: [{family:"Kim", given:"J."}, ...]
      // name í•„ë“œëŠ” ê¸°ê´€ì €ìì—ë§Œ ê°„í˜¹ ì¡´ì¬
      const au=(w.author||[]).map(a=>{
        if(a.family&&a.given) return`${a.family}, ${a.given.trim()[0].toUpperCase()}.`;
        if(a.family)          return a.family;
        if(a.name)            return a.name;
        return'';
      }).filter(Boolean);
      if(au.length===0)authors='Unknown';
      else if(au.length<=5)authors=au.join(', ');
      else authors=au[0]+', et al.';
    }
    // ì—°ë„
    const year=w._year||'n.d.';
    // ì œëª©
    const title=w._title||'Untitled';
    // ì €ë„
    const journal=w._journal||'';
    // ê¶ŒÂ·í˜¸Â·í˜ì´ì§€
    const vol=w.volume||w._vol||'';
    const iss=w.issue||w._iss||'';
    const page=w.page||w._page||'';
    // DOI
    const doi=w.DOI||w._doi||'';
    let cite=`${authors} (${year}). ${title}.`;
    if(journal)cite+=` ${journal}`;
    if(vol)cite+=`, ${vol}`;
    if(iss)cite+=`(${iss})`;
    if(page)cite+=`, ${page}`;
    cite+='.';
    if(doi)cite+=` https://doi.org/${doi}`;
    return cite;
  }

  function fmtName(n){
    // "Firstname Lastname" â†’ "Lastname, F."
    if(!n)return'';
    const parts=n.trim().split(/\s+/);
    if(parts.length===1)return parts[0];
    const last=parts[parts.length-1];
    const initials=parts.slice(0,-1).map(p=>p[0].toUpperCase()+'.').join(' ');
    return`${last}, ${initials}`;
  }

  /* â”€â”€ CrossRef API â”€â”€ */
  async function searchCrossRef(q,year){
    const rows=10;
    let url=`https://api.crossref.org/works?query=${encodeURIComponent(q)}&rows=${rows}&select=DOI,title,author,published-print,published-online,container-title,volume,issue,page&mailto=mdpro@editor.app`;
    if(year)url+=`&filter=from-pub-date:${year}`;
    const res=await fetch(url);
    if(!res.ok)throw new Error('CrossRef ì‘ë‹µ ì˜¤ë¥˜');
    const data=await res.json();
    return (data.message?.items||[]).map(w=>{
      const yr=(w['published-print']||w['published-online'])?.['date-parts']?.[0]?.[0]||'';
      return{
        _src:'crossref',_title:(w.title||[''])[0],_year:yr,
        _journal:(w['container-title']||[])[0]||'',
        _vol:w.volume||'',_iss:w.issue||'',_page:w.page||'',
        DOI:w.DOI||'',author:w.author||[],
        _url:w.DOI?`https://doi.org/${w.DOI}`:''
      };
    });
  }

  /* â”€â”€ OpenAlex API â”€â”€ */
  async function searchOpenAlex(q,year){
    let url=`https://api.openalex.org/works?search=${encodeURIComponent(q)}&per-page=10&select=id,title,authorships,publication_year,primary_location,biblio,doi,open_access`;
    if(year)url+=`&filter=publication_year:>${parseInt(year)-1}`;
    const res=await fetch(url);
    if(!res.ok)throw new Error('OpenAlex ì‘ë‹µ ì˜¤ë¥˜');
    const data=await res.json();
    return (data.results||[]).map(w=>{
      const src=w.primary_location?.source;
      return{
        _src:'openalex',_title:w.title||'',_year:w.publication_year||'',
        _journal:src?.display_name||'',
        _vol:w.biblio?.volume||'',_iss:w.biblio?.issue||'',
        _page:w.biblio?.first_page?(w.biblio.first_page+(w.biblio.last_page?'â€“'+w.biblio.last_page:'')):'',
        _doi:w.doi?w.doi.replace('https://doi.org/',''):'',
        DOI:w.doi?w.doi.replace('https://doi.org/',''):'',
        authorships:w.authorships||[],
        _oa:w.open_access?.is_oa||false,
        _url:w.doi||''
      };
    });
  }

  /* â”€â”€ ë Œë”ë§ â”€â”€ */
  function renderCards(items){
    const box=el('ref-results');
    if(!items.length){
      box.innerHTML='<div class="cite-empty">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.<br><span style="font-size:10px">ë‹¤ë¥¸ í‚¤ì›Œë“œë¥¼ ì‹œë„í•˜ê±°ë‚˜ Scholar â†— ë²„íŠ¼ìœ¼ë¡œ Google Scholarë¥¼ í™•ì¸í•˜ì„¸ìš”.</span></div>';
      return;
    }
    box.innerHTML=items.map((w,i)=>{
      const apa=toAPA(w);
      const doi=w.DOI||w._doi||'';
      const oa=w._oa?'<span class="ref-tag" style="color:var(--ok);border-color:var(--ok)">OA</span>':'';
      const src=w._src==='openalex'?'<span class="ref-tag">OpenAlex</span>':'<span class="ref-tag">CrossRef</span>';
      return`<div class="ref-card">
  <div class="ref-card-title">${w._title||'ì œëª© ì—†ìŒ'}</div>
  <div class="ref-card-meta">
    ${w._year?`<b>${w._year}</b> Â· `:''}${w._journal||''}${w._vol?` ${w._vol}`:''}${w._iss?`(${w._iss})`:''}
    ${src}${oa}
  </div>
  <div class="ref-card-apa" id="apa-${i}" title="í´ë¦­í•˜ë©´ ì „ì²´ ì„ íƒë¨">${apa}</div>
  <div class="ref-card-btns">
    <button class="btn btn-p btn-sm" onclick="RefSearch.addToLib(${i})">+ ì°¸ê³ ë¬¸í—Œì— ì¶”ê°€</button>
    <button class="btn btn-g btn-sm" onclick="RefSearch.copyAPA(${i})">ğŸ“‹ APA ë³µì‚¬</button>
    ${doi?`<a href="https://doi.org/${doi}" target="_blank" rel="noopener" class="btn btn-g btn-sm">DOI â†—</a>`:''}
  </div>
</div>`;
    }).join('');
    // ë°ì´í„° ì €ì¥ (ë²„íŠ¼ ì½œë°±ìš©)
    box._data=items;
    box._apas=items.map(toAPA);
  }

  /* â”€â”€ ê²€ìƒ‰ ì‹¤í–‰ â”€â”€ */
  async function search(){
    if(_loading)return;
    const q=el('ref-q').value.trim();
    const year=el('ref-year').value;
    const db=el('ref-db').value;
    if(!q){el('ref-q').focus();return}

    _loading=true;
    const status=el('ref-status');
    const box=el('ref-results');
    status.textContent='ğŸ”„ ê²€ìƒ‰ ì¤‘...';
    box.innerHTML='<div class="cite-empty" style="padding:24px"><div style="font-size:20px;margin-bottom:8px">â³</div>ì ì‹œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”...</div>';

    try{
      let items;
      if(db==='openalex')items=await searchOpenAlex(q,year);
      else items=await searchCrossRef(q,year);
      status.textContent=`âœ… ${items.length}ê±´ ê²€ìƒ‰ë¨ (${db==='openalex'?'OpenAlex':'CrossRef'}) Â· "${q}"`;
      renderCards(items);
    }catch(e){
      status.textContent=`âŒ ì˜¤ë¥˜: ${e.message}`;
      box.innerHTML=`<div class="cite-empty">ê²€ìƒ‰ ì‹¤íŒ¨: ${e.message}<br><span style="font-size:10px">ë„¤íŠ¸ì›Œí¬ë¥¼ í™•ì¸í•˜ê±°ë‚˜ Scholar â†—ë¥¼ ì‚¬ìš©í•´ì£¼ì„¸ìš”.</span></div>`;
    }
    _loading=false;
  }

  function addToLib(i){
    const box=el('ref-results');
    const apa=box._apas?.[i];
    if(!apa)return;
    CM.addRaw(apa);
    // ë²„íŠ¼ í”¼ë“œë°±
    const btns=box.querySelectorAll('.ref-card')[i]?.querySelectorAll('button');
    if(btns?.[0]){btns[0].textContent='âœ” ì¶”ê°€ë¨';btns[0].disabled=true;btns[0].style.opacity='.6';}
  }

  function copyAPA(i){
    const box=el('ref-results');
    const apa=box._apas?.[i];
    if(!apa)return;
    navigator.clipboard.writeText(apa).then(()=>{
      const btns=box.querySelectorAll('.ref-card')[i]?.querySelectorAll('button');
      if(btns?.[1]){const orig=btns[1].textContent;btns[1].textContent='âœ” ë³µì‚¬ë¨';setTimeout(()=>btns[1].textContent=orig,1500);}
    }).catch(()=>{
      // fallback
      const el2=document.createElement('textarea');el2.value=apa;document.body.appendChild(el2);el2.select();document.execCommand('copy');el2.remove();
    });
  }

  function openScholar(){
    const q=el('ref-q').value.trim();
    const url=q?`https://scholar.google.com/scholar?q=${encodeURIComponent(q)}&hl=ko`:'https://scholar.google.com/?hl=ko';
    window.open(url,'_blank');
  }

  return{search,addToLib,copyAPA,openScholar};
})();

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   COLOR PICKER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const ColorPicker=(()=>{
  let mode='text';
  const TEXT_COLORS=['#e8e8f0','#ff4444','#ff8800','#ffcc00','#44cc44','#00aaff','#aa44ff','#ff44aa','#000000','#333333','#666666','#999999','#cccccc','#ffffff','#5b4ce4','#f7a06a'];
  const BG_COLORS=['#fff176','#ffcc80','#ef9a9a','#80cbc4','#a5d6a7','#90caf9','#ce93d8','#f48fb1','#ffecb3','#dcedc8','transparent'];

  function open(m){
    mode=m;
    el('color-modal-title').textContent=m==='text'?'ê¸€ì ìƒ‰ìƒ ì„¤ì •':'í˜•ê´‘íœ í•˜ì´ë¼ì´íŠ¸ ìƒ‰ìƒ';
    const colors=m==='text'?TEXT_COLORS:BG_COLORS;
    el('color-swatches').innerHTML=colors.map(c=>`<div class="csw" style="background:${c==='transparent'?'repeating-linear-gradient(45deg,#888,#888 2px,transparent 2px,transparent 6px)':c};border-color:${c==='#ffffff'?'#ccc':'transparent'}" onclick="ColorPicker.setHex('${c}')" title="${c}"></div>`).join('');
    el('color-hex').value='';
    // ìŠ¤í¬ì´ë“œ ì§€ì› ì—¬ë¶€
    const supported='EyeDropper' in window;
    el('eyedropper-btn').style.display=supported?'':'none';
    el('eyedrop-support-msg').style.display=supported?'none':'block';
    // íŒ”ë ˆíŠ¸ í´ë¦­ ì—°ë™
    el('eyedrop-btn').onclick=e=>{e.preventDefault();el('color-native').click()};
    el('color-modal').classList.add('vis');
    updatePreview('');
  }

  function setHex(c){
    el('color-hex').value=c;
    // native color inputë„ ë™ê¸°í™” (íˆ¬ëª… ì œì™¸)
    if(c&&c!=='transparent'){try{el('color-native').value=c}catch(e){}}
    updatePreview(c);
  }

  // <input type="color"> íŒ”ë ˆíŠ¸ì—ì„œ ì„ íƒ
  function fromNative(hex){
    el('color-hex').value=hex;
    updatePreview(hex);
  }

  // EyeDropper API â€” Chrome 95+ / Edge 95+
  async function eyedrop(){
    if(!('EyeDropper' in window)){
      el('eyedrop-support-msg').style.display='block';return;
    }
    try{
      // ëª¨ë‹¬ íˆ¬ëª…í™” â†’ í™”ë©´ ì „ì²´ì—ì„œ ìƒ‰ìƒ ì„ íƒ ê°€ëŠ¥
      el('color-modal').style.opacity='0';
      el('color-modal').style.pointerEvents='none';
      const result=await new EyeDropper().open();
      el('color-modal').style.opacity='';
      el('color-modal').style.pointerEvents='';
      setHex(result.sRGBHex);
    }catch(e){
      // ì‚¬ìš©ì ì·¨ì†Œ ì‹œ ì¡°ìš©íˆ ë³µì›
      el('color-modal').style.opacity='';
      el('color-modal').style.pointerEvents='';
    }
  }

  function updatePreview(c){
    const prev=el('color-preview');
    if(!c||c==='transparent'){prev.style.color='';prev.style.background='';return}
    if(mode==='text'){prev.style.color=c;prev.style.background=''}
    else{prev.style.background=c;prev.style.color=''}
  }

  function apply(){
    const c=el('color-hex').value.trim();if(!c)return;
    const ed=el('editor');const s=ed.selectionStart,e=ed.selectionEnd;const sel=ed.value.substring(s,e)||'í…ìŠ¤íŠ¸';
    let wrapped;
    if(mode==='text'){wrapped=`<span style="color:${c}">${sel}</span>`}
    else{wrapped=c==='transparent'?sel:`<span style="background:${c}">${sel}</span>`}
    ins(ed,s,e,wrapped);
    if(mode==='text'){el('fc-bar').style.background=c}
    else{el('hl-bar').style.background=c}
    App.hideModal('color-modal');
  }

  return{open,setHex,fromNative,eyedrop,updatePreview,apply};
})();

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   EDITOR ACTIONS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   IMAGE DROP HANDLER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const IMG=(()=>{
  function dragOver(e){e.preventDefault();e.stopPropagation();el('img-dropzone').style.borderColor='var(--ac)';el('img-dropzone').style.background='var(--acg)'}
  function dragLeave(e){el('img-dropzone').style.borderColor='var(--bd)';el('img-dropzone').style.background='var(--bg3)'}
  function drop(e){
    e.preventDefault();e.stopPropagation();
    dragLeave(e);
    const file=e.dataTransfer.files[0];
    if(file&&file.type.startsWith('image/'))loadImage(file);
  }
  function fileSelected(ev){
    const file=ev.target.files[0];
    if(file)loadImage(file);
    ev.target.value='';
  }
  function loadImage(file){
    const reader=new FileReader();
    reader.onload=ev=>{
      const dataUrl=ev.target.result;
      el('img-url').value=dataUrl;
      if(!el('img-alt').value)el('img-alt').value=file.name.replace(/\.[^.]+$/,'');
      // Show preview
      el('img-preview').src=dataUrl;
      el('img-preview-wrap').style.display='block';
      el('img-drop-text').textContent='âœ“ '+file.name+' ('+Math.round(file.size/1024)+'KB)';
      el('img-drop-text').style.color='var(--ok)';
    };
    reader.readAsDataURL(file);
  }
  return{dragOver,dragLeave,drop,fileSelected};
})();

let lastCodeLang='python';// track last used language for Alt+C

const ED={
  ed(){return el('editor')},
  h(lv){const ed=this.ed();repCL(ed,'#'.repeat(lv)+' '+getCL(ed).text.replace(/^#+\s*/,''))},
  bold(){
    const ed=this.ed(),s=ed.selectionStart,e=ed.selectionEnd,sel=ed.value.substring(s,e);
    if(!sel){ins(ed,s,e,'**í…ìŠ¤íŠ¸**');ed.setSelectionRange(s+2,s+5);return}
    const b2=ed.value.substring(s-2,s),a2=ed.value.substring(e,e+2);
    if(b2==='**'&&a2==='**'){ed.value=ed.value.substring(0,s-2)+sel+ed.value.substring(e+2);ed.setSelectionRange(s-2,e-2);App.render();US.snap();return}
    const b3=ed.value.substring(s-3,s),a4=ed.value.substring(e,e+4);
    if(b3==='<b>'&&a4==='</b>'){ed.value=ed.value.substring(0,s-3)+sel+ed.value.substring(e+4);ed.setSelectionRange(s-3,e-3);App.render();US.snap();return}
    const w=/[()[\]{}<>]/.test(sel)?`<b>${sel}</b>`:`**${sel}**`;
    ins(ed,s,e,w);ed.setSelectionRange(s,s+w.length);
  },
  italic(){const ed=this.ed(),s=ed.selectionStart,e=ed.selectionEnd,sel=ed.value.substring(s,e)||'í…ìŠ¤íŠ¸';const b=ed.value.substring(s-1,s),a=ed.value.substring(e,e+1);if(b==='*'&&a==='*'){ed.value=ed.value.substring(0,s-1)+sel+ed.value.substring(e+1);ed.setSelectionRange(s-1,s-1+sel.length);App.render()}else ins(ed,s,e,`*${sel}*`)},
  strike(){const ed=this.ed(),s=ed.selectionStart,e=ed.selectionEnd;ins(ed,s,e,`~~${ed.value.substring(s,e)||'í…ìŠ¤íŠ¸'}~~`)},
  inlineCode(){const ed=this.ed(),s=ed.selectionStart,e=ed.selectionEnd;ins(ed,s,e,`\`${ed.value.substring(s,e)||'code'}\``)},
  fontSize(size){if(!size)return;const ed=this.ed(),s=ed.selectionStart,e=ed.selectionEnd,sel=ed.value.substring(s,e)||'í…ìŠ¤íŠ¸';ins(ed,s,e,`<span style="font-size:${size}">${sel}</span>`)},
  align(dir){const ed=this.ed();const{text}=getCL(ed);const c=text.replace(/<div[^>]*>(.*?)<\/div>/gi,'$1');repCL(ed,dir==='left'?c:`<div style="text-align:${dir}">${c}</div>`)},
  list(type){const ed=this.ed(),s=ed.selectionStart;const p=type==='ul'?'- ':'1. ';ins(ed,s,s,`\n${p}í•­ëª© 1\n${p}í•­ëª© 2\n${p}í•­ëª© 3\n`)},
  bquote(){const ed=this.ed(),s=ed.selectionStart,e=ed.selectionEnd,sel=ed.value.substring(s,e);if(sel)ins(ed,s,e,sel.split('\n').map(l=>'> '+l).join('\n'));else ins(ed,s,s,'\n> ì¸ìš©ë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”\n')},
  table(){const ed=this.ed(),s=ed.selectionStart;ins(ed,s,s,'\n| í—¤ë” 1 | í—¤ë” 2 | í—¤ë” 3 |\n| :-- | :-- | :-- |\n| ì…€ | ì…€ | ì…€ |\n| ì…€ | ì…€ | ì…€ |\n')},
  tableRow(){const ed=this.ed(),val=ed.value,pos=ed.selectionStart;const le=val.indexOf('\n',pos),ln=val.substring(val.lastIndexOf('\n',pos-1)+1,le===-1?val.length:le);if(!ln.trim().startsWith('|')){this.table();return}const cols=ln.split('|').filter(c=>c.trim()!=='').length;ins(ed,le===-1?val.length:le,le===-1?val.length:le,'\n|'+' ì…€ |'.repeat(cols))},
  tableCol(){const ed=this.ed(),lines=ed.value.split('\n');const cur=ed.value.substring(0,ed.selectionStart).split('\n').length-1;if(!lines[cur].trim().startsWith('|')){this.table();return}let s=cur,e2=cur;while(s>0&&lines[s-1].trim().startsWith('|'))s--;while(e2<lines.length-1&&lines[e2+1].trim().startsWith('|'))e2++;ed.value=lines.map((l,i)=>{if(i<s||i>e2||!l.trim().startsWith('|'))return l;return /^\|[\s:|-]+\|$/.test(l.trim())?l.trimEnd()+' :-- |':l.trimEnd()+' ìƒˆì—´ |'}).join('\n');App.render();US.snap()},

  /* â”€â”€ ì…€ ë³‘í•© ì‹œìŠ¤í…œ (MD í‘œ + HTML í‘œ ëª¨ë‘ ì§€ì›, ë°˜ë³µ ë³‘í•© ê°€ëŠ¥) â”€â”€ */

  _getMdTable(ed){
    const lines=ed.value.split('\n');
    const cur=ed.value.substring(0,ed.selectionStart).split('\n').length-1;
    if(!lines[cur].trim().startsWith('|'))return null;
    let s=cur,e2=cur;
    while(s>0&&lines[s-1].trim().startsWith('|'))s--;
    while(e2<lines.length-1&&lines[e2+1].trim().startsWith('|'))e2++;
    let sepIdx=-1;
    for(let i=s;i<=e2;i++){if(/^\|[\s:|-]+\|$/.test(lines[i].trim())){sepIdx=i;break;}}
    return{lines,start:s,end:e2,cur,sep:sepIdx};
  },

  _parseCells(line){
    return line.split('|').slice(1,-1).map(c=>c.trim());
  },

  _getCursorCell(ed){
    const val=ed.value,pos=ed.selectionStart;
    const ls=val.lastIndexOf('\n',pos-1)+1;
    const part=val.substring(ls,pos);
    return Math.max(0,part.split('|').length-2);
  },

  /* HTML í‘œ íŒŒì‹±: DOMParserë¡œ ê¸°ì¡´ colspan/rowspan ìœ ì§€í•˜ë©° ì¬íŒŒì‹± */
  _getHTMLTable(ed){
    const val=ed.value,pos=ed.selectionStart;
    const before=val.substring(0,pos);
    const tStart=before.lastIndexOf('<table');
    if(tStart===-1)return null;
    const tEnd=val.indexOf('</table>',tStart);
    if(tEnd===-1)return null;
    const tableHTML=val.substring(tStart,tEnd+8);
    const doc=new DOMParser().parseFromString('<body>'+tableHTML+'</body>','text/html');
    const table=doc.querySelector('table');
    if(!table)return null;
    const trs=[...table.querySelectorAll('tr')];
    if(!trs.length)return null;
    // ìµœëŒ€ ì—´ ìˆ˜ ê³„ì‚°
    const cols=trs.reduce((mx,tr)=>{
      let n=0;[...tr.cells].forEach(c=>n+=c.colSpan||1);return Math.max(mx,n);
    },0);
    const rows=trs.length;
    // cells[r][c] = {text,cs,rs,skip}
    const cells=Array.from({length:rows},()=>Array(cols).fill(null));
    const occupied=Array.from({length:rows},()=>Array(cols).fill(false));
    trs.forEach((tr,r)=>{
      let gc=0;
      [...tr.cells].forEach(td=>{
        while(gc<cols&&occupied[r][gc])gc++;
        const cs=td.colSpan||1,rs=td.rowSpan||1;
        cells[r][gc]={text:td.innerHTML.trim(),cs,rs,skip:false};
        for(let dr=0;dr<rs;dr++)for(let dc=0;dc<cs;dc++){
          if(r+dr<rows&&gc+dc<cols){
            occupied[r+dr][gc+dc]=true;
            if(dr>0||dc>0)cells[r+dr][gc+dc]={text:'',cs:1,rs:1,skip:true};
          }
        }
        gc+=cs;
      });
    });
    // ë¹ˆ ì…€ ë³´ì •
    for(let r=0;r<rows;r++)for(let c=0;c<cols;c++){
      if(!cells[r][c])cells[r][c]={text:'',cs:1,rs:1,skip:false};
    }
    // ì»¤ì„œ ìœ„ì¹˜ â†’ rowIdx, curCol ê³„ì‚°
    const posInTable=pos-tStart;
    const sliced=tableHTML.substring(0,posInTable);
    const rowIdx=Math.max(0,(sliced.match(/<tr[\s>]/gi)||[]).length-1);
    const tdIdx =Math.max(0,(sliced.match(/<t[dh][\s>]/gi)||[]).length-1);
    // tdIdxë²ˆì§¸ ì‹¤ì œ td/thê°€ ê·¸ë¦¬ë“œì˜ ëª‡ ë²ˆ ì—´ì¸ì§€
    let gc2=0,counted=0,curCol=0;
    if(trs[rowIdx]){
      for(const td of trs[rowIdx].cells){
        while(gc2<cols&&occupied[rowIdx]&&rowIdx>0&&cells[rowIdx][gc2]?.skip)gc2++;
        if(counted===tdIdx){curCol=gc2;break;}
        gc2+=td.colSpan||1;counted++;
      }
    }
    return{cells,rows,cols,rowIdx,curCol,tStart,tEnd:tEnd+8,val};
  },

  _renderHTMLTable(cells,rows,cols){
    let html='\n<table>\n<thead>\n<tr>';
    for(let c=0;c<cols;c++){
      const cell=cells[0]?.[c];if(!cell||cell.skip)continue;
      const cs=cell.cs>1?` colspan="${cell.cs}"`:''
      const rs=cell.rs>1?` rowspan="${cell.rs}"`:''
      html+=`<th${cs}${rs}>${cell.text}</th>`;
    }
    html+='</tr>\n</thead>\n<tbody>';
    for(let r=1;r<rows;r++){
      html+='\n<tr>';
      for(let c=0;c<cols;c++){
        const cell=cells[r]?.[c];if(!cell||cell.skip)continue;
        const cs=cell.cs>1?` colspan="${cell.cs}"`:''
        const rs=cell.rs>1?` rowspan="${cell.rs}"`:''
        html+=`<td${cs}${rs}>${cell.text}</td>`;
      }
      html+='</tr>';
    }
    html+='\n</tbody>\n</table>\n';
    return html;
  },

  /* ê³µí†µ ë³‘í•© ì‹¤í–‰: MD í‘œ â†’ HTML ë³€í™˜, HTML í‘œ â†’ ì§ì ‘ íŒŒì‹± í›„ ì¬ë³‘í•© */
  _doMerge(dir){
    const ed=this.ed();
    // â‘  HTML í‘œ ìš°ì„  ì‹œë„
    const htbl=this._getHTMLTable(ed);
    if(htbl){
      const{cells,rows,cols,rowIdx,curCol,tStart,tEnd,val}=htbl;
      const cell=cells[rowIdx]?.[curCol];
      if(!cell||cell.skip){alert('ì´ë¯¸ ë³‘í•©ëœ ì…€ì´ê±°ë‚˜ ìœ íš¨í•˜ì§€ ì•Šì€ ìœ„ì¹˜ì…ë‹ˆë‹¤.\nì…€ í…ìŠ¤íŠ¸ ìœ„ì— ì»¤ì„œë¥¼ ë†“ê³  ì‹¤í–‰í•˜ì„¸ìš”.');return;}
      if(dir==='h'){
        const nc=curCol+cell.cs;
        if(nc>=cols){alert('ì˜¤ë¥¸ìª½ì— ë³‘í•©í•  ì…€ì´ ì—†ìŠµë‹ˆë‹¤.');return;}
        const right=cells[rowIdx][nc];
        if(!right||right.skip){alert('ì˜¤ë¥¸ìª½ ì…€ì´ ì´ë¯¸ ë³‘í•© ì¤‘ì…ë‹ˆë‹¤.');return;}
        cell.text=(cell.text+(right.text?' '+right.text:'')).trim();
        cell.cs+=right.cs;
        for(let cc=curCol+1;cc<curCol+cell.cs;cc++)if(cells[rowIdx][cc])cells[rowIdx][cc].skip=true;
      } else {
        const nr=rowIdx+cell.rs;
        if(nr>=rows){alert('ì•„ë˜ì— ë³‘í•©í•  ì…€ì´ ì—†ìŠµë‹ˆë‹¤.');return;}
        const below=cells[nr]?.[curCol];
        if(!below||below.skip){alert('ì•„ë˜ ì…€ì´ ì´ë¯¸ ë³‘í•© ì¤‘ì…ë‹ˆë‹¤.');return;}
        cell.text=(cell.text+(below.text?' '+below.text:'')).trim();
        cell.rs+=below.rs;
        for(let rr=rowIdx+1;rr<rowIdx+cell.rs;rr++)if(cells[rr]?.[curCol])cells[rr][curCol].skip=true;
      }
      const newHTML=this._renderHTMLTable(cells,rows,cols);
      ed.value=val.substring(0,tStart)+newHTML+val.substring(tEnd);
      App.render();US.snap();
      return;
    }
    // â‘¡ Markdown í‘œ ì²˜ë¦¬
    const tbl=this._getMdTable(ed);
    if(!tbl){alert('ì»¤ì„œë¥¼ í‘œ ì•ˆì— ë†“ê³  ì‹¤í–‰í•˜ì„¸ìš”.');return;}
    const{lines,start,end,cur,sep}=tbl;
    const col=this._getCursorCell(ed);
    const allRows=[];
    for(let i=start;i<=end;i++){if(i!==sep)allRows.push(this._parseCells(lines[i]));}
    if(allRows.length<2)return;
    const cols2=allRows[0].length;
    const cells2=allRows.map(row=>row.map(t=>({text:t||'',cs:1,rs:1,skip:false})));
    const dataLines=[];
    for(let i=start;i<=end;i++){if(i!==sep)dataLines.push(i);}
    const rowIdx2=dataLines.indexOf(cur);
    if(rowIdx2<0){alert('ì»¤ì„œë¥¼ í‘œ ì…€ ì•ˆì— ë†“ê³  ì‹¤í–‰í•˜ì„¸ìš”.');return;}
    if(dir==='h'){
      if(col>=cols2-1){alert('ì˜¤ë¥¸ìª½ì— ë³‘í•©í•  ì…€ì´ ì—†ìŠµë‹ˆë‹¤.');return;}
      const c1=cells2[rowIdx2][col],c2=cells2[rowIdx2][col+1];
      c1.text=(c1.text+(c2.text?' '+c2.text:'')).trim();c1.cs=2;c2.skip=true;
    } else {
      if(rowIdx2>=allRows.length-1){alert('ì•„ë˜ì— ë³‘í•©í•  ì…€ì´ ì—†ìŠµë‹ˆë‹¤.');return;}
      const c1=cells2[rowIdx2][col],c2=cells2[rowIdx2+1][col];
      c1.text=(c1.text+(c2.text?' '+c2.text:'')).trim();c1.rs=2;c2.skip=true;
    }
    const bef=lines.slice(0,start).join('\n');
    const aft=lines.slice(end+1).join('\n');
    ed.value=(bef?(bef+'\n'):'')+this._renderHTMLTable(cells2,allRows.length,cols2)+(aft?('\n'+aft):'');
    App.render();US.snap();
  },

  mergeH(){this._doMerge('h');},
  mergeV(){this._doMerge('v');},

  /* HTML í‘œë¥¼ ë“¤ì—¬ì“°ê¸°ê°€ ì˜ ëœ í˜•íƒœë¡œ ì •ëˆ */
  tidyTable(){
    const ed=this.ed();
    const htbl=this._getHTMLTable(ed);
    if(!htbl){alert('ì»¤ì„œë¥¼ HTML í‘œ ì•ˆì— ë†“ê³  Tidyë¥¼ ì‹¤í–‰í•˜ì„¸ìš”.\n(ë³‘í•©ì´ ìˆëŠ” HTML í‘œì—ì„œ ì‚¬ìš©í•©ë‹ˆë‹¤.)');return;}
    const{cells,rows,cols,tStart,tEnd,val}=htbl;

    // ë“¤ì—¬ì“°ê¸° ì •ëˆëœ HTML ìƒì„±
    function tidyCell(tag,cell,indent){
      const attrs=[];
      if(cell.rs>1)attrs.push(`rowspan="${cell.rs}"`);
      if(cell.cs>1)attrs.push(`colspan="${cell.cs}"`);
      const attrStr=attrs.length?' '+attrs.join(' '):'';
      return `${indent}<${tag}${attrStr}>${cell.text}</${tag}>`;
    }

    const lines=[];
    lines.push('<table>');

    // thead: ì²« ë²ˆì§¸ í–‰
    lines.push('  <thead>');
    lines.push('    <tr>');
    for(let c=0;c<cols;c++){
      const cell=cells[0]?.[c];
      if(!cell||cell.skip)continue;
      lines.push(tidyCell('th',cell,'      '));
    }
    lines.push('    </tr>');
    lines.push('  </thead>');

    // tbody: ë‚˜ë¨¸ì§€ í–‰
    lines.push('  <tbody>');
    for(let r=1;r<rows;r++){
      lines.push('    <tr>');
      for(let c=0;c<cols;c++){
        const cell=cells[r]?.[c];
        if(!cell||cell.skip)continue;
        lines.push(tidyCell('td',cell,'      '));
      }
      lines.push('    </tr>');
    }
    lines.push('  </tbody>');
    lines.push('</table>');

    const newHTML='\n'+lines.join('\n')+'\n';
    ed.value=val.substring(0,tStart)+newHTML+val.substring(tEnd);
    App.render();US.snap();
  },

  // ì–¸ì–´ë³„ ì£¼ì„ ê¸°í˜¸ ë°˜í™˜  // ì–¸ì–´ë³„ ì£¼ì„ ê¸°í˜¸ ë°˜í™˜
  _cmt(lang){
    const hash=['python','r','ruby','bash','shell','sh','perl','yaml','toml','powershell','coffee'];
    const dash=['sql','haskell','lua','ada'];
    const pct=['matlab','latex','tex'];
    const semi=['lisp','clojure','scheme'];
    const html=['html','xml','markdown','md'];
    const l=lang.toLowerCase();
    if(hash.some(x=>l.startsWith(x)))return'#';
    if(dash.some(x=>l.startsWith(x)))return'--';
    if(pct.some(x=>l.startsWith(x)))return'%';
    if(semi.some(x=>l.startsWith(x)))return';';
    if(html.some(x=>l.startsWith(x)))return'<!--';
    return'//';// js, ts, java, c, cpp, go, swift, kotlin, rust, â€¦
  },
  // Direct code block with last used language (for Alt+C hotkey)
  codeBlockDirect(){
    const ed=this.ed(),s=ed.selectionStart,e=ed.selectionEnd;
    const cmt=this._cmt(lastCodeLang);
    const placeholder=cmt==='<!--'?`<!-- ì½”ë“œ ì…ë ¥ -->`:cmt+' ì½”ë“œ ì…ë ¥';
    const sel=ed.value.substring(s,e)||placeholder;
    ins(ed,s,e,`\n\`\`\`${lastCodeLang}\n${sel}\n\`\`\`\n`);
  },
  // Code block from modal (toolbar âŒ¨ button)
  codeBlockModal(){
    const lang=el('code-lang').value;lastCodeLang=lang||lastCodeLang;
    const ed=this.ed(),s=ed.selectionStart,e=ed.selectionEnd;
    const cmt=this._cmt(lastCodeLang);
    const placeholder=cmt==='<!--'?`<!-- ì½”ë“œ ì…ë ¥ -->`:cmt+' ì½”ë“œ ì…ë ¥';
    const sel=ed.value.substring(s,e)||placeholder;
    ins(ed,s,e,`\n\`\`\`${lastCodeLang}\n${sel}\n\`\`\`\n`);
    App.hideModal('code-modal');
  },
  pageBreak(){const ed=this.ed(),s=ed.selectionStart;ins(ed,s,s,'\n\n<div class="page-break"></div>\n\n')},
  lineBreak(){const ed=this.ed(),s=ed.selectionStart;ins(ed,s,s,'<br>\n')},
  insertNbsp(){const ed=this.ed();if(!ed)return;const s=ed.selectionStart,e=ed.selectionEnd;ins(ed,s,e,'&nbsp;');US.snap();},
  link(){const text=el('link-text').value||'ë§í¬';const url=el('link-url').value||'#';const ed=this.ed(),s=ed.selectionStart;ins(ed,s,s,`[${text}](${url})`);App.hideModal('link-modal');el('link-text').value='';el('link-url').value=''},
  image(){const alt=el('img-alt').value||'ì´ë¯¸ì§€';const url=el('img-url').value||'#';const ed=this.ed(),s=ed.selectionStart;ins(ed,s,s,`![${alt}](${url})`);el('img-alt').value='';el('img-url').value='';App.hideModal('image-modal')},
  math(){const ed=this.ed(),s=ed.selectionStart,e=ed.selectionEnd,sel=ed.value.substring(s,e);ins(ed,s,e,sel?`$$\n${sel}\n$$`:'\n$$\n\\phi = \\frac{\\lambda_2}{c^2}\n$$\n')},
  footnote(){
    const ed=this.ed();
    const pos=ed.selectionStart;
    const val=ed.value;
    const n=Math.floor((val.match(/\[\^\d+\]/g)||[]).length/2)+1;
    const marker=`[^${n}]`;
    const defLine=`\n[^${n}]: <span style="font-size:9pt">ê°ì£¼ ë‚´ìš©.</span>`;
    ed.value=val.substring(0,pos)+marker+val.substring(pos)+defLine;
    ed.setSelectionRange(pos+marker.length,pos+marker.length);
    App.render();US.snap();
  },
  dupLine(){
    const ed=this.ed();
    const s=ed.selectionStart,e=ed.selectionEnd;
    if(s!==e){
      // ì„ íƒ ì˜ì—­ì´ ìˆìœ¼ë©´ â€” ì„ íƒí•œ í…ìŠ¤íŠ¸ë¥¼ ê·¸ëŒ€ë¡œ ë³µì œí•´ì„œ ë°”ë¡œ ë’¤ì— ì‚½ì…
      const sel=ed.value.substring(s,e);
      // ì¤„ ê²½ê³„ì— ë§ê²Œ: ì„ íƒ ë ìœ„ì¹˜ ë’¤ì— ì‚½ì…
      // ì„ íƒì´ ì¤„ ì¤‘ê°„ì¼ ìˆ˜ë„ ìˆìœ¼ë¯€ë¡œ ê·¸ëƒ¥ ì„ íƒ ì§í›„ì— ë¶™ì„
      const insert='\n'+sel;
      ed.value=ed.value.substring(0,e)+insert+ed.value.substring(e);
      // ë³µì œëœ ë¶€ë¶„ì„ ì„ íƒ ìƒíƒœë¡œ í‘œì‹œ
      ed.setSelectionRange(e+1,e+1+sel.length);
      ed.focus();App.render();US.snap();
    }else{
      // ì„ íƒ ì—†ìœ¼ë©´ ì»¤ì„œê°€ ìˆëŠ” ì¤„ ë³µì œ (ê¸°ì¡´ ë™ì‘)
      const{le,text}=getCL(ed);
      ins(ed,le,le,'\n'+text);
    }
  },
  // Alt+â†‘/â†“ â€” í˜„ì¬ ì¤„(ë˜ëŠ” ì„ íƒ ì¤„ë“¤)ì„ ìœ„/ì•„ë˜ë¡œ ì´ë™
  moveLine(dir){
    const ed=this.ed();const val=ed.value;
    const ss=ed.selectionStart,se=ed.selectionEnd;
    const lines=val.split('\n');
    // ì„ íƒ ë²”ìœ„ì— í•´ë‹¹í•˜ëŠ” ì¤„ ì¸ë±ìŠ¤ ê³„ì‚°
    let pos=0,startLine=-1,endLine=-1;
    for(let i=0;i<lines.length;i++){
      const lstart=pos,lend=pos+lines[i].length;
      if(startLine===-1&&ss<=lend)startLine=i;
      if(ss!==se?se-1<=lend:ss<=lend){endLine=i;if(ss===se)break;}
      pos+=lines[i].length+1;
    }
    if(startLine<0)startLine=0;if(endLine<0)endLine=startLine;
    if(dir===-1&&startLine===0)return;// ë§¨ ìœ„
    if(dir===1&&endLine===lines.length-1)return;// ë§¨ ì•„ë˜
    // ì´ë™í•  ì¤„ ë©ì–´ë¦¬ ì¶”ì¶œ
    const block=lines.splice(startLine,endLine-startLine+1);
    const insertAt=dir===-1?startLine-1:startLine;
    lines.splice(insertAt,0,...block);
    // ìƒˆ ì»¤ì„œ ìœ„ì¹˜ ê³„ì‚°
    let newPos=0;for(let i=0;i<insertAt;i++)newPos+=lines[i].length+1;
    const newSS=newPos+(ss-val.split('\n').slice(0,startLine).join('\n').length-(startLine>0?1:0));
    const blockLen=block.join('\n').length;
    ed.value=lines.join('\n');
    // ì´ë™ëœ ì¤„ ì „ì²´ ì„ íƒ
    let nstart=0;for(let i=0;i<insertAt;i++)nstart+=lines[i].length+1;
    let nend=nstart;for(let i=0;i<block.length;i++)nend+=lines[insertAt+i].length+(i<block.length-1?1:0);
    ed.setSelectionRange(nstart,nend);
    ed.focus();App.render();US.snap();
  },
  tabInTable(ed,ev){const val=ed.value,pos=ed.selectionStart;const ls=val.lastIndexOf('\n',pos-1)+1,le=val.indexOf('\n',pos);const ln=val.substring(ls,le===-1?val.length:le);if(!ln.trim().startsWith('|'))return false;ev.preventDefault();const pipes=[];for(let i=ls;i<(le===-1?val.length:le);i++)if(val[i]==='|')pipes.push(i);const nx=pipes.find(p=>p>pos),nn=nx!==undefined?pipes.find(p=>p>nx):undefined;if(nx!==undefined&&nn!==undefined)ed.setSelectionRange(nx+1,nn);return true},
  enterInTable(ed,ev){const val=ed.value,pos=ed.selectionStart;const ls=val.lastIndexOf('\n',pos-1)+1,le=val.indexOf('\n',pos);const ln=val.substring(ls,le===-1?val.length:le);if(!ln.trim().startsWith('|')||/^\|[\s:|-]+\|$/.test(ln.trim()))return false;ev.preventDefault();const cols=ln.split('|').filter(c=>c.trim()!=='').length;ins(ed,le===-1?val.length:le,le===-1?val.length:le,'\n|'+' ì…€ |'.repeat(cols));return true},
};

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FONT SIZE MANAGER  (ì„ íƒ í…ìŠ¤íŠ¸ì— í¬ê¸° ì ìš©)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const FS=(()=>{
  const SIZES=[8,9,10,11,12,13,14,15,16,18,20,22,24,28,32,36,40,48,50];
  let cur=4;// ê¸°ë³¸ 12pt

  function updateDisplay(){
    el('fsize-display').textContent=SIZES[cur]+'pt';
  }

  function apply(){
    const pt=SIZES[cur];
    const ed=el('editor');
    const s=ed.selectionStart,e=ed.selectionEnd;
    const sel=ed.value.substring(s,e)||'í…ìŠ¤íŠ¸';
    ins(ed,s,e,`<span style="font-size:${pt}pt">${sel}</span>`);
  }

  function inc(){if(cur<SIZES.length-1){cur++;updateDisplay();apply()}}
  function dec(){if(cur>0){cur--;updateDisplay();apply()}}

  // í•œë²ˆ í´ë¦­ â†’ ë“œë¡­ë‹¤ìš´ í”½ì»¤
  let _picker=null;
  function clickPick(ev){
    ev.stopPropagation();
    if(_picker){_picker.remove();_picker=null;return}
    const rect=el('fsize-display').getBoundingClientRect();
    const div=document.createElement('div');
    div.style.cssText=`position:fixed;left:${rect.left}px;top:${rect.bottom+2}px;background:var(--bg2);border:1px solid var(--bd);border-radius:6px;box-shadow:0 6px 24px rgba(0,0,0,.4);z-index:9999;overflow:hidden;min-width:70px`;
    div.innerHTML=SIZES.map((s,i)=>`<div data-i="${i}" style="padding:5px 14px;font-family:var(--fm);font-size:12px;cursor:pointer;color:${i===cur?'var(--ac)':'var(--tx)'};background:${i===cur?'var(--acg)':'transparent'};transition:background .1s" onmouseenter="this.style.background='var(--bg5)'" onmouseleave="this.style.background='${i===cur?'var(--acg)':'transparent'}'" onclick="FS.pickSize(${i},event)">${s}pt</div>`).join('');
    document.body.appendChild(div);_picker=div;
    setTimeout(()=>document.addEventListener('click',_closePicker,{once:true}),10);
  }
  function _closePicker(){if(_picker){_picker.remove();_picker=null}}
  function pickSize(i,ev){if(ev)ev.stopPropagation();cur=i;updateDisplay();_closePicker();apply()}

  // ë‘ë²ˆ í´ë¦­ â†’ ì¸ë¼ì¸ ì§ì ‘ ì…ë ¥
  function startEdit(ev){
    ev.stopPropagation();_closePicker();
    const disp=el('fsize-display'),inp=el('fsize-input');
    inp.value=SIZES[cur];
    disp.style.display='none';inp.style.display='inline-block';
    inp.focus();inp.select();
  }
  function endEdit(){
    const inp=el('fsize-input'),disp=el('fsize-display');
    const v=parseInt(inp.value);
    if(v>=6&&v<=200){
      // find nearest or add
      let best=0,bDiff=999;
      SIZES.forEach((s,i)=>{const d=Math.abs(s-v);if(d<bDiff){bDiff=d;best=i}});
      cur=best;updateDisplay();apply();
    }
    inp.style.display='none';disp.style.display='';
  }
  function editKey(ev){if(ev.key==='Enter')el('fsize-input').blur();if(ev.key==='Escape'){el('fsize-input').style.display='none';el('fsize-display').style.display='';}}

  function update(){updateDisplay()}
  return{inc,dec,update,clickPick,pickSize,startEdit,endEdit,editKey};
})();

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FORMAT QUICK PANEL (Alt+L)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const FP=(()=>{
  let vis=false;
  function show(){
    const panel=el('fmt-panel');
    if(vis){hide();return}
    // position near toolbar
    const tb=document.querySelector('#toolbar');
    const rect=tb.getBoundingClientRect();
    panel.style.left='50%';panel.style.top=(rect.bottom+4)+'px';
    panel.style.transform='translateX(-50%)';
    panel.classList.add('vis');vis=true;
    setTimeout(()=>document.addEventListener('click',_outside,{once:true}),10);
  }
  function hide(){el('fmt-panel').classList.remove('vis');vis=false}
  function _outside(e){if(!el('fmt-panel').contains(e.target))hide();else setTimeout(()=>document.addEventListener('click',_outside,{once:true}),10)}

  function fsz(dir){
    const sel=el('fp-fsize');
    const idx=sel.selectedIndex;
    const ni=Math.max(0,Math.min(sel.options.length-1,idx+dir));
    sel.selectedIndex=ni;applyFsize();
  }
  function applyFsize(){
    const size=el('fp-fsize').value;
    const ed=el('editor');const s=ed.selectionStart,e=ed.selectionEnd;
    const sel2=ed.value.substring(s,e)||'í…ìŠ¤íŠ¸';
    ins(ed,s,e,`<span style="font-size:${size}">${sel2}</span>`);
  }
  function setFc(c){el('fp-fc').value=c==='#e8e8f0'?'#e8e8f0':c;applyColor()}
  function applyColor(){
    const c=el('fp-fc').value;
    const ed=el('editor');const s=ed.selectionStart,e=ed.selectionEnd;
    const sel2=ed.value.substring(s,e)||'í…ìŠ¤íŠ¸';
    ins(ed,s,e,`<span style="color:${c}">${sel2}</span>`);
  }
  function setHL(c){if(c==='none'){applyHLnone();return}el('fp-hl').value=c;applyHL()}
  function applyHL(){
    const c=el('fp-hl').value;
    const ed=el('editor');const s=ed.selectionStart,e=ed.selectionEnd;
    const sel2=ed.value.substring(s,e)||'í…ìŠ¤íŠ¸';
    ins(ed,s,e,`<span style="background:${c}">${sel2}</span>`);
  }
  function applyHLnone(){
    const ed=el('editor');const s=ed.selectionStart,e=ed.selectionEnd;
    const sel2=ed.value.substring(s,e);
    if(sel2)ins(ed,s,e,sel2.replace(/<span style="background:[^"]*">(.*?)<\/span>/gs,'$1'));
  }
  return{show,hide,fsz,applyFsize,setFc,applyColor,setHL,applyHL};
})();

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   APA STATISTICS INSERTER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const STATS=(()=>{
  const CUSTOM_KEY='mdpro_custom_stats';
  let curType='ttest';
  let customList=[];

  const TYPES={
    ttest:{
      label:'t-test',
      fields:[
        {id:'df',label:'df',ph:'ììœ ë„',req:true},
        {id:'t',label:'t',ph:'tê°’',req:true},
        {id:'p',label:'p',ph:'pê°’',req:true},
        {id:'d',label:"Cohen's d",ph:'íš¨ê³¼í¬ê¸° (ì„ íƒ)',req:false},
      ],
      fmt:(v)=>{
        let s=`(t(${v.df}) = ${v.t}, p = ${fmtP(v.p)}`;
        if(v.d)s+=`, d = ${v.d}`;
        return s+')';
      }
    },
    anova:{
      label:'ANOVA',
      fields:[
        {id:'df1',label:'dfâ‚',ph:'ì²˜ë¦¬ ììœ ë„',req:true},
        {id:'df2',label:'dfâ‚‚',ph:'ì˜¤ì°¨ ììœ ë„',req:true},
        {id:'F',label:'F',ph:'Fê°’',req:true},
        {id:'p',label:'p',ph:'pê°’',req:true},
        {id:'np2',label:'Î·Â²p',ph:'ë¶€ë¶„ ì—íƒ€ì œê³± (ì„ íƒ)',req:false},
      ],
      fmt:(v)=>{
        let s=`(F(${v.df1}, ${v.df2}) = ${v.F}, p = ${fmtP(v.p)}`;
        if(v.np2)s+=`, Î·Â²p = ${v.np2}`;
        return s+')';
      }
    },
    regression:{
      label:'Regression',
      fields:[
        {id:'beta',label:'Î² (í‘œì¤€í™”)',ph:'ë² íƒ€ (ì„ íƒ)',req:false},
        {id:'B',label:'B (ë¹„í‘œì¤€í™”)',ph:'B (ì„ íƒ)',req:false},
        {id:'SE',label:'SE',ph:'í‘œì¤€ì˜¤ì°¨ (ì„ íƒ)',req:false},
        {id:'t',label:'t',ph:'tê°’',req:true},
        {id:'p',label:'p',ph:'pê°’',req:true},
      ],
      fmt:(v)=>{
        const parts=[];
        if(v.beta)parts.push(`Î² = ${v.beta}`);
        if(v.B)parts.push(`B = ${v.B}`);
        if(v.SE)parts.push(`SE = ${v.SE}`);
        parts.push(`t = ${v.t}`);
        parts.push(`p = ${fmtP(v.p)}`);
        return '('+parts.join(', ')+')';
      }
    },
    correlation:{
      label:'Correlation',
      fields:[
        {id:'r',label:'r',ph:'ìƒê´€ê³„ìˆ˜',req:true},
        {id:'df',label:'df',ph:'ììœ ë„ (ì„ íƒ)',req:false},
        {id:'p',label:'p',ph:'pê°’',req:true},
      ],
      fmt:(v)=>{
        let s=v.df?`(r(${v.df}) = ${v.r}`:`(r = ${v.r}`;
        s+=`, p = ${fmtP(v.p)})`;
        return s;
      }
    },
    chisq:{
      label:'Chi-square',
      fields:[
        {id:'df',label:'df',ph:'ììœ ë„',req:true},
        {id:'chisq',label:'Ï‡Â²',ph:'ì¹´ì´ì œê³±ê°’',req:true},
        {id:'p',label:'p',ph:'pê°’',req:true},
        {id:'V',label:"Cramer's V",ph:'íš¨ê³¼í¬ê¸° (ì„ íƒ)',req:false},
      ],
      fmt:(v)=>{
        let s=`(Ï‡Â²(${v.df}) = ${v.chisq}, p = ${fmtP(v.p)}`;
        if(v.V)s+=`, Cramer's V = ${v.V}`;
        return s+')';
      }
    },
    sem:{
      label:'SEM',
      fields:[
        {id:'beta',label:'Î² (í‘œì¤€í™”)',ph:'ë² íƒ€ (ì„ íƒ)',req:false},
        {id:'b',label:'b (ë¹„í‘œì¤€í™”)',ph:'b (ì„ íƒ)',req:false},
        {id:'SE',label:'SE',ph:'í‘œì¤€ì˜¤ì°¨ (ì„ íƒ)',req:false},
        {id:'z',label:'z',ph:'zê°’',req:true},
        {id:'p',label:'p',ph:'pê°’',req:true},
      ],
      fmt:(v)=>{
        const parts=[];
        if(v.beta)parts.push(`Î² = ${v.beta}`);
        if(v.b)parts.push(`b = ${v.b}`);
        if(v.SE)parts.push(`SE = ${v.SE}`);
        parts.push(`z = ${v.z}`);
        parts.push(`p = ${fmtP(v.p)}`);
        return '('+parts.join(', ')+')';
      }
    },
    logistic:{
      label:'Logistic Regression',
      fields:[
        {id:'OR',label:'OR',ph:'ì˜¤ì¦ˆë¹„',req:true},
        {id:'CI_low',label:'95% CI í•˜í•œ',ph:'í•˜í•œê°’',req:true},
        {id:'CI_high',label:'95% CI ìƒí•œ',ph:'ìƒí•œê°’',req:true},
        {id:'p',label:'p',ph:'pê°’',req:true},
      ],
      fmt:(v)=>`(OR = ${v.OR}, 95% CI [${v.CI_low}, ${v.CI_high}], p = ${fmtP(v.p)})`
    },
    multilevel:{
      label:'Multilevel (HLM)',
      fields:[
        {id:'gamma',label:'Î³',ph:'ê°ë§ˆ ê³„ìˆ˜',req:true},
        {id:'SE',label:'SE',ph:'í‘œì¤€ì˜¤ì°¨',req:true},
        {id:'t',label:'t',ph:'tê°’',req:true},
        {id:'p',label:'p',ph:'pê°’',req:true},
      ],
      fmt:(v)=>`(Î³ = ${v.gamma}, SE = ${v.SE}, t = ${v.t}, p = ${fmtP(v.p)})`
    },
  };

  function fmtP(p){
    if(!p)return'?';
    const n=parseFloat(p);
    if(isNaN(n))return p;
    if(n<.001)return'< .001';
    if(n<.01)return n.toFixed(3).replace('0.','. ').replace(/ /,'');
    return n.toFixed(3).replace('0.','.').replace(/0+$/,'').replace(/\.$/,'');
  }

  function loadCustom(){try{customList=JSON.parse(localStorage.getItem(CUSTOM_KEY)||'[]')}catch(e){customList=[]}}
  function saveCustomList(){try{localStorage.setItem(CUSTOM_KEY,JSON.stringify(customList))}catch(e){}}

  function renderFields(type){
    const area=el('stats-fields');
    const customArea=el('stats-custom-area');
    if(type==='custom'){
      area.style.display='none';
      customArea.style.display='block';
      renderCustomSavedSel();
      updateCustomVars();
    }else{
      area.style.display='grid';
      customArea.style.display='none';
      const t=TYPES[type];if(!t)return;
      area.innerHTML=t.fields.map(f=>`
        <div class="fg" style="margin:0">
          <label class="fl">${f.label}${f.req?'':' <span style="color:var(--tx3)">(ì„ íƒ)</span>'}</label>
          <input class="fi" id="sf_${f.id}" type="text" placeholder="${f.ph}" oninput="STATS.preview()" style="padding:5px 8px">
        </div>`).join('');
    }
    preview();
  }

  function preview(){
    const pv=el('stats-preview');
    try{
      if(curType==='custom'){
        const fmt=el('custom-fmt').value;
        const vars=(el('custom-vars').value||'').split(',').map(s=>s.trim()).filter(Boolean);
        const vals={};
        vars.forEach(v=>{const inp=el('cfsf_'+v);vals[v]=inp?inp.value.trim():'';});
        let out=fmt;
        vars.forEach(v=>{if(vals[v])out=out.replaceAll('{'+v+'}',vals[v]);});
        pv.textContent=out||'(ì¶œë ¥ ë¯¸ë¦¬ë³´ê¸°)';
      }else{
        const t=TYPES[curType];if(!t){pv.textContent='';return}
        const vals={};
        t.fields.forEach(f=>{const inp=el('sf_'+f.id);vals[f.id]=inp?inp.value.trim():'';});
        pv.textContent=t.fmt(vals);
      }
    }catch(e){pv.textContent='ì…ë ¥ê°’ ì˜¤ë¥˜'}
  }

  function setType(type){
    curType=type;
    document.querySelectorAll('#stats-type-row .btn-tog').forEach(b=>b.classList.remove('active'));
    const btn=el('st-'+type);if(btn)btn.classList.add('active');
    renderFields(type);
  }

  function insert(){
    const pv=el('stats-preview').textContent;
    if(!pv||(pv==='(ì¶œë ¥ ë¯¸ë¦¬ë³´ê¸°)'&&curType==='custom'))return;
    const ed=el('editor');const pos=ed.selectionEnd;
    ed.value=ed.value.substring(0,pos)+pv+ed.value.substring(pos);
    ed.setSelectionRange(pos+pv.length,pos+pv.length);
    ed.focus();App.render();US.snap();
    App.hideModal('stats-modal');
  }

  function updateCustomVars(){
    const vars=(el('custom-vars').value||'').split(',').map(s=>s.trim()).filter(Boolean);
    const area=el('custom-fields');
    area.innerHTML=vars.map(v=>`
      <div class="fg" style="margin:0">
        <label class="fl">${v}</label>
        <input class="fi" id="cfsf_${v}" type="text" placeholder="${v} ê°’" oninput="STATS.preview()" style="padding:5px 8px">
      </div>`).join('');
    preview();
  }

  function saveCustom(){
    const name=(el('custom-name').value||'').trim();
    const fmt=(el('custom-fmt').value||'').trim();
    const vars=(el('custom-vars').value||'').trim();
    if(!name||!fmt){alert('ì´ë¦„ê³¼ í¬ë§·ì„ ì…ë ¥í•˜ì„¸ìš”.');return}
    const existing=customList.findIndex(c=>c.name===name);
    const entry={name,fmt,vars};
    if(existing>=0)customList[existing]=entry;
    else customList.push(entry);
    saveCustomList();
    renderCustomSavedSel();
    el('custom-name').value='';
    alert(`"${name}" ì €ì¥ë¨`);
  }

  function deleteCustom(){
    const sel=el('custom-saved-sel').value;
    if(!sel)return;
    customList=customList.filter(c=>c.name!==sel);
    saveCustomList();
    renderCustomSavedSel();
    el('custom-name').value='';el('custom-fmt').value='';el('custom-vars').value='';
    el('custom-fields').innerHTML='';
    preview();
  }

  function loadCustom(name){
    if(!name)return;
    const c=customList.find(x=>x.name===name);
    if(!c)return;
    el('custom-name').value=c.name;
    el('custom-fmt').value=c.fmt;
    el('custom-vars').value=c.vars||'';
    updateCustomVars();
  }

  function renderCustomSavedSel(){
    const sel=el('custom-saved-sel');
    sel.innerHTML='<option value="">â€” ì €ì¥ëœ ì»¤ìŠ¤í…€ â€”</option>'+customList.map(c=>`<option value="${c.name}">${c.name}</option>`).join('');
  }

  function show(){
    loadCustom();
    el('stats-modal').classList.add('vis');
    setType(curType);
  }

  return{show,setType,preview,insert,updateCustomVars,saveCustom,deleteCustom,loadCustom};
})();

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HOTKEY ENGINE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HK â€” ë‹¨ì¶•í‚¤ ëª©ë¡ ë§¤ë‹ˆì € (í¸ì§‘ ê°€ëŠ¥)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const HK = (() => {
  const STORAGE_KEY = 'mdpro-hotkeys-v1';

  // ê¸°ë³¸ ë‹¨ì¶•í‚¤ ë°ì´í„°
  const DEFAULT_DATA = [
    { section: 'ë¬¸ì„œ êµ¬ì¡°', items: [
      { desc: 'H1 / H2 / H3',              keys: 'Ctrl + Alt + 1~3' },
      { desc: 'í˜ì´ì§€ ë‚˜ëˆ„ê¸°',               keys: 'Ctrl + Enter' },
      { desc: 'ì¤„ë°”ê¿ˆ (<br>)',               keys: 'Ctrl + Shift + Enter' },
    ]},
    { section: 'í‘œ í¸ì§‘', items: [
      { desc: 'í‘œ ì‚½ì…',                    keys: 'Alt + 8' },
      { desc: 'í–‰ ì¶”ê°€',                    keys: 'Alt + 9' },
      { desc: 'ì—´ ì¶”ê°€',                    keys: 'Alt + 0' },
      { desc: 'ê°€ë¡œ ë³‘í•© (colspan)',         keys: 'Alt + Shift + H' },
      { desc: 'ì„¸ë¡œ ë³‘í•© (rowspan)',         keys: 'Alt + Shift + V' },
      { desc: 'HTML í‘œ ë“¤ì—¬ì“°ê¸° ì •ëˆ',       keys: 'Tidy ë²„íŠ¼' },
    ]},
    { section: 'í…ìŠ¤íŠ¸ ì„œì‹', items: [
      { desc: 'Smart Bold',                 keys: 'Ctrl + B' },
      { desc: 'ê¸°ìš¸ì„ê¼´',                    keys: 'Ctrl + I' },
      { desc: 'ì¸ë¼ì¸ ì½”ë“œ `code`',          keys: 'Alt + V' },
      { desc: 'ì½”ë“œ ì§ì ‘ ì‚½ì… (ë§ˆì§€ë§‰ ì–¸ì–´)', keys: 'Alt + C' },
      { desc: 'ê¸€ì í¬ê¸° í‚¤ìš°ê¸°',             keys: 'Shift + Alt + .' },
      { desc: 'ê¸€ì í¬ê¸° ì¤„ì´ê¸°',             keys: 'Shift + Alt + ,' },
    ]},
    { section: 'ë ˆì´ì•„ì›ƒ / ì •ë ¬', items: [
      { desc: 'ì™¼ìª½ / ê°€ìš´ë° / ì˜¤ë¥¸ìª½ ì •ë ¬', keys: 'Shift + Alt + L / C / R' },
      { desc: 'Split ë³´ê¸°',                 keys: 'Alt + 1' },
      { desc: 'ì—ë””í„°ë§Œ',                    keys: 'Alt + 2' },
      { desc: 'ë¯¸ë¦¬ë³´ê¸°ë§Œ',                  keys: 'Alt + 3' },
    ]},
    { section: 'í¸ì§‘', items: [
      { desc: 'ì¤„ ìœ„ë¡œ ì´ë™',                keys: 'Alt + â†‘' },
      { desc: 'ì¤„ ì•„ë˜ë¡œ ì´ë™',              keys: 'Alt + â†“' },
      { desc: 'ì¤„ / ì„ íƒ ë³µì œ',              keys: 'Shift + Alt + â†“' },
      { desc: 'ì‹¤í–‰ ì·¨ì†Œ',                   keys: 'Ctrl + Z' },
      { desc: 'ë‹¤ì‹œ ì‹¤í–‰',                   keys: 'Ctrl + Shift + Z' },
    ]},
    { section: 'ì‚½ì… / ë„êµ¬', items: [
      { desc: 'ì¸ìš© ì‚½ì…',                   keys: 'Ctrl + Shift + C' },
      { desc: 'ê°ì£¼ ì‚½ì…',                   keys: 'Shift + Alt + N' },
      { desc: 'APA í†µê³„ ì‚½ì…',               keys: 'Shift + Alt + 9' },
      { desc: 'ì„œì‹ íŒ¨ë„ (í¬ê¸°Â·ìƒ‰Â·í˜•ê´‘íœ)',    keys: 'Alt + L' },
      { desc: 'ì¤„ë²ˆí˜¸ ON/OFF',               keys: 'Ctrl + Alt + I' },
      { desc: 'ìƒˆì°½ ë¯¸ë¦¬ë³´ê¸°',               keys: 'Ctrl + Shift + P' },
      { desc: 'ì €ì¥ ë‹¤ì´ì–¼ë¡œê·¸',              keys: 'Ctrl + S' },
      { desc: 'ì°¾ê¸° / ë°”ê¾¸ê¸°',               keys: 'Ctrl + F' },
      { desc: 'Research Mode',               keys: 'Ctrl + Shift + R' },
      { desc: 'Scholar ê²€ìƒ‰',               keys: 'Ctrl + Shift + G' },
      { desc: 'ë‹¨ì¶•í‚¤ ëª©ë¡',                 keys: 'Alt + ?' },
    ]},
  ];

  let data = [];
  let editMode = false;

  function load() {
    try {
      const saved = localStorage.getItem(STORAGE_KEY);
      data = saved ? JSON.parse(saved) : JSON.parse(JSON.stringify(DEFAULT_DATA));
    } catch(e) {
      data = JSON.parse(JSON.stringify(DEFAULT_DATA));
    }
  }

  function save() {
    try { localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); } catch(e){}
  }

  function render() {
    const wrap = el('hk-list-wrap');
    wrap.innerHTML = '';
    data.forEach((group, gi) => {
      // ì„¹ì…˜ í—¤ë”
      const sec = document.createElement('div');
      sec.className = 'hk-s';
      sec.style.cssText = 'display:flex;align-items:center;gap:6px';
      if (editMode) {
        const inp = document.createElement('input');
        inp.className = 'hk-editable desc';
        inp.style.cssText = 'font-size:10px;font-weight:600;letter-spacing:.08em;text-transform:uppercase;color:var(--ac);flex:1';
        inp.value = group.section;
        inp.oninput = () => { data[gi].section = inp.value; };
        const delSec = document.createElement('button');
        delSec.className = 'hk-del-btn';
        delSec.title = 'ì„¹ì…˜ ì‚­ì œ';
        delSec.textContent = 'âœ•';
        delSec.onclick = () => { data.splice(gi, 1); render(); };
        sec.appendChild(inp);
        sec.appendChild(delSec);
      } else {
        sec.textContent = group.section;
      }
      wrap.appendChild(sec);

      // ê·¸ë¦¬ë“œ
      const grid = document.createElement('div');
      grid.className = 'hk-grid';
      grid.style.marginBottom = '4px';

      group.items.forEach((item, ii) => {
        const row = document.createElement('div');
        if (editMode) {
          row.className = 'hk-item-edit';
          const descInp = document.createElement('input');
          descInp.className = 'hk-editable desc';
          descInp.value = item.desc;
          descInp.oninput = () => { data[gi].items[ii].desc = descInp.value; };

          const keysInp = document.createElement('input');
          keysInp.className = 'hk-editable keys';
          keysInp.value = item.keys;
          keysInp.placeholder = 'Ctrl + X';
          keysInp.oninput = () => { data[gi].items[ii].keys = keysInp.value; };

          const del = document.createElement('button');
          del.className = 'hk-del-btn';
          del.title = 'í–‰ ì‚­ì œ';
          del.innerHTML = 'ğŸ—‘';
          del.onclick = () => { data[gi].items.splice(ii, 1); render(); };

          row.appendChild(descInp);
          row.appendChild(keysInp);
          row.appendChild(del);
        } else {
          row.className = 'hk-item';
          const keys = item.keys.split('+').map(k => k.trim()).filter(Boolean);
          row.innerHTML = `<span class="hk-desc">${item.desc}</span><div class="hk-keys">${keys.map(k=>`<kbd>${k}</kbd>`).join('')}</div>`;
        }
        grid.appendChild(row);
      });

      // í¸ì§‘ ëª¨ë“œ: ì´ ì„¹ì…˜ì— í–‰ ì¶”ê°€ ë²„íŠ¼
      if (editMode) {
        const addRow = document.createElement('div');
        addRow.style.cssText = 'padding:2px 6px;';
        const addBtn = document.createElement('button');
        addBtn.className = 'btn btn-g btn-sm';
        addBtn.style.cssText = 'font-size:10px;padding:2px 7px;width:100%;opacity:.7';
        addBtn.textContent = '+ ì´ ì„¹ì…˜ì— í–‰ ì¶”ê°€';
        addBtn.onclick = () => { data[gi].items.push({desc:'ìƒˆ í•­ëª©', keys:''}); render(); };
        addRow.appendChild(addBtn);
        grid.appendChild(addRow);
      }

      wrap.appendChild(grid);
    });

    // í¸ì§‘ ëª¨ë“œ: ì„¹ì…˜ ì¶”ê°€ ë²„íŠ¼
    if (editMode) {
      const addSec = document.createElement('button');
      addSec.className = 'btn btn-g btn-sm';
      addSec.style.cssText = 'width:100%;margin-top:6px;font-size:11px';
      addSec.textContent = 'ï¼‹ ì„¹ì…˜ ì¶”ê°€';
      addSec.onclick = () => { data.push({section:'ìƒˆ ì„¹ì…˜', items:[{desc:'í•­ëª©', keys:''}]}); render(); };
      wrap.appendChild(addSec);
    }
  }

  return {
    open() {
      load();
      editMode = false;
      el('hk-edit-btn').textContent = 'âœ í¸ì§‘';
      el('hk-edit-btn').classList.remove('btn-p');
      el('hk-edit-hint').style.display = 'none';
      el('hk-edit-actions').style.display = 'none';
      render();
      el('hk-overlay').classList.add('vis');
    },
    close() {
      el('hk-overlay').classList.remove('vis');
      editMode = false;
    },
    toggleEdit() {
      editMode = !editMode;
      const btn = el('hk-edit-btn');
      if (editMode) {
        btn.textContent = 'âœ“ ì™„ë£Œ';
        btn.classList.add('btn-p');
        btn.classList.remove('btn-g');
        el('hk-edit-hint').style.display = 'block';
        el('hk-edit-actions').style.display = 'flex';
      } else {
        // ì™„ë£Œ â†’ ìë™ ì €ì¥
        save();
        btn.textContent = 'âœ í¸ì§‘';
        btn.classList.remove('btn-p');
        btn.classList.add('btn-g');
        el('hk-edit-hint').style.display = 'none';
        el('hk-edit-actions').style.display = 'none';
      }
      render();
    },
    addRow() {
      if (data.length === 0) data.push({section:'ê¸°íƒ€', items:[]});
      data[data.length-1].items.push({desc:'ìƒˆ í•­ëª©', keys:''});
      render();
    },
    saveEdit() {
      save();
      editMode = false;
      el('hk-edit-btn').textContent = 'âœ í¸ì§‘';
      el('hk-edit-btn').classList.remove('btn-p');
      el('hk-edit-btn').classList.add('btn-g');
      el('hk-edit-hint').style.display = 'none';
      el('hk-edit-actions').style.display = 'none';
      render();
    },
    resetDefault() {
      if (!confirm('ë‹¨ì¶•í‚¤ ëª©ë¡ì„ ê¸°ë³¸ê°’ìœ¼ë¡œ ë˜ëŒë¦¬ê² ìŠµë‹ˆê¹Œ?')) return;
      data = JSON.parse(JSON.stringify(DEFAULT_DATA));
      save();
      render();
    },
  };
})();

function hkKey(e){const mac=navigator.platform.toUpperCase().includes('MAC');const ctrl=mac?e.metaKey:e.ctrlKey;const parts=[];if(ctrl)parts.push('C');if(e.shiftKey)parts.push('S');if(e.altKey)parts.push('A');parts.push(e.key.length===1?e.key.toUpperCase():e.key);return parts.join('+')}

function handleKey(e){
  const edi=el('editor');const inEd=document.activeElement===edi;const k=hkKey(e);
  // Global hotkeys
  if(k==='A+1'){e.preventDefault();App.setViewCycle('split');return}
  if(k==='A+2'){e.preventDefault();App.setViewCycle('editor');return}
  if(k==='A+3'){e.preventDefault();App.setViewCycle('preview');return}
  if(k==='S+A+9'){e.preventDefault();STATS.show();return}
  if(k==='A+L'){e.preventDefault();FP.show();return}
  if(k==='C+A+I'){e.preventDefault();LN.toggle();return}
  if(!inEd){if(k==='A+?'){e.preventDefault();App.showHK()}return}
  if(k==='C+Z'){e.preventDefault();US.undo();return}
  if(k==='C+S+Z'||k==='C+Y'){e.preventDefault();US.redo();return}
  // Ctrl+Shift+Space â†’ &nbsp; ì‚½ì… (ì¤„ë°”ê¿ˆ ë‹¤ìŒ ìœ„ì¹˜ì— ê³µë°± ì¶”ê°€)
  if(k==='C+S+ '){
    e.preventDefault();
    const ed=el('editor'),s=ed.selectionStart,v=ed.value;
    // í˜„ì¬ ìœ„ì¹˜ì— &nbsp; ì‚½ì…
    ins(ed,s,ed.selectionEnd,'&nbsp;');
    US.snap();return;
  }
  // Alt+ArrowUp/Down â€” move line
  if(k==='A+ArrowUp'){e.preventDefault();ED.moveLine(-1);return}
  if(k==='A+ArrowDown'){e.preventDefault();ED.moveLine(1);return}
  if(e.key==='Tab'){if(ED.tabInTable(edi,e))return}
  const map={
    'C+B':()=>ED.bold(),'C+I':()=>ED.italic(),'C+.':()=>ED.bquote(),
    'C+Enter':()=>ED.pageBreak(),'C+S+Enter':()=>ED.lineBreak(),
    'C+A+1':()=>ED.h(1),'C+A+2':()=>ED.h(2),'C+A+3':()=>ED.h(3),
    'S+A+L':()=>ED.align('left'),'S+A+C':()=>ED.align('center'),'S+A+R':()=>ED.align('right'),
    'A+8':()=>ED.table(),'A+9':()=>ED.tableRow(),'A+0':()=>ED.tableCol(),
    'S+A+H':()=>ED.mergeH(),'S+A+V':()=>ED.mergeV(),
    'S+A+N':()=>ED.footnote(),
    'A+C':()=>ED.codeBlockDirect(),
    'A+V':()=>ED.inlineCode(),
    'S+A+.':()=>FS.inc(),'S+A+>':()=>FS.inc(),
    'S+A+,':()=>FS.dec(),'S+A+<':()=>FS.dec(),
    'S+A+ArrowDown':()=>ED.dupLine(),
    'C+S':()=>App.showSaveDlg(),'C+F':()=>App.toggleFind(),
    'C+S+P':()=>PW.open(),'C+S+T':()=>PW.openPPT(),'C+S+R':()=>App.toggleRM(),'C+S+C':()=>App.showCite(),'C+S+G':()=>Scholar.show(),
    'A+?':()=>App.showHK(),
  };
  if(map[k]){e.preventDefault();map[k]()}
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TOOLTIP
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function initTooltip(){
  const tip=el('tooltip');let t;
  document.addEventListener('mouseover',e=>{const target=e.target.closest('[data-tooltip]');if(!target)return;clearTimeout(t);t=setTimeout(()=>{const key=target.dataset.key;tip.innerHTML=target.dataset.tooltip+(key?` <span class="tt-key">${key}</span>`:'');tip.classList.add('vis');let x=e.clientX+12,y=e.clientY+16;if(x+260>window.innerWidth)x=e.clientX-260;if(y+40>window.innerHeight)y=e.clientY-40;tip.style.left=x+'px';tip.style.top=y+'px'},300)});
  document.addEventListener('mouseout',()=>{clearTimeout(t);tip.classList.remove('vis')});
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ERROR DETECTION
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function detectErrors(md){
  const errs=[];const lines=md.split('\n');
  lines.forEach((l,i)=>{if(l.startsWith('|')){const cols=l.split('|').filter(c=>c.trim()!=='').length;if(i>0&&lines[i-1].startsWith('|')){const p=lines[i-1].split('|').filter(c=>c.trim()!=='').length;if(p!==cols&&!l.includes('---')&&!lines[i-1].includes('---'))errs.push(`ì¤„ ${i+1}: í‘œ ì—´ ë¶ˆì¼ì¹˜ (ì´ì „ ${p}, í˜„ì¬ ${cols})`)}}});
  if((md.match(/^```/gm)||[]).length%2!==0)errs.push('ì½”ë“œ ë¸”ë¡ ë¯¸ë‹«í˜ (``` ëˆ„ë½)');
  return errs;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MAIN APP
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const App={
  rm:false,rt:null,colorMode:'text',capType:'table',

  init(){
    AS.load();CM.load();initTooltip();SS.init();FS.update();
    // Set default view button state
    const splitBtn=el('vm-split');if(splitBtn)splitBtn.classList.add('active');
    const edi=el('editor');
    edi.addEventListener('input',()=>{US.snap();this.render()});
    edi.addEventListener('keydown',handleKey);
    edi.addEventListener('keyup',()=>this.updCursor());
    edi.addEventListener('click',()=>this.updCursor());
    edi.addEventListener('scroll',()=>LN.update(),{passive:true});
    document.addEventListener('selectionchange',()=>{if(document.activeElement===edi)this.updFmtBtns()});
    document.addEventListener('keydown',e=>{if(document.activeElement!==edi)handleKey(e)});
    el('doc-title').addEventListener('input',()=>this.render());
    setInterval(()=>PW.checkClosed(),2000);

    // Build template grid
    el('tmpl-grid').innerHTML=TMPLS.map((t,i)=>`<div class="tmpl-card" onclick="App.insertTmpl(${i})"><h4>${t.icon} ${t.name}</h4><p>${t.desc}</p></div>`).join('');

    if(!edi.value)edi.value=this.sample();
    this.render();US.snap();
  },

  render(){
    const edi=el('editor');const md=edi.value,title=el('doc-title').value;
    clearTimeout(this.rt);
    this.rt=setTimeout(()=>{
      PR.render(md);TOC.build(md);
      const errs=detectErrors(md);this.showErrs(errs);
      const words=md.trim()?md.trim().split(/\s+/).length:0;
      el('sw').textContent=words.toLocaleString()+' ë‹¨ì–´';
      el('sc').textContent=md.length.toLocaleString()+' ì';
      el('sp').textContent='ì•½ '+Math.ceil(words/250)+' í˜ì´ì§€';
      LN.update();
      el('render-ts').textContent=new Date().toLocaleTimeString();
      AS.save(md,title);
      PW.sync();
    },120);
    this.updCursor();
  },

  updCursor(){const edi=el('editor');const t=edi.value.substring(0,edi.selectionStart),ls=t.split('\n');el('cursor-pos').textContent=`ì¤„ ${ls.length}, ì—´ ${ls[ls.length-1].length+1}`;const sl=edi.selectionEnd-edi.selectionStart;el('sel-info').textContent=sl>0?`${sl}ì ì„ íƒ`:''},
  updFmtBtns(){const edi=el('editor'),s=edi.selectionStart,e=edi.selectionEnd;const b2=edi.value.substring(s-2,s),a2=edi.value.substring(e,e+2);const b3=edi.value.substring(s-3,s),a4=edi.value.substring(e,e+4);el('bold-btn').classList.toggle('active',(b2==='**'&&a2==='**')||(b3==='<b>'&&a4==='</b>'));const b1=edi.value.substring(s-1,s),a1=edi.value.substring(e,e+1);el('italic-btn').classList.toggle('active',b1==='*'&&a1==='*')},
  showErrs(errs){const ec=el('error-count'),sep=el('ec-sep'),list=el('ep-list'),panel=el('error-panel');if(!errs.length){ec.textContent='';sep.style.display='none';panel.classList.remove('vis');return}ec.textContent=`âš  ${errs.length}ê°œ ì˜¤ë¥˜`;sep.style.display='block';list.innerHTML=errs.map(e=>`<div class="error-item">${e}</div>`).join('')},
  toggleErr(){el('error-panel').classList.toggle('vis')},closeErr(){el('error-panel').classList.remove('vis')},
  toggleSidebar(){el('app').classList.toggle('ns')},
  setView(m){el('editor-pane').classList.toggle('hidden',m==='preview');el('preview-pane').classList.toggle('hidden',m==='editor')},
  setViewCycle(m){
    this.setView(m);
    ['split','editor','preview'].forEach(v=>{const b=el('vm-'+v);if(b)b.classList.toggle('active',v===m)});
  },
  toggleTheme(){document.documentElement.dataset.theme=document.documentElement.dataset.theme==='light'?'':'light'},
  toggleRM(){this.rm=!this.rm;el('rm-badge').classList.toggle('vis',this.rm);el('mode-ind').textContent=this.rm?'RESEARCH':'NORMAL';PR.rm=this.rm;PW.setRM(this.rm);this.render()},
  showHK(){HK.open()},hideHK(){HK.close()},
  showCode(){el('code-modal').classList.add('vis')},
  showLink(){el('link-modal').classList.add('vis');setTimeout(()=>el('link-text').focus(),50)},
  showImg(){
    // reset drop zone
    el('img-drop-text').textContent='ğŸ–¼ ì´ë¯¸ì§€ë¥¼ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•´ì„œ ì„ íƒ';
    el('img-drop-text').style.color='';
    el('img-preview-wrap').style.display='none';
    el('img-dropzone').style.borderColor='';el('img-dropzone').style.background='';
    el('image-modal').classList.add('vis');setTimeout(()=>el('img-alt').focus(),50);
  },
  showCite(){CM.open();el('cite-modal').classList.add('vis')},
  showStats(){STATS.show()},
  showSaveDlg(){el('save-modal').classList.add('vis')},
  hideModal(id){el(id).classList.remove('vis')},
  openColorPicker(m){ColorPicker.open(m)},
  applyColor(){ColorPicker.apply()},
  showCaption(type){CAP.show(type)},
  updateCapPreview(){CAP.updatePreview()},
  insertCaption(){CAP.insert()},
  showTmpl(){el('tmpl-modal').classList.add('vis')},
  insertTmpl(i){
    const t=TMPLS[i];
    if(!confirm(`"${t.name}" ì–‘ì‹ì„ í˜„ì¬ ë¬¸ì„œì— ì¶”ê°€í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`))return;
    const edi=el('editor');edi.value=(edi.value.trim()?edi.value+'\n\n---\n\n':'')+t.content;
    this.render();US.snap();App.hideModal('tmpl-modal');
  },

  toggleFind(){const bar=el('find-bar');bar.classList.toggle('vis');if(bar.classList.contains('vis'))el('fi').focus()},
  findKey(e){if(e.key==='Enter')this.findNext();if(e.key==='Escape')this.toggleFind()},
  findNext(){const q=el('fi').value;if(!q)return;const edi=el('editor');const idx=edi.value.indexOf(q,edi.selectionEnd);const fi2=idx===-1?edi.value.indexOf(q):idx;if(fi2!==-1){edi.setSelectionRange(fi2,fi2+q.length);edi.focus()}const cnt=(edi.value.match(new RegExp(q.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'),'g'))||[]).length;el('fc-cnt').textContent=cnt?`${cnt}ê±´`:q?'ì—†ìŒ':''},
  replaceOne(){const q=el('fi').value,r=el('ri').value;if(!q)return;const edi=el('editor'),s=edi.selectionStart,e=edi.selectionEnd;if(edi.value.substring(s,e)===q){edi.value=edi.value.substring(0,s)+r+edi.value.substring(e);this.render()}else this.findNext()},
  replaceAll(){const q=el('fi').value,r=el('ri').value;if(!q)return;const edi=el('editor');const cnt=(edi.value.match(new RegExp(q.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'),'g'))||[]).length;edi.value=edi.value.replaceAll(q,r);this.render();US.snap();el('fc-cnt').textContent=`${cnt}ê±´ êµì²´ë¨`},

  saveMD(){const c=el('editor').value,t=el('doc-title').value.replace(/[^a-z0-9ê°€-í£]/gi,'_');dlBlob(c,`${t}.md`,'text/markdown');this.hideModal('save-modal')},
  saveTXT(){const c=el('editor').value.replace(/[#*_`~>|]/g,'').replace(/\[(.*?)\]\(.*?\)/g,'$1').replace(/<[^>]+>/g,'');dlBlob(c,(el('doc-title').value||'document').replace(/[^a-z0-9ê°€-í£]/gi,'_')+'.txt','text/plain;charset=utf-8');this.hideModal('save-modal')},
  saveHTML(){
    const md=el('editor').value;const title=el('doc-title').value;
    const showFn=el('show-footnotes-chk').checked;
    const pages=splitPages(md);
    const html=pages.map((p,i)=>`<div class="preview-page${this.rm?' rm':''}" data-page="${i+1}">${mdRender(p,showFn)}</div>`).join('');
    const CSS=`body{font-family:sans-serif;background:#6a6e7e;display:flex;flex-direction:column;align-items:center;padding:20px 0 40px}.preview-page{width:210mm;min-height:297mm;background:white;color:#1a1a2e;padding:22mm 18mm;box-shadow:0 4px 30px rgba(0,0,0,.4);font-family:'Libre Baskerville',Georgia,serif;font-size:11pt;line-height:1.8;word-break:break-word;position:relative;margin-bottom:20px}.preview-page::after{content:"â€” " attr(data-page) " â€”";position:absolute;bottom:10mm;left:50%;transform:translateX(-50%);font-family:sans-serif;font-size:9pt;color:#bbb}.preview-page h1{font-size:21pt;font-weight:700;margin:0 0 14px;border-bottom:2px solid #1a1a2e;padding-bottom:8px}.preview-page h2{font-size:15pt;margin:20px 0 10px;font-weight:700}.preview-page h3{font-size:12pt;margin:16px 0 7px;font-weight:700}.preview-page p{margin:0 0 11px}.preview-page ul,.preview-page ol{margin:0 0 11px;padding-left:22px}.preview-page table{width:100%;border-collapse:collapse;margin:11px 0;font-size:inherit}.preview-page th{background:#1a1a2e;color:#fff;padding:7px 11px;text-align:left}.preview-page td{padding:6px 11px;border:1px solid #d0d0e0}.preview-page tr:nth-child(even) td{background:#f7f7fc}.preview-page code{font-family:monospace;font-size:9pt;background:#f0f0f8;padding:1px 4px;border-radius:3px;color:#5b4ce4}.preview-page pre{background:#1a1a2e;color:#e8e8f0;padding:14px;border-radius:6px;margin:11px 0;font-size:9pt}.preview-page pre code{background:none;color:inherit}.preview-page a{color:#5b4ce4}.preview-page img{max-width:100%}.preview-page .footnote-highlight{background:#f0f0f0;color:#1a1a2e;border-radius:2px;padding:0 2px}.preview-page .footnote-def{background:#f5f5f5;color:#1a1a2e;border-left:3px solid #bbb;padding:4px 10px;margin:4px 0;font-size:9.5pt}.preview-page .footnotes-section{border-top:1px solid #d0d0e0;margin-top:24px;padding-top:10px;font-size:9.5pt;color:#444}@media print{body{background:none;padding:0}.preview-page{box-shadow:none;margin:0;page-break-after:always;width:100%;min-height:0}.preview-page:last-child{page-break-after:auto}.preview-page::after{display:none}}`;
    const fullHtml=`<!DOCTYPE html><html lang="ko"><head><meta charset="UTF-8"><title>${title}</title><style>${CSS}</style></head><body>${html}</body></html>`;
    dlBlob(fullHtml,(el('doc-title').value||'document').replace(/[^a-z0-9ê°€-í£]/gi,'_')+'.html','text/html;charset=utf-8');
    this.hideModal('save-modal');
  },
  printDoc(){
    const md=el('editor').value;const title=el('doc-title').value;
    const showFn=document.getElementById('show-footnotes-chk')?el('show-footnotes-chk').checked:true;
    const pages=splitPages(md);
    const html=pages.map((p,i)=>`<div class="preview-page${this.rm?' rm':''}" data-page="${i+1}">${mdRender(p,showFn)}</div>`).join('');
    const CSS=`@import url('https://fonts.googleapis.com/css2?family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&family=JetBrains+Mono:wght@400;500&display=swap');*{box-sizing:border-box;margin:0;padding:0}body{font-family:sans-serif;background:#6a6e7e;display:flex;flex-direction:column;align-items:center;padding:20px 0 40px}.preview-page{width:210mm;min-height:297mm;background:white;color:#1a1a2e;padding:22mm 18mm;box-shadow:0 4px 30px rgba(0,0,0,.4);font-family:'Libre Baskerville',Georgia,serif;font-size:11pt;line-height:1.8;word-break:break-word;position:relative;margin-bottom:20px}.preview-page::after{content:"â€” " attr(data-page) " â€”";position:absolute;bottom:10mm;left:50%;transform:translateX(-50%);font-family:sans-serif;font-size:9pt;color:#bbb}.preview-page h1{font-size:21pt;font-weight:700;margin:0 0 14px;border-bottom:2px solid #1a1a2e;padding-bottom:8px}.preview-page h2{font-size:15pt;margin:20px 0 10px;font-weight:700}.preview-page h3{font-size:12pt;margin:16px 0 7px;font-weight:700}.preview-page p{margin:0 0 11px}.preview-page ul,.preview-page ol{margin:0 0 11px;padding-left:22px}.preview-page table{width:100%;border-collapse:collapse;margin:11px 0;font-size:inherit}.preview-page th{background:#1a1a2e;color:#fff;padding:7px 11px;text-align:left}.preview-page td{padding:6px 11px;border:1px solid #d0d0e0}.preview-page tr:nth-child(even) td{background:#f7f7fc}.preview-page code{font-family:'JetBrains Mono',monospace;font-size:9pt;background:#f0f0f8;padding:1px 4px;border-radius:3px;color:#5b4ce4}.preview-page pre{background:#1a1a2e;color:#e8e8f0;padding:14px;border-radius:6px;margin:11px 0;font-size:9pt}.preview-page pre code{background:none;color:inherit}.preview-page img{max-width:100%}.preview-page a{color:#5b4ce4}.preview-page .footnote-highlight{background:#f0f0f0;color:#1a1a2e;border-radius:2px;padding:0 2px}.preview-page .footnote-def{background:#f5f5f5;color:#1a1a2e;border-left:3px solid #bbb;padding:4px 10px;margin:4px 0;font-size:9.5pt}.preview-page .footnotes-section{border-top:1px solid #d0d0e0;margin-top:24px;padding-top:10px;font-size:9.5pt;color:#444}@media print{body{background:none;padding:0}.preview-page{box-shadow:none;margin:0;page-break-after:always;width:100%;min-height:0}.preview-page:last-child{page-break-after:auto}.preview-page::after{display:none}}`;
    const fullHtml=`<!DOCTYPE html><html lang="ko"><head><meta charset="UTF-8"><title>${title}</title><style>${CSS}</style></head><body>${html}<script>window.onload=function(){window.print();}<\/script></body></html>`;
    const w=window.open('','_blank','width=900,height=700');
    if(w){w.document.open();w.document.write(fullHtml);w.document.close();}
    else{alert('íŒì—…ì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤. íŒì—…ì„ í—ˆìš©í•´ ì£¼ì„¸ìš”.');}
    this.hideModal('save-modal');
  },

  sample(){return`# Markdown PDF Editor Pro

**ì œì‘: ë°•ì¤‘í¬(ì—°ì„¸ëŒ€ ì‹¬ë¦¬í•™ê³¼ ê²¸ì„êµìˆ˜)**

- ë…¼ë¬¸ ì§‘í•„ì„ ìœ„í•œ ì—ë””í„°ë¡œ ì—°êµ¬ì™€ ë…¼ë¬¸ì„ ìœ„í•œ ë„êµ¬ì…ë‹ˆë‹¤.
- ê²½ê¸°ëŒ€í•™êµ êµìœ¡ì‚°ì—…ì „ê³µì
- ì—°ì„¸ëŒ€í•™êµ ì‹¬ë¦¬ê³¼í•™ ì´ë…¸ë² ì´ì…˜ ëŒ€í•™ì› ì‹¬ë¦¬íŠ¸ë™ ì „ê³µì

## V20 ì—…ë°ì´íŠ¸ ì‹ ê¸°ëŠ¥

ëª¨ë“  ê¸°ëŠ¥ì´ í†µí•©ëœ **ì—°êµ¬Â·ë…¼ë¬¸ ì „ìš© ì—ë””í„°**ì…ë‹ˆë‹¤.

### ì£¼ìš” ê¸°ëŠ¥ ëª©ë¡

| ê¸°ëŠ¥ | ë‹¨ì¶•í‚¤ / ë²„íŠ¼ | ì„¤ëª… |
| :-- | :-- | :-- |
| ì½”ë“œ ë¸”ë¡ (ë§ˆì§€ë§‰ ì–¸ì–´) | **Alt+C** | ë§ˆì§€ë§‰ ì‚¬ìš© ì–¸ì–´ ì¦‰ì‹œ ì‚½ì… |
| ì½”ë“œ ë¸”ë¡ (ì–¸ì–´ ì„ íƒ) | âŒ¨ Code ë²„íŠ¼ | ì–¸ì–´ ì„ íƒ ëª¨ë‹¬ |
| ì¸ìš© ì‚½ì… | **Ctrl+Shift+C** | ì°¸ê³ ë¬¸í—Œ ê´€ë¦¬ì |
| Research Mode | **Ctrl+Shift+R** | ë‹¨ë½ ì¤„ë²ˆí˜¸ í‘œì‹œ |
| ì €ì¥ | **Ctrl+S** | MD / TXT / HTML ì„ íƒ |
| **ë‹¨ì¶•í‚¤ ëª©ë¡** | **Alt+?** | ë‹¨ì¶•í‚¤ í‘œì‹œ (í¸ì§‘ ê°€ëŠ¥) |
| **í‘œ HTML ì •ëˆ** | âœ¦ Tidy ë²„íŠ¼ | ë³‘í•© í›„ ë“¤ì—¬ì“°ê¸° ì •ë¦¬ |
| **ë¯¸ë¦¬ë³´ê¸° ë³µì‚¬** | ğŸ“‹ ë³µì‚¬ ë²„íŠ¼ | ì„œì‹ ìˆëŠ” ë³µì‚¬ (WordÂ·êµ¬ê¸€ë…ìŠ¤) |
| **A4 êµ¬ë¶„ì„ ** | ğŸ“„ A4 ë²„íŠ¼ | 297mm ìœ„ì¹˜ì— ë¹¨ê°„ ì ì„  í‘œì‹œ |

---

### Research Mode ì¤„ë²ˆí˜¸

**Ctrl+Shift+R** ë˜ëŠ” ğŸ”¬ Research ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ë¯¸ë¦¬ë³´ê¸°ì—ì„œ ê° ë‹¨ë½ì— ì¤„ë²ˆí˜¸ê°€ í‘œì‹œë©ë‹ˆë‹¤.

ì´ê²ƒì€ ë‘ ë²ˆì§¸ ë‹¨ë½ì…ë‹ˆë‹¤. ì¤„ë²ˆí˜¸ê°€ ì™¼ìª½ì— í‘œì‹œë©ë‹ˆë‹¤.

ì„¸ ë²ˆì§¸ ë‹¨ë½ì…ë‹ˆë‹¤.

---

### ì°¸ê³ ë¬¸í—Œ ê´€ë¦¬ì

**ğŸ“š References** ë²„íŠ¼ìœ¼ë¡œ APA ì°¸ê³ ë¬¸í—Œì„ ë¶™ì—¬ë„£ê³  ê´€ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

- **ë¹ˆ ì¤„ êµ¬ë¶„**: ì—¬ëŸ¬ ì°¸ê³ ë¬¸í—Œì„ ë¹ˆ ì¤„ë¡œ êµ¬ë¶„
- **ì—”í„° êµ¬ë¶„**: ê° ì¤„ì´ í•˜ë‚˜ì˜ ì°¸ê³ ë¬¸í—Œ

ìŠ¤íƒ€ì¼ ë³€í™˜: APA â†’ MLA 9 / Chicago / Vancouver ìë™ ë³€í™˜ì„ ì§€ì›í•©ë‹ˆë‹¤.

<div class="page-break"></div>

## 2í˜ì´ì§€ â€” ìº¡ì…˜, ìˆ˜ì‹, ë…¼ë¬¸ ì–‘ì‹

### í‘œ ìº¡ì…˜ ì˜ˆì‹œ

<span class="tbl-caption"><í‘œ1> ì—°êµ¬ëŒ€ìƒ íŠ¹ì„±</span>

| ë³€ìˆ˜ | M | SD | n |
| :-- | :-- | :-- | :-- |
| ì—°ë ¹ | 24.5 | 3.2 | 120 |
| í•™ìŠµì‹œê°„ | 5.3 | 1.8 | 120 |

### ìˆ˜ì‹

$$
\\phi = \\frac{\\lambda_2}{c^2}
$$

### ë…¼ë¬¸ ì–‘ì‹

**ğŸ“‹ ì–‘ì‹** ë²„íŠ¼ì„ ëˆŒëŸ¬ í•™ìœ„ë…¼ë¬¸, SSCI/KCI, ë‹¨ì¼/ë‹¤ì¤‘ ì—°êµ¬, ë©”íƒ€ë¶„ì„ êµ¬ì¡°ë¥¼ ì‚½ì…í•˜ì„¸ìš”.

> \`Alt+?\` â†’ ì „ì²´ ë‹¨ì¶•í‚¤ ëª©ë¡
`}
};

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PWA â€” Service Worker + Manifest (ì¸ë¼ì¸ ìƒì„±)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
(function(){
  // 1. Manifest ë™ì  ìƒì„±
  const manifest={
    name:'Markdown PDF Editor Pro',
    short_name:'MD PRO V20',
    description:'ì—°êµ¬Â·ë…¼ë¬¸ ì „ìš© ë§ˆí¬ë‹¤ìš´ ì—ë””í„°',
    start_url:'.',
    display:'standalone',
    background_color:'#0f0f13',
    theme_color:'#1a1a24',
    icons:[
      {src:'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 192 192"><rect width="192" height="192" rx="24" fill="%237c6af7"/><text x="96" y="130" font-size="110" text-anchor="middle" font-family="monospace" fill="white">M</text></svg>',sizes:'192x192',type:'image/svg+xml'},
      {src:'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><rect width="512" height="512" rx="60" fill="%237c6af7"/><text x="256" y="360" font-size="300" text-anchor="middle" font-family="monospace" fill="white">M</text></svg>',sizes:'512x512',type:'image/svg+xml'}
    ]
  };
  const blob=new Blob([JSON.stringify(manifest)],{type:'application/json'});
  const url=URL.createObjectURL(blob);
  const link=document.getElementById('pwa-manifest');
  if(link)link.href=url;

  // 2. Service Worker ì¸ë¼ì¸ ë“±ë¡
  if('serviceWorker' in navigator){
    const swCode=`
const CACHE='mdpro-v17-cache-v1';
const ASSETS=['/'];
self.addEventListener('install',e=>e.waitUntil(caches.open(CACHE).then(c=>c.addAll(ASSETS)).catch(()=>{})));
self.addEventListener('activate',e=>e.waitUntil(caches.keys().then(ks=>Promise.all(ks.filter(k=>k!==CACHE).map(k=>caches.delete(k))))));
self.addEventListener('fetch',e=>{e.respondWith(caches.match(e.request).then(r=>r||fetch(e.request).then(res=>{const rc=res.clone();caches.open(CACHE).then(c=>c.put(e.request,rc));return res}).catch(()=>caches.match('/'))).catch(()=>fetch(e.request)));});
`;
    const swBlob=new Blob([swCode],{type:'application/javascript'});
    const swUrl=URL.createObjectURL(swBlob);
    navigator.serviceWorker.register(swUrl,{scope:'./'}).catch(()=>{});
  }
})();

window.addEventListener('DOMContentLoaded',()=>App.init());
</script>
</body>
</html>.ippt-tool{background:none;border:1px solid rgba(255,255,255,.15);border-radius:5px;color:#ccc;cursor:pointer;padding:1px 5px;transition:all .15s}
.ippt-tool:hover{background:rgba(255,255,255,.12);color:#fff}
.ippt-tool.active-tool{background:rgba(240,192,96,.25);color:#f7d06a;border-color:#f0c060}


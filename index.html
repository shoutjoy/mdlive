<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="theme-color" content="#1a1a24">
<meta name="description" content="ì—°êµ¬Â·ë…¼ë¬¸ ì „ìš© ë§ˆí¬ë‹¤ìš´ ì—ë””í„° â€” ë°•ì¤‘í¬">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="MD PRO V9">
<link rel="manifest" id="pwa-manifest">
<title>Markdown PDF Editor Pro V9</title>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&family=Figtree:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/marked/9.1.6/marked.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.min.js"></script>
<style>
:root{
  --bg:#0f0f13;--bg2:#16161d;--bg3:#1c1c26;--bg4:#22222f;--bg5:#2a2a3a;
  --bd:#2e2e42;--bda:#4a4a6a;
  --ac:#7c6af7;--acd:#4a3fc4;--acg:rgba(124,106,247,.15);--ac2:#f7a06a;
  --tx:#e8e8f0;--tx2:#9090b0;--tx3:#55556a;--txh:#fff;
  --er:#f76a6a;--ok:#6af7a0;--wn:#f7d06a;
  --fm:'JetBrains Mono',monospace;--fb:'Figtree',sans-serif;--fs:'Libre Baskerville',serif;
  --r:6px;--sh:0 4px 24px rgba(0,0,0,.4);--tr:.15s ease;--sw:240px;
}
[data-theme=light]{
  --bg:#f0f0f5;--bg2:#fff;--bg3:#f7f7fc;--bg4:#ededf5;--bg5:#e8e8f2;
  --bd:#d0d0e0;--bda:#a0a0c0;--ac:#5b4ce4;--acd:#3d31a8;--acg:rgba(91,76,228,.1);
  --tx:#1a1a2e;--tx2:#505070;--tx3:#9090a8;--txh:#0a0a18;
  --er:#d64242;--ok:#2a8a50;--wn:#c07010;
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%;overflow:hidden;font-family:var(--fb);background:var(--bg);color:var(--tx);font-size:14px;line-height:1.5;-webkit-font-smoothing:antialiased}
/* layout */
#app{display:grid;grid-template-rows:36px 44px 1fr 26px;grid-template-columns:var(--sw) 1fr;height:100vh;grid-template-areas:"tb tb""bar bar""side main""stat stat"}
#app.ns{grid-template-columns:0 1fr}
#app.ns #sidebar{display:none}
/* titlebar */
#titlebar{grid-area:tb;display:flex;align-items:center;background:#1a1a24;border-bottom:1px solid #2e2e40;height:36px;padding:0 10px;z-index:100;gap:5px}
#app-logo{display:flex;align-items:center;gap:7px;font-family:var(--fm);font-size:11px;font-weight:600;color:var(--ac);letter-spacing:.05em;flex-shrink:0}
.logo-icon{width:20px;height:20px;background:var(--ac);border-radius:4px;display:flex;align-items:center;justify-content:center;font-size:11px;color:#fff;font-weight:700}
#doc-title{flex:1;text-align:center;background:none;border:none;color:#9090b0;font-family:var(--fb);font-size:13px;outline:none;cursor:pointer;transition:color var(--tr)}
#doc-title:hover,#doc-title:focus{color:#e8e8f0;cursor:text}
#tba{display:flex;align-items:center;gap:4px;flex-shrink:0}
/* toolbar */
#toolbar{grid-area:bar;display:flex;align-items:center;background:#222230;border-bottom:1px solid #2e2e42;padding:0 6px;overflow-x:auto;scrollbar-width:none;user-select:none}
#toolbar::-webkit-scrollbar{display:none}
.tg{display:flex;align-items:center;gap:1px;flex-shrink:0}
.ts{width:1px;height:18px;background:#3a3a50;margin:0 4px;flex-shrink:0}
.tb{display:flex;align-items:center;justify-content:center;min-width:26px;height:26px;padding:0 5px;border:none;background:transparent;color:#9090b0;border-radius:var(--r);cursor:pointer;font-size:11px;font-family:var(--fb);font-weight:500;transition:all var(--tr);white-space:nowrap;position:relative}
.tb:hover{background:#2e2e42;color:#e8e8f0}.tb.active{background:var(--acg);color:var(--ac)}
.tbsel{background:#2a2a3a;border:1px solid #3a3a50;border-radius:var(--r);color:#9090b0;font-size:11px;padding:2px 4px;outline:none;cursor:pointer;font-family:var(--fb);height:26px}
/* sidebar */
#sidebar{grid-area:side;background:var(--bg2);border-right:1px solid var(--bd);display:flex;flex-direction:column;overflow:hidden}
#sb-hdr{padding:8px 12px;font-size:10px;font-weight:600;letter-spacing:.1em;color:var(--tx3);text-transform:uppercase;border-bottom:1px solid var(--bd);display:flex;align-items:center;justify-content:space-between}
#toc-list{flex:1;overflow-y:auto;padding:4px 0;scrollbar-width:thin;scrollbar-color:var(--bd) transparent}
.toc-item{display:flex;align-items:center;gap:6px;padding:3px 12px;cursor:pointer;color:var(--tx2);font-size:12px;line-height:1.4;transition:all var(--tr);border-left:2px solid transparent}
.toc-item:hover{color:var(--tx);background:var(--bg3)}.toc-item.active{color:var(--ac);border-left-color:var(--ac);background:var(--acg)}
.toc-item[data-level="2"]{padding-left:22px}.toc-item[data-level="3"]{padding-left:34px;font-size:11px}
.toc-num{font-family:var(--fm);font-size:10px;color:var(--tx3);flex-shrink:0}
#sb-stats{padding:6px 12px;border-top:1px solid var(--bd);font-size:11px;color:var(--tx3);display:flex;flex-direction:column;gap:2px}
/* main */
#main{grid-area:main;display:flex;flex-direction:column;overflow:hidden}
#find-bar{display:none;align-items:center;gap:6px;padding:4px 10px;background:var(--bg2);border-bottom:1px solid var(--bd);flex-shrink:0}
#find-bar.vis{display:flex}
#find-bar input{background:var(--bg3);border:1px solid var(--bd);border-radius:4px;color:var(--tx);padding:3px 7px;font-size:12px;font-family:var(--fb);outline:none;width:140px}
#find-bar input:focus{border-color:var(--ac)}
#editor-wrap{flex:1;display:flex;overflow:hidden;position:relative}
/* editor pane */
#editor-pane{flex:1;display:flex;flex-direction:column;overflow:hidden;border-right:1px solid var(--bd)}
#editor-pane.hidden{display:none}
#ed-hdr{display:flex;align-items:center;padding:3px 8px;background:var(--bg2);border-bottom:1px solid var(--bd);gap:6px;height:30px;flex-shrink:0}
.pane-lbl{font-size:10px;font-weight:600;letter-spacing:.08em;text-transform:uppercase;color:var(--tx3)}
.pane-lbl span{width:6px;height:6px;border-radius:50%;background:var(--ac);display:inline-block;margin-right:5px}
#ed-container{flex:1;position:relative;overflow:hidden}
#line-numbers{position:absolute;left:0;top:0;bottom:0;width:42px;background:var(--bg2);border-right:1px solid var(--bd);overflow:hidden;pointer-events:none;display:none;z-index:1}
#line-numbers.vis{display:block}
.lnc{padding-top:12px;display:flex;flex-direction:column;align-items:flex-end;padding-right:8px}
.ln{font-family:var(--fm);font-size:11px;color:var(--tx3);line-height:21px;height:21px}
#editor{width:100%;height:100%;background:var(--bg3);color:var(--tx);border:none;outline:none;resize:none;font-family:var(--fm);font-size:13.5px;line-height:21px;padding:12px 14px;tab-size:2;word-wrap:break-word;overflow-y:auto;overflow-x:hidden;scrollbar-width:thin;scrollbar-color:var(--bd) transparent}
#editor.wln{padding-left:58px}
#editor::placeholder{color:var(--tx3)}
/* preview pane */
#preview-pane{flex:1;display:flex;flex-direction:column;overflow:hidden}
#preview-pane.hidden{display:none}
#pv-hdr{display:flex;align-items:center;padding:3px 8px;background:var(--bg2);border-bottom:1px solid var(--bd);gap:6px;height:30px;flex-shrink:0}
#preview-container{flex:1;overflow-y:auto;overflow-x:hidden;background:#6a6e7e;display:flex;flex-direction:column;align-items:center;padding:16px 0 36px;scrollbar-width:thin;scrollbar-color:#444 transparent}
/* A4 page cards */
.preview-page{width:210mm;min-height:297mm;background:white;color:#1a1a2e;padding:22mm 18mm;box-shadow:0 6px 40px rgba(0,0,0,.5);font-family:var(--fs);font-size:11pt;line-height:1.8;word-break:break-word;position:relative;flex-shrink:0;margin-bottom:16px}
.preview-page::after{content:"â€” " attr(data-page) " â€”";position:absolute;bottom:10mm;left:50%;transform:translateX(-50%);font-family:sans-serif;font-size:9pt;color:#bbb;white-space:nowrap}
.preview-page h1{font-size:21pt;font-weight:700;margin:0 0 14px;border-bottom:2.5px solid #1a1a2e;padding-bottom:8px}
.preview-page h2{font-size:15pt;font-weight:700;margin:20px 0 10px}
.preview-page h3{font-size:12pt;font-weight:700;margin:16px 0 7px;color:#2a2a3e}
.preview-page h4{font-size:11pt;font-weight:700;margin:14px 0 5px}
.preview-page p{margin:0 0 11px}
.preview-page ul,.preview-page ol{margin:0 0 11px;padding-left:22px}
.preview-page li{margin-bottom:3px}
.preview-page blockquote{border-left:3px solid #5b4ce4;margin:14px 0;padding:7px 14px;background:#f5f5ff;color:#3a3a5e;font-style:italic}
.preview-page code{font-family:'JetBrains Mono',monospace;font-size:9pt;background:#f0f0f8;padding:1px 4px;border-radius:3px;color:#5b4ce4}
.preview-page pre{background:#1a1a2e;color:#e8e8f0;padding:14px;border-radius:6px;overflow-x:auto;margin:11px 0;font-size:9pt}
.preview-page pre code{background:none;color:inherit;padding:0}
.preview-page table{width:100%;border-collapse:collapse;margin:11px 0;font-size:10pt}
.preview-page th{background:#1a1a2e;color:#fff;padding:7px 11px;text-align:left;font-weight:600}
.preview-page td{padding:6px 11px;border:1px solid #d0d0e0}
.preview-page tr:nth-child(even) td{background:#f7f7fc}
.preview-page img{max-width:100%}
.preview-page a{color:#5b4ce4;text-decoration:underline;text-underline-offset:2px}
.preview-page a[href^="http"]::after{content:" â†—";font-size:8pt;opacity:.5}
.preview-page .ref-block{border-top:1px solid #d0d0e0;margin-top:28px;padding-top:10px;font-size:9pt;color:#4a4a6a}
.preview-page .tbl-caption{font-size:10pt;font-weight:600;color:#1a1a2e;margin-bottom:5px;display:block}
.preview-page .fig-caption{font-size:10pt;color:#4a4a6a;margin-top:5px;font-style:italic;display:block;text-align:center}
/* RESEARCH MODE: paragraph line numbers */
.preview-page.rm{counter-reset:pln}
.preview-page.rm>p{counter-increment:pln;padding-left:36px;position:relative}
.preview-page.rm>p::before{content:counter(pln);position:absolute;left:0;top:0;font-family:'JetBrains Mono',monospace;font-size:8.5pt;color:#b0b0c8;min-width:28px;text-align:right;user-select:none;border-right:1px solid #ddd;margin-right:8px;padding-right:6px}
/* statusbar */
#statusbar{grid-area:stat;display:flex;align-items:center;padding:0 12px;background:var(--acd);color:rgba(255,255,255,.85);font-size:11px;gap:12px;font-family:var(--fm);overflow:hidden}
.si{white-space:nowrap;flex-shrink:0}.ss{color:rgba(255,255,255,.3);flex-shrink:0}.ssp{flex:1}
#autosave-indicator{display:flex;align-items:center;gap:4px}
.save-dot{width:6px;height:6px;border-radius:50%;background:var(--ok)}
.save-dot.saving{animation:pulse .8s ease infinite;background:var(--wn)}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}
#error-count{color:var(--er);cursor:pointer}
/* buttons */
.btn{display:inline-flex;align-items:center;gap:4px;padding:5px 11px;border:none;border-radius:var(--r);cursor:pointer;font-family:var(--fb);font-size:12px;font-weight:500;transition:all var(--tr)}
.btn-p{background:var(--ac);color:#fff}.btn-p:hover{background:var(--acd)}
.btn-g{background:transparent;border:1px solid var(--bd);color:var(--tx2)}.btn-g:hover{border-color:var(--bda);color:var(--tx);background:var(--bg5)}
.btn-sm{padding:3px 8px;font-size:11px}
.btn-ic{background:transparent;border:none;color:var(--tx2);cursor:pointer;padding:4px;border-radius:var(--r);transition:all var(--tr);display:flex;align-items:center;justify-content:center;font-size:13px}.btn-ic:hover{color:var(--tx);background:var(--bg5)}
.btn-tog{background:var(--bg3);border:1px solid var(--bd);color:var(--tx2)}.btn-tog.active{background:var(--acg);border-color:var(--ac);color:var(--ac)}
/* tooltip */
#tooltip{position:fixed;z-index:9999;background:#1a1a2e;color:#e8e8f0;padding:5px 9px;border-radius:5px;font-family:var(--fb);font-size:11px;pointer-events:none;opacity:0;transition:opacity .15s;max-width:260px;box-shadow:0 4px 16px rgba(0,0,0,.4);border:1px solid #2e2e42;line-height:1.4}
#tooltip.vis{opacity:1}
.tt-key{display:inline-block;background:#2e2e42;border-radius:3px;padding:0 4px;font-family:var(--fm);font-size:10px;color:#a0a0c0;margin-left:4px}
/* overlays & modals */
.ov{position:fixed;inset:0;z-index:8000;background:rgba(0,0,0,.55);backdrop-filter:blur(3px);display:none;align-items:center;justify-content:center}
.ov.vis{display:flex}
.modal{background:var(--bg2);border:1px solid var(--bd);border-radius:10px;padding:22px;min-width:340px;max-width:560px;width:90vw;box-shadow:var(--sh);max-height:90vh;overflow-y:auto}
.modal.lg{max-width:780px}.modal.xl{max-width:940px}
.modal h3{font-size:15px;font-weight:600;margin-bottom:14px;color:var(--txh)}
.mb{margin-bottom:16px}.mf{display:flex;gap:8px;justify-content:flex-end;margin-top:14px}
.fg{margin-bottom:10px}
.fl{display:block;font-size:11px;color:var(--tx2);margin-bottom:3px;font-weight:500}
.fi{width:100%;background:var(--bg3);border:1px solid var(--bd);border-radius:var(--r);color:var(--tx);padding:7px 10px;font-family:var(--fb);font-size:13px;outline:none;transition:border-color var(--tr)}
.fi:focus{border-color:var(--ac)}
select.fi option{background:var(--bg2)}
textarea.fi{resize:vertical;min-height:70px;font-family:var(--fm);font-size:12px;line-height:1.6}
/* tabs */
.tab-row{display:flex;border-bottom:1px solid var(--bd);margin-bottom:14px}
.tab{padding:6px 13px;font-size:12px;font-weight:500;color:var(--tx3);cursor:pointer;border-bottom:2px solid transparent;transition:all var(--tr);white-space:nowrap}
.tab.active{color:var(--ac);border-bottom-color:var(--ac)}
.tp{display:none}.tp.active{display:block}
/* cite */
#cite-list-area{min-height:60px;max-height:210px;overflow-y:auto;border:1px solid var(--bd);border-radius:var(--r);background:var(--bg3);margin-bottom:10px}
.cite-entry{display:flex;align-items:flex-start;gap:8px;padding:7px 11px;border-bottom:1px solid var(--bd);cursor:pointer;transition:background var(--tr)}
.cite-entry:last-child{border-bottom:none}
.cite-entry:hover{background:var(--bg5)}
.cite-entry input[type=checkbox]{margin-top:3px;accent-color:var(--ac);flex-shrink:0}
.cite-body{flex:1;min-width:0}
.cite-key{font-family:var(--fm);font-size:11px;color:var(--ac);font-weight:600;margin-bottom:2px}
.cite-full{font-size:11px;color:var(--tx2);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.cite-empty{padding:18px;text-align:center;color:var(--tx3);font-size:12px}
#lib-list{min-height:50px;max-height:280px;overflow-y:auto;border:1px solid var(--bd);border-radius:var(--r);background:var(--bg3)}
.lib-item{display:flex;align-items:center;padding:5px 10px;border-bottom:1px solid var(--bd);font-size:11px;gap:6px}
.lib-item:last-child{border-bottom:none}
.lib-key{font-family:var(--fm);font-size:10px;color:var(--ac);font-weight:600;flex-shrink:0;min-width:90px}
/* error panel */
#error-panel{position:absolute;bottom:0;left:0;right:0;background:var(--bg2);border-top:1px solid var(--bd);max-height:100px;overflow-y:auto;z-index:50;display:none}
#error-panel.vis{display:block}
#ep-hdr{display:flex;align-items:center;justify-content:space-between;padding:4px 12px;font-size:11px;font-weight:600;color:var(--er);border-bottom:1px solid var(--bd)}
.error-item{padding:3px 12px;font-size:11px;font-family:var(--fm);color:var(--tx2);border-bottom:1px solid var(--bd)}
/* hotkey overlay */
#hk-overlay{position:fixed;inset:0;z-index:10000;background:rgba(0,0,0,.7);backdrop-filter:blur(4px);display:none;align-items:center;justify-content:center}
#hk-overlay.vis{display:flex}
#hk-panel{background:var(--bg2);border:1px solid var(--bd);border-radius:12px;padding:22px;max-width:700px;width:92vw;max-height:82vh;overflow-y:auto;box-shadow:0 24px 80px rgba(0,0,0,.5)}
#hk-panel h2{font-size:15px;font-weight:600;color:var(--txh);margin-bottom:16px;display:flex;align-items:center;justify-content:space-between}
.hk-s{font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:.1em;color:var(--ac);margin:12px 0 6px}
.hk-grid{display:grid;grid-template-columns:1fr 1fr;gap:3px}
.hk-item{display:flex;align-items:center;justify-content:space-between;padding:4px 8px;border-radius:4px;background:var(--bg3)}
.hk-desc{font-size:11px;color:var(--tx2)}.hk-keys{display:flex;gap:2px;flex-shrink:0}
kbd{background:var(--bg5);border:1px solid var(--bd);border-radius:3px;padding:1px 5px;font-family:var(--fm);font-size:9px;color:var(--tx)}
/* color swatches */
.csw-row{display:flex;gap:4px;flex-wrap:wrap;margin-top:4px}
.csw{width:22px;height:22px;border-radius:3px;cursor:pointer;border:2px solid transparent;transition:border-color .1s}
.csw:hover,.csw.sel{border-color:white}
/* template grid */
.tmpl-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.tmpl-card{border:1px solid var(--bd);border-radius:8px;padding:12px;cursor:pointer;transition:all var(--tr);background:var(--bg3)}
.tmpl-card:hover{border-color:var(--ac);background:var(--acg)}
.tmpl-card h4{font-size:13px;font-weight:600;color:var(--txh);margin-bottom:4px}
.tmpl-card p{font-size:11px;color:var(--tx2);line-height:1.4}
/* rm badge */
#rm-badge{background:var(--acd);color:rgba(255,255,255,.9);font-size:10px;font-weight:600;padding:2px 7px;border-radius:3px;display:none}
#rm-badge.vis{display:inline-block}
#vm-sel{background:var(--bg3);border:1px solid var(--bd);border-radius:var(--r);color:var(--tx2);font-size:11px;padding:2px 6px;outline:none;cursor:pointer;font-family:var(--fb)}
#pw-btn{position:relative}
#pw-btn::after{content:'';position:absolute;top:3px;right:3px;width:5px;height:5px;border-radius:50%;background:var(--ok);display:none}
#pw-btn.open::after{display:block}
.spacer{flex:1}
/* caption opts */
.cap-opt{padding:4px 10px;border:1px solid var(--bd);border-radius:var(--r);font-size:12px;cursor:pointer;background:var(--bg3);color:var(--tx2);transition:all var(--tr)}
.cap-opt.sel{border-color:var(--ac);background:var(--acg);color:var(--ac)}
/* font size stepper â€” inline input mode */
#fsize-input{display:none;width:50px;text-align:center;font-family:var(--fm);font-size:12px;font-weight:600;color:#e8e8f0;background:#2a2a3a;border:1px solid var(--ac);border-radius:3px;outline:none;padding:0 4px;height:22px}
#fsize-input.vis{display:block}
#fsize-display.edit-mode{display:none}
/* format quick panel */
#fmt-panel{position:fixed;z-index:9000;background:var(--bg2);border:1px solid var(--bd);border-radius:10px;padding:16px;box-shadow:0 8px 40px rgba(0,0,0,.5);min-width:300px;display:none}
#fmt-panel.vis{display:block}
#fmt-panel h4{font-size:12px;font-weight:600;color:var(--tx3);text-transform:uppercase;letter-spacing:.08em;margin-bottom:10px}
.fmt-row{display:flex;align-items:center;gap:8px;margin-bottom:10px}
.fmt-lbl{font-size:11px;color:var(--tx2);width:56px;flex-shrink:0}
/* stats type buttons */
#stats-type-row .btn-tog{font-size:11px;padding:3px 8px}
/* view mode buttons */
#vm-split,#vm-editor,#vm-preview{font-size:10px;min-width:34px;padding:0 5px}
/* footnote highlight in editor via preview */
.preview-page .footnote-highlight{background:#f0f0f0;color:#1a1a2e;border-radius:2px;padding:0 2px}
.preview-page .footnote-def{background:#f5f5f5;color:#1a1a2e;border-left:3px solid #bbb;padding:4px 10px;margin:4px 0;font-size:9.5pt}
.preview-page .footnotes-section{border-top:1px solid #d0d0e0;margin-top:24px;padding-top:10px;font-size:9.5pt;color:#444}
/* editor footnote syntax highlight */
#editor{caret-color:var(--ac)}
/* search result cards */
.ref-card{padding:9px 12px;border-bottom:1px solid var(--bd);transition:background var(--tr)}
.ref-card:last-child{border-bottom:none}
.ref-card:hover{background:var(--bg5)}
.ref-card-title{font-size:12px;font-weight:600;color:var(--txh);margin-bottom:3px;line-height:1.4}
.ref-card-meta{font-size:10px;color:var(--tx3);margin-bottom:5px;line-height:1.5}
.ref-card-apa{font-size:10px;color:var(--tx2);font-family:var(--fm);background:var(--bg4);border-radius:3px;padding:4px 8px;margin-bottom:5px;line-height:1.6;word-break:break-word;cursor:text;user-select:all}
.ref-card-btns{display:flex;gap:5px;flex-wrap:wrap;align-items:center}
.ref-tag{font-size:9px;padding:1px 5px;border-radius:3px;background:var(--bg5);color:var(--tx3);border:1px solid var(--bd)}
::-webkit-scrollbar{width:5px;height:5px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--bd);border-radius:3px}
::-webkit-scrollbar-thumb:hover{background:var(--bda)}
@media print{
  #app{display:block;height:auto}
  #titlebar,#toolbar,#sidebar,#statusbar,#editor-pane{display:none!important}
  #main{display:block}#preview-pane{display:block!important}
  #preview-container{background:white;padding:0;display:block}
  .preview-page{box-shadow:none;margin:0;page-break-after:always;width:100%;min-height:0}
  .preview-page:last-child{page-break-after:auto}
  .preview-page::after{display:none}
}
</style>
</head>
<body>
<div id="app">

<!-- TITLEBAR -->
<header id="titlebar">
  <div id="app-logo"><div class="logo-icon">M</div>MD PRO V9</div>
  <input id="doc-title" type="text" value="Untitled Document" spellcheck="false">
  <div id="tba">
    <span id="rm-badge">RESEARCH</span>
    <button class="btn btn-g btn-sm" onclick="App.showTmpl()" data-tooltip="ë…¼ë¬¸ ì–‘ì‹ ì„ íƒ">ğŸ“‹ ì–‘ì‹</button>
    <button class="btn btn-g btn-sm" onclick="App.toggleRM()" data-tooltip="Research Mode (ë‹¨ë½ ì¤„ë²ˆí˜¸)" data-key="Ctrl+Shift+R">ğŸ”¬ Research</button>
    <button class="btn btn-g btn-sm" onclick="App.showCite()" data-tooltip="ì°¸ê³ ë¬¸í—Œ ê´€ë¦¬ & ì¸ìš©" data-key="Ctrl+Shift+C">ğŸ“š References</button>
    <button class="btn btn-g btn-sm" onclick="Scholar.show()" data-tooltip="Google Scholar ê²€ìƒ‰ (ìƒˆ ì°½)" data-key="Ctrl+Shift+G">ğŸ” Scholar</button>
    <button class="btn btn-g btn-sm" onclick="App.showSaveDlg()" data-tooltip="ì €ì¥ í˜•ì‹ ì„ íƒ" data-key="Ctrl+S">ğŸ’¾ ì €ì¥</button>
    <button class="btn btn-p btn-sm" onclick="App.printDoc()" data-tooltip="ì¸ì‡„ / PDF ì €ì¥">ğŸ–¨ï¸ ì¸ì‡„</button>
  </div>
</header>

<!-- TOOLBAR -->
<div id="toolbar">
  <div class="tg"><button class="tb" onclick="App.toggleSidebar()" data-tooltip="ì‚¬ì´ë“œë°”">â˜°</button></div>
  <div class="ts"></div>
  <div class="tg">
    <button class="tb" onclick="ED.h(1)" data-tooltip="ì œëª© H1" data-key="Ctrl+Alt+1"><b>H1</b></button>
    <button class="tb" onclick="ED.h(2)" data-tooltip="ì œëª© H2" data-key="Ctrl+Alt+2"><b>H2</b></button>
    <button class="tb" onclick="ED.h(3)" data-tooltip="ì œëª© H3" data-key="Ctrl+Alt+3"><b>H3</b></button>
  </div>
  <div class="ts"></div>
  <div class="tg">
    <button class="tb" id="bold-btn" onclick="ED.bold()" data-tooltip="Smart Bold" data-key="Ctrl+B"><b>B</b></button>
    <button class="tb" id="italic-btn" onclick="ED.italic()" data-tooltip="ê¸°ìš¸ì„ê¼´" data-key="Ctrl+I"><i>I</i></button>
    <button class="tb" onclick="ED.strike()" data-tooltip="ì·¨ì†Œì„ ">SÌ¶</button>
    <button class="tb" onclick="ED.inlineCode()" data-tooltip="ì¸ë¼ì¸ ì½”ë“œ"><code style="font-size:10px">`c`</code></button>
  </div>
  <div class="ts"></div>
  <!-- font size +/- -->
  <div class="tg" style="gap:0">
    <button class="tb" onclick="FS.dec()" data-tooltip="ì„ íƒ ê¸€ì í¬ê¸° ì¤„ì´ê¸° (Shift+Alt+,)" style="min-width:22px;font-size:14px;font-weight:700;padding:0 4px">âˆ’</button>
    <div id="fsize-display" style="min-width:38px;text-align:center;font-family:var(--fm);font-size:12px;font-weight:600;color:#e8e8f0;line-height:26px;cursor:pointer;user-select:none;background:#2a2a3a;border-top:1px solid #3a3a50;border-bottom:1px solid #3a3a50" data-tooltip="í•œë²ˆ í´ë¦­: ëª©ë¡ / ë‘ë²ˆ í´ë¦­: ì§ì ‘ ì…ë ¥" onclick="FS.clickPick(event)" ondblclick="FS.startEdit(event)">12pt</div>
    <input id="fsize-input" type="text" value="12" onblur="FS.endEdit()" onkeydown="FS.editKey(event)" style="display:none;width:46px;text-align:center;font-family:var(--fm);font-size:12px;font-weight:600;color:#e8e8f0;background:#2a2a3a;border:1px solid var(--ac);border-radius:3px;outline:none;padding:0 4px;height:22px;line-height:22px">
    <button class="tb" onclick="FS.inc()" data-tooltip="ì„ íƒ ê¸€ì í¬ê¸° í‚¤ìš°ê¸° (Shift+Alt+.)" style="min-width:22px;font-size:14px;font-weight:700;padding:0 4px">+</button>
  </div>
  <!-- font color + highlight -->
  <div class="tg">
    <button class="tb" id="fc-btn" onclick="App.openColorPicker('text')" data-tooltip="ê¸€ì ìƒ‰ìƒ" style="flex-direction:column;gap:1px">
      <span style="font-size:11px;font-weight:700">A</span>
      <span id="fc-bar" style="width:14px;height:2px;border-radius:1px;background:#e8e8f0"></span>
    </button>
    <button class="tb" id="hl-btn" onclick="App.openColorPicker('bg')" data-tooltip="í˜•ê´‘íœ í•˜ì´ë¼ì´íŠ¸" style="flex-direction:column;gap:1px">
      <span style="font-size:11px">ğŸ–Š</span>
      <span id="hl-bar" style="width:14px;height:2px;border-radius:1px;background:transparent;border:1px solid var(--bd)"></span>
    </button>
  </div>
  <div class="ts"></div>
  <div class="tg">
    <button class="tb" onclick="ED.align('left')" data-tooltip="ì™¼ìª½ ì •ë ¬" data-key="Shift+Alt+L">â‡¤</button>
    <button class="tb" onclick="ED.align('center')" data-tooltip="ê°€ìš´ë° ì •ë ¬" data-key="Shift+Alt+C">â‡”</button>
    <button class="tb" onclick="ED.align('right')" data-tooltip="ì˜¤ë¥¸ìª½ ì •ë ¬" data-key="Shift+Alt+R">â‡¥</button>
  </div>
  <div class="ts"></div>
  <div class="tg">
    <button class="tb" onclick="ED.list('ul')" data-tooltip="ëª©ë¡">â€¢ List</button>
    <button class="tb" onclick="ED.list('ol')" data-tooltip="ë²ˆí˜¸ ëª©ë¡">1. List</button>
    <button class="tb" onclick="ED.bquote()" data-tooltip="ì¸ìš©êµ¬" data-key="Ctrl+.">â</button>
  </div>
  <div class="ts"></div>
  <div class="tg">
    <button class="tb" onclick="ED.table()" data-tooltip="í‘œ ì‚½ì…" data-key="Alt+8">âŠ í‘œ</button>
    <button class="tb" onclick="ED.tableRow()" data-tooltip="í–‰ ì¶”ê°€" data-key="Alt+9">+í–‰</button>
    <button class="tb" onclick="ED.tableCol()" data-tooltip="ì—´ ì¶”ê°€" data-key="Alt+0">+ì—´</button>
    <button class="tb" onclick="ED.mergeH()" data-tooltip="ê°€ë¡œ ë³‘í•© (colspan)" data-key="Alt+Shift+H">âŠH</button>
    <button class="tb" onclick="ED.mergeV()" data-tooltip="ì„¸ë¡œ ë³‘í•© (rowspan)" data-key="Alt+Shift+V">âŠV</button>
    <button class="tb" onclick="App.showCaption('table')" data-tooltip="í‘œ ìº¡ì…˜">ã€ˆí‘œã€‰</button>
    <button class="tb" onclick="App.showCaption('fig')" data-tooltip="ê·¸ë¦¼ ìº¡ì…˜">[ê·¸ë¦¼]</button>
  </div>
  <div class="ts"></div>
  <div class="tg">
    <!-- hotkey = direct insert with last lang; toolbar button = show modal -->
    <button class="tb" onclick="App.showCode()" data-tooltip="ì½”ë“œ ë¸”ë¡ ì–¸ì–´ ì„ íƒ (ë©”ë‰´) / Alt+C = ë§ˆì§€ë§‰ ì–¸ì–´ ì§ì ‘ ì‚½ì…">âŒ¨ Code</button>
  </div>
  <div class="ts"></div>
  <div class="tg">
    <button class="tb" onclick="ED.pageBreak()" data-tooltip="í˜ì´ì§€ ë‚˜ëˆ„ê¸°" data-key="Ctrl+Enter">â‹¯ PB</button>
    <button class="tb" onclick="ED.lineBreak()" data-tooltip="ì¤„ë°”ê¿ˆ &lt;br&gt;" data-key="Ctrl+Shift+Enter">â†©</button>
    <button class="tb" onclick="App.showImg()" data-tooltip="ì´ë¯¸ì§€">ğŸ–¼</button>
    <button class="tb" onclick="App.showLink()" data-tooltip="ë§í¬ (ìƒˆ íƒ­)">ğŸ”—</button>
    <button class="tb" onclick="ED.footnote()" data-tooltip="ê°ì£¼">â€ </button>
    <button class="tb" onclick="ED.math()" data-tooltip="ìˆ˜ì‹(LaTeX)">âˆ‘</button>
    <button class="tb" onclick="App.showCite()" data-tooltip="ì¸ìš© ì‚½ì…" data-key="Ctrl+Shift+C">ğŸ“–</button>
    <button class="tb" onclick="STATS.show()" data-tooltip="APA í†µê³„ ì‚½ì…" data-key="Shift+Alt+9">ğ‘“(x)</button>
  </div>
  <div class="ts"></div>
  <div class="tg"><button class="tb" onclick="App.toggleFind()" data-tooltip="ì°¾ê¸°/ë°”ê¾¸ê¸°" data-key="Ctrl+F">ğŸ”</button></div>
  <div class="spacer"></div>
  <div class="tg">
    <button class="tb" onclick="App.setViewCycle('split')" id="vm-split" data-tooltip="ë¶„í•  ë³´ê¸° (Alt+1)" data-key="Alt+1" style="font-size:10px;min-width:36px">Split</button>
    <button class="tb" onclick="App.setViewCycle('editor')" id="vm-editor" data-tooltip="ì—ë””í„°ë§Œ (Alt+2)" data-key="Alt+2" style="font-size:10px;min-width:36px">Edit</button>
    <button class="tb" onclick="App.setViewCycle('preview')" id="vm-preview" data-tooltip="ë¯¸ë¦¬ë³´ê¸°ë§Œ (Alt+3)" data-key="Alt+3" style="font-size:10px;min-width:36px">View</button>
  </div>
  <div class="ts"></div>
  <div class="tg">
    <button class="tb" id="pw-btn" onclick="PW.open()" data-tooltip="ìƒˆì°½ ë¯¸ë¦¬ë³´ê¸°" data-key="Ctrl+Shift+P">ğŸ—— PV</button>
    <button class="tb" onclick="PW.forceRefresh()" data-tooltip="ìƒˆì°½ ê°•ì œ ìƒˆë¡œê³ ì¹¨">â†»</button>
  </div>
  <div class="ts"></div>
  <div class="tg">
    <button class="tb" onclick="App.toggleTheme()" data-tooltip="í…Œë§ˆ ì „í™˜">â—‘</button>
    <button class="tb" id="ln-btn" onclick="LN.toggle()" data-tooltip="ì¤„ ë²ˆí˜¸">ln</button>
    <button class="tb" onclick="App.showHK()" data-tooltip="ë‹¨ì¶•í‚¤ ëª©ë¡" data-key="Shift+?">?</button>
  </div>
</div>

<!-- SIDEBAR -->
<nav id="sidebar">
  <div id="sb-hdr"><span>ëª©ì°¨ (TOC)</span><button class="btn-ic" onclick="TOC.build(document.getElementById('editor').value)">â†»</button></div>
  <div id="toc-list"><div style="padding:12px;color:var(--tx3);font-size:12px">í—¤ë”©(#) ì¶”ê°€ ì‹œ ìë™ ìƒì„±</div></div>
  <div id="sb-stats"><span id="sw">0 ë‹¨ì–´</span><span id="sc">0 ì</span><span id="sp">ì•½ 0 í˜ì´ì§€</span></div>
</nav>

<!-- MAIN -->
<main id="main">
  <div id="find-bar">
    <span style="font-size:11px;color:var(--tx3)">ì°¾ê¸°</span>
    <input id="fi" type="text" placeholder="ê²€ìƒ‰ì–´..." onkeydown="App.findKey(event)">
    <span style="font-size:11px;color:var(--tx3)">ë°”ê¾¸ê¸°</span>
    <input id="ri" type="text" placeholder="ë°”ê¿€ ë‚´ìš©...">
    <button class="btn btn-g btn-sm" onclick="App.findNext()">ë‹¤ìŒ</button>
    <button class="btn btn-g btn-sm" onclick="App.replaceOne()">ë°”ê¾¸ê¸°</button>
    <button class="btn btn-g btn-sm" onclick="App.replaceAll()">ëª¨ë‘</button>
    <button class="btn-ic" onclick="App.toggleFind()">âœ•</button>
    <span id="fc-cnt" style="font-size:11px;color:var(--tx3)"></span>
  </div>
  <div id="editor-wrap">
    <div id="editor-pane">
      <div id="ed-hdr"><span class="pane-lbl"><span></span>MARKDOWN</span></div>
      <div id="ed-container">
        <div id="line-numbers"><div class="lnc" id="lnc"></div></div>
        <textarea id="editor" placeholder="# ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”&#10;&#10;ì—¬ê¸°ì— Markdownì„ ì‘ì„±í•˜ì„¸ìš”.&#10;Shift+? â†’ ë‹¨ì¶•í‚¤ ëª©ë¡" spellcheck="false"></textarea>
      </div>
    </div>
    <div id="preview-pane">
      <div id="pv-hdr">
        <span class="pane-lbl"><span style="background:var(--ac2)"></span>PREVIEW â€” A4 ë‹¤ì¤‘ í˜ì´ì§€</span>
        <span class="spacer"></span>
        <span id="pg-cnt" style="font-size:10px;color:var(--tx3)"></span>
        <span id="render-ts" style="font-size:10px;color:var(--tx3);margin-left:8px"></span>
      </div>
      <div id="preview-container"></div>
    </div>
  </div>
  <div id="error-panel">
    <div id="ep-hdr"><span>âš  ì˜¤ë¥˜</span><button class="btn-ic" onclick="App.closeErr()">âœ•</button></div>
    <div id="ep-list"></div>
  </div>
</main>

<!-- STATUSBAR -->
<div id="statusbar">
  <div class="si" id="autosave-indicator"><div class="save-dot" id="save-dot"></div><span id="save-st">ì €ì¥ë¨</span></div>
  <div class="ss">|</div><div class="si" id="cursor-pos">ì¤„ 1, ì—´ 1</div>
  <div class="ss">|</div><div class="si" id="sel-info"></div>
  <div class="ssp"></div>
  <div class="si" id="error-count" onclick="App.toggleErr()"></div>
  <div class="ss" id="ec-sep" style="display:none">|</div>
  <div class="si">UTF-8</div><div class="ss">|</div>
  <div class="si" id="mode-ind">NORMAL</div>
</div>
</div><!-- #app -->

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• MODALS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->

<!-- HOTKEY OVERLAY -->
<div id="hk-overlay" onclick="App.hideHK()">
  <div id="hk-panel" onclick="event.stopPropagation()">
    <h2>ë‹¨ì¶•í‚¤ ì•ˆë‚´ <button class="btn-ic" onclick="App.hideHK()">âœ•</button></h2>
    <div class="hk-s">ë¬¸ì„œ êµ¬ì¡°</div>
    <div class="hk-grid">
      <div class="hk-item"><span class="hk-desc">H1/H2/H3</span><div class="hk-keys"><kbd>Ctrl</kbd><kbd>Alt</kbd><kbd>1~3</kbd></div></div>
      <div class="hk-item"><span class="hk-desc">í˜ì´ì§€ ë‚˜ëˆ„ê¸°</span><div class="hk-keys"><kbd>Ctrl</kbd><kbd>Enter</kbd></div></div>
      <div class="hk-item"><span class="hk-desc">ì¤„ë°”ê¿ˆ(&lt;br&gt;)</span><div class="hk-keys"><kbd>Ctrl</kbd><kbd>Shift</kbd><kbd>Enter</kbd></div></div>
    </div>
    <div class="hk-s">í‘œ í¸ì§‘</div>
    <div class="hk-grid">
      <div class="hk-item"><span class="hk-desc">í‘œ ì‚½ì…</span><div class="hk-keys"><kbd>Alt</kbd><kbd>8</kbd></div></div>
      <div class="hk-item"><span class="hk-desc">í–‰ ì¶”ê°€</span><div class="hk-keys"><kbd>Alt</kbd><kbd>9</kbd></div></div>
      <div class="hk-item"><span class="hk-desc">ì—´ ì¶”ê°€</span><div class="hk-keys"><kbd>Alt</kbd><kbd>0</kbd></div></div>
      <div class="hk-item"><span class="hk-desc">ê°€ë¡œ ë³‘í•© (colspan) â†’ HTML ë³€í™˜</span><div class="hk-keys"><kbd>Alt</kbd><kbd>Shift</kbd><kbd>H</kbd></div></div>
      <div class="hk-item"><span class="hk-desc">ì„¸ë¡œ ë³‘í•© (rowspan) â†’ HTML ë³€í™˜</span><div class="hk-keys"><kbd>Alt</kbd><kbd>Shift</kbd><kbd>V</kbd></div></div>
    </div>
    <div class="hk-s">ì„œì‹</div>
    <div class="hk-grid">
      <div class="hk-item"><span class="hk-desc">Smart Bold</span><div class="hk-keys"><kbd>Ctrl</kbd><kbd>B</kbd></div></div>
      <div class="hk-item"><span class="hk-desc">ê¸°ìš¸ì„ê¼´</span><div class="hk-keys"><kbd>Ctrl</kbd><kbd>I</kbd></div></div>
      <div class="hk-item"><span class="hk-desc">ì¸ë¼ì¸ ì½”ë“œ `code`</span><div class="hk-keys"><kbd>Alt</kbd><kbd>V</kbd></div></div>
      <div class="hk-item"><span class="hk-desc">ì½”ë“œ ì§ì ‘ ì‚½ì… (ë§ˆì§€ë§‰ ì–¸ì–´)</span><div class="hk-keys"><kbd>Alt</kbd><kbd>C</kbd></div></div>
      <div class="hk-item"><span class="hk-desc">ê¸€ì í¬ê¸° í‚¤ìš°ê¸°</span><div class="hk-keys"><kbd>Shift</kbd><kbd>Alt</kbd><kbd>&gt;</kbd></div></div>
      <div class="hk-item"><span class="hk-desc">ê¸€ì í¬ê¸° ì¤„ì´ê¸°</span><div class="hk-keys"><kbd>Shift</kbd><kbd>Alt</kbd><kbd>&lt;</kbd></div></div>
    </div>
    <div class="hk-s">í™”ë©´ ì „í™˜</div>
    <div class="hk-grid">
      <div class="hk-item"><span class="hk-desc">Split ë³´ê¸°</span><div class="hk-keys"><kbd>Alt</kbd><kbd>1</kbd></div></div>
      <div class="hk-item"><span class="hk-desc">ì—ë””í„°ë§Œ</span><div class="hk-keys"><kbd>Alt</kbd><kbd>2</kbd></div></div>
      <div class="hk-item"><span class="hk-desc">ë¯¸ë¦¬ë³´ê¸°ë§Œ</span><div class="hk-keys"><kbd>Alt</kbd><kbd>3</kbd></div></div>
    </div>
    <div class="hk-s">í¸ì§‘</div>
    <div class="hk-grid">
      <div class="hk-item"><span class="hk-desc">ì¤„ ìœ„ë¡œ ì´ë™</span><div class="hk-keys"><kbd>Alt</kbd><kbd>â†‘</kbd></div></div>
      <div class="hk-item"><span class="hk-desc">ì¤„ ì•„ë˜ë¡œ ì´ë™</span><div class="hk-keys"><kbd>Alt</kbd><kbd>â†“</kbd></div></div>
      <div class="hk-item"><span class="hk-desc">ì¤„/ì„ íƒ ë³µì œ</span><div class="hk-keys"><kbd>Shift</kbd><kbd>Alt</kbd><kbd>â†“</kbd></div></div>
    </div>
    <div class="hk-s">ì‚½ì… / ë„êµ¬</div>
    <div class="hk-grid">
      <div class="hk-item"><span class="hk-desc">ì¸ìš© ì‚½ì…</span><div class="hk-keys"><kbd>Ctrl</kbd><kbd>Shift</kbd><kbd>C</kbd></div></div>
      <div class="hk-item"><span class="hk-desc">ì£¼ì„(ê°ì£¼) ì‚½ì… (9pt)</span><div class="hk-keys"><kbd>Shift</kbd><kbd>Alt</kbd><kbd>N</kbd></div></div>
      <div class="hk-item"><span class="hk-desc">APA í†µê³„ ì‚½ì…</span><div class="hk-keys"><kbd>Shift</kbd><kbd>Alt</kbd><kbd>9</kbd></div></div>
      <div class="hk-item"><span class="hk-desc">ì„œì‹ íŒ¨ë„ (í¬ê¸°Â·ìƒ‰Â·í˜•ê´‘íœ)</span><div class="hk-keys"><kbd>Alt</kbd><kbd>L</kbd></div></div>
      <div class="hk-item"><span class="hk-desc">ì¤„ë²ˆí˜¸ ON/OFF</span><div class="hk-keys"><kbd>Ctrl</kbd><kbd>Alt</kbd><kbd>I</kbd></div></div>
      <div class="hk-item"><span class="hk-desc">ìƒˆì°½ ë¯¸ë¦¬ë³´ê¸°</span><div class="hk-keys"><kbd>Ctrl</kbd><kbd>Shift</kbd><kbd>P</kbd></div></div>
      <div class="hk-item"><span class="hk-desc">ì €ì¥ ë‹¤ì´ì–¼ë¡œê·¸</span><div class="hk-keys"><kbd>Ctrl</kbd><kbd>S</kbd></div></div>
      <div class="hk-item"><span class="hk-desc">ì°¾ê¸°/ë°”ê¾¸ê¸°</span><div class="hk-keys"><kbd>Ctrl</kbd><kbd>F</kbd></div></div>
      <div class="hk-item"><span class="hk-desc">Research Mode</span><div class="hk-keys"><kbd>Ctrl</kbd><kbd>Shift</kbd><kbd>R</kbd></div></div>
      <div class="hk-item"><span class="hk-desc">ë‹¨ì¶•í‚¤ ëª©ë¡</span><div class="hk-keys"><kbd>Shift</kbd><kbd>?</kbd></div></div>
      <div class="hk-item"><span class="hk-desc">Scholar ê²€ìƒ‰</span><div class="hk-keys"><kbd>Ctrl</kbd><kbd>Shift</kbd><kbd>G</kbd></div></div>
    </div>
    <div style="margin-top:10px;font-size:11px;color:var(--tx3)">í‘œ ë‚´ë¶€: Tabâ†’ë‹¤ìŒ ì…€ | Enterâ†’ìƒˆ í–‰ | âŒ¨ Code ë²„íŠ¼â†’ì–¸ì–´ ì„ íƒ | Alt+Câ†’ë§ˆì§€ë§‰ ì–¸ì–´ ì§ì ‘ ì‚½ì…</div>
  </div>
</div>

<!-- SAVE DIALOG -->
<div class="ov" id="save-modal">
  <div class="modal" style="max-width:400px">
    <h3>ğŸ’¾ ì €ì¥ í˜•ì‹ ì„ íƒ</h3>
    <div style="display:flex;flex-direction:column;gap:9px;margin-bottom:16px">
      <button class="btn btn-g" style="justify-content:flex-start;padding:11px 14px;gap:10px" onclick="App.saveMD()">
        <span style="font-size:18px">ğŸ“</span>
        <div style="text-align:left"><div style="font-weight:600;font-size:13px">Markdown (.md)</div><div style="font-size:11px;color:var(--tx2)">ì›ë³¸ ë§ˆí¬ë‹¤ìš´ íŒŒì¼</div></div>
      </button>
      <button class="btn btn-g" style="justify-content:flex-start;padding:11px 14px;gap:10px" onclick="App.saveTXT()">
        <span style="font-size:18px">ğŸ“„</span>
        <div style="text-align:left"><div style="font-weight:600;font-size:13px">Plain Text (.txt)</div><div style="font-size:11px;color:var(--tx2)">ë§ˆí¬ë‹¤ìš´ ê¸°í˜¸ ì œê±°í•œ í…ìŠ¤íŠ¸</div></div>
      </button>
      <button class="btn btn-g" style="justify-content:flex-start;padding:11px 14px;gap:10px" onclick="App.saveHTML()">
        <span style="font-size:18px">ğŸŒ</span>
        <div style="text-align:left"><div style="font-weight:600;font-size:13px">HTML (.html)</div><div style="font-size:11px;color:var(--tx2)">A4 ë‹¤ì¤‘ í˜ì´ì§€ ìŠ¤íƒ€ì¼ í¬í•¨</div></div>
      </button>
      <button class="btn btn-g" style="justify-content:flex-start;padding:11px 14px;gap:10px" onclick="App.printDoc()">
        <span style="font-size:18px">ğŸ–¨ï¸</span>
        <div style="text-align:left"><div style="font-weight:600;font-size:13px">ì¸ì‡„ / PDFë¡œ ì €ì¥</div><div style="font-size:11px;color:var(--tx2)">ë¸Œë¼ìš°ì € ì¸ì‡„ì°½ â†’ PDF ì €ì¥ ê°€ëŠ¥ (ì „ì²´ í˜ì´ì§€)</div></div>
      </button>
      <div style="display:flex;align-items:center;gap:10px;padding:10px 14px;background:var(--bg3);border-radius:var(--r);border:1px solid var(--bd)">
        <span style="font-size:16px">ğŸ”–</span>
        <div style="flex:1;text-align:left">
          <div style="font-weight:600;font-size:12px;color:var(--tx)">ì£¼ì„([^n]) í‘œì‹œ ì„¤ì •</div>
          <div style="font-size:11px;color:var(--tx2);margin-top:2px">ì €ì¥Â·ì¸ì‡„ ì‹œ ê°ì£¼ í‘œì‹œ ì—¬ë¶€</div>
        </div>
        <label style="display:flex;align-items:center;gap:5px;cursor:pointer;font-size:12px;color:var(--tx2)">
          <input type="checkbox" id="show-footnotes-chk" checked style="accent-color:var(--ac)"> í‘œì‹œ
        </label>
      </div>
    </div>
    <div class="mf"><button class="btn btn-g btn-sm" onclick="App.hideModal('save-modal')">ë‹«ê¸°</button></div>
  </div>
</div>

<!-- APA STATS MODAL -->
<div class="ov" id="stats-modal">
  <div class="modal" style="max-width:560px">
    <h3>ğ‘“(x) APA í†µê³„ ê²°ê³¼ ì‚½ì… <span style="font-size:11px;color:var(--tx3);font-weight:400">Shift+Alt+9</span></h3>
    <!-- Analysis type selector -->
    <div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:14px" id="stats-type-row">
      <button class="btn btn-tog btn-sm active" onclick="STATS.setType('ttest')" id="st-ttest">t-test</button>
      <button class="btn btn-tog btn-sm" onclick="STATS.setType('anova')" id="st-anova">ANOVA</button>
      <button class="btn btn-tog btn-sm" onclick="STATS.setType('regression')" id="st-regression">Regression</button>
      <button class="btn btn-tog btn-sm" onclick="STATS.setType('correlation')" id="st-correlation">Correlation</button>
      <button class="btn btn-tog btn-sm" onclick="STATS.setType('chisq')" id="st-chisq">Chi-square</button>
      <button class="btn btn-tog btn-sm" onclick="STATS.setType('sem')" id="st-sem">SEM</button>
      <button class="btn btn-tog btn-sm" onclick="STATS.setType('logistic')" id="st-logistic">Logistic</button>
      <button class="btn btn-tog btn-sm" onclick="STATS.setType('multilevel')" id="st-multilevel">Multilevel</button>
      <button class="btn btn-tog btn-sm" onclick="STATS.setType('custom')" id="st-custom" style="border-color:var(--ac2);color:var(--ac2)">âœ Custom</button>
    </div>
    <!-- Fields area -->
    <div id="stats-fields" style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:10px"></div>
    <!-- Custom area (hidden by default) -->
    <div id="stats-custom-area" style="display:none;margin-bottom:10px">
      <div class="fg"><label class="fl">ì»¤ìŠ¤í…€ ì´ë¦„</label><input class="fi" id="custom-name" type="text" placeholder="ì˜ˆ: Mixed ANOVA"></div>
      <div class="fg"><label class="fl">ì¶œë ¥ í¬ë§· <span style="color:var(--tx3);font-size:10px">{ë³€ìˆ˜ëª…} ì‚¬ìš©</span></label>
        <input class="fi" id="custom-fmt" type="text" placeholder="ì˜ˆ: (F({df1}, {df2}) = {F}, p = {p})">
      </div>
      <div class="fg" id="custom-vars-area"><label class="fl">ë³€ìˆ˜ ëª©ë¡ <span style="color:var(--tx3);font-size:10px">ì½¤ë§ˆë¡œ êµ¬ë¶„</span></label>
        <input class="fi" id="custom-vars" type="text" placeholder="df1, df2, F, p" oninput="STATS.updateCustomVars()">
      </div>
      <div id="custom-fields" style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px"></div>
      <div style="margin-top:8px;display:flex;gap:6px;align-items:center">
        <button class="btn btn-g btn-sm" onclick="STATS.saveCustom()">ğŸ’¾ ì €ì¥</button>
        <select id="custom-saved-sel" class="fi" style="width:auto;flex:1;padding:4px 8px;font-size:11px" onchange="STATS.loadCustom(this.value)"><option value="">â€” ì €ì¥ëœ ì»¤ìŠ¤í…€ â€”</option></select>
        <button class="btn btn-g btn-sm" style="color:var(--er)" onclick="STATS.deleteCustom()">ì‚­ì œ</button>
      </div>
    </div>
    <!-- Preview -->
    <div style="background:var(--bg3);border:1px solid var(--bd);border-radius:var(--r);padding:8px 12px;margin-bottom:12px;font-family:var(--fm);font-size:12px;color:var(--tx);min-height:28px">
      <span style="font-size:10px;color:var(--tx3);margin-right:6px">ë¯¸ë¦¬ë³´ê¸°:</span><span id="stats-preview" style="color:var(--ac)"></span>
    </div>
    <div class="mf">
      <button class="btn btn-g btn-sm" onclick="App.hideModal('stats-modal')">ì·¨ì†Œ</button>
      <button class="btn btn-p btn-sm" onclick="STATS.insert()">ì‚½ì…</button>
    </div>
  </div>
</div>

<!-- CITATION MANAGER -->
<div class="ov" id="cite-modal">
  <div class="modal xl">
    <h3>ğŸ“š ì°¸ê³ ë¬¸í—Œ ê´€ë¦¬ &amp; ì¸ìš© ì‚½ì…</h3>
    <div class="tab-row">
      <div class="tab active" onclick="CM.tab('add')">â‘  ì°¸ê³ ë¬¸í—Œ ì¶”ê°€</div>
      <div class="tab" onclick="CM.tab('cite')">â‘¡ ì¸ìš© ì‚½ì…</div>
      <div class="tab" onclick="CM.tab('convert')">â‘¢ ìŠ¤íƒ€ì¼ ë³€í™˜</div>
      <div class="tab" onclick="CM.tab('lib')">â‘£ ì €ì¥ëœ ëª©ë¡</div>
      <div class="tab" onclick="CM.tab('search')" style="color:var(--ac2)">â‘¤ ğŸ” ë…¼ë¬¸ ê²€ìƒ‰</div>
    </div>

    <!-- ADD -->
    <div class="tp active" id="cp-add">
      <div class="fg">
        <label class="fl">ì…ë ¥ êµ¬ë¶„ ë°©ì‹</label>
        <div style="display:flex;gap:8px;margin-bottom:10px">
          <button id="sep-blank-btn" class="btn btn-tog active btn-sm" style="flex:1" onclick="CM.setSep('blank')">
            ğŸ“‹ ë¹ˆ ì¤„ë¡œ êµ¬ë¶„<br><span style="font-size:10px;color:inherit;opacity:.8">í•­ëª© ì‚¬ì´ì— ë¹ˆ ì¤„ 1ê°œ</span>
          </button>
          <button id="sep-line-btn" class="btn btn-tog btn-sm" style="flex:1" onclick="CM.setSep('line')">
            â†µ ì—”í„°(ì¤„ë°”ê¿ˆ)ë¡œ êµ¬ë¶„<br><span style="font-size:10px;color:inherit;opacity:.8">ê° ì¤„ = 1ê°œ ì°¸ê³ ë¬¸í—Œ</span>
          </button>
        </div>
      </div>
      <div class="fg">
        <label class="fl">APA í˜•ì‹ ì°¸ê³ ë¬¸í—Œ ë¶™ì—¬ë„£ê¸°</label>
        <textarea id="cite-raw" class="fi" style="min-height:130px" placeholder="ì—¬ê¸°ì— ì°¸ê³ ë¬¸í—Œì„ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”..."></textarea>
        <div style="display:flex;gap:8px;margin-top:7px;align-items:center;flex-wrap:wrap">
          <button class="btn btn-p btn-sm" onclick="CM.parse()">ì•±ì—ì„œ ì‚¬ìš©í•˜ê¸° â†’</button>
          <button class="btn btn-g btn-sm" onclick="document.getElementById('cite-raw').value=''">ì§€ìš°ê¸°</button>
          <label class="btn btn-g btn-sm" style="cursor:pointer">ğŸ“ TXT ë¶ˆëŸ¬ì˜¤ê¸°<input type="file" accept=".txt,.bib,.ris" style="display:none" onchange="CM.loadFile(event)"></label>
          <span id="cite-msg" style="font-size:11px;color:var(--ok)"></span>
        </div>
        <div style="margin-top:7px;font-size:11px;color:var(--tx3)" id="sep-desc">í˜„ì¬: ë¹ˆ ì¤„ë¡œ êµ¬ë¶„ â€” í•­ëª© ì‚¬ì´ì— ë¹ˆ ì¤„ í•˜ë‚˜ë¥¼ ë„£ì–´ êµ¬ë¶„í•˜ì„¸ìš”.</div>
      </div>
    </div>

    <!-- CITE -->
    <div class="tp" id="cp-cite">
      <div style="display:flex;gap:7px;margin-bottom:9px;align-items:center">
        <input type="text" id="cite-search" class="fi" style="flex:1" placeholder="ì €ì, ì—°ë„, í‚¤ì›Œë“œë¡œ ê²€ìƒ‰..." oninput="CM.filter()">
        <button class="btn btn-g btn-sm" onclick="CM.selAll()">ì „ì²´ ì„ íƒ</button>
        <button class="btn btn-g btn-sm" onclick="CM.clrSel()">ì„ íƒ í•´ì œ</button>
      </div>
      <div id="cite-list-area"><div class="cite-empty">ì¶”ê°€ íƒ­ì—ì„œ ë¨¼ì € ì°¸ê³ ë¬¸í—Œì„ ì…ë ¥í•˜ì„¸ìš”.</div></div>
      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:8px">
        <label style="font-size:12px;color:var(--tx2)">ì‚½ì… í˜•ì‹:</label>
        <select id="cite-style" class="fi" style="width:auto;padding:4px 8px">
          <option value="inline">ì¸ë¼ì¸: (ì €ì, ì—°ë„)</option>
          <option value="narrative">ì„œìˆ í˜•: ì €ì(ì—°ë„)</option>
          <option value="multi">ë³µìˆ˜: (A, ì—°ë„; B, ì—°ë„)</option>
          <option value="footnote">ê°ì£¼: [^n]</option>
        </select>
        <span id="cite-sc" style="font-size:11px;color:var(--tx3);margin-left:auto">0ê°œ ì„ íƒë¨</span>
      </div>
    </div>

    <!-- CONVERT -->
    <div class="tp" id="cp-convert">
      <div style="display:flex;gap:8px;margin-bottom:12px;align-items:center;flex-wrap:wrap">
        <label style="font-size:12px;color:var(--tx2)">ì…ë ¥ ìŠ¤íƒ€ì¼:</label>
        <select id="from-style" class="fi" style="width:auto;padding:4px 8px">
          <option value="apa" selected>APA 7 (ê¸°ë³¸)</option>
          <option value="mla">MLA 9</option>
          <option value="chicago">Chicago (Author-Date)</option>
          <option value="vancouver">Vancouver</option>
        </select>
        <span style="font-size:12px;color:var(--tx2)">â†’ ë³€í™˜ ëŒ€ìƒ:</span>
        <select id="to-style" class="fi" style="width:auto;padding:4px 8px">
          <option value="mla" selected>MLA 9</option>
          <option value="apa">APA 7</option>
          <option value="chicago">Chicago (Author-Date)</option>
          <option value="vancouver">Vancouver</option>
        </select>
        <button class="btn btn-p btn-sm" onclick="CM.convertStyle()">ë³€í™˜</button>
      </div>
      <div class="fg">
        <label class="fl">ë³€í™˜í•  ì°¸ê³ ë¬¸í—Œ (ì €ì¥ ëª©ë¡ ë¯¸ì„ íƒ ì‹œ ì§ì ‘ ì…ë ¥)</label>
        <textarea id="conv-input" class="fi" style="min-height:80px" placeholder="Kim, J. H., &amp; Lee, S. (2023). SEM in education. Journal of Educational Research, 45(2), 123â€“145."></textarea>
      </div>
      <div class="fg">
        <label class="fl">ë³€í™˜ ê²°ê³¼ <span id="conv-label" style="color:var(--ac);font-weight:600"></span></label>
        <textarea id="conv-output" class="fi" style="min-height:80px" readonly placeholder="ë³€í™˜ ê²°ê³¼ê°€ ì—¬ê¸° í‘œì‹œë©ë‹ˆë‹¤..."></textarea>
      </div>
      <div style="display:flex;gap:8px">
        <button class="btn btn-g btn-sm" onclick="CM.copyConverted()">ğŸ“‹ ë³µì‚¬</button>
        <button class="btn btn-p btn-sm" onclick="CM.insertConverted()">ì—ë””í„°ì— ì‚½ì…</button>
      </div>
    </div>

    <!-- LIB -->
    <div class="tp" id="cp-lib">
      <div style="display:flex;gap:7px;margin-bottom:9px;align-items:center;flex-wrap:wrap">
        <span style="font-size:12px;color:var(--tx2)">ì €ì¥ <span id="lib-cnt" style="color:var(--ac);font-weight:600">0</span>ê±´</span>
        <span class="spacer"></span>
        <button class="btn btn-g btn-sm" onclick="CM.insertRefSection()">ğŸ“„ ì°¸ê³ ë¬¸í—Œ ì„¹ì…˜ ì‚½ì…</button>
        <button class="btn btn-g btn-sm" onclick="CM.downloadLib()">â¬‡ ëª©ë¡ ë‹¤ìš´ë¡œë“œ</button>
        <button class="btn btn-g btn-sm" style="color:var(--er)" onclick="CM.clearAll()">ì „ì²´ ì‚­ì œ</button>
      </div>
      <div id="lib-list"><div class="cite-empty">ì €ì¥ëœ ì°¸ê³ ë¬¸í—Œì´ ì—†ìŠµë‹ˆë‹¤.</div></div>
    </div>

    <!-- SEARCH TAB -->
    <div class="tp" id="cp-search">
      <!-- ê²€ìƒ‰ì°½ -->
      <div style="display:flex;gap:6px;margin-bottom:8px;align-items:flex-end;flex-wrap:wrap">
        <div style="flex:1;min-width:200px">
          <label class="fl">ì œëª© / ì €ì / í‚¤ì›Œë“œ</label>
          <input class="fi" id="ref-q" type="text" placeholder="ì˜ˆ) self-efficacy academic achievement Korea" onkeydown="if(event.key==='Enter')RefSearch.search()">
        </div>
        <div style="flex:0 0 auto">
          <label class="fl">ì¶œíŒì—°ë„ ì´í›„</label>
          <select class="fi" id="ref-year" style="padding:7px 8px;width:auto">
            <option value="">ì „ì²´</option>
            <option value="2020">2020~</option>
            <option value="2018">2018~</option>
            <option value="2015">2015~</option>
            <option value="2010">2010~</option>
          </select>
        </div>
        <div style="flex:0 0 auto">
          <label class="fl">ê²€ìƒ‰ DB</label>
          <select class="fi" id="ref-db" style="padding:7px 8px;width:auto">
            <option value="crossref">CrossRef (ì „ì²´)</option>
            <option value="openalex">OpenAlex (ì˜¤í”ˆì•¡ì„¸ìŠ¤)</option>
          </select>
        </div>
        <button class="btn btn-p" onclick="RefSearch.search()" style="height:36px;padding:0 16px;flex-shrink:0">ğŸ” ê²€ìƒ‰</button>
        <button class="btn btn-g btn-sm" onclick="RefSearch.openScholar()" style="height:36px;flex-shrink:0" title="Google Scholar ìƒˆ ì°½">Scholar â†—</button>
      </div>

      <!-- ìƒíƒœ/ê²°ê³¼ìˆ˜ -->
      <div id="ref-status" style="font-size:11px;color:var(--tx3);min-height:18px;margin-bottom:6px"></div>

      <!-- ê²°ê³¼ ëª©ë¡ -->
      <div id="ref-results" style="border:1px solid var(--bd);border-radius:var(--r);background:var(--bg3);min-height:80px;max-height:340px;overflow-y:auto">
        <div class="cite-empty" id="ref-placeholder">ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ê³  ğŸ” ê²€ìƒ‰ì„ ëˆ„ë¥´ì„¸ìš”.<br><span style="font-size:10px;color:var(--tx3)">CrossRef: 1ì–µ ê±´+ | OpenAlex: ì˜¤í”ˆì•¡ì„¸ìŠ¤ ë…¼ë¬¸ íŠ¹í™”</span></div>
      </div>

      <!-- í•˜ë‹¨ ì•ˆë‚´ -->
      <div style="margin-top:8px;font-size:10px;color:var(--tx3);line-height:1.7">
        âœ… <b>+ ì¶”ê°€</b> í´ë¦­ â†’ APA í˜•ì‹ìœ¼ë¡œ â‘£ ì €ì¥ëœ ëª©ë¡ì— ìë™ ì €ì¥ &nbsp;|&nbsp;
        ğŸ“‹ <b>ë³µì‚¬</b> í´ë¦­ â†’ í´ë¦½ë³´ë“œë¡œ ë³µì‚¬ &nbsp;|&nbsp;
        ê²°ê³¼ê°€ ì—†ìœ¼ë©´ <b>Scholar â†—</b>ë¡œ ì§ì ‘ ê²€ìƒ‰
      </div>
    </div>
      <button class="btn btn-g btn-sm" onclick="App.hideModal('cite-modal')">ë‹«ê¸°</button>
      <button class="btn btn-p btn-sm" id="cite-ins-btn" onclick="CM.insert()" style="display:none">âœ” ì„ íƒ í•­ëª© ì¸ìš© ì‚½ì…</button>
    </div>
  </div>
</div>

<!-- CODE MODAL (toolbar button) -->
<div class="ov" id="code-modal">
  <div class="modal" style="max-width:380px">
    <h3>ì½”ë“œ ë¸”ë¡ ì–¸ì–´ ì„ íƒ</h3>
    <div class="mb">
      <select class="fi" id="code-lang">
        <option value="">ì—†ìŒ</option><option value="python">Python</option><option value="javascript">JavaScript</option>
        <option value="typescript">TypeScript</option><option value="java">Java</option><option value="c">C</option>
        <option value="cpp">C++</option><option value="r">R</option><option value="matlab">MATLAB</option>
        <option value="sql">SQL</option><option value="bash">Bash/Shell</option><option value="latex">LaTeX</option>
        <option value="html">HTML</option><option value="css">CSS</option><option value="json">JSON</option>
        <option value="yaml">YAML</option><option value="markdown">Markdown</option>
      </select>
    </div>
    <div class="mf">
      <button class="btn btn-g btn-sm" onclick="App.hideModal('code-modal')">ì·¨ì†Œ</button>
      <button class="btn btn-p btn-sm" onclick="ED.codeBlockModal()">ì‚½ì…</button>
    </div>
  </div>
</div>

<!-- LINK MODAL -->
<div class="ov" id="link-modal">
  <div class="modal" style="max-width:420px">
    <h3>ğŸ”— ë§í¬ ì‚½ì… <span style="font-size:11px;color:var(--ac2)">(ìƒˆ íƒ­)</span></h3>
    <div class="mb">
      <div class="fg"><label class="fl">í‘œì‹œ í…ìŠ¤íŠ¸</label><input class="fi" id="link-text" type="text" placeholder="ë§í¬ í…ìŠ¤íŠ¸"></div>
      <div class="fg"><label class="fl">URL</label><input class="fi" id="link-url" type="text" placeholder="https://..."></div>
    </div>
    <div class="mf">
      <button class="btn btn-g btn-sm" onclick="App.hideModal('link-modal')">ì·¨ì†Œ</button>
      <button class="btn btn-p btn-sm" onclick="ED.link()">ì‚½ì…</button>
    </div>
  </div>
</div>

<!-- IMAGE MODAL -->
<div class="ov" id="image-modal">
  <div class="modal" style="max-width:480px">
    <h3>ğŸ–¼ ì´ë¯¸ì§€ ì‚½ì…</h3>
    <!-- Drag & Drop Zone -->
    <div id="img-dropzone" style="border:2px dashed var(--bd);border-radius:8px;padding:20px;text-align:center;margin-bottom:14px;cursor:pointer;transition:all .2s;background:var(--bg3)" onclick="document.getElementById('img-file-input').click()" ondragover="IMG.dragOver(event)" ondragleave="IMG.dragLeave(event)" ondrop="IMG.drop(event)">
      <div id="img-drop-text" style="font-size:13px;color:var(--tx2)">ğŸ–¼ ì´ë¯¸ì§€ë¥¼ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•´ì„œ ì„ íƒ</div>
      <div style="font-size:11px;color:var(--tx3);margin-top:4px">PNG, JPG, GIF, WebP ì§€ì› Â· Base64ë¡œ ìë™ ì‚½ì…</div>
      <input type="file" id="img-file-input" accept="image/*" style="display:none" onchange="IMG.fileSelected(event)">
    </div>
    <div id="img-preview-wrap" style="display:none;margin-bottom:12px;text-align:center">
      <img id="img-preview" style="max-width:100%;max-height:160px;border-radius:4px;border:1px solid var(--bd)">
    </div>
    <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px">
      <div style="flex:1;height:1px;background:var(--bd)"></div>
      <span style="font-size:11px;color:var(--tx3)">ë˜ëŠ” URL ì…ë ¥</span>
      <div style="flex:1;height:1px;background:var(--bd)"></div>
    </div>
    <div class="mb">
      <div class="fg"><label class="fl">Alt í…ìŠ¤íŠ¸</label><input class="fi" id="img-alt" type="text" placeholder="ì´ë¯¸ì§€ ì„¤ëª…"></div>
      <div class="fg"><label class="fl">URL ë˜ëŠ” ê²½ë¡œ</label><input class="fi" id="img-url" type="text" placeholder="https://..."></div>
    </div>
    <div class="mf">
      <button class="btn btn-g btn-sm" onclick="App.hideModal('image-modal')">ì·¨ì†Œ</button>
      <button class="btn btn-p btn-sm" onclick="ED.image()">ì‚½ì…</button>
    </div>
  </div>
</div>

<!-- COLOR PICKER MODAL -->
<!-- SCHOLAR SEARCH MODAL -->
<div class="ov" id="scholar-modal">
  <div class="modal" style="max-width:520px">
    <h3>ğŸ” Google Scholar ê²€ìƒ‰</h3>
    <div class="fg">
      <label class="fl">ê²€ìƒ‰ì–´ (ë…¼ë¬¸ ì œëª©, ì €ì, í‚¤ì›Œë“œ ë“±)</label>
      <div style="display:flex;gap:7px">
        <input class="fi" id="scholar-q" type="text" placeholder="ì˜ˆ) structural equation modeling education Korea" style="flex:1" onkeydown="if(event.key==='Enter')Scholar.search()">
        <button class="btn btn-p" onclick="Scholar.search()" style="white-space:nowrap">ê²€ìƒ‰ â†’</button>
      </div>
    </div>
    <div class="fg">
      <label class="fl">ê²€ìƒ‰ ì˜µì…˜</label>
      <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
        <label style="font-size:12px;color:var(--tx2)">ì–¸ì–´:</label>
        <select id="scholar-lang" class="fi" style="width:auto;padding:4px 8px">
          <option value="ko">í•œêµ­ì–´ ìš°ì„ </option>
          <option value="">ì „ì²´</option>
          <option value="en">ì˜ì–´ ìš°ì„ </option>
        </select>
        <label style="font-size:12px;color:var(--tx2)">ê¸°ê°„:</label>
        <select id="scholar-year" class="fi" style="width:auto;padding:4px 8px">
          <option value="">ì „ì²´ ê¸°ê°„</option>
          <option value="2024">2024ë…„~</option>
          <option value="2022">2022ë…„~</option>
          <option value="2020">2020ë…„~</option>
          <option value="2015">2015ë…„~</option>
          <option value="2010">2010ë…„~</option>
        </select>
        <label style="display:flex;align-items:center;gap:4px;font-size:12px;color:var(--tx2);cursor:pointer">
          <input type="checkbox" id="scholar-review" style="accent-color:var(--ac)"> ë¦¬ë·° ë…¼ë¬¸ë§Œ
        </label>
      </div>
    </div>
    <div style="font-size:11px;color:var(--tx3);margin-bottom:10px;line-height:1.6">
      ğŸ’¡ ê²€ìƒ‰ ê²°ê³¼ëŠ” <b>Google Scholar ìƒˆ ì°½</b>ì—ì„œ ì—´ë¦½ë‹ˆë‹¤.<br>
      ë…¼ë¬¸ ì œëª© í´ë¦­ â†’ ì¸ìš© ë²„íŠ¼ â†’ APA ë³µì‚¬ â†’ ğŸ“š References íƒ­ì— ë¶™ì—¬ë„£ê¸°
    </div>
    <div class="fg" id="scholar-recent-wrap" style="display:none">
      <label class="fl">ìµœê·¼ ê²€ìƒ‰ì–´</label>
      <div id="scholar-recent" style="display:flex;gap:5px;flex-wrap:wrap"></div>
    </div>
    <div class="mf">
      <button class="btn btn-g btn-sm" onclick="Scholar.clear()">ê²€ìƒ‰ì–´ ì´ˆê¸°í™”</button>
      <button class="btn btn-g btn-sm" onclick="App.hideModal('scholar-modal')">ë‹«ê¸°</button>
      <button class="btn btn-p btn-sm" onclick="Scholar.search()">ğŸ” Scholar ê²€ìƒ‰</button>
    </div>
  </div>
</div>

<div class="ov" id="color-modal">
  <div class="modal" style="max-width:400px">
    <h3 id="color-modal-title">ê¸€ì ìƒ‰ìƒ ì„¤ì •</h3>
    <div class="fg">
      <label class="fl">ë¹ ë¥¸ ì„ íƒ</label>
      <div class="csw-row" id="color-swatches"></div>
    </div>
    <div class="fg">
      <div style="display:flex;gap:6px;align-items:center">
        <div style="flex:1">
          <label class="fl">ì§ì ‘ ì…ë ¥ (Hex ë˜ëŠ” ìƒ‰ìƒëª…)</label>
          <input class="fi" id="color-hex" type="text" placeholder="#ff0000" style="font-family:var(--fm)" oninput="ColorPicker.updatePreview(this.value)">
        </div>
        <!-- ë„¤ì´í‹°ë¸Œ color input (hidden) -->
        <div style="display:flex;flex-direction:column;align-items:center;gap:3px;flex-shrink:0;margin-top:14px">
          <label id="eyedrop-btn" class="btn btn-g btn-sm" style="cursor:pointer;padding:5px 8px;display:flex;flex-direction:column;align-items:center;gap:2px" title="ìŠ¤í¬ì´ë“œ / ìƒ‰ìƒ íŒ”ë ˆíŠ¸">
            <span style="font-size:16px">ğŸ¨</span>
            <span style="font-size:9px">íŒ”ë ˆíŠ¸</span>
            <input type="color" id="color-native" style="position:absolute;opacity:0;width:0;height:0;pointer-events:none" oninput="ColorPicker.fromNative(this.value)" onchange="ColorPicker.fromNative(this.value)">
          </label>
          <button id="eyedropper-btn" class="btn btn-g btn-sm" style="padding:5px 8px;display:flex;flex-direction:column;align-items:center;gap:2px" onclick="ColorPicker.eyedrop()" title="í™”ë©´ì—ì„œ ìƒ‰ìƒ ì¶”ì¶œ (ìŠ¤í¬ì´ë“œ)">
            <span style="font-size:16px">ğŸ’‰</span>
            <span style="font-size:9px">ìŠ¤í¬ì´ë“œ</span>
          </button>
        </div>
      </div>
    </div>
    <div style="display:flex;align-items:center;gap:10px;margin-bottom:12px">
      <label class="fl" style="margin:0;flex-shrink:0">ë¯¸ë¦¬ë³´ê¸°:</label>
      <div id="color-preview" style="flex:1;padding:5px 12px;border-radius:4px;font-size:13px;border:1px solid var(--bd);transition:all .15s">ìƒ˜í”Œ í…ìŠ¤íŠ¸ / Sample Text</div>
    </div>
    <div id="eyedrop-support-msg" style="font-size:10px;color:var(--tx3);margin-bottom:8px;display:none">âš  ìŠ¤í¬ì´ë“œëŠ” Chrome/Edgeì—ì„œë§Œ ì§€ì›ë©ë‹ˆë‹¤.</div>
    <div class="mf">
      <button class="btn btn-g btn-sm" onclick="App.hideModal('color-modal')">ì·¨ì†Œ</button>
      <button class="btn btn-p btn-sm" onclick="App.applyColor()">ì ìš©</button>
    </div>
  </div>
</div>

<!-- CAPTION MODAL -->
<div class="ov" id="caption-modal">
  <div class="modal" style="max-width:520px">
    <h3 id="cap-title">í‘œ ìº¡ì…˜ ì‚½ì…</h3>
    <div class="fg">
      <label class="fl">í˜•ì‹ ì„ íƒ (í´ë¦­ìœ¼ë¡œ ì„ íƒ)</label>
      <div id="cap-opts" style="display:flex;gap:6px;flex-wrap:wrap;margin-top:4px"></div>
    </div>
    <div style="display:flex;gap:10px;margin-bottom:10px">
      <div class="fg" style="flex:0 0 80px">
        <label class="fl">ë²ˆí˜¸</label>
        <input class="fi" id="cap-num" type="text" placeholder="1" oninput="App.updateCapPreview()">
      </div>
      <div class="fg" style="flex:1">
        <label class="fl">ì„¤ëª… / ì œëª©</label>
        <input class="fi" id="cap-desc" type="text" placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”" oninput="App.updateCapPreview()">
      </div>
    </div>
    <div class="fg">
      <label class="fl">ë¯¸ë¦¬ë³´ê¸°</label>
      <div id="cap-preview" style="background:var(--bg3);border:1px solid var(--bd);border-radius:var(--r);padding:8px 12px;font-family:var(--fm);font-size:12px;color:var(--tx);min-height:28px"></div>
    </div>
    <div class="mf">
      <button class="btn btn-g btn-sm" onclick="App.hideModal('caption-modal')">ì·¨ì†Œ</button>
      <button class="btn btn-p btn-sm" onclick="App.insertCaption()">ì‚½ì…</button>
    </div>
  </div>
</div>

<!-- TEMPLATE MODAL -->
<div class="ov" id="tmpl-modal">
  <div class="modal lg">
    <h3>ğŸ“‹ ë…¼ë¬¸ ì–‘ì‹ ì„ íƒ</h3>
    <p style="font-size:12px;color:var(--tx2);margin-bottom:14px">ì„ íƒí•˜ë©´ ì—ë””í„°ì— êµ¬ì¡°ê°€ ìë™ ì‚½ì…ë©ë‹ˆë‹¤. ê¸°ì¡´ ë‚´ìš©ì€ ìœ ì§€ë©ë‹ˆë‹¤.</p>
    <div class="tmpl-grid" id="tmpl-grid"></div>
    <div class="mf"><button class="btn btn-g btn-sm" onclick="App.hideModal('tmpl-modal')">ë‹«ê¸°</button></div>
  </div>
</div>

<!-- FORMAT QUICK PANEL (Alt+L) -->
<div id="fmt-panel">
  <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px">
    <h4 style="font-size:13px;font-weight:600;color:var(--txh);margin:0">âœï¸ ì„œì‹ ì„¤ì • <span style="font-size:10px;color:var(--tx3);font-weight:400">Alt+L</span></h4>
    <button class="btn-ic" onclick="FP.hide()" style="font-size:14px">âœ•</button>
  </div>
  <!-- font size -->
  <div class="fmt-row">
    <span class="fmt-lbl">ê¸€ì í¬ê¸°</span>
    <button class="btn btn-g btn-sm" style="padding:2px 8px;font-size:13px;font-weight:700" onclick="FP.fsz(-1)">âˆ’</button>
    <select id="fp-fsize" class="fi" style="flex:1;padding:3px 6px;font-size:12px" onchange="FP.applyFsize()">
      <option>8pt</option><option>9pt</option><option>10pt</option><option>11pt</option>
      <option selected>12pt</option><option>13pt</option><option>14pt</option><option>15pt</option>
      <option>16pt</option><option>18pt</option><option>20pt</option><option>22pt</option>
      <option>24pt</option><option>28pt</option><option>32pt</option><option>36pt</option><option>40pt</option><option>48pt</option><option>50pt</option>
    </select>
    <button class="btn btn-g btn-sm" style="padding:2px 8px;font-size:13px;font-weight:700" onclick="FP.fsz(1)">+</button>
  </div>
  <!-- font color -->
  <div class="fmt-row">
    <span class="fmt-lbl">ê¸€ì ìƒ‰</span>
    <div style="display:flex;gap:4px;flex-wrap:wrap;flex:1">
      <input type="color" id="fp-fc" value="#e8e8f0" style="width:30px;height:26px;border:none;border-radius:4px;cursor:pointer;background:none;padding:0" onchange="FP.applyColor()">
      <div style="display:flex;gap:3px;flex-wrap:wrap">
        <div class="csw" style="background:#e8e8f0" onclick="FP.setFc('#e8e8f0')" title="í°ìƒ‰ê³„"></div>
        <div class="csw" style="background:#ff4444" onclick="FP.setFc('#ff4444')" title="ë¹¨ê°•"></div>
        <div class="csw" style="background:#ff8800" onclick="FP.setFc('#ff8800')" title="ì£¼í™©"></div>
        <div class="csw" style="background:#ffcc00" onclick="FP.setFc('#ffcc00')" title="ë…¸ë‘"></div>
        <div class="csw" style="background:#44cc44" onclick="FP.setFc('#44cc44')" title="ì´ˆë¡"></div>
        <div class="csw" style="background:#00aaff" onclick="FP.setFc('#00aaff')" title="íŒŒë‘"></div>
        <div class="csw" style="background:#aa44ff" onclick="FP.setFc('#aa44ff')" title="ë³´ë¼"></div>
        <div class="csw" style="background:#ff44aa" onclick="FP.setFc('#ff44aa')" title="í•‘í¬"></div>
        <div class="csw" style="background:#333333" onclick="FP.setFc('#333333')" title="ê²€ì •"></div>
        <div class="csw" style="background:#5b4ce4" onclick="FP.setFc('#5b4ce4')" title="ì¸ë””ê³ "></div>
      </div>
    </div>
  </div>
  <!-- highlight -->
  <div class="fmt-row">
    <span class="fmt-lbl">í˜•ê´‘íœ</span>
    <div style="display:flex;gap:4px;flex-wrap:wrap;flex:1">
      <input type="color" id="fp-hl" value="#fff176" style="width:30px;height:26px;border:none;border-radius:4px;cursor:pointer;background:none;padding:0" onchange="FP.applyHL()">
      <div style="display:flex;gap:3px;flex-wrap:wrap">
        <div class="csw" style="background:#fff176" onclick="FP.setHL('#fff176')" title="ë…¸ë‘"></div>
        <div class="csw" style="background:#ffcc80" onclick="FP.setHL('#ffcc80')" title="ì˜¤ë Œì§€"></div>
        <div class="csw" style="background:#ef9a9a" onclick="FP.setHL('#ef9a9a')" title="ë¹¨ê°•"></div>
        <div class="csw" style="background:#80cbc4" onclick="FP.setHL('#80cbc4')" title="ë¯¼íŠ¸"></div>
        <div class="csw" style="background:#a5d6a7" onclick="FP.setHL('#a5d6a7')" title="ì´ˆë¡"></div>
        <div class="csw" style="background:#90caf9" onclick="FP.setHL('#90caf9')" title="íŒŒë‘"></div>
        <div class="csw" style="background:#ce93d8" onclick="FP.setHL('#ce93d8')" title="ë³´ë¼"></div>
        <div class="csw" style="background:#f48fb1" onclick="FP.setHL('#f48fb1')" title="í•‘í¬"></div>
        <div class="csw" style="background:#ffecb3" onclick="FP.setHL('#ffecb3')" title="ì—°ë…¸ë‘"></div>
        <div class="csw" style="background:repeating-linear-gradient(45deg,#888,#888 2px,transparent 2px,transparent 6px);border:1px solid #888" onclick="FP.setHL('none')" title="ì—†ìŒ"></div>
      </div>
    </div>
  </div>
  <div style="text-align:right;margin-top:4px">
    <button class="btn btn-g btn-sm" onclick="FP.hide()">ë‹«ê¸°</button>
  </div>
</div>

<div id="tooltip"></div>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   UNDO STACK
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const US=(()=>{
  const MAX=500;let st=[],ptr=-1;
  const snap=()=>{const e=el('editor');push(e.value,[e.selectionStart,e.selectionEnd])};
  function push(v,s){st=st.slice(0,ptr+1);st.push({v,s});if(st.length>MAX)st.shift();else ptr++}
  function undo(){if(ptr<=0)return;ptr--;const s=st[ptr];el('editor').value=s.v;el('editor').setSelectionRange(s.s[0],s.s[1]);App.render()}
  function redo(){if(ptr>=st.length-1)return;ptr++;const s=st[ptr];el('editor').value=s.v;el('editor').setSelectionRange(s.s[0],s.s[1]);App.render()}
  return{snap,undo,redo};
})();

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HELPERS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function el(id){return document.getElementById(id)}
function ins(ed,s,e,text){ed.value=ed.value.substring(0,s)+text+ed.value.substring(e);const p=s+text.length;ed.setSelectionRange(p,p);ed.focus();App.render();US.snap()}
function getCL(ed){const pos=ed.selectionStart,bef=ed.value.substring(0,pos);const ls=bef.lastIndexOf('\n')+1,aft=ed.value.substring(pos);const le=pos+(aft.indexOf('\n')===-1?aft.length:aft.indexOf('\n'));return{ls,le,text:ed.value.substring(ls,le)}}
function repCL(ed,t){const{ls,le}=getCL(ed);ed.value=ed.value.substring(0,ls)+t+ed.value.substring(le);const p=ls+t.length;ed.setSelectionRange(p,p);ed.focus();App.render();US.snap()}
function dlBlob(content,filename,type){const a=document.createElement('a');a.href=URL.createObjectURL(new Blob([content],{type}));a.download=filename;a.click()}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MARKED SETUP â€” links new tab
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
marked.setOptions({breaks:true,gfm:true});
const _r=new marked.Renderer();
_r.heading=(text,level)=>{const id='h-'+text.toLowerCase().replace(/[^a-z0-9ê°€-í£\s]/g,'').replace(/\s+/g,'-').substring(0,50);return`<h${level} id="${id}">${text}</h${level}>`;};
_r.link=(href,title,text)=>`<a href="${href}"${title?` title="${title}"`:''} target="_blank" rel="noopener noreferrer">${text}</a>`;
marked.use({renderer:_r});
function mdRender(md,showFootnotes){
  try{
    // Process footnotes: highlight [^n] references and collect definitions
    let fnDefs={};let fnCounter=0;
    // Collect footnote definitions [^n]: text
    md=md.replace(/^\[\^([^\]]+)\]:\s*(.+)$/gm,(m,key,text)=>{fnDefs[key]=text;return'__FN_DEF_'+key+'__'});
    // Replace inline [^n] with highlighted spans
    md=md.replace(/\[\^([^\]]+)\]/g,(m,key)=>{
      fnCounter++;
      return`<sup class="footnote-highlight" title="${fnDefs[key]||''}">[${fnCounter}]</sup>`;
    });
    // Remove def placeholders (they'll be added to footnotes section)
    md=md.replace(/__FN_DEF_[^_]+__\n?/g,'');
    let html=marked.parse(md||'');
    // Append footnotes section if there are definitions and showFootnotes is not false
    if(Object.keys(fnDefs).length>0 && showFootnotes!==false){
      let fnHtml='<div class="footnotes-section">';
      let i=1;
      Object.entries(fnDefs).forEach(([k,v])=>{fnHtml+=`<div class="footnote-def"><sup>[${i}]</sup> ${v}</div>`;i++});
      fnHtml+='</div>';
      html+=fnHtml;
    }
    return html;
  }catch(e){return`<p style="color:red">${e.message}</p>`;}
}
/* PAGE SPLIT */
function splitPages(md){const p=md.replace(/\r\n/g,'\n').split(/\n?<div class="page-break"><\/div>\n?/);return p.length?p:[md]}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PREVIEW RENDERER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const PR={
  rm:false,
  render(md,showFootnotes){
    if(showFootnotes===undefined)showFootnotes=true;
    const c=el('preview-container');const pages=splitPages(md);c.innerHTML='';
    pages.forEach((p,i)=>{
      const div=document.createElement('div');
      div.className='preview-page'+(this.rm?' rm':'');div.dataset.page=i+1;
      div.innerHTML=mdRender(p,showFootnotes);
      div.querySelectorAll('a').forEach(a=>{a.target='_blank';a.rel='noopener noreferrer'});
      c.appendChild(div);
    });
    if(window.MathJax)MathJax.typesetPromise([c]).catch(()=>{});
    el('pg-cnt').textContent=`${pages.length} í˜ì´ì§€`;
  }
};

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PREVIEW WINDOW (popup) + scroll sync
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const PW=(()=>{
  let win=null,st=null,rm=false;
  const CSS=`@import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500&family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&display=swap');
*{box-sizing:border-box;margin:0;padding:0}body{font-family:sans-serif;background:#6a6e7e;display:flex;flex-direction:column;align-items:center;padding:16px 0 36px;min-height:100vh}
.preview-page{width:210mm;min-height:297mm;background:white;color:#1a1a2e;padding:22mm 18mm;box-shadow:0 6px 40px rgba(0,0,0,.5);font-family:'Libre Baskerville',serif;font-size:11pt;line-height:1.8;word-break:break-word;position:relative;margin-bottom:16px}
.preview-page::after{content:"â€” " attr(data-page) " â€”";position:absolute;bottom:10mm;left:50%;transform:translateX(-50%);font-family:sans-serif;font-size:9pt;color:#bbb}
.preview-page h1{font-size:21pt;font-weight:700;margin:0 0 14px;border-bottom:2px solid #1a1a2e;padding-bottom:8px}
.preview-page h2{font-size:15pt;font-weight:700;margin:20px 0 10px}.preview-page h3{font-size:12pt;font-weight:700;margin:16px 0 7px}
.preview-page p{margin:0 0 11px}.preview-page ul,.preview-page ol{margin:0 0 11px;padding-left:22px}.preview-page li{margin-bottom:3px}
.preview-page blockquote{border-left:3px solid #5b4ce4;margin:14px 0;padding:7px 14px;background:#f5f5ff;font-style:italic}
.preview-page code{font-family:'JetBrains Mono',monospace;font-size:9pt;background:#f0f0f8;padding:1px 4px;border-radius:3px;color:#5b4ce4}
.preview-page pre{background:#1a1a2e;color:#e8e8f0;padding:14px;border-radius:6px;overflow-x:auto;margin:11px 0;font-size:9pt}
.preview-page pre code{background:none;color:inherit;padding:0}
.preview-page table{width:100%;border-collapse:collapse;margin:11px 0;font-size:10pt}
.preview-page th{background:#1a1a2e;color:#fff;padding:7px 11px;text-align:left}
.preview-page td{padding:6px 11px;border:1px solid #d0d0e0}
.preview-page tr:nth-child(even) td{background:#f7f7fc}
.preview-page img{max-width:100%}
.preview-page a{color:#5b4ce4;text-decoration:underline}
.preview-page a[href^="http"]::after{content:" â†—";font-size:8pt;opacity:.5}
.preview-page .ref-block{border-top:1px solid #d0d0e0;margin-top:28px;padding-top:10px;font-size:9pt;color:#4a4a6a}
.preview-page.rm{counter-reset:pln}
.preview-page.rm>p{counter-increment:pln;padding-left:36px;position:relative}
.preview-page.rm>p::before{content:counter(pln);position:absolute;left:0;top:0;font-family:'JetBrains Mono',monospace;font-size:8.5pt;color:#b0b0c8;min-width:28px;text-align:right;border-right:1px solid #ddd;padding-right:6px}
@media print{body{background:none;padding:0}.preview-page{box-shadow:none;margin:0;page-break-after:always;width:100%;min-height:0}.preview-page:last-child{page-break-after:auto}.preview-page::after{display:none}}`;

  function buildHTML(md,title){
    const pages=splitPages(md);
    const html=pages.map((p,i)=>`<div class="preview-page${rm?' rm':''}" data-page="${i+1}">${mdRender(p)}</div>`).join('');
    return`<!DOCTYPE html><html lang="ko"><head><meta charset="UTF-8"><title>${title||'Preview'}</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.min.js"><\/script>
<style>${CSS}<\/style></head><body>${html}
<script>
document.querySelectorAll('a').forEach(a=>{a.target='_blank';a.rel='noopener noreferrer'});
window.addEventListener('message',e=>{if(e.data&&e.data.type==='ss')window.scrollTo(0,e.data.ratio*(document.body.scrollHeight-window.innerHeight))});
let _st;window.addEventListener('scroll',()=>{clearTimeout(_st);_st=setTimeout(()=>{const r=window.scrollY/Math.max(1,document.body.scrollHeight-window.innerHeight);try{window.opener.postMessage({type:'pvS',ratio:r},'*')}catch(e){}},10)},{passive:true});
<\/script></body></html>`;
  }

  // ì´ìŠˆ1 ìˆ˜ì •: ë©”ì‹œì§€ ë¦¬ìŠ¤ë„ˆë¥¼ open() ë°–ì—ì„œ 1íšŒë§Œ ë“±ë¡
  let _msgListenerRegistered=false;
  function _initMsgListener(){
    if(_msgListenerRegistered)return;
    _msgListenerRegistered=true;
    window.addEventListener('message',e=>{
      if(e.data&&e.data.type==='pvS'){
        const r=e.data.ratio;
        const ed2=el('editor');
        ed2.scrollTop=r*(ed2.scrollHeight-ed2.clientHeight);
        const pc=el('preview-container');
        pc.scrollTop=r*(pc.scrollHeight-pc.clientHeight);
      }
    });
  }

  function open(){
    const title=el('doc-title').value;
    if(win&&!win.closed){win.focus();sync();return}
    const w=920,h=Math.floor(window.screen.height*.88);
    const left=window.screenX+window.outerWidth+10,top=window.screenY;
    try{
      win=window.open('','md_pv_v7',`width=${w},height=${h},left=${left},top=${top},resizable=yes,scrollbars=yes`);
      if(!win)throw 0;
      win.document.open();win.document.write(buildHTML(el('editor').value,title));win.document.close();
      el('pw-btn').classList.add('open');
      win.addEventListener('beforeunload',()=>el('pw-btn').classList.remove('open'));
      _initMsgListener(); // ìµœì´ˆ 1íšŒë§Œ ì‹¤ì œ ë“±ë¡ë¨
    }catch(e){alert('íŒì—…ì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤.');}
  }

  function pushScroll(r){if(!win||win.closed)return;try{win.postMessage({type:'ss',ratio:r},'*')}catch(e){}}

  function sync(){
    clearTimeout(st);st=setTimeout(()=>{
      if(!win||win.closed){el('pw-btn').classList.remove('open');return}
      const title=el('doc-title').value;
      try{const sy=win.scrollY,sh=win.document.body.scrollHeight,ih=win.innerHeight,r=sy/Math.max(1,sh-ih);
        win.document.open();win.document.write(buildHTML(el('editor').value,title));win.document.close();
        setTimeout(()=>{if(!win||win.closed)return;win.scrollTo(0,r*(win.document.body.scrollHeight-win.innerHeight))},150);
      }catch(e){}
    },200);
  }

  function forceRefresh(){if(win&&!win.closed){const t=el('doc-title').value;try{win.document.open();win.document.write(buildHTML(el('editor').value,t));win.document.close()}catch(e){}}else open()}
  function checkClosed(){if(win&&win.closed)el('pw-btn').classList.remove('open')}
  function setRM(v){rm=v}
  return{open,sync,forceRefresh,checkClosed,pushScroll,setRM};
})();

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SCROLL SYNC (editor â†” inline preview â†” popup)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const SS=(()=>{
  let el2=false,pl=false,t=null;
  function init(){
    const ed=el('editor'),pc=el('preview-container');
    ed.addEventListener('scroll',()=>{if(pl)return;clearTimeout(t);t=setTimeout(()=>{const r=ed.scrollTop/Math.max(1,ed.scrollHeight-ed.clientHeight);pl=true;pc.scrollTop=r*(pc.scrollHeight-pc.clientHeight);PW.pushScroll(r);setTimeout(()=>pl=false,60)},5)},{passive:true});
    pc.addEventListener('scroll',()=>{if(el2)return;clearTimeout(t);t=setTimeout(()=>{const r=pc.scrollTop/Math.max(1,pc.scrollHeight-pc.clientHeight);el2=true;const ed2=el('editor');ed2.scrollTop=r*(ed2.scrollHeight-ed2.clientHeight);PW.pushScroll(r);setTimeout(()=>el2=false,60)},5)},{passive:true});
  }
  return{init};
})();

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TOC
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const TOC=(()=>{
  let obs=null;
  function build(md){
    const list=el('toc-list');const hs=[];const cnt=[0,0,0];
    md.split('\n').forEach(line=>{const m=line.match(/^(#{1,3})\s+(.+)/);if(!m)return;const lv=m[1].length,text=m[2].replace(/[*_`]/g,'');const id='h-'+text.toLowerCase().replace(/[^a-z0-9ê°€-í£\s]/g,'').replace(/\s+/g,'-').substring(0,50);cnt[lv-1]++;for(let i=lv;i<3;i++)cnt[i]=0;const num=lv===1?cnt[0]:lv===2?`${cnt[0]}.${cnt[1]}`:`${cnt[0]}.${cnt[1]}.${cnt[2]}`;hs.push({lv,text,id,num})});
    if(!hs.length){list.innerHTML='<div style="padding:12px;color:var(--tx3);font-size:12px">í—¤ë”©(#)ì„ ì¶”ê°€í•˜ë©´ ìë™ ìƒì„±ë©ë‹ˆë‹¤.</div>';return}
    list.innerHTML=hs.map(h=>`<div class="toc-item" data-level="${h.lv}" onclick="TOC.go('${h.id}')"><span class="toc-num">${h.num}</span><span style="flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${h.text}</span></div>`).join('');
    attachObs();
  }
  function go(id){const e=document.querySelector(`#preview-container #${id}`);if(e){e.scrollIntoView({behavior:'smooth',block:'start'});document.querySelectorAll('.toc-item').forEach(i=>i.classList.remove('active'));document.querySelectorAll(`.toc-item[data-id="${id}"]`).forEach(i=>i.classList.add('active'))}}
  function attachObs(){if(obs)obs.disconnect();const pc=el('preview-container');obs=new IntersectionObserver(es=>{es.forEach(e=>{if(e.isIntersecting){const id=e.target.id;document.querySelectorAll('.toc-item').forEach(i=>i.classList.remove('active'));document.querySelectorAll(`.toc-item[data-id="${id}"]`).forEach(i=>i.classList.add('active'))}})},{root:pc,threshold:.15});pc.querySelectorAll('h1,h2,h3').forEach(h=>obs.observe(h))}
  return{build,go};
})();

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LINE NUMBERS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const LN=(()=>{
  let v=false;
  function update(){if(!v)return;const ed=el('editor'),c=el('lnc');c.innerHTML=ed.value.split('\n').map((_,i)=>`<div class="ln">${i+1}</div>`).join('');el('line-numbers').scrollTop=ed.scrollTop}
  function toggle(){v=!v;el('line-numbers').classList.toggle('vis',v);el('editor').classList.toggle('wln',v);el('ln-btn').classList.toggle('active',v);update()}
  return{update,toggle};
})();

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   AUTO SAVE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const AS=(()=>{
  let t;const K='mdpro_v7';
  function load(){try{const d=JSON.parse(localStorage.getItem(K)||'{}');if(d.c)el('editor').value=d.c;if(d.t)el('doc-title').value=d.t}catch(e){}}
  function save(c,t2){
    clearTimeout(t);
    el('save-dot').classList.add('saving');
    el('save-st').textContent='ì €ì¥ ì¤‘...';
    t=setTimeout(()=>{
      try{
        localStorage.setItem(K,JSON.stringify({c,t:t2,ts:Date.now()}));
        el('save-dot').classList.remove('saving');
        el('save-dot').style.background='';
        el('save-st').textContent='ì €ì¥ë¨';
      }catch(e){
        // ì´ìŠˆ2 ìˆ˜ì •: QuotaExceededError ë“± ì €ì¥ ì‹¤íŒ¨ ì‹œ ì‚¬ìš©ìì—ê²Œ ëª…ì‹œì ìœ¼ë¡œ ì•Œë¦¼
        el('save-dot').classList.remove('saving');
        el('save-dot').style.background='#f76a6a';
        el('save-st').textContent='âš  ìë™ì €ì¥ ì‹¤íŒ¨ (ìš©ëŸ‰ ì´ˆê³¼) â€” ğŸ’¾ ì €ì¥ ë²„íŠ¼ìœ¼ë¡œ íŒŒì¼ ì €ì¥ ê¶Œì¥';
        console.warn('localStorage ì €ì¥ ì‹¤íŒ¨:',e);
      }
    },1000);
  }
  return{load,save};
})();

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CITATION MANAGER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const CM=(()=>{
  const KEY='mdpro_refs';let refs=[];let sep='blank';// blank|line

  function load(){try{refs=JSON.parse(localStorage.getItem(KEY)||'[]')}catch(e){refs=[]}}
  function save(){try{localStorage.setItem(KEY,JSON.stringify(refs))}catch(e){}}

  function setSep(s){
    sep=s;
    el('sep-blank-btn').classList.toggle('active',s==='blank');
    el('sep-line-btn').classList.toggle('active',s==='line');
    const descs={blank:'í˜„ì¬: ë¹ˆ ì¤„ë¡œ êµ¬ë¶„ â€” í•­ëª© ì‚¬ì´ì— ë¹ˆ ì¤„ í•˜ë‚˜ë¥¼ ë„£ì–´ êµ¬ë¶„í•˜ì„¸ìš”.',line:'í˜„ì¬: ì—”í„°(ì¤„ë°”ê¿ˆ)ë¡œ êµ¬ë¶„ â€” ê° ì¤„ì´ í•˜ë‚˜ì˜ ì°¸ê³ ë¬¸í—Œìœ¼ë¡œ ì²˜ë¦¬ë©ë‹ˆë‹¤.'};
    el('sep-desc').textContent=descs[s];
  }

  /* APA parser */
  function parseAPA(line){
    line=line.trim();if(!line||line.length<10)return null;
    const ym=line.match(/\((\d{4}[a-z]?)\)/);const year=ym?ym[1]:'?';
    let ap=ym?line.substring(0,line.indexOf(ym[0])).trim().replace(/,\s*$/,''):line.split('.')[0];
    const names=ap.split(/,\s*&\s*|;\s*|,\s*(?=[A-Zê°€-í£])/).map(s=>s.trim().split(',')[0].trim()).filter(Boolean);
    let key=names.length===1?`${names[0]}, ${year}`:names.length===2?`${names[0]} & ${names[1]}, ${year}`:`${names[0]} et al., ${year}`;
    return{key,year,author:names[0]||'Unknown',full:line,id:Date.now()+Math.random(),mla:'',chicago:''};
  }

  function parse(){
    const raw=el('cite-raw').value;if(!raw.trim())return;
    let lines;
    if(sep==='blank'){
      // Split by one or more blank lines
      lines=raw.split(/\n[ \t]*\n+/).map(block=>
        block.split('\n').map(l=>l.trim()).filter(Boolean).join(' ')
      ).map(l=>l.replace(/^\d+[\.\)]\s*/,'')).filter(l=>l.length>10);
    }else{
      // Each non-empty line is one reference
      lines=raw.split('\n').map(l=>l.replace(/^\d+[\.\)]\s*/,'').trim()).filter(l=>l.length>10);
    }
    let added=0;
    lines.forEach(l=>{const p=parseAPA(l);if(p&&!refs.find(r=>r.full===p.full)){p.mla=toMLA(p);p.chicago=toChicago(p);refs.push(p);added++}});
    save();
    el('cite-msg').textContent=added?`âœ“ ${added}ê±´ ì¶”ê°€ë¨ (ì´ ${refs.length}ê±´)`:lines.length?'ì´ë¯¸ ì¡´ì¬í•˜ê±°ë‚˜ íŒŒì‹± ì‹¤íŒ¨':'ë¹ˆ ì¤„ì´ ì—†ìŠµë‹ˆë‹¤ â€” êµ¬ë¶„ ë°©ì‹ì„ í™•ì¸í•˜ì„¸ìš”';
    setTimeout(()=>el('cite-msg').textContent='',4000);
    renderLib();renderList('');
  }

  function loadFile(ev){
    const file=ev.target.files[0];if(!file)return;
    const reader=new FileReader();
    reader.onload=e=>{el('cite-raw').value=e.target.result;};
    reader.readAsText(file,'utf-8');
    ev.target.value='';
  }

  /* Style converters (heuristic) */
  function toMLA(ref){
    // APA: Author, A. A., & Author, B. B. (Year). Title. Journal, Vol(No), pp. DOI
    const m=ref.full.match(/^(.+?)\.\s*\((\d{4}[a-z]?)\)\.\s*(.+?)\.\s*([^,]+),\s*(\d+)\((\d+)\),\s*([\dâ€“\-]+)/);
    if(m){const[,authors,year,title,journal,vol,no,pp]=m;return`${expandAuthors(authors)} "${capTitle(title.trim())}" ${journal}, vol. ${vol}, no. ${no}, ${year}, pp. ${pp}.`}
    // fallback â€” use ref.year (not local year which is out of scope here)
    const fy=ref.year||'?';
    const titlePart=ref.full.replace(/\(.*?\)\./,'').replace(/^[^.]+\.\s*/,'').trim();
    return`${ref.author}. "${titlePart}" ${fy}.`;
  }

  function toChicago(ref){
    const m=ref.full.match(/^(.+?)\.\s*\((\d{4}[a-z]?)\)\.\s*(.+?)\.\s*([^,]+),\s*(\d+)\((\d+)\),\s*([\dâ€“\-]+)/);
    if(m){const[,authors,year,title,journal,vol,no,pp]=m;return`${expandAuthors(authors)} ${year}. "${capTitle(title.trim())}" ${journal} ${vol} (${no}): ${pp}.`}
    return`${ref.author}. ${ref.year}. "${ref.full}."`;
  }

  function toVancouver(ref){
    const m=ref.full.match(/^(.+?)\.\s*\((\d{4}[a-z]?)\)\.\s*(.+?)\.\s*([^,]+),\s*(\d+)\((\d+)\),\s*([\dâ€“\-]+)/);
    if(m){const[,authors,year,title,journal,vol,no,pp]=m;const au=authors.split(/,\s*&\s*|;\s*/).map(s=>s.trim()).join(', ');return`${au}. ${title.trim()}. ${journal}. ${year};${vol}(${no}):${pp}.`}
    return ref.full;
  }

  function expandAuthors(s){return s.replace(/\s*&\s*/g,', and ').replace(/,\s*et\s+al\./,'et al.')}
  function capTitle(t){return t.replace(/\b(\w)/g,(m,c,i)=>i===0||'.:!?'.includes(t[i-1])?c.toUpperCase():m)}

  function convertByStyle(ref,style){
    if(style==='mla')return ref.mla||toMLA(ref);
    if(style==='chicago')return ref.chicago||toChicago(ref);
    if(style==='vancouver')return toVancouver(ref);
    return ref.full;// APA
  }

  function convertStyle(){
    const from=el('from-style').value,to=el('to-style').value;
    const raw=el('conv-input').value.trim();
    if(!raw){el('conv-output').value='ì…ë ¥ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.';return}
    const p=parseAPA(raw);if(!p){el('conv-output').value='íŒŒì‹± ì‹¤íŒ¨ â€” APA í˜•ì‹ì„ í™•ì¸í•˜ì„¸ìš”.';return}
    p.mla=toMLA(p);p.chicago=toChicago(p);
    el('conv-output').value=convertByStyle(p,to);
    const labels={apa:'APA 7',mla:'MLA 9',chicago:'Chicago (Author-Date)',vancouver:'Vancouver'};
    el('conv-label').textContent=`â†’ ${labels[to]}`;
  }
  function copyConverted(){const v=el('conv-output').value;if(v)navigator.clipboard.writeText(v).then(()=>{}).catch(()=>{})}
  function insertConverted(){const v=el('conv-output').value;if(!v)return;const ed=el('editor'),pos=ed.selectionEnd;ins(ed,pos,pos,'\n'+v+'\n');App.hideModal('cite-modal')}

  /* List rendering */
  function renderList(q){
    const area=el('cite-list-area');
    const flt=refs.filter(r=>!q||r.full.toLowerCase().includes(q.toLowerCase())||r.key.toLowerCase().includes(q.toLowerCase()));
    if(!flt.length){area.innerHTML='<div class="cite-empty">í•´ë‹¹ ë¬¸í—Œ ì—†ìŒ. ì¶”ê°€ íƒ­ì—ì„œ ë¨¼ì € ì…ë ¥í•˜ì„¸ìš”.</div>';return}
    area.innerHTML=flt.map(r=>`<div class="cite-entry" onclick="CM.toggle('cb_${r.id}')"><input type="checkbox" id="cb_${r.id}" data-id="${r.id}" onchange="CM.upd()" onclick="event.stopPropagation()"><div class="cite-body"><div class="cite-key">${r.key}</div><div class="cite-full" title="${r.full}">${r.full}</div></div></div>`).join('');
    upd();
  }

  function filter(){renderList(el('cite-search').value)}
  function toggle(id){const cb=el(id);if(cb){cb.checked=!cb.checked;upd()}}
  function getSel(){return Array.from(document.querySelectorAll('#cite-list-area input:checked')).map(cb=>refs.find(r=>String(r.id)===cb.dataset.id)).filter(Boolean)}
  function upd(){const n=getSel().length;el('cite-sc').textContent=`${n}ê°œ ì„ íƒë¨`;el('cite-ins-btn').style.display=n>0?'':'none'}
  function selAll(){document.querySelectorAll('#cite-list-area input[type=checkbox]').forEach(cb=>cb.checked=true);upd()}
  function clrSel(){document.querySelectorAll('#cite-list-area input[type=checkbox]').forEach(cb=>cb.checked=false);upd()}

  function insert(){
    const sel=getSel();if(!sel.length)return;
    const style=el('cite-style').value;const ed=el('editor');const pos=ed.selectionStart;let text='';
    if(style==='inline')text='('+sel.map(r=>r.key).join('; ')+')';
    else if(style==='narrative')text=sel.map(r=>`${r.author}(${r.year})`).join('; ');
    else if(style==='multi')text='('+sel.map(r=>r.key).join('; ')+')';
    else if(style==='footnote'){let it='',dt='\n';sel.forEach((r,i)=>{const n=Math.floor((ed.value.match(/\[\^\d+\]/g)||[]).length/2)+i+1;it+=`[^${n}]`;dt+=`[^${n}]: ${r.full}\n`});ed.value=ed.value.substring(0,pos)+it+ed.value.substring(pos)+dt;App.render();US.snap();App.hideModal('cite-modal');return}
    ed.value=ed.value.substring(0,pos)+text+ed.value.substring(pos);ed.setSelectionRange(pos+text.length,pos+text.length);App.render();US.snap();App.hideModal('cite-modal');
  }

  function renderLib(){
    el('lib-cnt').textContent=refs.length;
    if(!refs.length){el('lib-list').innerHTML='<div class="cite-empty">ì €ì¥ëœ ì°¸ê³ ë¬¸í—Œì´ ì—†ìŠµë‹ˆë‹¤.</div>';return}
    el('lib-list').innerHTML=refs.map((r,i)=>`<div class="lib-item"><span class="lib-key">${r.key}</span><span style="flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;font-size:11px" title="${r.full}">${r.full}</span><span style="font-size:10px;color:var(--tx3);flex-shrink:0;margin:0 4px">${r.mla?'MLAâœ“':''}</span><button class="btn-ic" style="color:var(--er);font-size:12px;flex-shrink:0" onclick="CM.del(${i})">âœ•</button></div>`).join('');
  }

  function del(i){refs.splice(i,1);save();renderLib();renderList(el('cite-search')?.value||'')}
  function clearAll(){if(!confirm('ëª¨ë“  ì°¸ê³ ë¬¸í—Œì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?'))return;refs=[];save();renderLib();renderList('')}

  function insertRefSection(){
    const ed=el('editor');const pos=ed.selectionEnd;
    const list=refs.map((r,i)=>`${i+1}. ${r.full}`).join('\n');
    const block=`\n\n<div class="ref-block">\n\n**ì°¸ê³ ë¬¸í—Œ**\n\n${list}\n\n</div>\n`;
    ed.value=ed.value.substring(0,pos)+block+ed.value.substring(pos);App.render();US.snap();App.hideModal('cite-modal');
  }

  function downloadLib(){
    let content=`# ì°¸ê³ ë¬¸í—Œ ëª©ë¡ (${new Date().toLocaleDateString()})\n\n`;
    content+=`## APA 7\n\n`;refs.forEach((r,i)=>{content+=`${i+1}. ${r.full}\n`});
    content+=`\n## MLA 9\n\n`;refs.forEach((r,i)=>{content+=`${i+1}. ${r.mla||toMLA(r)}\n`});
    content+=`\n## Chicago (Author-Date)\n\n`;refs.forEach((r,i)=>{content+=`${i+1}. ${r.chicago||toChicago(r)}\n`});
    dlBlob(content,'references.txt','text/plain;charset=utf-8');
  }

  function tab(name){
    const names=['add','cite','convert','lib','search'];
    document.querySelectorAll('#cite-modal .tab').forEach((t,i)=>t.classList.toggle('active',names[i]===name));
    names.forEach(n=>el(`cp-${n}`)?.classList.toggle('active',n===name));
    if(name==='cite'){renderList(el('cite-search')?.value||'');el('cite-ins-btn').style.display='none'}
    if(name==='lib')renderLib();
    if(name==='search')setTimeout(()=>el('ref-q')?.focus(),80);
  }

  // RefSearch ì—ì„œ ë‹¨ì¼ APA ë¬¸ìì—´ì„ ì§ì ‘ ì¶”ê°€í•˜ëŠ” ê³µê°œ ë©”ì„œë“œ
  function addRaw(apaStr){
    apaStr=apaStr.trim();if(!apaStr)return;
    const p=parseAPA(apaStr);
    if(p&&!refs.find(r=>r.full===p.full)){p.mla=toMLA(p);p.chicago=toChicago(p);refs.push(p);save();renderLib();}
  }

  function open(){load();renderList('');renderLib();el('cite-ins-btn').style.display='none'}

  return{load,setSep,parse,loadFile,filter,toggle,getSel,upd,selAll,clrSel,insert,del,clearAll,insertRefSection,downloadLib,convertStyle,copyConverted,insertConverted,tab,open,addRaw};
})();

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CAPTION MANAGER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const CAP=(()=>{
  let type='table';let selOpt=0;

  const tableOpts=[
    {label:'&lt;í‘œ N&gt;',template:(n,d)=>`<í‘œ${n}> ${d}`},
    {label:'í‘œ N.',template:(n,d)=>`í‘œ ${n}. ${d}`},
    {label:'&lt;Table N&gt;',template:(n,d)=>`<Table ${n}> ${d}`},
    {label:'Table N.',template:(n,d)=>`Table ${n}. ${d}`},
  ];
  const figOpts=[
    {label:'[ê·¸ë¦¼ N]',template:(n,d)=>`[ê·¸ë¦¼ ${n}] ${d}`},
    {label:'ê·¸ë¦¼ N.',template:(n,d)=>`ê·¸ë¦¼ ${n}. ${d}`},
    {label:'[Fig N]',template:(n,d)=>`[Fig ${n}] ${d}`},
    {label:'Fig N.',template:(n,d)=>`Fig ${n}. ${d}`},
    {label:'[Figure N]',template:(n,d)=>`[Figure ${n}] ${d}`},
    {label:'Figure N.',template:(n,d)=>`Figure ${n}. ${d}`},
  ];

  function show(t){
    type=t;selOpt=0;
    el('cap-title').textContent=t==='table'?'í‘œ ìº¡ì…˜ ì‚½ì…':'ê·¸ë¦¼ ìº¡ì…˜ ì‚½ì…';
    const opts=t==='table'?tableOpts:figOpts;
    el('cap-opts').innerHTML=opts.map((o,i)=>`<span class="cap-opt${i===0?' sel':''}" onclick="CAP.selOpt(${i})">${o.label}</span>`).join('');
    el('cap-num').value='1';el('cap-desc').value='';
    updatePreview();
    el('caption-modal').classList.add('vis');
  }

  function selOptFn(i){
    selOpt=i;
    document.querySelectorAll('#cap-opts .cap-opt').forEach((o,j)=>o.classList.toggle('sel',j===i));
    updatePreview();
  }

  function updatePreview(){
    const opts=type==='table'?tableOpts:figOpts;
    const n=el('cap-num').value||'1';
    const d=el('cap-desc').value||'(ìº¡ì…˜ ë‚´ìš©)';
    el('cap-preview').textContent=opts[selOpt].template(n,d);
  }

  function insert(){
    const opts=type==='table'?tableOpts:figOpts;
    const n=el('cap-num').value||'1';
    const d=el('cap-desc').value||'ë‚´ìš©';
    const caption=opts[selOpt].template(n,d);
    const ed=el('editor');const pos=ed.selectionEnd;
    const cssClass=type==='table'?'tbl-caption':'fig-caption';
    const md=`\n<span class="${cssClass}">${caption}</span>\n`;
    ins(ed,pos,pos,md);
    App.hideModal('caption-modal');
  }

  return{show,selOpt:selOptFn,updatePreview,insert};
})();

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PAPER TEMPLATES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const TMPLS=[
  {name:'í•™ìœ„ë…¼ë¬¸ (ì‚¬íšŒê³¼í•™Â·êµìœ¡í•™Â·ì‹¬ë¦¬í•™)',icon:'ğŸ“',desc:'êµ­ë¬¸ì´ˆë¡, Abstract, 6ì¥ êµ¬ì¡°',content:`# ë…¼ë¬¸ ì œëª©

---

## êµ­ë¬¸ì´ˆë¡

í•µì‹¬ì–´: 

---

## Abstract

Keywords: 

---

## ëª©ì°¨

---

## í‘œ ëª©ì°¨

---

## ê·¸ë¦¼ ëª©ì°¨

---

# ì œ1ì¥ ì„œë¡ 

## 1. ì—°êµ¬ì˜ í•„ìš”ì„±

## 2. ì—°êµ¬ ëª©ì 

## 3. ì—°êµ¬ ë¬¸ì œ

1. 
2. 

## 4. ì—°êµ¬ ê°€ì„¤

## 5. ìš©ì–´ì˜ ì •ì˜

## 6. ì—°êµ¬ì˜ ì œí•œì 

<div class="page-break"></div>

# ì œ2ì¥ ì´ë¡ ì  ë°°ê²½

## 1. í•µì‹¬ ì´ë¡ 

## 2. ì„ í–‰ì—°êµ¬ ê³ ì°°

## 3. ì—°êµ¬ëª¨í˜• ì„¤ì •

<div class="page-break"></div>

# ì œ3ì¥ ì—°êµ¬ë°©ë²•

## 1. ì—°êµ¬ëŒ€ìƒ

## 2. ì—°êµ¬ë„êµ¬

## 3. ìë£Œìˆ˜ì§‘ ì ˆì°¨

## 4. ë¶„ì„ë°©ë²•

## 5. ì—°êµ¬ëª¨í˜• ë¶„ì„ì „ëµ

<div class="page-break"></div>

# ì œ4ì¥ ì—°êµ¬ê²°ê³¼

## 1. ê¸°ìˆ í†µê³„

## 2. ì¸¡ì •ëª¨í˜• ê²€ì¦

## 3. êµ¬ì¡°ëª¨í˜• ë¶„ì„

## 4. ì¶”ê°€ ë¶„ì„

<div class="page-break"></div>

# ì œ5ì¥ ë…¼ì˜

## 1. ê²°ê³¼ í•´ì„

## 2. ì´ë¡ ì  ì‹œì‚¬ì 

## 3. ì‹¤ì²œì  ì‹œì‚¬ì 

<div class="page-break"></div>

# ì œ6ì¥ ê²°ë¡ 

## 1. ì—°êµ¬ ìš”ì•½

## 2. ì •ì±…ì  ì œì–¸

## 3. í›„ì†ì—°êµ¬ ì œì•ˆ

<div class="page-break"></div>

# ì°¸ê³ ë¬¸í—Œ

<div class="ref-block">

</div>

---

# ë¶€ë¡
`},
  {name:'SSCI / KCI í•™ìˆ ì§€',icon:'ğŸ“°',desc:'êµ­ì œí•™ìˆ ì§€ í‘œì¤€ IMRaD êµ¬ì¡°',content:`# ë…¼ë¬¸ ì œëª©

**Authors:** 

**Journal:** 

**Received:** | **Accepted:** | **Published:** 

---

## Abstract

**Keywords:** 

---

# 1. Introduction

## 1.1 Background

## 1.2 Research Gap

## 1.3 Research Purpose

<div class="page-break"></div>

# 2. Literature Review

<div class="page-break"></div>

# 3. Theoretical Framework and Hypotheses

**H1:** 

**H2:** 

<div class="page-break"></div>

# 4. Method

## 4.1 Participants

## 4.2 Measures

## 4.3 Procedure

## 4.4 Data Analysis

<div class="page-break"></div>

# 5. Results

<div class="page-break"></div>

# 6. Discussion

## 6.1 Theoretical Implications

## 6.2 Practical Implications

## 6.3 Limitations and Future Research

<div class="page-break"></div>

# 7. Conclusion

<div class="page-break"></div>

# References

<div class="ref-block">

</div>
`},
  {name:'ë‹¨ì¼ ì—°êµ¬ ë…¼ë¬¸ (ì‹¤ì¦)',icon:'ğŸ”¬',desc:'ì„œë¡ -ë°©ë²•-ê²°ê³¼-ë…¼ì˜ 4ë‹¨ êµ¬ì¡°',content:`# ë…¼ë¬¸ ì œëª©

**ì €ì:** 

---

## ìš”ì•½

**ì£¼ìš”ì–´:** 

---

# 1. ì„œë¡ 

<div class="page-break"></div>

# 2. ì´ë¡ ì  ë°°ê²½ ë° ê°€ì„¤ ì„¤ì •

## 2.1 ì´ë¡ ì  ë°°ê²½

## 2.2 ì—°êµ¬ ê°€ì„¤

**ê°€ì„¤ 1:** 

**ê°€ì„¤ 2:** 

<div class="page-break"></div>

# 3. ì—°êµ¬ë°©ë²•

## 3.1 ì—°êµ¬ëŒ€ìƒ

## 3.2 ì¸¡ì •ë„êµ¬

## 3.3 ë¶„ì„ë°©ë²•

<div class="page-break"></div>

# 4. ì—°êµ¬ê²°ê³¼

## 4.1 ê¸°ìˆ í†µê³„

## 4.2 ê°€ì„¤ ê²€ì¦

<div class="page-break"></div>

# 5. ë…¼ì˜ ë° ê²°ë¡ 

## 5.1 ë…¼ì˜

## 5.2 ê²°ë¡ 

## 5.3 ì—°êµ¬ì˜ í•œê³„

# ì°¸ê³ ë¬¸í—Œ

<div class="ref-block">

</div>
`},
  {name:'ë‹¤ì¤‘ ì—°êµ¬ (Study 1 / Study 2)',icon:'ğŸ“Š',desc:'ë³µìˆ˜ ì—°êµ¬ í¬í•¨ ì‹¤ì¦ ë…¼ë¬¸ êµ¬ì¡°',content:`# ë…¼ë¬¸ ì œëª©

**Authors:** 

---

## Abstract

**Keywords:** 

---

# 1. Introduction

<div class="page-break"></div>

# 2. Study 1

## 2.1 Method

### 2.1.1 Participants

### 2.1.2 Measures

### 2.1.3 Procedure

## 2.2 Results

## 2.3 Discussion

<div class="page-break"></div>

# 3. Study 2

## 3.1 Method

### 3.1.1 Participants

### 3.1.2 Measures

### 3.1.3 Procedure

## 3.2 Results

## 3.3 Discussion

<div class="page-break"></div>

# 4. General Discussion

## 4.1 Theoretical Contributions

## 4.2 Practical Implications

## 4.3 Limitations and Future Research

# References

<div class="ref-block">

</div>
`},
  {name:'ë©”íƒ€ë¶„ì„ ë…¼ë¬¸',icon:'ğŸ“ˆ',desc:'ì²´ê³„ì  ë¬¸í—Œ ê²€í†  ë° ë©”íƒ€ë¶„ì„',content:`# ë…¼ë¬¸ ì œëª©: A Meta-Analysis

**Authors:** 

---

## Abstract

**Keywords:** 

---

# 1. Introduction

## 1.1 Theoretical Background

## 1.2 Purpose of Meta-Analysis

<div class="page-break"></div>

# 2. Literature Search Strategy

## 2.1 Search Databases

## 2.2 Search Keywords

## 2.3 Search Period

<div class="page-break"></div>

# 3. Inclusion Criteria

## 3.1 Inclusion Criteria

## 3.2 Exclusion Criteria

## 3.3 PRISMA Flow Diagram

<div class="page-break"></div>

# 4. Coding Procedure

## 4.1 Variables Coded

## 4.2 Coder Agreement

<div class="page-break"></div>

# 5. Statistical Analysis

## 5.1 Effect Size Calculation

## 5.2 Heterogeneity Test

## 5.3 Moderator Analysis

<div class="page-break"></div>

# 6. Results

## 6.1 Overall Effect Size

## 6.2 Moderator Effects

<div class="page-break"></div>

# 7. Publication Bias Test

## 7.1 Funnel Plot

## 7.2 Egger's Test

<div class="page-break"></div>

# 8. Discussion

## 8.1 Interpretation of Effect Sizes

## 8.2 Practical Implications

## 8.3 Limitations

# References

<div class="ref-block">

</div>

---

# Appendix

## Appendix A: List of Included Studies
`},
];

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   GOOGLE SCHOLAR SEARCH
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const Scholar=(()=>{
  const RK='mdpro_scholar_recent';
  let recent=[];

  function load(){try{recent=JSON.parse(localStorage.getItem(RK)||'[]')}catch(e){recent=[]}}

  function show(){
    load();renderRecent();el('scholar-modal').classList.add('vis');
    setTimeout(()=>el('scholar-q').focus(),80);
  }

  function search(){
    const q=el('scholar-q').value.trim();
    if(!q){el('scholar-q').focus();return;}
    const lang=el('scholar-lang').value;
    const year=el('scholar-year').value;
    const review=el('scholar-review').checked;

    // URL íŒŒë¼ë¯¸í„° êµ¬ì„±
    const params=new URLSearchParams();
    params.set('q',q);
    params.set('hl',lang==='ko'?'ko':'en');
    if(year)params.set('as_ylo',year);
    if(review)params.set('as_rr','1');// ë¦¬ë·° ë…¼ë¬¸ í•„í„°

    const url=`https://scholar.google.com/scholar?${params.toString()}`;
    window.open(url,'scholar_search','width=1100,height=800,left=100,top=80,resizable=yes,scrollbars=yes');

    // ìµœê·¼ ê²€ìƒ‰ì–´ ì €ì¥ (ì¤‘ë³µ ì œê±°, ìµœëŒ€ 8ê°œ)
    recent=recent.filter(r=>r!==q);recent.unshift(q);recent=recent.slice(0,8);
    try{localStorage.setItem(RK,JSON.stringify(recent))}catch(e){}
    renderRecent();
  }

  function renderRecent(){
    const wrap=el('scholar-recent-wrap');
    const div=el('scholar-recent');
    if(!recent.length){wrap.style.display='none';return}
    wrap.style.display='block';
    div.innerHTML=recent.map(r=>`<span style="display:inline-flex;align-items:center;gap:3px;background:var(--bg5);border:1px solid var(--bd);border-radius:var(--r);padding:2px 8px;font-size:11px;cursor:pointer;color:var(--tx2)" onclick="Scholar.useRecent('${r.replace(/'/g,"\\'")}')">ğŸ• ${r}</span>`).join('');
  }

  function useRecent(q){el('scholar-q').value=q;search()}

  function clear(){
    el('scholar-q').value='';recent=[];
    try{localStorage.removeItem(RK)}catch(e){}
    renderRecent();
    el('scholar-q').focus();
  }

  return{show,search,useRecent,clear};
})();

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   REF SEARCH â€” CrossRef / OpenAlex ë‚´ì¥ ë…¼ë¬¸ ê²€ìƒ‰
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const RefSearch=(()=>{
  let _loading=false;

  /* â”€â”€ APA í¬ë§·í„° â”€â”€ */
  function toAPA(w){
    // ì €ì
    let authors='';
    if(w._src==='openalex'){
      const au=(w.authorships||[]).map(a=>a.author?.display_name||'').filter(Boolean);
      if(au.length===0)authors='Unknown';
      else if(au.length<=5)authors=au.map(fmtName).join(', ');
      else authors=fmtName(au[0])+', et al.';
    } else {
      // CrossRef ì‹¤ì œ êµ¬ì¡°: [{family:"Kim", given:"J."}, ...]
      // name í•„ë“œëŠ” ê¸°ê´€ì €ìì—ë§Œ ê°„í˜¹ ì¡´ì¬
      const au=(w.author||[]).map(a=>{
        if(a.family&&a.given) return`${a.family}, ${a.given.trim()[0].toUpperCase()}.`;
        if(a.family)          return a.family;
        if(a.name)            return a.name;
        return'';
      }).filter(Boolean);
      if(au.length===0)authors='Unknown';
      else if(au.length<=5)authors=au.join(', ');
      else authors=au[0]+', et al.';
    }
    // ì—°ë„
    const year=w._year||'n.d.';
    // ì œëª©
    const title=w._title||'Untitled';
    // ì €ë„
    const journal=w._journal||'';
    // ê¶ŒÂ·í˜¸Â·í˜ì´ì§€
    const vol=w.volume||w._vol||'';
    const iss=w.issue||w._iss||'';
    const page=w.page||w._page||'';
    // DOI
    const doi=w.DOI||w._doi||'';
    let cite=`${authors} (${year}). ${title}.`;
    if(journal)cite+=` ${journal}`;
    if(vol)cite+=`, ${vol}`;
    if(iss)cite+=`(${iss})`;
    if(page)cite+=`, ${page}`;
    cite+='.';
    if(doi)cite+=` https://doi.org/${doi}`;
    return cite;
  }

  function fmtName(n){
    // "Firstname Lastname" â†’ "Lastname, F."
    if(!n)return'';
    const parts=n.trim().split(/\s+/);
    if(parts.length===1)return parts[0];
    const last=parts[parts.length-1];
    const initials=parts.slice(0,-1).map(p=>p[0].toUpperCase()+'.').join(' ');
    return`${last}, ${initials}`;
  }

  /* â”€â”€ CrossRef API â”€â”€ */
  async function searchCrossRef(q,year){
    const rows=10;
    let url=`https://api.crossref.org/works?query=${encodeURIComponent(q)}&rows=${rows}&select=DOI,title,author,published-print,published-online,container-title,volume,issue,page&mailto=mdpro@editor.app`;
    if(year)url+=`&filter=from-pub-date:${year}`;
    const res=await fetch(url);
    if(!res.ok)throw new Error('CrossRef ì‘ë‹µ ì˜¤ë¥˜');
    const data=await res.json();
    return (data.message?.items||[]).map(w=>{
      const yr=(w['published-print']||w['published-online'])?.['date-parts']?.[0]?.[0]||'';
      return{
        _src:'crossref',_title:(w.title||[''])[0],_year:yr,
        _journal:(w['container-title']||[])[0]||'',
        _vol:w.volume||'',_iss:w.issue||'',_page:w.page||'',
        DOI:w.DOI||'',author:w.author||[],
        _url:w.DOI?`https://doi.org/${w.DOI}`:''
      };
    });
  }

  /* â”€â”€ OpenAlex API â”€â”€ */
  async function searchOpenAlex(q,year){
    let url=`https://api.openalex.org/works?search=${encodeURIComponent(q)}&per-page=10&select=id,title,authorships,publication_year,primary_location,biblio,doi,open_access`;
    if(year)url+=`&filter=publication_year:>${parseInt(year)-1}`;
    const res=await fetch(url);
    if(!res.ok)throw new Error('OpenAlex ì‘ë‹µ ì˜¤ë¥˜');
    const data=await res.json();
    return (data.results||[]).map(w=>{
      const src=w.primary_location?.source;
      return{
        _src:'openalex',_title:w.title||'',_year:w.publication_year||'',
        _journal:src?.display_name||'',
        _vol:w.biblio?.volume||'',_iss:w.biblio?.issue||'',
        _page:w.biblio?.first_page?(w.biblio.first_page+(w.biblio.last_page?'â€“'+w.biblio.last_page:'')):'',
        _doi:w.doi?w.doi.replace('https://doi.org/',''):'',
        DOI:w.doi?w.doi.replace('https://doi.org/',''):'',
        authorships:w.authorships||[],
        _oa:w.open_access?.is_oa||false,
        _url:w.doi||''
      };
    });
  }

  /* â”€â”€ ë Œë”ë§ â”€â”€ */
  function renderCards(items){
    const box=el('ref-results');
    if(!items.length){
      box.innerHTML='<div class="cite-empty">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.<br><span style="font-size:10px">ë‹¤ë¥¸ í‚¤ì›Œë“œë¥¼ ì‹œë„í•˜ê±°ë‚˜ Scholar â†— ë²„íŠ¼ìœ¼ë¡œ Google Scholarë¥¼ í™•ì¸í•˜ì„¸ìš”.</span></div>';
      return;
    }
    box.innerHTML=items.map((w,i)=>{
      const apa=toAPA(w);
      const doi=w.DOI||w._doi||'';
      const oa=w._oa?'<span class="ref-tag" style="color:var(--ok);border-color:var(--ok)">OA</span>':'';
      const src=w._src==='openalex'?'<span class="ref-tag">OpenAlex</span>':'<span class="ref-tag">CrossRef</span>';
      return`<div class="ref-card">
  <div class="ref-card-title">${w._title||'ì œëª© ì—†ìŒ'}</div>
  <div class="ref-card-meta">
    ${w._year?`<b>${w._year}</b> Â· `:''}${w._journal||''}${w._vol?` ${w._vol}`:''}${w._iss?`(${w._iss})`:''}
    ${src}${oa}
  </div>
  <div class="ref-card-apa" id="apa-${i}" title="í´ë¦­í•˜ë©´ ì „ì²´ ì„ íƒë¨">${apa}</div>
  <div class="ref-card-btns">
    <button class="btn btn-p btn-sm" onclick="RefSearch.addToLib(${i})">+ ì°¸ê³ ë¬¸í—Œì— ì¶”ê°€</button>
    <button class="btn btn-g btn-sm" onclick="RefSearch.copyAPA(${i})">ğŸ“‹ APA ë³µì‚¬</button>
    ${doi?`<a href="https://doi.org/${doi}" target="_blank" rel="noopener" class="btn btn-g btn-sm">DOI â†—</a>`:''}
  </div>
</div>`;
    }).join('');
    // ë°ì´í„° ì €ì¥ (ë²„íŠ¼ ì½œë°±ìš©)
    box._data=items;
    box._apas=items.map(toAPA);
  }

  /* â”€â”€ ê²€ìƒ‰ ì‹¤í–‰ â”€â”€ */
  async function search(){
    if(_loading)return;
    const q=el('ref-q').value.trim();
    const year=el('ref-year').value;
    const db=el('ref-db').value;
    if(!q){el('ref-q').focus();return}

    _loading=true;
    const status=el('ref-status');
    const box=el('ref-results');
    status.textContent='ğŸ”„ ê²€ìƒ‰ ì¤‘...';
    box.innerHTML='<div class="cite-empty" style="padding:24px"><div style="font-size:20px;margin-bottom:8px">â³</div>ì ì‹œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”...</div>';

    try{
      let items;
      if(db==='openalex')items=await searchOpenAlex(q,year);
      else items=await searchCrossRef(q,year);
      status.textContent=`âœ… ${items.length}ê±´ ê²€ìƒ‰ë¨ (${db==='openalex'?'OpenAlex':'CrossRef'}) Â· "${q}"`;
      renderCards(items);
    }catch(e){
      status.textContent=`âŒ ì˜¤ë¥˜: ${e.message}`;
      box.innerHTML=`<div class="cite-empty">ê²€ìƒ‰ ì‹¤íŒ¨: ${e.message}<br><span style="font-size:10px">ë„¤íŠ¸ì›Œí¬ë¥¼ í™•ì¸í•˜ê±°ë‚˜ Scholar â†—ë¥¼ ì‚¬ìš©í•´ì£¼ì„¸ìš”.</span></div>`;
    }
    _loading=false;
  }

  function addToLib(i){
    const box=el('ref-results');
    const apa=box._apas?.[i];
    if(!apa)return;
    CM.addRaw(apa);
    // ë²„íŠ¼ í”¼ë“œë°±
    const btns=box.querySelectorAll('.ref-card')[i]?.querySelectorAll('button');
    if(btns?.[0]){btns[0].textContent='âœ” ì¶”ê°€ë¨';btns[0].disabled=true;btns[0].style.opacity='.6';}
  }

  function copyAPA(i){
    const box=el('ref-results');
    const apa=box._apas?.[i];
    if(!apa)return;
    navigator.clipboard.writeText(apa).then(()=>{
      const btns=box.querySelectorAll('.ref-card')[i]?.querySelectorAll('button');
      if(btns?.[1]){const orig=btns[1].textContent;btns[1].textContent='âœ” ë³µì‚¬ë¨';setTimeout(()=>btns[1].textContent=orig,1500);}
    }).catch(()=>{
      // fallback
      const el2=document.createElement('textarea');el2.value=apa;document.body.appendChild(el2);el2.select();document.execCommand('copy');el2.remove();
    });
  }

  function openScholar(){
    const q=el('ref-q').value.trim();
    const url=q?`https://scholar.google.com/scholar?q=${encodeURIComponent(q)}&hl=ko`:'https://scholar.google.com/?hl=ko';
    window.open(url,'_blank');
  }

  return{search,addToLib,copyAPA,openScholar};
})();

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   COLOR PICKER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const ColorPicker=(()=>{
  let mode='text';
  const TEXT_COLORS=['#e8e8f0','#ff4444','#ff8800','#ffcc00','#44cc44','#00aaff','#aa44ff','#ff44aa','#000000','#333333','#666666','#999999','#cccccc','#ffffff','#5b4ce4','#f7a06a'];
  const BG_COLORS=['#fff176','#ffcc80','#ef9a9a','#80cbc4','#a5d6a7','#90caf9','#ce93d8','#f48fb1','#ffecb3','#dcedc8','transparent'];

  function open(m){
    mode=m;
    el('color-modal-title').textContent=m==='text'?'ê¸€ì ìƒ‰ìƒ ì„¤ì •':'í˜•ê´‘íœ í•˜ì´ë¼ì´íŠ¸ ìƒ‰ìƒ';
    const colors=m==='text'?TEXT_COLORS:BG_COLORS;
    el('color-swatches').innerHTML=colors.map(c=>`<div class="csw" style="background:${c==='transparent'?'repeating-linear-gradient(45deg,#888,#888 2px,transparent 2px,transparent 6px)':c};border-color:${c==='#ffffff'?'#ccc':'transparent'}" onclick="ColorPicker.setHex('${c}')" title="${c}"></div>`).join('');
    el('color-hex').value='';
    // ìŠ¤í¬ì´ë“œ ì§€ì› ì—¬ë¶€
    const supported='EyeDropper' in window;
    el('eyedropper-btn').style.display=supported?'':'none';
    el('eyedrop-support-msg').style.display=supported?'none':'block';
    // íŒ”ë ˆíŠ¸ í´ë¦­ ì—°ë™
    el('eyedrop-btn').onclick=e=>{e.preventDefault();el('color-native').click()};
    el('color-modal').classList.add('vis');
    updatePreview('');
  }

  function setHex(c){
    el('color-hex').value=c;
    // native color inputë„ ë™ê¸°í™” (íˆ¬ëª… ì œì™¸)
    if(c&&c!=='transparent'){try{el('color-native').value=c}catch(e){}}
    updatePreview(c);
  }

  // <input type="color"> íŒ”ë ˆíŠ¸ì—ì„œ ì„ íƒ
  function fromNative(hex){
    el('color-hex').value=hex;
    updatePreview(hex);
  }

  // EyeDropper API â€” Chrome 95+ / Edge 95+
  async function eyedrop(){
    if(!('EyeDropper' in window)){
      el('eyedrop-support-msg').style.display='block';return;
    }
    try{
      // ëª¨ë‹¬ íˆ¬ëª…í™” â†’ í™”ë©´ ì „ì²´ì—ì„œ ìƒ‰ìƒ ì„ íƒ ê°€ëŠ¥
      el('color-modal').style.opacity='0';
      el('color-modal').style.pointerEvents='none';
      const result=await new EyeDropper().open();
      el('color-modal').style.opacity='';
      el('color-modal').style.pointerEvents='';
      setHex(result.sRGBHex);
    }catch(e){
      // ì‚¬ìš©ì ì·¨ì†Œ ì‹œ ì¡°ìš©íˆ ë³µì›
      el('color-modal').style.opacity='';
      el('color-modal').style.pointerEvents='';
    }
  }

  function updatePreview(c){
    const prev=el('color-preview');
    if(!c||c==='transparent'){prev.style.color='';prev.style.background='';return}
    if(mode==='text'){prev.style.color=c;prev.style.background=''}
    else{prev.style.background=c;prev.style.color=''}
  }

  function apply(){
    const c=el('color-hex').value.trim();if(!c)return;
    const ed=el('editor');const s=ed.selectionStart,e=ed.selectionEnd;const sel=ed.value.substring(s,e)||'í…ìŠ¤íŠ¸';
    let wrapped;
    if(mode==='text'){wrapped=`<span style="color:${c}">${sel}</span>`}
    else{wrapped=c==='transparent'?sel:`<span style="background:${c}">${sel}</span>`}
    ins(ed,s,e,wrapped);
    if(mode==='text'){el('fc-bar').style.background=c}
    else{el('hl-bar').style.background=c}
    App.hideModal('color-modal');
  }

  return{open,setHex,fromNative,eyedrop,updatePreview,apply};
})();

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   EDITOR ACTIONS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   IMAGE DROP HANDLER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const IMG=(()=>{
  function dragOver(e){e.preventDefault();e.stopPropagation();el('img-dropzone').style.borderColor='var(--ac)';el('img-dropzone').style.background='var(--acg)'}
  function dragLeave(e){el('img-dropzone').style.borderColor='var(--bd)';el('img-dropzone').style.background='var(--bg3)'}
  function drop(e){
    e.preventDefault();e.stopPropagation();
    dragLeave(e);
    const file=e.dataTransfer.files[0];
    if(file&&file.type.startsWith('image/'))loadImage(file);
  }
  function fileSelected(ev){
    const file=ev.target.files[0];
    if(file)loadImage(file);
    ev.target.value='';
  }
  function loadImage(file){
    const reader=new FileReader();
    reader.onload=ev=>{
      const dataUrl=ev.target.result;
      el('img-url').value=dataUrl;
      if(!el('img-alt').value)el('img-alt').value=file.name.replace(/\.[^.]+$/,'');
      // Show preview
      el('img-preview').src=dataUrl;
      el('img-preview-wrap').style.display='block';
      el('img-drop-text').textContent='âœ“ '+file.name+' ('+Math.round(file.size/1024)+'KB)';
      el('img-drop-text').style.color='var(--ok)';
    };
    reader.readAsDataURL(file);
  }
  return{dragOver,dragLeave,drop,fileSelected};
})();

let lastCodeLang='python';// track last used language for Alt+C

const ED={
  ed(){return el('editor')},
  h(lv){const ed=this.ed();repCL(ed,'#'.repeat(lv)+' '+getCL(ed).text.replace(/^#+\s*/,''))},
  bold(){
    const ed=this.ed(),s=ed.selectionStart,e=ed.selectionEnd,sel=ed.value.substring(s,e);
    if(!sel){ins(ed,s,e,'**í…ìŠ¤íŠ¸**');ed.setSelectionRange(s+2,s+5);return}
    const b2=ed.value.substring(s-2,s),a2=ed.value.substring(e,e+2);
    if(b2==='**'&&a2==='**'){ed.value=ed.value.substring(0,s-2)+sel+ed.value.substring(e+2);ed.setSelectionRange(s-2,e-2);App.render();US.snap();return}
    const b3=ed.value.substring(s-3,s),a4=ed.value.substring(e,e+4);
    if(b3==='<b>'&&a4==='</b>'){ed.value=ed.value.substring(0,s-3)+sel+ed.value.substring(e+4);ed.setSelectionRange(s-3,e-3);App.render();US.snap();return}
    const w=/[()[\]{}<>]/.test(sel)?`<b>${sel}</b>`:`**${sel}**`;
    ins(ed,s,e,w);ed.setSelectionRange(s,s+w.length);
  },
  italic(){const ed=this.ed(),s=ed.selectionStart,e=ed.selectionEnd,sel=ed.value.substring(s,e)||'í…ìŠ¤íŠ¸';const b=ed.value.substring(s-1,s),a=ed.value.substring(e,e+1);if(b==='*'&&a==='*'){ed.value=ed.value.substring(0,s-1)+sel+ed.value.substring(e+1);ed.setSelectionRange(s-1,s-1+sel.length);App.render()}else ins(ed,s,e,`*${sel}*`)},
  strike(){const ed=this.ed(),s=ed.selectionStart,e=ed.selectionEnd;ins(ed,s,e,`~~${ed.value.substring(s,e)||'í…ìŠ¤íŠ¸'}~~`)},
  inlineCode(){const ed=this.ed(),s=ed.selectionStart,e=ed.selectionEnd;ins(ed,s,e,`\`${ed.value.substring(s,e)||'code'}\``)},
  fontSize(size){if(!size)return;const ed=this.ed(),s=ed.selectionStart,e=ed.selectionEnd,sel=ed.value.substring(s,e)||'í…ìŠ¤íŠ¸';ins(ed,s,e,`<span style="font-size:${size}">${sel}</span>`)},
  align(dir){const ed=this.ed();const{text}=getCL(ed);const c=text.replace(/<div[^>]*>(.*?)<\/div>/gi,'$1');repCL(ed,dir==='left'?c:`<div style="text-align:${dir}">${c}</div>`)},
  list(type){const ed=this.ed(),s=ed.selectionStart;const p=type==='ul'?'- ':'1. ';ins(ed,s,s,`\n${p}í•­ëª© 1\n${p}í•­ëª© 2\n${p}í•­ëª© 3\n`)},
  bquote(){const ed=this.ed(),s=ed.selectionStart,e=ed.selectionEnd,sel=ed.value.substring(s,e);if(sel)ins(ed,s,e,sel.split('\n').map(l=>'> '+l).join('\n'));else ins(ed,s,s,'\n> ì¸ìš©ë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”\n')},
  table(){const ed=this.ed(),s=ed.selectionStart;ins(ed,s,s,'\n| í—¤ë” 1 | í—¤ë” 2 | í—¤ë” 3 |\n| :-- | :-- | :-- |\n| ì…€ | ì…€ | ì…€ |\n| ì…€ | ì…€ | ì…€ |\n')},
  tableRow(){const ed=this.ed(),val=ed.value,pos=ed.selectionStart;const le=val.indexOf('\n',pos),ln=val.substring(val.lastIndexOf('\n',pos-1)+1,le===-1?val.length:le);if(!ln.trim().startsWith('|')){this.table();return}const cols=ln.split('|').filter(c=>c.trim()!=='').length;ins(ed,le===-1?val.length:le,le===-1?val.length:le,'\n|'+' ì…€ |'.repeat(cols))},
  tableCol(){const ed=this.ed(),lines=ed.value.split('\n');const cur=ed.value.substring(0,ed.selectionStart).split('\n').length-1;if(!lines[cur].trim().startsWith('|')){this.table();return}let s=cur,e2=cur;while(s>0&&lines[s-1].trim().startsWith('|'))s--;while(e2<lines.length-1&&lines[e2+1].trim().startsWith('|'))e2++;ed.value=lines.map((l,i)=>{if(i<s||i>e2||!l.trim().startsWith('|'))return l;return /^\|[\s:|-]+\|$/.test(l.trim())?l.trimEnd()+' :-- |':l.trimEnd()+' ìƒˆì—´ |'}).join('\n');App.render();US.snap()},

  /* â”€â”€ ì…€ ë³‘í•© ì‹œìŠ¤í…œ (MD í‘œ + HTML í‘œ ëª¨ë‘ ì§€ì›, ë°˜ë³µ ë³‘í•© ê°€ëŠ¥) â”€â”€ */

  _getMdTable(ed){
    const lines=ed.value.split('\n');
    const cur=ed.value.substring(0,ed.selectionStart).split('\n').length-1;
    if(!lines[cur].trim().startsWith('|'))return null;
    let s=cur,e2=cur;
    while(s>0&&lines[s-1].trim().startsWith('|'))s--;
    while(e2<lines.length-1&&lines[e2+1].trim().startsWith('|'))e2++;
    let sepIdx=-1;
    for(let i=s;i<=e2;i++){if(/^\|[\s:|-]+\|$/.test(lines[i].trim())){sepIdx=i;break;}}
    return{lines,start:s,end:e2,cur,sep:sepIdx};
  },

  _parseCells(line){
    return line.split('|').slice(1,-1).map(c=>c.trim());
  },

  _getCursorCell(ed){
    const val=ed.value,pos=ed.selectionStart;
    const ls=val.lastIndexOf('\n',pos-1)+1;
    const part=val.substring(ls,pos);
    return Math.max(0,part.split('|').length-2);
  },

  /* HTML í‘œ íŒŒì‹±: DOMParserë¡œ ê¸°ì¡´ colspan/rowspan ìœ ì§€í•˜ë©° ì¬íŒŒì‹± */
  _getHTMLTable(ed){
    const val=ed.value,pos=ed.selectionStart;
    const before=val.substring(0,pos);
    const tStart=before.lastIndexOf('<table');
    if(tStart===-1)return null;
    const tEnd=val.indexOf('</table>',tStart);
    if(tEnd===-1)return null;
    const tableHTML=val.substring(tStart,tEnd+8);
    const doc=new DOMParser().parseFromString('<body>'+tableHTML+'</body>','text/html');
    const table=doc.querySelector('table');
    if(!table)return null;
    const trs=[...table.querySelectorAll('tr')];
    if(!trs.length)return null;
    // ìµœëŒ€ ì—´ ìˆ˜ ê³„ì‚°
    const cols=trs.reduce((mx,tr)=>{
      let n=0;[...tr.cells].forEach(c=>n+=c.colSpan||1);return Math.max(mx,n);
    },0);
    const rows=trs.length;
    // cells[r][c] = {text,cs,rs,skip}
    const cells=Array.from({length:rows},()=>Array(cols).fill(null));
    const occupied=Array.from({length:rows},()=>Array(cols).fill(false));
    trs.forEach((tr,r)=>{
      let gc=0;
      [...tr.cells].forEach(td=>{
        while(gc<cols&&occupied[r][gc])gc++;
        const cs=td.colSpan||1,rs=td.rowSpan||1;
        cells[r][gc]={text:td.innerHTML.trim(),cs,rs,skip:false};
        for(let dr=0;dr<rs;dr++)for(let dc=0;dc<cs;dc++){
          if(r+dr<rows&&gc+dc<cols){
            occupied[r+dr][gc+dc]=true;
            if(dr>0||dc>0)cells[r+dr][gc+dc]={text:'',cs:1,rs:1,skip:true};
          }
        }
        gc+=cs;
      });
    });
    // ë¹ˆ ì…€ ë³´ì •
    for(let r=0;r<rows;r++)for(let c=0;c<cols;c++){
      if(!cells[r][c])cells[r][c]={text:'',cs:1,rs:1,skip:false};
    }
    // ì»¤ì„œ ìœ„ì¹˜ â†’ rowIdx, curCol ê³„ì‚°
    const posInTable=pos-tStart;
    const sliced=tableHTML.substring(0,posInTable);
    const rowIdx=Math.max(0,(sliced.match(/<tr[\s>]/gi)||[]).length-1);
    const tdIdx =Math.max(0,(sliced.match(/<t[dh][\s>]/gi)||[]).length-1);
    // tdIdxë²ˆì§¸ ì‹¤ì œ td/thê°€ ê·¸ë¦¬ë“œì˜ ëª‡ ë²ˆ ì—´ì¸ì§€
    let gc2=0,counted=0,curCol=0;
    if(trs[rowIdx]){
      for(const td of trs[rowIdx].cells){
        while(gc2<cols&&occupied[rowIdx]&&rowIdx>0&&cells[rowIdx][gc2]?.skip)gc2++;
        if(counted===tdIdx){curCol=gc2;break;}
        gc2+=td.colSpan||1;counted++;
      }
    }
    return{cells,rows,cols,rowIdx,curCol,tStart,tEnd:tEnd+8,val};
  },

  _renderHTMLTable(cells,rows,cols){
    let html='\n<table>\n<thead>\n<tr>';
    for(let c=0;c<cols;c++){
      const cell=cells[0]?.[c];if(!cell||cell.skip)continue;
      const cs=cell.cs>1?` colspan="${cell.cs}"`:''
      const rs=cell.rs>1?` rowspan="${cell.rs}"`:''
      html+=`<th${cs}${rs}>${cell.text}</th>`;
    }
    html+='</tr>\n</thead>\n<tbody>';
    for(let r=1;r<rows;r++){
      html+='\n<tr>';
      for(let c=0;c<cols;c++){
        const cell=cells[r]?.[c];if(!cell||cell.skip)continue;
        const cs=cell.cs>1?` colspan="${cell.cs}"`:''
        const rs=cell.rs>1?` rowspan="${cell.rs}"`:''
        html+=`<td${cs}${rs}>${cell.text}</td>`;
      }
      html+='</tr>';
    }
    html+='\n</tbody>\n</table>\n';
    return html;
  },

  /* ê³µí†µ ë³‘í•© ì‹¤í–‰: MD í‘œ â†’ HTML ë³€í™˜, HTML í‘œ â†’ ì§ì ‘ íŒŒì‹± í›„ ì¬ë³‘í•© */
  _doMerge(dir){
    const ed=this.ed();
    // â‘  HTML í‘œ ìš°ì„  ì‹œë„
    const htbl=this._getHTMLTable(ed);
    if(htbl){
      const{cells,rows,cols,rowIdx,curCol,tStart,tEnd,val}=htbl;
      const cell=cells[rowIdx]?.[curCol];
      if(!cell||cell.skip){alert('ì´ë¯¸ ë³‘í•©ëœ ì…€ì´ê±°ë‚˜ ìœ íš¨í•˜ì§€ ì•Šì€ ìœ„ì¹˜ì…ë‹ˆë‹¤.\nì…€ í…ìŠ¤íŠ¸ ìœ„ì— ì»¤ì„œë¥¼ ë†“ê³  ì‹¤í–‰í•˜ì„¸ìš”.');return;}
      if(dir==='h'){
        const nc=curCol+cell.cs;
        if(nc>=cols){alert('ì˜¤ë¥¸ìª½ì— ë³‘í•©í•  ì…€ì´ ì—†ìŠµë‹ˆë‹¤.');return;}
        const right=cells[rowIdx][nc];
        if(!right||right.skip){alert('ì˜¤ë¥¸ìª½ ì…€ì´ ì´ë¯¸ ë³‘í•© ì¤‘ì…ë‹ˆë‹¤.');return;}
        cell.text=(cell.text+(right.text?' '+right.text:'')).trim();
        cell.cs+=right.cs;
        for(let cc=curCol+1;cc<curCol+cell.cs;cc++)if(cells[rowIdx][cc])cells[rowIdx][cc].skip=true;
      } else {
        const nr=rowIdx+cell.rs;
        if(nr>=rows){alert('ì•„ë˜ì— ë³‘í•©í•  ì…€ì´ ì—†ìŠµë‹ˆë‹¤.');return;}
        const below=cells[nr]?.[curCol];
        if(!below||below.skip){alert('ì•„ë˜ ì…€ì´ ì´ë¯¸ ë³‘í•© ì¤‘ì…ë‹ˆë‹¤.');return;}
        cell.text=(cell.text+(below.text?' '+below.text:'')).trim();
        cell.rs+=below.rs;
        for(let rr=rowIdx+1;rr<rowIdx+cell.rs;rr++)if(cells[rr]?.[curCol])cells[rr][curCol].skip=true;
      }
      const newHTML=this._renderHTMLTable(cells,rows,cols);
      ed.value=val.substring(0,tStart)+newHTML+val.substring(tEnd);
      App.render();US.snap();
      return;
    }
    // â‘¡ Markdown í‘œ ì²˜ë¦¬
    const tbl=this._getMdTable(ed);
    if(!tbl){alert('ì»¤ì„œë¥¼ í‘œ ì•ˆì— ë†“ê³  ì‹¤í–‰í•˜ì„¸ìš”.');return;}
    const{lines,start,end,cur,sep}=tbl;
    const col=this._getCursorCell(ed);
    const allRows=[];
    for(let i=start;i<=end;i++){if(i!==sep)allRows.push(this._parseCells(lines[i]));}
    if(allRows.length<2)return;
    const cols2=allRows[0].length;
    const cells2=allRows.map(row=>row.map(t=>({text:t||'',cs:1,rs:1,skip:false})));
    const dataLines=[];
    for(let i=start;i<=end;i++){if(i!==sep)dataLines.push(i);}
    const rowIdx2=dataLines.indexOf(cur);
    if(rowIdx2<0){alert('ì»¤ì„œë¥¼ í‘œ ì…€ ì•ˆì— ë†“ê³  ì‹¤í–‰í•˜ì„¸ìš”.');return;}
    if(dir==='h'){
      if(col>=cols2-1){alert('ì˜¤ë¥¸ìª½ì— ë³‘í•©í•  ì…€ì´ ì—†ìŠµë‹ˆë‹¤.');return;}
      const c1=cells2[rowIdx2][col],c2=cells2[rowIdx2][col+1];
      c1.text=(c1.text+(c2.text?' '+c2.text:'')).trim();c1.cs=2;c2.skip=true;
    } else {
      if(rowIdx2>=allRows.length-1){alert('ì•„ë˜ì— ë³‘í•©í•  ì…€ì´ ì—†ìŠµë‹ˆë‹¤.');return;}
      const c1=cells2[rowIdx2][col],c2=cells2[rowIdx2+1][col];
      c1.text=(c1.text+(c2.text?' '+c2.text:'')).trim();c1.rs=2;c2.skip=true;
    }
    const bef=lines.slice(0,start).join('\n');
    const aft=lines.slice(end+1).join('\n');
    ed.value=(bef?(bef+'\n'):'')+this._renderHTMLTable(cells2,allRows.length,cols2)+(aft?('\n'+aft):'');
    App.render();US.snap();
  },

  mergeH(){this._doMerge('h');},
  mergeV(){this._doMerge('v');},

  // ì–¸ì–´ë³„ ì£¼ì„ ê¸°í˜¸ ë°˜í™˜  // ì–¸ì–´ë³„ ì£¼ì„ ê¸°í˜¸ ë°˜í™˜
  _cmt(lang){
    const hash=['python','r','ruby','bash','shell','sh','perl','yaml','toml','powershell','coffee'];
    const dash=['sql','haskell','lua','ada'];
    const pct=['matlab','latex','tex'];
    const semi=['lisp','clojure','scheme'];
    const html=['html','xml','markdown','md'];
    const l=lang.toLowerCase();
    if(hash.some(x=>l.startsWith(x)))return'#';
    if(dash.some(x=>l.startsWith(x)))return'--';
    if(pct.some(x=>l.startsWith(x)))return'%';
    if(semi.some(x=>l.startsWith(x)))return';';
    if(html.some(x=>l.startsWith(x)))return'<!--';
    return'//';// js, ts, java, c, cpp, go, swift, kotlin, rust, â€¦
  },
  // Direct code block with last used language (for Alt+C hotkey)
  codeBlockDirect(){
    const ed=this.ed(),s=ed.selectionStart,e=ed.selectionEnd;
    const cmt=this._cmt(lastCodeLang);
    const placeholder=cmt==='<!--'?`<!-- ì½”ë“œ ì…ë ¥ -->`:cmt+' ì½”ë“œ ì…ë ¥';
    const sel=ed.value.substring(s,e)||placeholder;
    ins(ed,s,e,`\n\`\`\`${lastCodeLang}\n${sel}\n\`\`\`\n`);
  },
  // Code block from modal (toolbar âŒ¨ button)
  codeBlockModal(){
    const lang=el('code-lang').value;lastCodeLang=lang||lastCodeLang;
    const ed=this.ed(),s=ed.selectionStart,e=ed.selectionEnd;
    const cmt=this._cmt(lastCodeLang);
    const placeholder=cmt==='<!--'?`<!-- ì½”ë“œ ì…ë ¥ -->`:cmt+' ì½”ë“œ ì…ë ¥';
    const sel=ed.value.substring(s,e)||placeholder;
    ins(ed,s,e,`\n\`\`\`${lastCodeLang}\n${sel}\n\`\`\`\n`);
    App.hideModal('code-modal');
  },
  pageBreak(){const ed=this.ed(),s=ed.selectionStart;ins(ed,s,s,'\n\n<div class="page-break"></div>\n\n')},
  lineBreak(){const ed=this.ed(),s=ed.selectionStart;ins(ed,s,s,'<br>\n')},
  link(){const text=el('link-text').value||'ë§í¬';const url=el('link-url').value||'#';const ed=this.ed(),s=ed.selectionStart;ins(ed,s,s,`[${text}](${url})`);App.hideModal('link-modal');el('link-text').value='';el('link-url').value=''},
  image(){const alt=el('img-alt').value||'ì´ë¯¸ì§€';const url=el('img-url').value||'#';const ed=this.ed(),s=ed.selectionStart;ins(ed,s,s,`![${alt}](${url})`);el('img-alt').value='';el('img-url').value='';App.hideModal('image-modal')},
  math(){const ed=this.ed(),s=ed.selectionStart,e=ed.selectionEnd,sel=ed.value.substring(s,e);ins(ed,s,e,sel?`$$\n${sel}\n$$`:'\n$$\n\\phi = \\frac{\\lambda_2}{c^2}\n$$\n')},
  footnote(){
    const ed=this.ed();
    const pos=ed.selectionStart;
    const val=ed.value;
    const n=Math.floor((val.match(/\[\^\d+\]/g)||[]).length/2)+1;
    const marker=`[^${n}]`;
    const defLine=`\n[^${n}]: <span style="font-size:9pt">ê°ì£¼ ë‚´ìš©.</span>`;
    ed.value=val.substring(0,pos)+marker+val.substring(pos)+defLine;
    ed.setSelectionRange(pos+marker.length,pos+marker.length);
    App.render();US.snap();
  },
  dupLine(){
    const ed=this.ed();
    const s=ed.selectionStart,e=ed.selectionEnd;
    if(s!==e){
      // ì„ íƒ ì˜ì—­ì´ ìˆìœ¼ë©´ â€” ì„ íƒí•œ í…ìŠ¤íŠ¸ë¥¼ ê·¸ëŒ€ë¡œ ë³µì œí•´ì„œ ë°”ë¡œ ë’¤ì— ì‚½ì…
      const sel=ed.value.substring(s,e);
      // ì¤„ ê²½ê³„ì— ë§ê²Œ: ì„ íƒ ë ìœ„ì¹˜ ë’¤ì— ì‚½ì…
      // ì„ íƒì´ ì¤„ ì¤‘ê°„ì¼ ìˆ˜ë„ ìˆìœ¼ë¯€ë¡œ ê·¸ëƒ¥ ì„ íƒ ì§í›„ì— ë¶™ì„
      const insert='\n'+sel;
      ed.value=ed.value.substring(0,e)+insert+ed.value.substring(e);
      // ë³µì œëœ ë¶€ë¶„ì„ ì„ íƒ ìƒíƒœë¡œ í‘œì‹œ
      ed.setSelectionRange(e+1,e+1+sel.length);
      ed.focus();App.render();US.snap();
    }else{
      // ì„ íƒ ì—†ìœ¼ë©´ ì»¤ì„œê°€ ìˆëŠ” ì¤„ ë³µì œ (ê¸°ì¡´ ë™ì‘)
      const{le,text}=getCL(ed);
      ins(ed,le,le,'\n'+text);
    }
  },
  // Alt+â†‘/â†“ â€” í˜„ì¬ ì¤„(ë˜ëŠ” ì„ íƒ ì¤„ë“¤)ì„ ìœ„/ì•„ë˜ë¡œ ì´ë™
  moveLine(dir){
    const ed=this.ed();const val=ed.value;
    const ss=ed.selectionStart,se=ed.selectionEnd;
    const lines=val.split('\n');
    // ì„ íƒ ë²”ìœ„ì— í•´ë‹¹í•˜ëŠ” ì¤„ ì¸ë±ìŠ¤ ê³„ì‚°
    let pos=0,startLine=-1,endLine=-1;
    for(let i=0;i<lines.length;i++){
      const lstart=pos,lend=pos+lines[i].length;
      if(startLine===-1&&ss<=lend)startLine=i;
      if(ss!==se?se-1<=lend:ss<=lend){endLine=i;if(ss===se)break;}
      pos+=lines[i].length+1;
    }
    if(startLine<0)startLine=0;if(endLine<0)endLine=startLine;
    if(dir===-1&&startLine===0)return;// ë§¨ ìœ„
    if(dir===1&&endLine===lines.length-1)return;// ë§¨ ì•„ë˜
    // ì´ë™í•  ì¤„ ë©ì–´ë¦¬ ì¶”ì¶œ
    const block=lines.splice(startLine,endLine-startLine+1);
    const insertAt=dir===-1?startLine-1:startLine;
    lines.splice(insertAt,0,...block);
    // ìƒˆ ì»¤ì„œ ìœ„ì¹˜ ê³„ì‚°
    let newPos=0;for(let i=0;i<insertAt;i++)newPos+=lines[i].length+1;
    const newSS=newPos+(ss-val.split('\n').slice(0,startLine).join('\n').length-(startLine>0?1:0));
    const blockLen=block.join('\n').length;
    ed.value=lines.join('\n');
    // ì´ë™ëœ ì¤„ ì „ì²´ ì„ íƒ
    let nstart=0;for(let i=0;i<insertAt;i++)nstart+=lines[i].length+1;
    let nend=nstart;for(let i=0;i<block.length;i++)nend+=lines[insertAt+i].length+(i<block.length-1?1:0);
    ed.setSelectionRange(nstart,nend);
    ed.focus();App.render();US.snap();
  },
  tabInTable(ed,ev){const val=ed.value,pos=ed.selectionStart;const ls=val.lastIndexOf('\n',pos-1)+1,le=val.indexOf('\n',pos);const ln=val.substring(ls,le===-1?val.length:le);if(!ln.trim().startsWith('|'))return false;ev.preventDefault();const pipes=[];for(let i=ls;i<(le===-1?val.length:le);i++)if(val[i]==='|')pipes.push(i);const nx=pipes.find(p=>p>pos),nn=nx!==undefined?pipes.find(p=>p>nx):undefined;if(nx!==undefined&&nn!==undefined)ed.setSelectionRange(nx+1,nn);return true},
  enterInTable(ed,ev){const val=ed.value,pos=ed.selectionStart;const ls=val.lastIndexOf('\n',pos-1)+1,le=val.indexOf('\n',pos);const ln=val.substring(ls,le===-1?val.length:le);if(!ln.trim().startsWith('|')||/^\|[\s:|-]+\|$/.test(ln.trim()))return false;ev.preventDefault();const cols=ln.split('|').filter(c=>c.trim()!=='').length;ins(ed,le===-1?val.length:le,le===-1?val.length:le,'\n|'+' ì…€ |'.repeat(cols));return true},
};

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FONT SIZE MANAGER  (ì„ íƒ í…ìŠ¤íŠ¸ì— í¬ê¸° ì ìš©)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const FS=(()=>{
  const SIZES=[8,9,10,11,12,13,14,15,16,18,20,22,24,28,32,36,40,48,50];
  let cur=4;// ê¸°ë³¸ 12pt

  function updateDisplay(){
    el('fsize-display').textContent=SIZES[cur]+'pt';
  }

  function apply(){
    const pt=SIZES[cur];
    const ed=el('editor');
    const s=ed.selectionStart,e=ed.selectionEnd;
    const sel=ed.value.substring(s,e)||'í…ìŠ¤íŠ¸';
    ins(ed,s,e,`<span style="font-size:${pt}pt">${sel}</span>`);
  }

  function inc(){if(cur<SIZES.length-1){cur++;updateDisplay();apply()}}
  function dec(){if(cur>0){cur--;updateDisplay();apply()}}

  // í•œë²ˆ í´ë¦­ â†’ ë“œë¡­ë‹¤ìš´ í”½ì»¤
  let _picker=null;
  function clickPick(ev){
    ev.stopPropagation();
    if(_picker){_picker.remove();_picker=null;return}
    const rect=el('fsize-display').getBoundingClientRect();
    const div=document.createElement('div');
    div.style.cssText=`position:fixed;left:${rect.left}px;top:${rect.bottom+2}px;background:var(--bg2);border:1px solid var(--bd);border-radius:6px;box-shadow:0 6px 24px rgba(0,0,0,.4);z-index:9999;overflow:hidden;min-width:70px`;
    div.innerHTML=SIZES.map((s,i)=>`<div data-i="${i}" style="padding:5px 14px;font-family:var(--fm);font-size:12px;cursor:pointer;color:${i===cur?'var(--ac)':'var(--tx)'};background:${i===cur?'var(--acg)':'transparent'};transition:background .1s" onmouseenter="this.style.background='var(--bg5)'" onmouseleave="this.style.background='${i===cur?'var(--acg)':'transparent'}'" onclick="FS.pickSize(${i},event)">${s}pt</div>`).join('');
    document.body.appendChild(div);_picker=div;
    setTimeout(()=>document.addEventListener('click',_closePicker,{once:true}),10);
  }
  function _closePicker(){if(_picker){_picker.remove();_picker=null}}
  function pickSize(i,ev){if(ev)ev.stopPropagation();cur=i;updateDisplay();_closePicker();apply()}

  // ë‘ë²ˆ í´ë¦­ â†’ ì¸ë¼ì¸ ì§ì ‘ ì…ë ¥
  function startEdit(ev){
    ev.stopPropagation();_closePicker();
    const disp=el('fsize-display'),inp=el('fsize-input');
    inp.value=SIZES[cur];
    disp.style.display='none';inp.style.display='inline-block';
    inp.focus();inp.select();
  }
  function endEdit(){
    const inp=el('fsize-input'),disp=el('fsize-display');
    const v=parseInt(inp.value);
    if(v>=6&&v<=200){
      // find nearest or add
      let best=0,bDiff=999;
      SIZES.forEach((s,i)=>{const d=Math.abs(s-v);if(d<bDiff){bDiff=d;best=i}});
      cur=best;updateDisplay();apply();
    }
    inp.style.display='none';disp.style.display='';
  }
  function editKey(ev){if(ev.key==='Enter')el('fsize-input').blur();if(ev.key==='Escape'){el('fsize-input').style.display='none';el('fsize-display').style.display='';}}

  function update(){updateDisplay()}
  return{inc,dec,update,clickPick,pickSize,startEdit,endEdit,editKey};
})();

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FORMAT QUICK PANEL (Alt+L)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const FP=(()=>{
  let vis=false;
  function show(){
    const panel=el('fmt-panel');
    if(vis){hide();return}
    // position near toolbar
    const tb=document.querySelector('#toolbar');
    const rect=tb.getBoundingClientRect();
    panel.style.left='50%';panel.style.top=(rect.bottom+4)+'px';
    panel.style.transform='translateX(-50%)';
    panel.classList.add('vis');vis=true;
    setTimeout(()=>document.addEventListener('click',_outside,{once:true}),10);
  }
  function hide(){el('fmt-panel').classList.remove('vis');vis=false}
  function _outside(e){if(!el('fmt-panel').contains(e.target))hide();else setTimeout(()=>document.addEventListener('click',_outside,{once:true}),10)}

  function fsz(dir){
    const sel=el('fp-fsize');
    const idx=sel.selectedIndex;
    const ni=Math.max(0,Math.min(sel.options.length-1,idx+dir));
    sel.selectedIndex=ni;applyFsize();
  }
  function applyFsize(){
    const size=el('fp-fsize').value;
    const ed=el('editor');const s=ed.selectionStart,e=ed.selectionEnd;
    const sel2=ed.value.substring(s,e)||'í…ìŠ¤íŠ¸';
    ins(ed,s,e,`<span style="font-size:${size}">${sel2}</span>`);
  }
  function setFc(c){el('fp-fc').value=c==='#e8e8f0'?'#e8e8f0':c;applyColor()}
  function applyColor(){
    const c=el('fp-fc').value;
    const ed=el('editor');const s=ed.selectionStart,e=ed.selectionEnd;
    const sel2=ed.value.substring(s,e)||'í…ìŠ¤íŠ¸';
    ins(ed,s,e,`<span style="color:${c}">${sel2}</span>`);
  }
  function setHL(c){if(c==='none'){applyHLnone();return}el('fp-hl').value=c;applyHL()}
  function applyHL(){
    const c=el('fp-hl').value;
    const ed=el('editor');const s=ed.selectionStart,e=ed.selectionEnd;
    const sel2=ed.value.substring(s,e)||'í…ìŠ¤íŠ¸';
    ins(ed,s,e,`<span style="background:${c}">${sel2}</span>`);
  }
  function applyHLnone(){
    const ed=el('editor');const s=ed.selectionStart,e=ed.selectionEnd;
    const sel2=ed.value.substring(s,e);
    if(sel2)ins(ed,s,e,sel2.replace(/<span style="background:[^"]*">(.*?)<\/span>/gs,'$1'));
  }
  return{show,hide,fsz,applyFsize,setFc,applyColor,setHL,applyHL};
})();

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   APA STATISTICS INSERTER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const STATS=(()=>{
  const CUSTOM_KEY='mdpro_custom_stats';
  let curType='ttest';
  let customList=[];

  const TYPES={
    ttest:{
      label:'t-test',
      fields:[
        {id:'df',label:'df',ph:'ììœ ë„',req:true},
        {id:'t',label:'t',ph:'tê°’',req:true},
        {id:'p',label:'p',ph:'pê°’',req:true},
        {id:'d',label:"Cohen's d",ph:'íš¨ê³¼í¬ê¸° (ì„ íƒ)',req:false},
      ],
      fmt:(v)=>{
        let s=`(t(${v.df}) = ${v.t}, p = ${fmtP(v.p)}`;
        if(v.d)s+=`, d = ${v.d}`;
        return s+')';
      }
    },
    anova:{
      label:'ANOVA',
      fields:[
        {id:'df1',label:'dfâ‚',ph:'ì²˜ë¦¬ ììœ ë„',req:true},
        {id:'df2',label:'dfâ‚‚',ph:'ì˜¤ì°¨ ììœ ë„',req:true},
        {id:'F',label:'F',ph:'Fê°’',req:true},
        {id:'p',label:'p',ph:'pê°’',req:true},
        {id:'np2',label:'Î·Â²p',ph:'ë¶€ë¶„ ì—íƒ€ì œê³± (ì„ íƒ)',req:false},
      ],
      fmt:(v)=>{
        let s=`(F(${v.df1}, ${v.df2}) = ${v.F}, p = ${fmtP(v.p)}`;
        if(v.np2)s+=`, Î·Â²p = ${v.np2}`;
        return s+')';
      }
    },
    regression:{
      label:'Regression',
      fields:[
        {id:'beta',label:'Î² (í‘œì¤€í™”)',ph:'ë² íƒ€ (ì„ íƒ)',req:false},
        {id:'B',label:'B (ë¹„í‘œì¤€í™”)',ph:'B (ì„ íƒ)',req:false},
        {id:'SE',label:'SE',ph:'í‘œì¤€ì˜¤ì°¨ (ì„ íƒ)',req:false},
        {id:'t',label:'t',ph:'tê°’',req:true},
        {id:'p',label:'p',ph:'pê°’',req:true},
      ],
      fmt:(v)=>{
        const parts=[];
        if(v.beta)parts.push(`Î² = ${v.beta}`);
        if(v.B)parts.push(`B = ${v.B}`);
        if(v.SE)parts.push(`SE = ${v.SE}`);
        parts.push(`t = ${v.t}`);
        parts.push(`p = ${fmtP(v.p)}`);
        return '('+parts.join(', ')+')';
      }
    },
    correlation:{
      label:'Correlation',
      fields:[
        {id:'r',label:'r',ph:'ìƒê´€ê³„ìˆ˜',req:true},
        {id:'df',label:'df',ph:'ììœ ë„ (ì„ íƒ)',req:false},
        {id:'p',label:'p',ph:'pê°’',req:true},
      ],
      fmt:(v)=>{
        let s=v.df?`(r(${v.df}) = ${v.r}`:`(r = ${v.r}`;
        s+=`, p = ${fmtP(v.p)})`;
        return s;
      }
    },
    chisq:{
      label:'Chi-square',
      fields:[
        {id:'df',label:'df',ph:'ììœ ë„',req:true},
        {id:'chisq',label:'Ï‡Â²',ph:'ì¹´ì´ì œê³±ê°’',req:true},
        {id:'p',label:'p',ph:'pê°’',req:true},
        {id:'V',label:"Cramer's V",ph:'íš¨ê³¼í¬ê¸° (ì„ íƒ)',req:false},
      ],
      fmt:(v)=>{
        let s=`(Ï‡Â²(${v.df}) = ${v.chisq}, p = ${fmtP(v.p)}`;
        if(v.V)s+=`, Cramer's V = ${v.V}`;
        return s+')';
      }
    },
    sem:{
      label:'SEM',
      fields:[
        {id:'beta',label:'Î² (í‘œì¤€í™”)',ph:'ë² íƒ€ (ì„ íƒ)',req:false},
        {id:'b',label:'b (ë¹„í‘œì¤€í™”)',ph:'b (ì„ íƒ)',req:false},
        {id:'SE',label:'SE',ph:'í‘œì¤€ì˜¤ì°¨ (ì„ íƒ)',req:false},
        {id:'z',label:'z',ph:'zê°’',req:true},
        {id:'p',label:'p',ph:'pê°’',req:true},
      ],
      fmt:(v)=>{
        const parts=[];
        if(v.beta)parts.push(`Î² = ${v.beta}`);
        if(v.b)parts.push(`b = ${v.b}`);
        if(v.SE)parts.push(`SE = ${v.SE}`);
        parts.push(`z = ${v.z}`);
        parts.push(`p = ${fmtP(v.p)}`);
        return '('+parts.join(', ')+')';
      }
    },
    logistic:{
      label:'Logistic Regression',
      fields:[
        {id:'OR',label:'OR',ph:'ì˜¤ì¦ˆë¹„',req:true},
        {id:'CI_low',label:'95% CI í•˜í•œ',ph:'í•˜í•œê°’',req:true},
        {id:'CI_high',label:'95% CI ìƒí•œ',ph:'ìƒí•œê°’',req:true},
        {id:'p',label:'p',ph:'pê°’',req:true},
      ],
      fmt:(v)=>`(OR = ${v.OR}, 95% CI [${v.CI_low}, ${v.CI_high}], p = ${fmtP(v.p)})`
    },
    multilevel:{
      label:'Multilevel (HLM)',
      fields:[
        {id:'gamma',label:'Î³',ph:'ê°ë§ˆ ê³„ìˆ˜',req:true},
        {id:'SE',label:'SE',ph:'í‘œì¤€ì˜¤ì°¨',req:true},
        {id:'t',label:'t',ph:'tê°’',req:true},
        {id:'p',label:'p',ph:'pê°’',req:true},
      ],
      fmt:(v)=>`(Î³ = ${v.gamma}, SE = ${v.SE}, t = ${v.t}, p = ${fmtP(v.p)})`
    },
  };

  function fmtP(p){
    if(!p)return'?';
    const n=parseFloat(p);
    if(isNaN(n))return p;
    if(n<.001)return'< .001';
    if(n<.01)return n.toFixed(3).replace('0.','. ').replace(/ /,'');
    return n.toFixed(3).replace('0.','.').replace(/0+$/,'').replace(/\.$/,'');
  }

  function loadCustom(){try{customList=JSON.parse(localStorage.getItem(CUSTOM_KEY)||'[]')}catch(e){customList=[]}}
  function saveCustomList(){try{localStorage.setItem(CUSTOM_KEY,JSON.stringify(customList))}catch(e){}}

  function renderFields(type){
    const area=el('stats-fields');
    const customArea=el('stats-custom-area');
    if(type==='custom'){
      area.style.display='none';
      customArea.style.display='block';
      renderCustomSavedSel();
      updateCustomVars();
    }else{
      area.style.display='grid';
      customArea.style.display='none';
      const t=TYPES[type];if(!t)return;
      area.innerHTML=t.fields.map(f=>`
        <div class="fg" style="margin:0">
          <label class="fl">${f.label}${f.req?'':' <span style="color:var(--tx3)">(ì„ íƒ)</span>'}</label>
          <input class="fi" id="sf_${f.id}" type="text" placeholder="${f.ph}" oninput="STATS.preview()" style="padding:5px 8px">
        </div>`).join('');
    }
    preview();
  }

  function preview(){
    const pv=el('stats-preview');
    try{
      if(curType==='custom'){
        const fmt=el('custom-fmt').value;
        const vars=(el('custom-vars').value||'').split(',').map(s=>s.trim()).filter(Boolean);
        const vals={};
        vars.forEach(v=>{const inp=el('cfsf_'+v);vals[v]=inp?inp.value.trim():'';});
        let out=fmt;
        vars.forEach(v=>{if(vals[v])out=out.replaceAll('{'+v+'}',vals[v]);});
        pv.textContent=out||'(ì¶œë ¥ ë¯¸ë¦¬ë³´ê¸°)';
      }else{
        const t=TYPES[curType];if(!t){pv.textContent='';return}
        const vals={};
        t.fields.forEach(f=>{const inp=el('sf_'+f.id);vals[f.id]=inp?inp.value.trim():'';});
        pv.textContent=t.fmt(vals);
      }
    }catch(e){pv.textContent='ì…ë ¥ê°’ ì˜¤ë¥˜'}
  }

  function setType(type){
    curType=type;
    document.querySelectorAll('#stats-type-row .btn-tog').forEach(b=>b.classList.remove('active'));
    const btn=el('st-'+type);if(btn)btn.classList.add('active');
    renderFields(type);
  }

  function insert(){
    const pv=el('stats-preview').textContent;
    if(!pv||(pv==='(ì¶œë ¥ ë¯¸ë¦¬ë³´ê¸°)'&&curType==='custom'))return;
    const ed=el('editor');const pos=ed.selectionEnd;
    ed.value=ed.value.substring(0,pos)+pv+ed.value.substring(pos);
    ed.setSelectionRange(pos+pv.length,pos+pv.length);
    ed.focus();App.render();US.snap();
    App.hideModal('stats-modal');
  }

  function updateCustomVars(){
    const vars=(el('custom-vars').value||'').split(',').map(s=>s.trim()).filter(Boolean);
    const area=el('custom-fields');
    area.innerHTML=vars.map(v=>`
      <div class="fg" style="margin:0">
        <label class="fl">${v}</label>
        <input class="fi" id="cfsf_${v}" type="text" placeholder="${v} ê°’" oninput="STATS.preview()" style="padding:5px 8px">
      </div>`).join('');
    preview();
  }

  function saveCustom(){
    const name=(el('custom-name').value||'').trim();
    const fmt=(el('custom-fmt').value||'').trim();
    const vars=(el('custom-vars').value||'').trim();
    if(!name||!fmt){alert('ì´ë¦„ê³¼ í¬ë§·ì„ ì…ë ¥í•˜ì„¸ìš”.');return}
    const existing=customList.findIndex(c=>c.name===name);
    const entry={name,fmt,vars};
    if(existing>=0)customList[existing]=entry;
    else customList.push(entry);
    saveCustomList();
    renderCustomSavedSel();
    el('custom-name').value='';
    alert(`"${name}" ì €ì¥ë¨`);
  }

  function deleteCustom(){
    const sel=el('custom-saved-sel').value;
    if(!sel)return;
    customList=customList.filter(c=>c.name!==sel);
    saveCustomList();
    renderCustomSavedSel();
    el('custom-name').value='';el('custom-fmt').value='';el('custom-vars').value='';
    el('custom-fields').innerHTML='';
    preview();
  }

  function loadCustom(name){
    if(!name)return;
    const c=customList.find(x=>x.name===name);
    if(!c)return;
    el('custom-name').value=c.name;
    el('custom-fmt').value=c.fmt;
    el('custom-vars').value=c.vars||'';
    updateCustomVars();
  }

  function renderCustomSavedSel(){
    const sel=el('custom-saved-sel');
    sel.innerHTML='<option value="">â€” ì €ì¥ëœ ì»¤ìŠ¤í…€ â€”</option>'+customList.map(c=>`<option value="${c.name}">${c.name}</option>`).join('');
  }

  function show(){
    loadCustom();
    el('stats-modal').classList.add('vis');
    setType(curType);
  }

  return{show,setType,preview,insert,updateCustomVars,saveCustom,deleteCustom,loadCustom};
})();

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HOTKEY ENGINE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function hkKey(e){const mac=navigator.platform.toUpperCase().includes('MAC');const ctrl=mac?e.metaKey:e.ctrlKey;const parts=[];if(ctrl)parts.push('C');if(e.shiftKey)parts.push('S');if(e.altKey)parts.push('A');parts.push(e.key.length===1?e.key.toUpperCase():e.key);return parts.join('+')}

function handleKey(e){
  const edi=el('editor');const inEd=document.activeElement===edi;const k=hkKey(e);
  // Global hotkeys
  if(k==='A+1'){e.preventDefault();App.setViewCycle('split');return}
  if(k==='A+2'){e.preventDefault();App.setViewCycle('editor');return}
  if(k==='A+3'){e.preventDefault();App.setViewCycle('preview');return}
  if(k==='S+A+9'){e.preventDefault();STATS.show();return}
  if(k==='A+L'){e.preventDefault();FP.show();return}
  if(k==='C+A+I'){e.preventDefault();LN.toggle();return}
  if(!inEd){if(k==='S+?'){e.preventDefault();App.showHK()}return}
  if(k==='C+Z'){e.preventDefault();US.undo();return}
  if(k==='C+S+Z'||k==='C+Y'){e.preventDefault();US.redo();return}
  // Alt+ArrowUp/Down â€” move line
  if(k==='A+ArrowUp'){e.preventDefault();ED.moveLine(-1);return}
  if(k==='A+ArrowDown'){e.preventDefault();ED.moveLine(1);return}
  if(e.key==='Tab'){if(ED.tabInTable(edi,e))return}
  const map={
    'C+B':()=>ED.bold(),'C+I':()=>ED.italic(),'C+.':()=>ED.bquote(),
    'C+Enter':()=>ED.pageBreak(),'C+S+Enter':()=>ED.lineBreak(),
    'C+A+1':()=>ED.h(1),'C+A+2':()=>ED.h(2),'C+A+3':()=>ED.h(3),
    'S+A+L':()=>ED.align('left'),'S+A+C':()=>ED.align('center'),'S+A+R':()=>ED.align('right'),
    'A+8':()=>ED.table(),'A+9':()=>ED.tableRow(),'A+0':()=>ED.tableCol(),
    'S+A+H':()=>ED.mergeH(),'S+A+V':()=>ED.mergeV(),
    'S+A+N':()=>ED.footnote(),
    'A+C':()=>ED.codeBlockDirect(),
    'A+V':()=>ED.inlineCode(),
    'S+A+.':()=>FS.inc(),'S+A+>':()=>FS.inc(),
    'S+A+,':()=>FS.dec(),'S+A+<':()=>FS.dec(),
    'S+A+ArrowDown':()=>ED.dupLine(),
    'C+S':()=>App.showSaveDlg(),'C+F':()=>App.toggleFind(),
    'C+S+P':()=>PW.open(),'C+S+R':()=>App.toggleRM(),'C+S+C':()=>App.showCite(),'C+S+G':()=>Scholar.show(),
    'S+?':()=>App.showHK(),
  };
  if(map[k]){e.preventDefault();map[k]()}
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TOOLTIP
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function initTooltip(){
  const tip=el('tooltip');let t;
  document.addEventListener('mouseover',e=>{const target=e.target.closest('[data-tooltip]');if(!target)return;clearTimeout(t);t=setTimeout(()=>{const key=target.dataset.key;tip.innerHTML=target.dataset.tooltip+(key?` <span class="tt-key">${key}</span>`:'');tip.classList.add('vis');let x=e.clientX+12,y=e.clientY+16;if(x+260>window.innerWidth)x=e.clientX-260;if(y+40>window.innerHeight)y=e.clientY-40;tip.style.left=x+'px';tip.style.top=y+'px'},300)});
  document.addEventListener('mouseout',()=>{clearTimeout(t);tip.classList.remove('vis')});
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ERROR DETECTION
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function detectErrors(md){
  const errs=[];const lines=md.split('\n');
  lines.forEach((l,i)=>{if(l.startsWith('|')){const cols=l.split('|').filter(c=>c.trim()!=='').length;if(i>0&&lines[i-1].startsWith('|')){const p=lines[i-1].split('|').filter(c=>c.trim()!=='').length;if(p!==cols&&!l.includes('---')&&!lines[i-1].includes('---'))errs.push(`ì¤„ ${i+1}: í‘œ ì—´ ë¶ˆì¼ì¹˜ (ì´ì „ ${p}, í˜„ì¬ ${cols})`)}}});
  if((md.match(/^```/gm)||[]).length%2!==0)errs.push('ì½”ë“œ ë¸”ë¡ ë¯¸ë‹«í˜ (``` ëˆ„ë½)');
  return errs;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MAIN APP
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const App={
  rm:false,rt:null,colorMode:'text',capType:'table',

  init(){
    AS.load();CM.load();initTooltip();SS.init();FS.update();
    // Set default view button state
    const splitBtn=el('vm-split');if(splitBtn)splitBtn.classList.add('active');
    const edi=el('editor');
    edi.addEventListener('input',()=>{US.snap();this.render()});
    edi.addEventListener('keydown',handleKey);
    edi.addEventListener('keyup',()=>this.updCursor());
    edi.addEventListener('click',()=>this.updCursor());
    edi.addEventListener('scroll',()=>LN.update(),{passive:true});
    document.addEventListener('selectionchange',()=>{if(document.activeElement===edi)this.updFmtBtns()});
    document.addEventListener('keydown',e=>{if(document.activeElement!==edi)handleKey(e)});
    el('doc-title').addEventListener('input',()=>this.render());
    setInterval(()=>PW.checkClosed(),2000);

    // Build template grid
    el('tmpl-grid').innerHTML=TMPLS.map((t,i)=>`<div class="tmpl-card" onclick="App.insertTmpl(${i})"><h4>${t.icon} ${t.name}</h4><p>${t.desc}</p></div>`).join('');

    if(!edi.value)edi.value=this.sample();
    this.render();US.snap();
  },

  render(){
    const edi=el('editor');const md=edi.value,title=el('doc-title').value;
    clearTimeout(this.rt);
    this.rt=setTimeout(()=>{
      PR.render(md);TOC.build(md);
      const errs=detectErrors(md);this.showErrs(errs);
      const words=md.trim()?md.trim().split(/\s+/).length:0;
      el('sw').textContent=words.toLocaleString()+' ë‹¨ì–´';
      el('sc').textContent=md.length.toLocaleString()+' ì';
      el('sp').textContent='ì•½ '+Math.ceil(words/250)+' í˜ì´ì§€';
      LN.update();
      el('render-ts').textContent=new Date().toLocaleTimeString();
      AS.save(md,title);
      PW.sync();
    },120);
    this.updCursor();
  },

  updCursor(){const edi=el('editor');const t=edi.value.substring(0,edi.selectionStart),ls=t.split('\n');el('cursor-pos').textContent=`ì¤„ ${ls.length}, ì—´ ${ls[ls.length-1].length+1}`;const sl=edi.selectionEnd-edi.selectionStart;el('sel-info').textContent=sl>0?`${sl}ì ì„ íƒ`:''},
  updFmtBtns(){const edi=el('editor'),s=edi.selectionStart,e=edi.selectionEnd;const b2=edi.value.substring(s-2,s),a2=edi.value.substring(e,e+2);const b3=edi.value.substring(s-3,s),a4=edi.value.substring(e,e+4);el('bold-btn').classList.toggle('active',(b2==='**'&&a2==='**')||(b3==='<b>'&&a4==='</b>'));const b1=edi.value.substring(s-1,s),a1=edi.value.substring(e,e+1);el('italic-btn').classList.toggle('active',b1==='*'&&a1==='*')},
  showErrs(errs){const ec=el('error-count'),sep=el('ec-sep'),list=el('ep-list'),panel=el('error-panel');if(!errs.length){ec.textContent='';sep.style.display='none';panel.classList.remove('vis');return}ec.textContent=`âš  ${errs.length}ê°œ ì˜¤ë¥˜`;sep.style.display='block';list.innerHTML=errs.map(e=>`<div class="error-item">${e}</div>`).join('')},
  toggleErr(){el('error-panel').classList.toggle('vis')},closeErr(){el('error-panel').classList.remove('vis')},
  toggleSidebar(){el('app').classList.toggle('ns')},
  setView(m){el('editor-pane').classList.toggle('hidden',m==='preview');el('preview-pane').classList.toggle('hidden',m==='editor')},
  setViewCycle(m){
    this.setView(m);
    ['split','editor','preview'].forEach(v=>{const b=el('vm-'+v);if(b)b.classList.toggle('active',v===m)});
  },
  toggleTheme(){document.documentElement.dataset.theme=document.documentElement.dataset.theme==='light'?'':'light'},
  toggleRM(){this.rm=!this.rm;el('rm-badge').classList.toggle('vis',this.rm);el('mode-ind').textContent=this.rm?'RESEARCH':'NORMAL';PR.rm=this.rm;PW.setRM(this.rm);this.render()},
  showHK(){el('hk-overlay').classList.add('vis')},hideHK(){el('hk-overlay').classList.remove('vis')},
  showCode(){el('code-modal').classList.add('vis')},
  showLink(){el('link-modal').classList.add('vis');setTimeout(()=>el('link-text').focus(),50)},
  showImg(){
    // reset drop zone
    el('img-drop-text').textContent='ğŸ–¼ ì´ë¯¸ì§€ë¥¼ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•´ì„œ ì„ íƒ';
    el('img-drop-text').style.color='';
    el('img-preview-wrap').style.display='none';
    el('img-dropzone').style.borderColor='';el('img-dropzone').style.background='';
    el('image-modal').classList.add('vis');setTimeout(()=>el('img-alt').focus(),50);
  },
  showCite(){CM.open();el('cite-modal').classList.add('vis')},
  showStats(){STATS.show()},
  showSaveDlg(){el('save-modal').classList.add('vis')},
  hideModal(id){el(id).classList.remove('vis')},
  openColorPicker(m){ColorPicker.open(m)},
  applyColor(){ColorPicker.apply()},
  showCaption(type){CAP.show(type)},
  updateCapPreview(){CAP.updatePreview()},
  insertCaption(){CAP.insert()},
  showTmpl(){el('tmpl-modal').classList.add('vis')},
  insertTmpl(i){
    const t=TMPLS[i];
    if(!confirm(`"${t.name}" ì–‘ì‹ì„ í˜„ì¬ ë¬¸ì„œì— ì¶”ê°€í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`))return;
    const edi=el('editor');edi.value=(edi.value.trim()?edi.value+'\n\n---\n\n':'')+t.content;
    this.render();US.snap();App.hideModal('tmpl-modal');
  },

  toggleFind(){const bar=el('find-bar');bar.classList.toggle('vis');if(bar.classList.contains('vis'))el('fi').focus()},
  findKey(e){if(e.key==='Enter')this.findNext();if(e.key==='Escape')this.toggleFind()},
  findNext(){const q=el('fi').value;if(!q)return;const edi=el('editor');const idx=edi.value.indexOf(q,edi.selectionEnd);const fi2=idx===-1?edi.value.indexOf(q):idx;if(fi2!==-1){edi.setSelectionRange(fi2,fi2+q.length);edi.focus()}const cnt=(edi.value.match(new RegExp(q.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'),'g'))||[]).length;el('fc-cnt').textContent=cnt?`${cnt}ê±´`:q?'ì—†ìŒ':''},
  replaceOne(){const q=el('fi').value,r=el('ri').value;if(!q)return;const edi=el('editor'),s=edi.selectionStart,e=edi.selectionEnd;if(edi.value.substring(s,e)===q){edi.value=edi.value.substring(0,s)+r+edi.value.substring(e);this.render()}else this.findNext()},
  replaceAll(){const q=el('fi').value,r=el('ri').value;if(!q)return;const edi=el('editor');const cnt=(edi.value.match(new RegExp(q.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'),'g'))||[]).length;edi.value=edi.value.replaceAll(q,r);this.render();US.snap();el('fc-cnt').textContent=`${cnt}ê±´ êµì²´ë¨`},

  saveMD(){const c=el('editor').value,t=el('doc-title').value.replace(/[^a-z0-9ê°€-í£]/gi,'_');dlBlob(c,`${t}.md`,'text/markdown');this.hideModal('save-modal')},
  saveTXT(){const c=el('editor').value.replace(/[#*_`~>|]/g,'').replace(/\[(.*?)\]\(.*?\)/g,'$1').replace(/<[^>]+>/g,'');dlBlob(c,(el('doc-title').value||'document').replace(/[^a-z0-9ê°€-í£]/gi,'_')+'.txt','text/plain;charset=utf-8');this.hideModal('save-modal')},
  saveHTML(){
    const md=el('editor').value;const title=el('doc-title').value;
    const showFn=el('show-footnotes-chk').checked;
    const pages=splitPages(md);
    const html=pages.map((p,i)=>`<div class="preview-page${this.rm?' rm':''}" data-page="${i+1}">${mdRender(p,showFn)}</div>`).join('');
    const CSS=`body{font-family:sans-serif;background:#6a6e7e;display:flex;flex-direction:column;align-items:center;padding:20px 0 40px}.preview-page{width:210mm;min-height:297mm;background:white;color:#1a1a2e;padding:22mm 18mm;box-shadow:0 4px 30px rgba(0,0,0,.4);font-family:'Libre Baskerville',Georgia,serif;font-size:11pt;line-height:1.8;word-break:break-word;position:relative;margin-bottom:20px}.preview-page::after{content:"â€” " attr(data-page) " â€”";position:absolute;bottom:10mm;left:50%;transform:translateX(-50%);font-family:sans-serif;font-size:9pt;color:#bbb}.preview-page h1{font-size:21pt;font-weight:700;margin:0 0 14px;border-bottom:2px solid #1a1a2e;padding-bottom:8px}.preview-page h2{font-size:15pt;margin:20px 0 10px;font-weight:700}.preview-page h3{font-size:12pt;margin:16px 0 7px;font-weight:700}.preview-page p{margin:0 0 11px}.preview-page ul,.preview-page ol{margin:0 0 11px;padding-left:22px}.preview-page table{width:100%;border-collapse:collapse;margin:11px 0;font-size:10pt}.preview-page th{background:#1a1a2e;color:#fff;padding:7px 11px;text-align:left}.preview-page td{padding:6px 11px;border:1px solid #d0d0e0}.preview-page tr:nth-child(even) td{background:#f7f7fc}.preview-page code{font-family:monospace;font-size:9pt;background:#f0f0f8;padding:1px 4px;border-radius:3px;color:#5b4ce4}.preview-page pre{background:#1a1a2e;color:#e8e8f0;padding:14px;border-radius:6px;margin:11px 0;font-size:9pt}.preview-page pre code{background:none;color:inherit}.preview-page a{color:#5b4ce4}.preview-page img{max-width:100%}.preview-page .footnote-highlight{background:#f0f0f0;color:#1a1a2e;border-radius:2px;padding:0 2px}.preview-page .footnote-def{background:#f5f5f5;color:#1a1a2e;border-left:3px solid #bbb;padding:4px 10px;margin:4px 0;font-size:9.5pt}.preview-page .footnotes-section{border-top:1px solid #d0d0e0;margin-top:24px;padding-top:10px;font-size:9.5pt;color:#444}@media print{body{background:none;padding:0}.preview-page{box-shadow:none;margin:0;page-break-after:always;width:100%;min-height:0}.preview-page:last-child{page-break-after:auto}.preview-page::after{display:none}}`;
    const fullHtml=`<!DOCTYPE html><html lang="ko"><head><meta charset="UTF-8"><title>${title}</title><style>${CSS}</style></head><body>${html}</body></html>`;
    dlBlob(fullHtml,(el('doc-title').value||'document').replace(/[^a-z0-9ê°€-í£]/gi,'_')+'.html','text/html;charset=utf-8');
    this.hideModal('save-modal');
  },
  printDoc(){
    const md=el('editor').value;const title=el('doc-title').value;
    const showFn=document.getElementById('show-footnotes-chk')?el('show-footnotes-chk').checked:true;
    const pages=splitPages(md);
    const html=pages.map((p,i)=>`<div class="preview-page${this.rm?' rm':''}" data-page="${i+1}">${mdRender(p,showFn)}</div>`).join('');
    const CSS=`@import url('https://fonts.googleapis.com/css2?family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&family=JetBrains+Mono:wght@400;500&display=swap');*{box-sizing:border-box;margin:0;padding:0}body{font-family:sans-serif;background:#6a6e7e;display:flex;flex-direction:column;align-items:center;padding:20px 0 40px}.preview-page{width:210mm;min-height:297mm;background:white;color:#1a1a2e;padding:22mm 18mm;box-shadow:0 4px 30px rgba(0,0,0,.4);font-family:'Libre Baskerville',Georgia,serif;font-size:11pt;line-height:1.8;word-break:break-word;position:relative;margin-bottom:20px}.preview-page::after{content:"â€” " attr(data-page) " â€”";position:absolute;bottom:10mm;left:50%;transform:translateX(-50%);font-family:sans-serif;font-size:9pt;color:#bbb}.preview-page h1{font-size:21pt;font-weight:700;margin:0 0 14px;border-bottom:2px solid #1a1a2e;padding-bottom:8px}.preview-page h2{font-size:15pt;margin:20px 0 10px;font-weight:700}.preview-page h3{font-size:12pt;margin:16px 0 7px;font-weight:700}.preview-page p{margin:0 0 11px}.preview-page ul,.preview-page ol{margin:0 0 11px;padding-left:22px}.preview-page table{width:100%;border-collapse:collapse;margin:11px 0;font-size:10pt}.preview-page th{background:#1a1a2e;color:#fff;padding:7px 11px;text-align:left}.preview-page td{padding:6px 11px;border:1px solid #d0d0e0}.preview-page tr:nth-child(even) td{background:#f7f7fc}.preview-page code{font-family:'JetBrains Mono',monospace;font-size:9pt;background:#f0f0f8;padding:1px 4px;border-radius:3px;color:#5b4ce4}.preview-page pre{background:#1a1a2e;color:#e8e8f0;padding:14px;border-radius:6px;margin:11px 0;font-size:9pt}.preview-page pre code{background:none;color:inherit}.preview-page img{max-width:100%}.preview-page a{color:#5b4ce4}.preview-page .footnote-highlight{background:#f0f0f0;color:#1a1a2e;border-radius:2px;padding:0 2px}.preview-page .footnote-def{background:#f5f5f5;color:#1a1a2e;border-left:3px solid #bbb;padding:4px 10px;margin:4px 0;font-size:9.5pt}.preview-page .footnotes-section{border-top:1px solid #d0d0e0;margin-top:24px;padding-top:10px;font-size:9.5pt;color:#444}@media print{body{background:none;padding:0}.preview-page{box-shadow:none;margin:0;page-break-after:always;width:100%;min-height:0}.preview-page:last-child{page-break-after:auto}.preview-page::after{display:none}}`;
    const fullHtml=`<!DOCTYPE html><html lang="ko"><head><meta charset="UTF-8"><title>${title}</title><style>${CSS}</style></head><body>${html}<script>window.onload=function(){window.print();}<\/script></body></html>`;
    const w=window.open('','_blank','width=900,height=700');
    if(w){w.document.open();w.document.write(fullHtml);w.document.close();}
    else{alert('íŒì—…ì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤. íŒì—…ì„ í—ˆìš©í•´ ì£¼ì„¸ìš”.');}
    this.hideModal('save-modal');
  },

  sample(){return`# Markdown PDF Editor Pro V9

**ì œì‘: ë°•ì¤‘í¬(ì—°ì„¸ëŒ€í•™êµ ì‹¬ë¦¬í•™ê³¼ ê²¸ì„êµìˆ˜/ê²½ê¸°ëŒ€ êµì§í•™ë¶€ ê²¸ì„êµìˆ˜)**

- ë…¼ë¬¸ ì§‘í•„ì„ ìœ„í•œ ì—ë””í„°ë¡œ ì—°êµ¬ì™€ ë…¼ë¬¸ì„ ìœ„í•œ ë„êµ¬ì…ë‹ˆë‹¤.
- ê²½ê¸°ëŒ€í•™êµ êµìœ¡ì‚°ì—…ì „ê³µì
- ì—°ì„¸ëŒ€í•™êµ ì‹¬ë¦¬ê³¼í•™ ì´ë…¸ë² ì´ì…˜ ëŒ€í•™ì› ì‹¬ë¦¬íŠ¸ë™ ì „ê³µì

## ì´ë²ˆ ì—…ë°ì´íŠ¸ ì‹ ê¸°ëŠ¥

ëª¨ë“  ê¸°ëŠ¥ì´ í†µí•©ëœ **ì—°êµ¬Â·ë…¼ë¬¸ ì „ìš© ì—ë””í„°**ì…ë‹ˆë‹¤.

### ì£¼ìš” ê¸°ëŠ¥ ëª©ë¡

| ê¸°ëŠ¥ | ë‹¨ì¶•í‚¤ | ì„¤ëª… |
| :-- | :-- | :-- |
| ì½”ë“œ ë¸”ë¡ (ë§ˆì§€ë§‰ ì–¸ì–´) | **Alt+C** | ë§ˆì§€ë§‰ ì‚¬ìš© ì–¸ì–´ ì¦‰ì‹œ ì‚½ì… |
| ì½”ë“œ ë¸”ë¡ (ì–¸ì–´ ì„ íƒ) | âŒ¨ Code ë²„íŠ¼ | ì–¸ì–´ ì„ íƒ ëª¨ë‹¬ |
| ì¸ìš© ì‚½ì… | **Ctrl+Shift+C** | ì°¸ê³ ë¬¸í—Œ ê´€ë¦¬ì |
| Research Mode | **Ctrl+Shift+R** | ë‹¨ë½ ì¤„ë²ˆí˜¸ í‘œì‹œ |
| ì €ì¥ | **Ctrl+S** | MD / TXT / HTML ì„ íƒ |

---

### Research Mode ì¤„ë²ˆí˜¸

**Ctrl+Shift+R** ë˜ëŠ” ğŸ”¬ Research ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ë¯¸ë¦¬ë³´ê¸°ì—ì„œ ê° ë‹¨ë½ì— ì¤„ë²ˆí˜¸ê°€ í‘œì‹œë©ë‹ˆë‹¤.

ì´ê²ƒì€ ë‘ ë²ˆì§¸ ë‹¨ë½ì…ë‹ˆë‹¤. ì¤„ë²ˆí˜¸ê°€ ì™¼ìª½ì— í‘œì‹œë©ë‹ˆë‹¤.

ì„¸ ë²ˆì§¸ ë‹¨ë½ì…ë‹ˆë‹¤.

---

### ì°¸ê³ ë¬¸í—Œ ê´€ë¦¬ì

**ğŸ“š References** ë²„íŠ¼ìœ¼ë¡œ APA ì°¸ê³ ë¬¸í—Œì„ ë¶™ì—¬ë„£ê³  ê´€ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

- **ë¹ˆ ì¤„ êµ¬ë¶„**: ì—¬ëŸ¬ ì°¸ê³ ë¬¸í—Œì„ ë¹ˆ ì¤„ë¡œ êµ¬ë¶„
- **ì—”í„° êµ¬ë¶„**: ê° ì¤„ì´ í•˜ë‚˜ì˜ ì°¸ê³ ë¬¸í—Œ

ìŠ¤íƒ€ì¼ ë³€í™˜: APA â†’ MLA 9 / Chicago / Vancouver ìë™ ë³€í™˜ì„ ì§€ì›í•©ë‹ˆë‹¤.

<div class="page-break"></div>

## 2í˜ì´ì§€ â€” ìº¡ì…˜, ìˆ˜ì‹, ë…¼ë¬¸ ì–‘ì‹

### í‘œ ìº¡ì…˜ ì˜ˆì‹œ

<span class="tbl-caption"><í‘œ1> ì—°êµ¬ëŒ€ìƒ íŠ¹ì„±</span>

| ë³€ìˆ˜ | M | SD | n |
| :-- | :-- | :-- | :-- |
| ì—°ë ¹ | 24.5 | 3.2 | 120 |
| í•™ìŠµì‹œê°„ | 5.3 | 1.8 | 120 |

### ìˆ˜ì‹

$$
\\phi = \\frac{\\lambda_2}{c^2}
$$

### ë…¼ë¬¸ ì–‘ì‹

**ğŸ“‹ ì–‘ì‹** ë²„íŠ¼ì„ ëˆŒëŸ¬ í•™ìœ„ë…¼ë¬¸, SSCI/KCI, ë‹¨ì¼/ë‹¤ì¤‘ ì—°êµ¬, ë©”íƒ€ë¶„ì„ êµ¬ì¡°ë¥¼ ì‚½ì…í•˜ì„¸ìš”.

> \`Shift+?\` â†’ ì „ì²´ ë‹¨ì¶•í‚¤ ëª©ë¡
`}
};

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PWA â€” Service Worker + Manifest (ì¸ë¼ì¸ ìƒì„±)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
(function(){
  // 1. Manifest ë™ì  ìƒì„±
  const manifest={
    name:'Markdown PDF Editor Pro V9',
    short_name:'MD PRO V9',
    description:'ì—°êµ¬Â·ë…¼ë¬¸ ì „ìš© ë§ˆí¬ë‹¤ìš´ ì—ë””í„°',
    start_url:'.',
    display:'standalone',
    background_color:'#0f0f13',
    theme_color:'#1a1a24',
    icons:[
      {src:'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 192 192"><rect width="192" height="192" rx="24" fill="%237c6af7"/><text x="96" y="130" font-size="110" text-anchor="middle" font-family="monospace" fill="white">M</text></svg>',sizes:'192x192',type:'image/svg+xml'},
      {src:'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><rect width="512" height="512" rx="60" fill="%237c6af7"/><text x="256" y="360" font-size="300" text-anchor="middle" font-family="monospace" fill="white">M</text></svg>',sizes:'512x512',type:'image/svg+xml'}
    ]
  };
  const blob=new Blob([JSON.stringify(manifest)],{type:'application/json'});
  const url=URL.createObjectURL(blob);
  const link=document.getElementById('pwa-manifest');
  if(link)link.href=url;

  // 2. Service Worker ì¸ë¼ì¸ ë“±ë¡
  if('serviceWorker' in navigator){
    const swCode=`
const CACHE='mdpro-v9-cache-v1';
const ASSETS=['/'];
self.addEventListener('install',e=>e.waitUntil(caches.open(CACHE).then(c=>c.addAll(ASSETS)).catch(()=>{})));
self.addEventListener('activate',e=>e.waitUntil(caches.keys().then(ks=>Promise.all(ks.filter(k=>k!==CACHE).map(k=>caches.delete(k))))));
self.addEventListener('fetch',e=>{e.respondWith(caches.match(e.request).then(r=>r||fetch(e.request).then(res=>{const rc=res.clone();caches.open(CACHE).then(c=>c.put(e.request,rc));return res}).catch(()=>caches.match('/'))).catch(()=>fetch(e.request)));});
`;
    const swBlob=new Blob([swCode],{type:'application/javascript'});
    const swUrl=URL.createObjectURL(swBlob);
    navigator.serviceWorker.register(swUrl,{scope:'./'}).catch(()=>{});
  }
})();

window.addEventListener('DOMContentLoaded',()=>App.init());
</script>
</body>
</html>

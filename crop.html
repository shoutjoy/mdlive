<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>이미지 크롭</title>
  <style>
    * { box-sizing: border-box; }
    html, body { height: 100%; margin: 0; overflow: hidden; }
    body {
      display: flex;
      flex-direction: column;
      padding: 12px;
      font-family: sans-serif;
      background: #1a1a2e;
      color: #e8e8f0;
    }
    h3 { margin: 0 0 8px; font-size: 14px; flex-shrink: 0; }
    .crop-canvas-wrap {
      flex: 1 1 0;
      min-height: 0;
      overflow: auto;
      margin-bottom: 8px;
    }
    #crop-canvas { display: block; max-width: 100%; cursor: crosshair; border: 1px solid #3a3a50; border-radius: 6px; }
    .crop-preview-label { font-size: 12px; color: #888; margin: 0 0 4px; flex-shrink: 0; }
    .crop-preview-wrap { width: 100%; height: 120px; background: #0d0d14; border: 1px solid #3a3a50; border-radius: 6px; overflow: hidden; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
    #crop-preview { max-width: 100%; max-height: 100%; width: auto; height: auto; object-fit: contain; display: block; }
    .btns { margin-top: 8px; display: flex; gap: 8px; flex-wrap: wrap; flex-shrink: 0; }
    button { padding: 8px 14px; border-radius: 6px; cursor: pointer; font-size: 13px; border: 1px solid #4a4a6a; background: #2a2a3a; color: #e8e8f0; }
    button.primary { background: #5b4ce4; border-color: #6a5cf7; }
  </style>
</head>
<body>
  <h3>영역을 드래그하여 선택 후 [크롭 적용] 클릭</h3>
  <div class="crop-canvas-wrap">
    <canvas id="crop-canvas"></canvas>
  </div>
  <div class="crop-preview-label">크롭 미리보기</div>
  <div class="crop-preview-wrap">
    <img id="crop-preview" alt="크롭 미리보기" />
  </div>
  <div class="btns">
    <button class="primary" id="btn-apply">크롭 적용</button>
    <button id="btn-cancel">취소</button>
  </div>
  <script>
    let img = null, scale = { w: 1, h: 1 }, rect = { x: 0, y: 0, w: 0, h: 0 }, dragging = false, start = { x: 0, y: 0 };
    const canvas = document.getElementById('crop-canvas');
    const ctx = canvas.getContext('2d');
    const previewEl = document.getElementById('crop-preview');

    function draw() {
      if (!img) return;
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
      if (rect.w > 2 && rect.h > 2) {
        ctx.strokeStyle = '#6ac8f7';
        ctx.lineWidth = 2;
        ctx.setLineDash([4, 4]);
        ctx.strokeRect(rect.x, rect.y, rect.w, rect.h);
        ctx.fillStyle = 'rgba(0,0,0,.4)';
        ctx.fillRect(0, 0, canvas.width, rect.y);
        ctx.fillRect(0, rect.y, rect.x, rect.h);
        ctx.fillRect(rect.x + rect.w, rect.y, canvas.width - rect.x - rect.w, rect.h);
        ctx.fillRect(0, rect.y + rect.h, canvas.width, canvas.height - rect.y - rect.h);
        updatePreview();
      } else {
        previewEl.style.display = 'none';
      }
    }

    function updatePreview() {
      if (!img || rect.w < 5 || rect.h < 5) {
        previewEl.style.display = 'none';
        return;
      }
      const sw = Math.round(rect.w * scale.w);
      const sh = Math.round(rect.h * scale.h);
      const tc = document.createElement('canvas');
      tc.width = sw;
      tc.height = sh;
      const tctx = tc.getContext('2d');
      tctx.drawImage(img, rect.x * scale.w, rect.y * scale.h, sw, sh, 0, 0, sw, sh);
      previewEl.src = tc.toDataURL('image/png');
      previewEl.style.display = 'block';
    }

    function receiveImage(imageData) {
      if (!imageData) return;
      img = new Image();
      if (imageData.startsWith('data:')) {
        img.src = imageData;
      } else {
        img.crossOrigin = 'anonymous';
        img.src = imageData;
      }
      img.onerror = function() {
        document.body.insertAdjacentHTML('beforeend', '<p style="color:#e55">이미지를 불러올 수 없습니다.</p>');
      };
      img.onload = function() {
        const wrap = document.querySelector('.crop-canvas-wrap');
        const maxW = wrap ? Math.min(560, wrap.clientWidth) : 560;
        const maxH = wrap ? Math.min(280, wrap.clientHeight) : 280;
        let w = img.width, h = img.height;
        if (w > maxW || h > maxH) {
          const r = Math.min(maxW / w, maxH / h);
          w = Math.round(w * r); h = Math.round(h * r);
        }
        canvas.width = w; canvas.height = h;
        scale = { w: img.width / w, h: img.height / h };
        rect = { x: 0, y: 0, w: w, h: h };
        draw();
      };
    }

    window.addEventListener('message', function(e) {
      if (e.data && e.data.type === 'crop' && e.data.image) {
        receiveImage(e.data.image);
      }
    });

    if (window.opener) {
      window.opener.postMessage({ type: 'crop-ready' }, '*');
    }

    canvas.addEventListener('mousedown', function(e) {
      const r = canvas.getBoundingClientRect();
      const x = (e.clientX - r.left) * (canvas.width / r.width);
      const y = (e.clientY - r.top) * (canvas.height / r.height);
      dragging = true;
      start = { x: x, y: y };
      rect = { x: x, y: y, w: 0, h: 0 };
    });
    canvas.addEventListener('mousemove', function(e) {
      if (!dragging) return;
      const r = canvas.getBoundingClientRect();
      const x = (e.clientX - r.left) * (canvas.width / r.width);
      const y = (e.clientY - r.top) * (canvas.height / r.height);
      rect = { x: Math.min(start.x, x), y: Math.min(start.y, y), w: Math.abs(x - start.x), h: Math.abs(y - start.y) };
      draw();
    });
    canvas.addEventListener('mouseup', function() { dragging = false; });
    canvas.addEventListener('mouseleave', function() { dragging = false; });

    document.getElementById('btn-apply').addEventListener('click', function() {
      if (!img || rect.w < 5 || rect.h < 5) { window.close(); return; }
      const tc = document.createElement('canvas');
      tc.width = Math.round(rect.w * scale.w);
      tc.height = Math.round(rect.h * scale.h);
      const tctx = tc.getContext('2d');
      tctx.drawImage(img, rect.x * scale.w, rect.y * scale.h, tc.width, tc.height, 0, 0, tc.width, tc.height);
      const dataUrl = tc.toDataURL('image/png');
      if (window.opener) window.opener.postMessage({ type: 'aiimg-cropped', dataUrl: dataUrl }, '*');
      window.close();
    });
    document.getElementById('btn-cancel').addEventListener('click', function() { window.close(); });
  </script>
</body>
</html>
